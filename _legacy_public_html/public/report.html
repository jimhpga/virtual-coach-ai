<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Virtual Coach AI - Report</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; max-width: 1100px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .error { background: #ffe5e5; border: 1px solid #ff8a8a; padding: 12px; border-radius: 10px; color: #7a0000; display:none; }
    .ok { background: #e7fff1; border: 1px solid #7ee2a8; padding: 12px; border-radius: 10px; color: #0b5a2a; display:none; }
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .tile { border: 1px solid #eee; border-radius: 12px; padding: 10px; }
    .label { font-weight: bold; margin-bottom: 8px; }
    img { width: 100%; border-radius: 10px; background:#000; }
    video { width: 100%; max-height: 420px; border-radius: 12px; background:#000; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .btn { padding: 10px 14px; border-radius: 10px; border: 0; cursor: pointer; }
    .btn-primary { background: #0a7; color: #fff; }
    .btn-ghost { background: #eee; }
    .small { font-size: 12px; color: #666; }
  </style>
</head>
<body>
  <h1>Swing Report</h1>

  <div class="card">
    <div class="row">
      <button id="back" class="btn btn-ghost">← Back to Upload</button>
      <button id="rerun" class="btn btn-primary">Re-run Extract</button>
      <div id="meta" class="small"></div>
    </div>

    <div id="error" class="error"></div>
    <div id="ok" class="ok"></div>

    <video id="vid" controls playsinline style="display:none;"></video>
  </div>

  <div class="card">
    <h2>P1–P9 Frames</h2>
    <div id="grid" class="grid"></div>
  </div>

<script>
  const errorEl = document.getElementById("error");
  const okEl = document.getElementById("ok");
  const grid = document.getElementById("grid");
  const vid = document.getElementById("vid");
  const meta = document.getElementById("meta");

  function showError(msg) {
    okEl.style.display = "none";
    errorEl.textContent = msg;
    errorEl.style.display = "block";
  }
  function showOk(msg) {
    errorEl.style.display = "none";
    okEl.textContent = msg;
    okEl.style.display = "block";
  }

  function renderFrames(frames) {
    grid.innerHTML = "";
    frames.forEach(f => {
      const div = document.createElement("div");
      div.className = "tile";
      const lab = document.createElement("div");
      lab.className = "label";
      lab.textContent = "P" + f.p;
      const img = document.createElement("img");
      // cache-bust so you see updates on rerun
      img.src = f.url + "?t=" + Date.now();
      div.appendChild(lab);
      div.appendChild(img);
      grid.appendChild(div);
    });
  }

  async function runExtract() {
    const videoUrl = sessionStorage.getItem("vca_videoUrl");
    if (!videoUrl) {
      showError("No uploaded video found. Go back and upload a clip first.");
      return;
    }

    vid.src = videoUrl;
    vid.style.display = "block";

    showOk("Extracting P1–P9…");
    grid.innerHTML = "";

    const res = await fetch("/api/extract-pframes", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ videoUrl })
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data.ok) {
      showError(data.error || "Extract failed.");
      return;
    }

    meta.textContent = "Job: " + data.jobId;
    showOk("Done. Showing P1–P9.");
    renderFrames(data.frames || []);
  }

  document.getElementById("back").addEventListener("click", () => {
    window.location.href = "/upload.html";
  });

  document.getElementById("rerun").addEventListener("click", () => {
    runExtract();
  });

  // auto-run on load
  runExtract();
</script>
<script>
  (function () {
    const url = sessionStorage.getItem("vca_video_preview_url");
    const v = document.getElementById("vid");

    if (!v) return;

    if (!url) {
      // No preview stored (user came direct to report). Leave hidden.
      return;
    }

    v.style.display = "block";
    v.src = url;
    v.load();
  })();
</script>

</body>
</html>




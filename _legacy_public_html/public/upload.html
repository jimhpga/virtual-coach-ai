<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Virtual Coach AI - Upload</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; max-width: 860px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .btn { padding: 10px 14px; border-radius: 10px; border: 0; cursor: pointer; }
    .btn-primary { background: #0a7; color: #fff; }
    .btn-disabled { background: #bbb; color: #fff; cursor: not-allowed; }
    .hint { color: #444; line-height: 1.4; }
    .error { background: #ffe5e5; border: 1px solid #ff8a8a; padding: 12px; border-radius: 10px; color: #7a0000; display:none; margin-top:12px; }
    .ok { background: #e7fff1; border: 1px solid #7ee2a8; padding: 12px; border-radius: 10px; color: #0b5a2a; display:none; margin-top:12px; }
    video { width: 100%; max-height: 420px; border-radius: 12px; background: #000; margin-top: 12px; display:none; }
    .small { font-size: 12px; color: #666; margin-top: 8px; }
  </style>
</head>
<body>
  <h1>Upload Your Swing</h1>
  <p class="hint">
    MVP rule: <b>clip must be 12 seconds or less</b> (ideal: 7–10 seconds).<br/>
    Start about 1 second before takeaway. End about 1 second after finish.
  </p>

  <div class="card">
    <div class="row">
      <input id="file" type="file" accept="video/*" />
      <button id="uploadBtn" class="btn btn-primary btn-disabled" disabled>Upload</button>
    </div>

    <div id="error" class="error"></div>
    <div id="ok" class="ok"></div>

    <video id="preview" controls playsinline></video>
    <div id="meta" class="small"></div>
  </div>

<script>
  const fileEl = document.getElementById("file");
  const uploadBtn = document.getElementById("uploadBtn");
  const errorEl = document.getElementById("error");
  const okEl = document.getElementById("ok");
  const preview = document.getElementById("preview");
  const meta = document.getElementById("meta");

  function showError(msg) {
    okEl.style.display = "none";
    errorEl.textContent = msg;
    errorEl.style.display = "block";
  }
  function showOk(msg) {
    errorEl.style.display = "none";
    okEl.textContent = msg;
    okEl.style.display = "block";
  }

  fileEl.addEventListener("change", () => {
    errorEl.style.display = "none";
    okEl.style.display = "none";
    const f = fileEl.files && fileEl.files[0];
    if (!f) {
      uploadBtn.disabled = true;
      uploadBtn.classList.add("btn-disabled");
      preview.style.display = "none";
      meta.textContent = "";
      return;
    }

    // local preview
    const url = URL.createObjectURL(f);
    preview.src = url;
    preview.style.display = "block";
    meta.textContent = "Selected: " + f.name + " (" + Math.round(f.size/1024/1024) + " MB)";

    uploadBtn.disabled = false;
    uploadBtn.classList.remove("btn-disabled");
  });

  uploadBtn.addEventListener("click", async () => {
    const f = fileEl.files && fileEl.files[0];
    if (!f) return;

    uploadBtn.disabled = true;
    uploadBtn.classList.add("btn-disabled");
    showOk("Uploading…");

    try {
      const res = await fetch("/api/upload", {
        method: "POST",
        headers: { "x-file-name": f.name },
        body: f
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok || !data.ok) {
        showError(data.error || "Upload failed.");
        uploadBtn.disabled = false;
        uploadBtn.classList.remove("btn-disabled");
        return;
      }

      // Save for next page (optional)
      sessionStorage.setItem("vca_videoUrl", data.videoUrl);
      sessionStorage.setItem("vca_durationSec", String(data.durationSec || ""));

      showOk("Upload complete (" + (data.durationSec || 0).toFixed(1) + "s). Ready for analysis.");
      meta.textContent = "Saved: " + data.videoUrl;

      // OPTIONAL redirect:
      window.location.href = "/report.html";

    } catch (e) {
      showError("Network error. Try again.");
      uploadBtn.disabled = false;
      uploadBtn.classList.remove("btn-disabled");
    }
  });
</script>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="robots" content="noindex, nofollow"/>
  <title>Virtual Coach AI</title>
  <style>
    html,body{height:100%;margin:0;padding:0;background:#0a0a0a url("homepage-background.png") center/cover no-repeat fixed;color:#f5f5f5;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:920px;margin:0 auto;padding:48px 20px;text-align:center;text-shadow:0 1px 2px rgba(0,0,0,.25)}
    .logo{width:360px;max-width:90vw;height:auto;margin:8px auto 20px;display:block;filter:drop-shadow(0 6px 16px rgba(0,0,0,.35))}
    h1{margin:0 0 12px}
    p{margin:0 0 12px}
    .btn{display:inline-block;margin:10px 6px 0;padding:12px 18px;border-radius:12px;border:1px solid rgba(255,255,255,.16);
      background:#1F6F1F;color:#fff;font-weight:700;text-decoration:none;cursor:pointer}
    .btn.secondary{background:transparent}
    /* Progress overlay */
    #vc-status{position:fixed;inset:0;background:rgba(0,0,0,.75);color:#fff;display:none;align-items:center;justify-content:center;z-index:9999}
    #vc-status .box{padding:18px 22px;border:1px solid rgba(255,255,255,.2);border-radius:14px;background:rgba(0,0,0,.35)}
    #vc-status .stage{font-weight:800;font-size:18px;margin:0 0 6px}
    #vc-status .hint{opacity:.8;font-size:12px;margin:0 0 8px}
    .spinner{width:40px;height:40px;border:4px solid rgba(255,255,255,.2);border-top-color:#1F6F1F;border-radius:50%;margin:10px auto;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="wrap">
    <img src="virtualcoach-logo-transparent.png" alt="Virtual Coach AI" class="logo"/>
    <h1>WELCOME</h1>
    <p>Upload a short swing clip (2â€“10 seconds). Weâ€™ll analyze it and generate your live report.</p>

    <!-- Hidden file input -->
    <input type="file" id="swingUpload" accept="video/mp4,video/quicktime,video/webm" style="display:none" onchange="uploadSwing()"/>

    <!-- Buttons -->
    <label for="swingUpload" class="btn">â¬† Upload Your Swing</label>
    <a href="/summary.html" class="btn secondary">ðŸ“Š Reports</a>
  </div>

  <!-- Progress overlay -->
  <div id="vc-status">
    <div class="box">
      <div class="stage" id="vc-stage">Startingâ€¦</div>
      <div class="hint" id="vc-hint">If this stays here > 45s, weâ€™ll show the error.</div>
      <div class="spinner"></div>
    </div>
  </div>

  <script>
    // --- helpers ---
    const overlay = document.getElementById('vc-status');
    const stageEl = document.getElementById('vc-stage');
    function show(msg){ stageEl.textContent = msg; overlay.style.display='flex'; }
    function hide(){ overlay.style.display='none'; }
    function guardLogin(){ try{ return localStorage.getItem('vc_auth') === 'ok'; }catch(_){ return false; } }
    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

    // iOS-safe duration read
    function readDuration(file){
      return new Promise((resolve)=>{
        const url = URL.createObjectURL(file);
        const v = document.createElement('video');
        v.preload = 'metadata'; v.src = url;
        let done = false;
        v.onloadedmetadata = () => { if(!done){ done=true; URL.revokeObjectURL(url); resolve(v.duration);} };
        v.onerror = () => { if(!done){ done=true; URL.revokeObjectURL(url); resolve(NaN);} };
        // iOS Infinity quirk
        setTimeout(()=>{
          if (!done && !isFinite(v.duration)) {
            v.currentTime = Number.MAX_SAFE_INTEGER;
            v.ontimeupdate = () => { if(!done){ done=true; URL.revokeObjectURL(url); resolve(v.duration);} };
          }
        }, 350);
      });
    }

    // Extract 6 frames (JPEG 0.6), iOS-safe seeking
    async function extractFrames(file){
      const url = URL.createObjectURL(file);
      const video = document.createElement('video');
      video.src = url; video.muted = true; video.playsInline = true; video.preload = 'metadata';
      await new Promise((res,rej)=>{ video.onloadedmetadata=res; video.onerror=()=>rej(new Error('metadata')); });
      try{ await video.play(); }catch(_){} video.pause();

      const dur = Math.max(0.6, Math.min(2.0, video.duration || 1.5));
      const steps = 6;
      const ts = Array.from({length:steps},(_,i)=> +(i*(dur/(steps-1))).toFixed(2));

      const canvas = document.createElement('canvas');
      canvas.width = 480; canvas.height = 270;
      const ctx = canvas.getContext('2d');

      const images = [];
      for (const t of ts){
        const target = Math.min(t, (video.duration || dur) - 0.05);
        const sought = new Promise(res=>{
          let done=false;
          video.onseeked = () => { if(!done){ done=true; res(); } };
          setTimeout(()=>{ if(!done){ done=true; res(); } }, 900); // safety
        });
        video.currentTime = target;
        await sought;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        images.push(canvas.toDataURL('image/jpeg', 0.6));
      }
      URL.revokeObjectURL(url);
      return images;
    }

    // Watchdog to surface network stalls
    function withTimeout(promise, ms, label='operation'){
      let t; const timeout = new Promise((_,rej)=> t=setTimeout(()=>rej(new Error(label+' timeout')), ms));
      return Promise.race([promise.finally(()=>clearTimeout(t)), timeout]);
    }

    async function uploadSwing(){
      if (!guardLogin()){ window.location.href = '/login.html'; return; }

      const input = document.getElementById('swingUpload');
      const file = input?.files?.[0];
      if (!file){ alert('Please select a swing file.'); return; }

      show('Reading videoâ€¦');
      const duration = await readDuration(file);
      if (!duration || !isFinite(duration)){ hide(); alert('Could not read video length. Try another clip.'); input.value=''; return; }
      if (duration > 10){ hide(); alert('Clip too long. Please upload â‰¤ 10 seconds.'); input.value=''; return; }

      show('Extracting framesâ€¦');
      let frames = [];
      try { frames = await extractFrames(file); }
      catch(e){ hide(); alert('Could not extract frames. Try another clip.'); return; }

      // Keep payload modest
      frames = frames.slice(0,6);

      show('Analyzing (10â€“30s)â€¦');
      const id = Date.now().toString();
      try{
        const resp = await withTimeout(fetch('/api/analyze', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ id, frames })
        }), 45000, 'analysis');

        if (!resp.ok){
          const txt = await resp.text();
          hide();
          alert('Analysis failed:\n' + txt.slice(0,200));
          return;
        }
        const report = await resp.json();
        sessionStorage.setItem('vc_report_'+id, JSON.stringify(report));

        show('Building reportâ€¦');
        await sleep(300);
        window.location.href = `/summary.html?id=${encodeURIComponent(id)}`;
      }catch(e){
        hide();
        alert('Analysis error: ' + (e?.message || e));
      }
    }
  </script>
</body>
</html>

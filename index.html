<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Virtual Coach AI</title>
  <style>
    html, body {
      height: 100%; margin: 0; padding: 0; color: #f5f5f5;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: #0a0a0a url("homepage-background.png") center / cover no-repeat fixed;
      filter: brightness(1.08) contrast(1.03);
    }
    body { min-height: -webkit-fill-available; }
    .hero { max-width: 760px; margin: 0 auto; padding: 48px 24px 72px; text-align: center; text-shadow: 0 1px 2px rgba(0,0,0,0.25); }
    .logo { width: 420px; max-width: 90vw; height: auto; margin: 8px auto 20px; display: block; filter: drop-shadow(0 6px 16px rgba(0,0,0,0.25)); }
    .logo-green { filter: brightness(0) saturate(100%) invert(26%) sepia(56%) saturate(2350%) hue-rotate(79deg) brightness(85%) contrast(90%) drop-shadow(0 6px 16px rgba(0,0,0,0.25)); }
    h1 { margin: 0 0 10px; font-size: 36px; letter-spacing: 0.04em; }
    p  { margin: 0 auto 16px; line-height: 1.6; max-width: 560px; }
    .btn { display:inline-block; margin: 10px 8px 0; padding: 12px 18px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); text-decoration:none; font-weight:700; color:#fff; background:#0f172a; cursor:pointer; }
    .btn:hover { opacity:.92; }
    .btn-secondary { background: transparent; border-color: rgba(255,255,255,0.25); }
    .contact a { color: #22c55e; text-decoration: none; }
    .contact a:hover { text-decoration: underline; }
    @media (max-width: 480px) { h1 { font-size: 30px; } .logo { width: 300px; } }

    /* Status overlay */
    #vc-status { position:fixed; inset:0; background:rgba(0,0,0,.72); color:#fff; display:none; align-items:center; justify-content:center; z-index:9999 }
  </style>
</head>
<body>
  <div class="hero">
    <img src="virtualcoach-logo-transparent.png" alt="Virtual Coach AI Logo" class="logo logo-green" />
    <h1>WELCOME</h1>
    <p>to the beta launch of Virtual Coach AI â€” the intelligent swing coach designed to help you reach your golfing potential.</p>
<div style="margin:12px 0; display:flex; gap:12px; justify-content:center; flex-wrap:wrap">
  <!-- Handedness -->
  <label style="display:flex; align-items:center; gap:6px; background:rgba(0,0,0,.25); padding:8px 10px; border-radius:10px">
    Handedness:
    <select id="handed" style="padding:6px 8px; border-radius:8px;">
      <option value="right" selected>Right-handed</option>
      <option value="left">Left-handed</option>
    </select>
  </label>

  <!-- Eye dominance -->
  <label style="display:flex; align-items:center; gap:6px; background:rgba(0,0,0,.25); padding:8px 10px; border-radius:10px">
    Eye Dominance:
    <select id="eye" style="padding:6px 8px; border-radius:8px;">
      <option value="right" selected>Right-eye</option>
      <option value="left">Left-eye</option>
      <option value="unknown">Not sure</option>
    </select>
  </label>
</div>

    <!-- Hidden file input (wired) -->
    <input type="file" id="swingUpload"
           accept="video/mp4,video/quicktime,video/webm"
           style="display:none"
           onchange="uploadSwing()" />

    <!-- Buttons -->
    <label for="swingUpload" class="btn">â¬† Upload Your Swing</label>
    <a href="/summary.html" class="btn btn-secondary">ðŸ“Š Reports</a>
    <p class="contact" style="margin-top:14px;">Questions? <a href="mailto:jimh@pga.com">jimh@pga.com</a></p>
  </div>

  <!-- Status overlay -->
  <div id="vc-status">
    <div style="text-align:center;font-family:system-ui,-apple-system,Segoe UI,Roboto">
      <div id="vc-status-text" style="font-weight:700;font-size:18px;margin-bottom:8px">Startingâ€¦</div>
      <div style="font-size:13px;opacity:.8">If this stays here > 45s, weâ€™ll show the error.</div>
    </div>
  </div>

  <script>
    // Safety: surface JS/network errors instead of silent failures
    window.addEventListener('error', e => alert('App error: ' + (e.message || 'unknown')));
    window.addEventListener('unhandledrejection', e => alert('Network/analysis error: ' + (e.reason?.message || e.reason || 'unknown')));

    // ===== Helpers =====
    const overlay = document.getElementById('vc-status');
    const ovText  = document.getElementById('vc-status-text');
    function show(msg){ try{ ovText.textContent = msg; overlay.style.display='flex'; }catch(_){ alert(msg); } }
    function hide(){ try{ overlay.style.display='none'; }catch(_){} }
    function toast(m){ try{ alert(m); } catch(_){} }

    // ===== iOS-friendly frame extraction =====
    async function extractFrames(file) {
      const url = URL.createObjectURL(file);
      const video = document.createElement('video');
      video.src = url; video.muted = true; video.playsInline = true; video.preload = 'metadata';

      // Load metadata
      await new Promise((resolve, reject) => {
        video.onloadedmetadata = resolve;
        video.onerror = () => reject(new Error('Could not load video metadata'));
      });

      // iOS poke
      try { await video.play(); } catch(_) {}
      video.pause();

      // 9 frames for display; weâ€™ll send 5 to API
      const dur = Math.max(0.6, Math.min(2.0, video.duration || 1.5));
      const steps = 9;
      const ts = Array.from({length: steps}, (_,i) => +(i * (dur / (steps - 1))).toFixed(2));

      const canvas = document.createElement('canvas');
      canvas.width = 480; canvas.height = 270;
      const ctx = canvas.getContext('2d');

      const images = [];
      for (const t of ts) {
        const target = Math.min(t, (video.duration || dur) - 0.05);
        // Seek with longer timeout for iOS reliability
        const sought = new Promise(res => {
          let done=false;
          video.onseeked = () => { if(!done){ done=true; res(); } };
          setTimeout(()=>{ if(!done){ done=true; res(); } }, 1200);
        });
        video.currentTime = target;
        await sought;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        images.push(canvas.toDataURL('image/jpeg', 0.5));
      }
      URL.revokeObjectURL(url);
      return images;
    }

    // Promise watchdog
    function withTimeout(promise, ms, label='operation'){
      let t; const timeout = new Promise((_,rej)=> t=setTimeout(()=>rej(new Error(label+' timeout')), ms));
      return Promise.race([promise.finally(()=>clearTimeout(t)), timeout]);
    }

    // ===== Main upload handler =====
    async function uploadSwing() {
      try {
        // Require passcode per-device
        if (localStorage.getItem('vc_auth') !== 'ok') { window.location.href = '/login.html'; return; }

        // Online check (course Wi-Fi/1-bar issues)
        if (!navigator.onLine) { toast('No internet. Try again when youâ€™re online.'); return; }

        const input = document.getElementById('swingUpload');
        const file = input?.files?.[0];
        if (!file) { toast('Please select a swing file.'); return; }

        show('Reading videoâ€¦');

        // Quick duration check with iOS Infinity fix
        const tmpUrl = URL.createObjectURL(file);
        const v = document.createElement('video');
        v.preload = 'metadata'; v.src = tmpUrl;
        const duration = await new Promise((resolve) => {
          v.onloadedmetadata = () => resolve(v.duration);
          v.onerror = () => resolve(NaN);
          setTimeout(()=>{ if (!isFinite(v.duration)) { v.currentTime = Number.MAX_SAFE_INTEGER; v.ontimeupdate=()=>resolve(v.duration);} }, 600);
        });
        URL.revokeObjectURL(tmpUrl);

        if (!duration || !isFinite(duration)) { hide(); toast('Could not read video length. Try another clip.'); input.value=''; return; }
        if (duration > 10) { hide(); toast('Clip too long. Please upload â‰¤ 10 seconds.'); input.value=''; return; }

        show('Extracting framesâ€¦');
        const framesAll = await extractFrames(file);           // 9 frames for thumbnails
        const framesForApi = framesAll.slice(0,5);             // 5 frames for analysis
        const id = Date.now().toString();

        // save frames for summary thumbnails
        try { sessionStorage.setItem('vc_frames_' + id, JSON.stringify(framesAll)); } catch(_) {}

        if (!navigator.onLine) { hide(); toast('Connection dropped. Please retry.'); return; }

        show('Analyzing (10â€“30s)â€¦');
        const resp = await withTimeout(fetch('/api/analyze', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ id, frames: framesForApi })
        }), 45000, 'analysis');

        if (!resp.ok) {
          const txt = await resp.text();
          hide();
          toast('Analysis failed.\n' + txt.slice(0, 200));
          return;
        }

        const report = await resp.json();
        try { sessionStorage.setItem('vc_report_' + id, JSON.stringify(report)); } catch(_) {}

        // Clean input so next upload is fresh
        try { input.value = ''; } catch(_) {}

        show('Building reportâ€¦');
        window.location.href = `/summary.html?id=${encodeURIComponent(id)}`;
      } catch (e) {
        hide();
        toast('Upload/analysis error: ' + (e?.message || e));
      }
    }
    window.uploadSwing = uploadSwing;
  </script>
</body>
</html>

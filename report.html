<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Virtual Coach AI – Swing Report</title>
  <style>
    :root{
      --bg:#0a0a0a;
      --panel:#111111e6;
      --border:rgba(255,255,255,.12);
      --text:#fff;
      --muted:#cfd3d8;
      --brand:#003300; /* dark green */
      --ok:#f9c846;    /* yellow */
      --good:#24d07b;  /* green */
      --need:#ff5f60;  /* red */
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: #000 url('homepage-background.png') center/cover fixed no-repeat;
    }
    .wrap{
      background: linear-gradient(180deg, rgba(0,0,0,.70), rgba(0,0,0,.55));
      min-height:100%;
      padding:16px;
    }
    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin:6px auto 12px; max-width:1200px;
      padding:8px 10px; border:1px solid var(--border); background:var(--panel); border-radius:14px;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
    }
    .brand img{ height:42px; width:auto; filter: brightness(0) saturate(100%) invert(26%) sepia(88%) saturate(214%) hue-rotate(66deg) brightness(95%) contrast(85%); }
    .brand h1{ font-size:1.2rem; margin:0; letter-spacing:.2px; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{
      background:var(--brand); color:#fff; border:1px solid var(--border); border-radius:10px;
      padding:8px 12px; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; gap:6px;
    }
    .btn.secondary{ background:transparent; }
    main{ max-width:1200px; margin:0 auto; display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; }
    @media (max-width: 980px){ main{ grid-template-columns:1fr; } }

    .card{
      background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px;
    }
    .card h2{ margin:0 0 10px; font-size:1.1rem; color:#bfeecf; }
    video{ width:100%; border-radius:12px; border:1px solid var(--border); background:#000; }

    /* Key totals */
    .totals{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; }
    @media (max-width:700px){ .totals{ grid-template-columns: repeat(2, 1fr); } }
    .total{
      text-align:center; padding:12px; border:1px solid var(--border); border-radius:12px; background:#0e0e0eee;
    }
    .total .label{ color:var(--muted); font-size:.9rem; }
    .total .value{ font-size:1.5rem; font-weight:700; margin-top:4px; }

    /* P1–P9 grid */
    .pgrid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    @media (max-width:980px){ .pgrid{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width:600px){ .pgrid{ grid-template-columns: 1fr; } }
    .pbox{
      border:1px solid var(--border); border-radius:12px; padding:12px; background:#0e0e0eee;
    }
    .prow{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .ptitle{ font-weight:700; }
    .badge{ font-size:.8rem; padding:4px 8px; border-radius:999px; border:1px solid var(--border); }
    .good{ background: color-mix(in srgb, var(--good) 25%, transparent); }
    .ok{ background: color-mix(in srgb, var(--ok) 25%, transparent); }
    .need{ background: color-mix(in srgb, var(--need) 25%, transparent); }
    .pshort{ margin:8px 0 6px; color:var(--muted); }
    details{ background:#0b0b0b; border:1px dashed var(--border); border-radius:10px; padding:8px 10px; }
    details summary{ cursor:pointer; color:#bfeecf; }

    /* Tips columns */
    .twocol{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:700px){ .twocol{ grid-template-columns:1fr; } }
    ul.clean{ margin:8px 0 0 18px; }
    ul.clean li{ margin:6px 0; }

    /* Footer/print */
    @media print{
      body{ background:#fff !important; }
      .wrap{ background:#fff; padding:0; }
      header, .actions .btn{ display:none !important; }
      .card{ background:#fff; border:1px solid #ddd; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img src="virtualcoach-logo-transparent.png" alt="Virtual Coach AI" />
        <h1>Virtual Coach AI – Swing Report</h1>
      </div>
      <div class="actions">
        <a href="index.html" class="btn secondary">Home</a>
        <a href="upload.html" class="btn">Upload Another Swing</a>
        <button class="btn secondary" onclick="window.print()">Print</button>
      </div>
    </header>

    <main>
      <!-- Left: Video + Overview + P-stack -->
      <section class="left-col">
        <div class="card">
          <h2>Video</h2>
          <video id="vid" controls playsinline></video>
          <div id="vsrc" style="margin-top:8px; font-size:.9rem; color:var(--muted)"></div>
        </div>

        <div class="card" id="overview">
          <h2>Overview</h2>
          <div class="totals" id="totals">
            <!-- totals injected -->
          </div>
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; color:var(--muted)" id="meta">
            <!-- profile/tempo injected -->
          </div>
        </div>

        <div class="card">
          <h2>Positions (P1–P9)</h2>
          <div class="pgrid" id="pgrid">
            <!-- P1..P9 injected -->
          </div>
        </div>
      </section>

      <!-- Right: Quick Wins + Power + Plan -->
      <section class="right-col">
        <div class="card">
          <h2>Top 3 – Consistency</h2>
          <ul class="clean" id="tips3">
            <!-- tips injected -->
          </ul>
        </div>

        <div class="card">
          <h2>Top 3 – Power</h2>
          <ul class="clean" id="powertips3">
            <!-- power tips injected -->
          </ul>
        </div>

        <div class="card">
          <h2>14-Day Practice Plan</h2>
          <ul class="clean" id="plan14">
            <!-- lessons injected -->
          </ul>
        </div>
      </section>
    </main>
  </div>

  <script>
    // --- helpers ---
    const $ = (sel) => document.querySelector(sel);
    const el = (tag, cls, txt) => {
      const n = document.createElement(tag);
      if (cls) n.className = cls;
      if (txt != null) n.textContent = txt;
      return n;
    };
    const statusClass = (s) => (s === 'good' ? 'good' : (s === 'need' ? 'need' : 'ok'));

    // 1) Load video URL from sessionStorage or ?v=
    function getVideoUrl() {
      try {
        const ss = sessionStorage.getItem('uploadedVideoUrl');
        if (ss) return ss;
      } catch {}
      const u = new URL(location.href);
      return u.searchParams.get('v') || '';
    }

    // 2) Render helpers
    function renderTotals(totals){
      const tbox = $('#totals'); tbox.innerHTML = '';
      const items = [
        ['Fairways', totals?.fairways ?? '—'],
        ['Greens', totals?.greens ?? '—'],
        ['Putts', totals?.putts ?? '—'],
        ['Swing Speed (avg)', totals?.swingSpeedAvg ?? '—']
      ];
      items.forEach(([label,value])=>{
        const d = el('div','total');
        d.appendChild(el('div','label',label));
        d.appendChild(el('div','value', String(value)));
        tbox.appendChild(d);
      });
    }

    function renderMeta(profile, tempo, powerScore){
      const m = $('#meta'); m.innerHTML = '';
      const bits = [];
      if (profile) bits.push(`Profile: ${profile}`);
      if (tempo) bits.push(`Tempo: ${tempo}`);
      if (powerScore != null) bits.push(`Power: ${powerScore}`);
      m.textContent = bits.join('  ·  ');
    }

    function renderTips(list, targetSel){
      const ul = $(targetSel); ul.innerHTML = '';
      (list || []).forEach(t => {
        const li = el('li', null, t);
        ul.appendChild(li);
      });
      if (!ul.children.length) {
        ul.appendChild(el('li', null, '—'));
      }
    }

    function renderPlan(list){
      const ul = $('#plan14'); ul.innerHTML = '';
      (list || []).forEach(t => ul.appendChild(el('li', null, t)));
      if (!ul.children.length) ul.appendChild(el('li', null, '—'));
    }

    function renderPstack(pstack){
      const grid = $('#pgrid'); grid.innerHTML = '';
      const order = ['P1','P2','P3','P4','P5','P6','P7','P8','P9'];
      order.forEach(k=>{
        const p = pstack?.[k];
        const box = el('div','pbox');
        const top = el('div','prow');
        const title = el('div','ptitle', `${k} – ${p?.condition || ''}`);
        const badge = el('div', `badge ${statusClass(p?.status)}`, (p?.status || '—').toUpperCase());
        top.appendChild(title); top.appendChild(badge);
        box.appendChild(top);
        box.appendChild(el('div','pshort', p?.short || ''));
        const det = el('details');
        const sum = el('summary', null, 'Details');
        det.appendChild(sum);
        det.appendChild(el('div', null, p?.long || ''));
        box.appendChild(det);
        grid.appendChild(box);
      });
    }

    // 3) Boot sequence
    (async function init(){
      // Video
      const vUrl = getVideoUrl();
      const vid = $('#vid'), vsrc = $('#vsrc');
      if (vUrl){
        vid.src = vUrl;
        vsrc.textContent = 'Source: ' + vUrl;
      } else {
        vsrc.textContent = 'No video URL detected.';
      }

      // Build selections from saved prefs
      let selections = {};
      try{
        const hand = sessionStorage.getItem('vc_handedness');
        const eye  = sessionStorage.getItem('vc_eye');
        if (hand) selections.handed = hand;
        if (eye) selections.eye = eye;
      }catch{}

      // Fetch analysis JSON
      let data;
      try{
        const res = await fetch('/api/analyze', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ videoUrl: vUrl, selections })
        });
        if (!res.ok) throw new Error('Analyze failed: ' + res.status);
        data = await res.json();
      }catch(err){
        console.error('[analyze error]', err);
        // Fallback minimal
        data = {
          profile: 'Auto',
          tempo: '3:1',
          totals: { fairways: '—', greens: '—', putts: '—', swingSpeedAvg: '—' },
          pstack: {
            P1:{condition:'Setup',status:'ok',short:'Neutral posture',long:'Maintain athletic posture, slight knee flex.'},
            P2:{condition:'Takeaway',status:'good',short:'One-piece start',long:'Clubhead outside hands, face square.'},
            P3:{condition:'Lead Arm Parallel',status:'ok',short:'Width looks good',long:'Keep trail wrist set gradually.'},
            P4:{condition:'Top',status:'need',short:'Slight across-line',long:'Feel more left arm depth, club parallel to target.'},
            P5:{condition:'Transition',status:'ok',short:'Sequencing close',long:'Start from ground up, pressure left early.'},
            P6:{condition:'Delivery',status:'ok',short:'Shaft shallow',long:'Maintain side-bend, trail elbow in front of hip.'},
            P7:{condition:'Impact',status:'good',short:'Forward shaft lean',long:'Weight left, handle ahead, face square.'},
            P8:{condition:'Extension',status:'ok',short:'Post-impact width',long:'Extend arms, chest up and left.'},
            P9:{condition:'Finish',status:'good',short:'Balanced finish',long:'Belt buckle to target, hold pose.'}
          },
          tips3: ['Narrow-to-wide tempo', 'Preset trail wrist', 'Hold balanced finish'],
          power: { score: 80 },
          powerTips3: ['Step-change drill', 'Pump to P6, rip', 'Medicine ball throw'],
          lessons14: Array.from({length:14},(_,i)=>`Day ${i+1} – Practice block`)
        };
      }

      // Render
      renderTotals(data.totals);
      renderMeta(data.profile, data.tempo, data.power?.score);
      renderPstack(data.pstack);
      renderTips(data.tips3, '#tips3');
      renderTips(data.powerTips3, '#powertips3');
      renderPlan(data.lessons14);
    })();
  </script>
</body>
</html>

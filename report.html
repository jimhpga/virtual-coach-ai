  // ====== NAV (hamburger) ====================================================
  const header = document.getElementById('site-header');
  const btn = document.getElementById('menuBtn');
  btn.addEventListener('click', ()=>{
    const open = header.classList.toggle('open');
    btn.setAttribute('aria-expanded', open ? 'true' : 'false');
  });
  document.getElementById('siteNav').addEventListener('click', e=>{
    if(e.target.tagName==='A'){ header.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
  });

  // ====== UTILITIES & QUERY PARAMS ===========================================
  const $ = s => document.querySelector(s);
  const qp = new URLSearchParams(location.search);
  const src = (qp.get('src') || '').toLowerCase();
  const reportParam = qp.get('report');
  const keyParam = qp.get('key'); // NEW: uploads/<ts>-file.ext
  const fileSrc = (reportParam === 'local') ? null : (reportParam || '/report.json');

  // ====== RENDER HELPERS (unchanged) =========================================
  const fmt  = v => `${v}%`;
  const band = v => v>=75 ? 'ok' : v>=55 ? 'warn' : 'bad';
  const chip = g => (g==='good'?'g-good':g==='ok'?'g-ok':'g-bad');
  const metricRow = m => `<div class="metric"><div class="name">${m.label||m.p}</div><div class="bar"><span class="${band(m.value)}" style="width:${m.value}%"></span></div><div class="pct">${fmt(m.value)}</div></div>`;

  function toYouTubeEmbed(url){
    try{
      const u = new URL(url);
      if (u.hostname.includes('youtube.com')) {
        if (u.pathname === '/watch' && u.searchParams.get('v')) return `https://www.youtube.com/embed/${u.searchParams.get('v')}`;
        if (u.pathname.startsWith('/embed/')) return url;
      }
      if (u.hostname === 'youtu.be') return `https://www.youtube.com/embed/${u.pathname.slice(1)}`;
    }catch{}
    return null;
  }
  function openViewer(href){
    const viewer = $('#viewer');
    const body = $('#viewerBody');
    body.innerHTML = '';
    const yt = toYouTubeEmbed(href);
    if (yt){
      body.innerHTML = `<iframe src="${yt}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
    } else if (/^https?:/.test(href)){
      body.innerHTML = `<video controls playsinline src="${href}"></video>`;
    } else {
      window.open(href, '_blank', 'noopener'); return;
    }
    viewer.classList.add('open');
  }
  $('#viewerClose').addEventListener('click', ()=>$('#viewer').classList.remove('open'));
  $('#viewer').addEventListener('click', (e)=>{ if(e.target.id==='viewer') $('#viewer').classList.remove('open'); });

  function phaseRow(ph,i){
    const id = ph.id || ('P'+(i+1));
    const name = ph.name || '';
    const gRaw = String(ph.grade||'').toLowerCase();
    const grade = (gRaw==='bad') ? 'needs help' : (gRaw || 'ok');
    const short = ph.short || '';
    const long  = ph.long  || '';
    const ref   = ph.ref || ph.video || ph.video_url || '';
    const btnLabel = /youtu(\.be|be\.com)/.test(ref) ? 'YouTube' : 'Video';
    return `
    <details class="panel" ${i===0?'open':''}>
      <summary>
        <span class="pnum">${id}</span>
        <span class="pname">${name}</span>
        <span class="gchip ${chip(gRaw)}">${grade.toUpperCase()}</span>
        <span class="sub" style="margin-left:8px">${short}</span>
        <svg class="caret" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
      </summary>
      <div class="content">
        <div class="sub" style="margin-bottom:8px">${short}</div>
        <div style="margin-bottom:10px">${long}</div>
        ${ref?`<button class="btn videoBtn" data-href="${ref}">${btnLabel}</button>`:''}
      </div>
    </details>`;
  }
  function coachItem(item){
    const title = item.title || '';
    const short = item.short || '';
    const long  = item.long  || '';
    const ref   = item.ref || '';
    const btnLabel = /youtu(\.be|be\.com)/.test(ref) ? 'YouTube' : 'Video';
    return `<details class="panel">
      <summary><span class="pname">${title}</span><span class="sub" style="margin-left:8px">${short}</span>
        <svg class="caret" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
      </summary>
      <div class="content">
        <div style="margin-bottom:10px">${long}</div>
        ${ref?`<button class="btn videoBtn" data-href="${ref}">${btnLabel}</button>`:''}
      </div>
    </details>`;
  }

  let last = null;
  function renderReport(data){
    last = data || {};
    document.getElementById('date').textContent = new Date().toLocaleDateString();
    if(data.discipline){
      document.getElementById('modeLabel').textContent =
        /putt/i.test(data.discipline) ? 'Putting' :
        /chip/i.test(data.discipline) ? 'Chipping' : 'Full Swing';
    }
    if(data.swings!=null){ document.getElementById('swingCount').textContent = String(data.swings); }

    const phases = Array.isArray(data.phases)? data.phases : [];
    document.getElementById('plist').innerHTML = phases.map(phaseRow).join('') || '<div class="content sub">No phases found in report.</div>';

    const pri = (data.coaching && Array.isArray(data.coaching.priority_fixes)) ? data.coaching.priority_fixes : [];
    const pow = (data.coaching && Array.isArray(data.coaching.power_fixes)) ? data.coaching.power_fixes : [];
    document.getElementById('coachPriority').innerHTML = pri.map(coachItem).join('') || '<div class="sub">No priority fixes in report.</div>';
    document.getElementById('coachPower').innerHTML    = pow.map(coachItem).join('')    || '<div class="sub">No power fixes in report.</div>';

    document.getElementById('position').innerHTML = (data.position_metrics||[]).map(metricRow).join('') || '<div class="sub">No position metrics.</div>';
    document.getElementById('swing').innerHTML    = (data.swing_metrics||[]).map(metricRow).join('')    || '<div class="sub">No swing metrics.</div>';

    const p = data.power||{score:0, tempo:'—', release_timing:0};
    document.getElementById('power').innerHTML = `
      <div class="metric"><div class="name">Power Score</div><div class="bar"><span class="${band(+p.score||0)}" style="width:${+p.score||0}%"></span></div><div class="pct">${+p.score||0}%</div></div>
      <div class="metric"><div class="name">Tempo</div><div class="bar"><span class="ok" style="width:76%"></span></div><div class="pct">${p.tempo||'—'}</div></div>
      <div class="metric"><div class="name">Release Timing</div><div class="bar"><span class="${band(+p.release_timing||0)}" style="width:${+p.release_timing||0}%"></span></div><div class="pct">${+p.release_timing||0}%</div></div>`;

    document.querySelectorAll('.videoBtn').forEach(b=> b.addEventListener('click', ()=> openViewer(b.dataset.href)));
  }

  // ====== STATUS PILL (added programmatically) ===============================
  function ensureStatusPill(){
    let pill = document.getElementById('statusPill');
    if (!pill) {
      const hdr = document.querySelector('.hdr');
      pill = document.createElement('span');
      pill.id = 'statusPill';
      pill.className = 'badge';
      pill.style.marginLeft = '8px';
      hdr && hdr.appendChild(pill);
    }
    return pill;
  }
  function setPill(text, ok){
    const pill = ensureStatusPill();
    pill.textContent = text;
    pill.style.borderColor = ok ? '#2a6' : 'rgba(255,255,255,.18)';
    pill.style.background = ok ? 'rgba(25,195,125,.18)' : 'rgba(255,255,255,.10)';
  }

  // ====== DATA LOADERS =======================================================
  async function loadReport(url){
    try{
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const txt = await res.text();
      const data = JSON.parse(txt.trim().replace(/^\uFEFF/, ''));
      renderReport(data);
      try{ localStorage.setItem('vc_last_report', JSON.stringify(data)); }catch{}
      setPill('Loaded ✓', true);
    }catch(err){
      console.error('Report load failed:', err);
      setPill('Load failed', false);
      document.querySelector('main').insertAdjacentHTML('afterbegin',
        `<div class="card" style="margin-bottom:10px"><div class="content" style="color:#ffd1d1">Failed to load report: ${String(err.message||err)}</div></div>`);
    }
  }
  function tryLocal() {
    try {
      const rawLocal = localStorage.getItem('vc_last_report') || sessionStorage.getItem('vc_report') || '';
      if (rawLocal) { renderReport(JSON.parse(rawLocal)); setPill('Loaded (cached) ✓', true); return true; }
    } catch(e) {}
    return false;
  }

  // NEW: Poll /api/analyze?key=... until ready
  async function fetchAnalyze(key){
    const r = await fetch(`/api/analyze?key=${encodeURIComponent(key)}`, { cache: 'no-store' });
    if (!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }
  let __pollTimer = null;
  async function bootFromKey(key){
    setPill('Checking…', false);
    const tick = async ()=>{
      try{
        const data = await fetchAnalyze(key);
        if (data.status === 'ready') {
          clearInterval(__pollTimer); __pollTimer = null;
          setPill('Ready ✓', true);
          if (data.report) {
            renderReport(data.report);
            try{ localStorage.setItem('vc_last_report', JSON.stringify(data.report)); }catch{}
          } else {
            // Fallback: if API returns {format:'html', key:...}, just link it
            document.querySelector('main').insertAdjacentHTML('afterbegin',
              `<div class="card"><div class="content">Your report is ready: <a class="btn primary" href="/${data.key}" target="_blank" rel="noopener">Open HTML Report</a></div></div>`);
          }
        } else {
          setPill('Processing…', false);
        }
      }catch(e){
        console.warn('Status check failed:', e);
        setPill('Checking…', false);
      }
    };
    await tick();
    if (!__pollTimer) __pollTimer = setInterval(tick, 7000);
  }

  // ====== BOOT SEQUENCE ======================================================
  (function boot(){
    document.getElementById('date').textContent = new Date().toLocaleDateString();

    if (keyParam) {         // Preferred: dynamic via /api/analyze
      bootFromKey(keyParam);
      return;
    }

    if (src === 'session' || src === 'local') {  // Fallback: from storage
      if (tryLocal()) return;
      if (fileSrc) return loadReport(fileSrc);
      alert('No saved report found. Go to Upload and try again.');
    } else if (fileSrc) {   // Static JSON path
      setPill('Loading…', false);
      loadReport(fileSrc);
    } else if (!tryLocal()) {
      alert('No report found.');
    }
  })();

  // ====== SHARE / SEND / DOWNLOAD (unchanged) ================================
  function shareUrl(){
    try{
      const u = new URL(location.href);
      u.searchParams.delete('src');
      if (keyParam) {
        u.searchParams.set('key', keyParam);
        u.searchParams.delete('report');
      } else {
        u.searchParams.set('report', reportParam || '/report.json');
      }
      return u.toString();
    }catch{ return location.href; }
  }
  let lastReport = null;
  document.getElementById('btnCopy').addEventListener('click', async ()=>{
    const link = shareUrl();
    try{ await navigator.clipboard.writeText(link); alert('Share link copied'); }
    catch{ prompt('Copy link:', link); }
  });
  document.getElementById('btnSend').addEventListener('click', ()=>{
    const email = prompt('Coach email (e.g. coach@example.com):'); if(!email) return;
    const p = (last && last.power) ? `Power ${last.power.score||'-'}%  Tempo ${last.power.tempo||'-'}  Release ${last.power.release_timing||'-'}%` : '';
    const subject = encodeURIComponent('Virtual Coach AI Swing Report');
    const body = encodeURIComponent(`Here is my swing report:\n${shareUrl()}\n\n${p}\n\n— sent from virtualcoachai.net`);
    location.href = `mailto:${email}?subject=${subject}&body=${body}`;
  });
  document.getElementById('btnDownload').addEventListener('click', ()=>{
    const html = document.documentElement.outerHTML;
    const blob = new Blob([html], {type:'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'swing-report.html';
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  });

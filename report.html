<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Virtual Coach AI — Swing Report</title>
<link rel="preload" as="image" href="/homepage-background.png" />
<style>
  :root{ --nav:#0b2b12; --brand:#0b2b12; --scrim: rgba(0,0,0,.06); --panel: rgba(10,18,24,.24); --line: rgba(255,255,255,.08); --text:#ecf3f7; --muted:#cfe0e6; --radius:16px; --shadow:0 8px 24px rgba(0,0,0,.20);}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;color:var(--text);background:url('/homepage-background.png') center/cover fixed no-repeat;font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial}
  .scrim{min-height:100vh;background:var(--scrim)}

  /* NAV (hamburger) */
  header.top{position:sticky;top:0;z-index:100;background:var(--nav);border-bottom:1px solid rgba(255,255,255,.1)}
  .navwrap{width:min(1080px,92%);margin:0 auto;padding:10px 0;display:flex;gap:12px;align-items:center;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:10px;color:#fff;text-decoration:none;font-weight:800}
  .brand-logo{width:160px;height:36px;background:var(--brand);
    -webkit-mask:url('/virtualcoach-logo-transparent.png') center/contain no-repeat;
            mask:url('/virtualcoach-logo-transparent.png') center/contain no-repeat;}
  .menu-toggle{display:none;align-items:center;gap:8px;color:#fff;background:transparent;border:1px solid rgba(255,255,255,.3);border-radius:10px;padding:6px 10px;cursor:pointer}
  nav.nav{display:flex;gap:8px}
  nav.nav a{color:#fff;text-decoration:none;padding:8px 10px;border-radius:10px;border:1px solid transparent;white-space:nowrap}
  nav.nav a:hover{background:rgba(255,255,255,.08)}
  nav.nav a[aria-current="page"]{border-color:rgba(255,255,255,.18);background:rgba(255,255,255,.10)}
  @media(max-width:820px){
    .menu-toggle{display:inline-flex}
    nav.nav{position:absolute;right:0;top:100%;background:var(--nav);border-bottom:1px solid rgba(255,255,255,.1);display:none;flex-direction:column;padding:8px}
    header.top.open nav.nav{display:flex}
  }

  .wrap{width:min(1080px,92%);margin:0 auto;padding:18px 0 42px}
  .title{font-size:26px;font-weight:800}
  .sub{color:var(--muted);font-size:13px}
  .badge{background:rgba(255,255,255,.06);border:1px solid var(--line);color:#dff3ff;padding:6px 10px;border-radius:999px;font-size:12px}
  .card,details.panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(1.5px)}
  .card h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--line)}
  .card .content{padding:12px 16px}
  .hdr{display:flex;align-items:center;justify-content:space-between;gap:10px;position:relative}
  .actions{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
  .btn{border:1px solid var(--line);background:rgba(255,255,255,.10);color:#fff;padding:8px 12px;border-radius:10px;text-decoration:none;display:inline-flex;gap:8px;align-items:center;cursor:pointer}
  .btn:hover{background:rgba(255,255,255,.16)}
  .btn.primary{background:rgba(25,195,125,.18);border-color:#2a6;}
  .btn.warn{background:rgba(246,196,83,.18);border-color:#b8860b;}
  .btn.ghost{background:rgba(255,255,255,.06);}
  summary{list-style:none;display:flex;gap:10px;align-items:center;padding:14px 16px;cursor:pointer}
  summary::-webkit-details-marker{display:none}
  .pnum{width:34px;height:34px;border-radius:10px;background:#0c1820;border:1px solid var(--line);display:grid;place-items:center;font-weight:800}
  .pname{font-weight:700}
  .caret{margin-left:auto;transition:transform .2s}
  details[open] .caret{transform:rotate(180deg)}
  .gchip{font-size:12px;font-weight:800;padding:4px 8px;border-radius:999px;margin-left:8px}
  .g-good{background:#19c37d;color:#fff}
  .g-ok{background:#f6c453;color:#2a2300}
  .g-bad{background:#ff6b6b;color:#fff}
  .metric{display:flex;align-items:center;gap:10px;margin:9px 0}
  .metric .name{flex:0 0 210px;color:#d8ebf2}
  .bar{flex:1;height:10px;border-radius:999px;background:#10222c;border:1px solid #22404f;position:relative;overflow:hidden}
  .bar>span{position:absolute;left:0;top:0;bottom:0;border-radius:999px}
  .ok{background:linear-gradient(90deg,#19c37d,#2bd897)}
  .warn{background:linear-gradient(90deg,#f6c453,#ffd479)}
  .bad{background:linear-gradient(90deg,#ff6b6b,#ff8f8f)}
  .pct{width:52px;text-align:right;color:#cfe3ee}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media(max-width:960px){.grid2{grid-template-columns:1fr}}
  .info{border:1px solid var(--line);background:rgba(255,255,255,.10);color:#fff;padding:6px 10px;border-radius:10px;cursor:pointer}
  .info:hover{background:rgba(255,255,255,.16)}

  /* Modal viewer */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
  .modal.open{display:flex}
  .modal .box{width:min(960px,95vw);background:#0b1520;border:1px solid #123;border-radius:12px;box-shadow:0 10px 28px rgba(0,0,0,.4)}
  .modal header.mh{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #123}
  .modal header.mh h4{margin:0;font-size:16px}
  .modal .content{padding:10px 12px}
  .modal iframe, .modal video{width:100%;height:min(72vh,56vw);background:#000;border-radius:8px}
  .closebtn{background:transparent;color:#fff;border:1px solid #345;padding:6px 10px;border-radius:8px;cursor:pointer}

  /* === inline help popovers === */
  .qbtn{
    display:inline-flex; align-items:center; justify-content:center;
    width:22px; height:22px; margin-left:8px; border-radius:50%;
    border:1px solid var(--line); background:rgba(255,255,255,.10);
    color:#fff; font-weight:800; cursor:pointer; line-height:1;
  }
  .qbtn:hover{ background:rgba(255,255,255,.16); }
  .pop{
    position:absolute; top:calc(100% + 8px); right:0; z-index:20;
    max-width:min(520px, 92vw); padding:12px 14px; border-radius:12px;
    background:rgba(12,24,32,.96); border:1px solid var(--line);
    box-shadow:0 10px 28px rgba(0,0,0,.35); color:var(--text); display:none;
  }
  .pop.show{ display:block; }
  .pop::after{ content:""; position:absolute; top:-8px; right:12px;
    border-width:8px; border-style:solid;
    border-color:transparent transparent rgba(12,24,32,.96) transparent;
  }
  .pop h4{ margin:0 0 6px; font-size:14px; }
  .pop p{ margin:6px 0; font-size:13px; color:var(--muted); }
  .pop ul{ margin:6px 0 0 18px; padding:0; }
  .pop li{ margin:4px 0; font-size:13px; color:var(--muted); }

  /* === inline glossary tooltips (auto-added in text) === */
  .hint{ position:relative; cursor:help; border-bottom:1px dotted rgba(255,255,255,.55); }
  .hint:focus-visible{ outline:2px dashed rgba(255,255,255,.35); outline-offset:2px; }
  .hint[data-tip]::after{
    content:attr(data-tip);
    position:absolute; left:0; bottom:calc(100% + 6px);
    display:none; z-index:30;
    background:rgba(12,24,32,.96); color:var(--text);
    border:1px solid var(--line); border-radius:8px;
    padding:8px 10px; box-shadow:0 10px 28px rgba(0,0,0,.35);
    width:min(360px, 92vw); white-space:normal;
  }
  .hint:hover::after, .hint:focus-visible::after{ display:block; }
</style>
</head>
<body>
  <header class="top" id="site-header">
    <div class="navwrap">
      <a class="brand" href="/"><div class="brand-logo"></div><span>Virtual Coach AI</span></a>
      <button class="menu-toggle" id="menuBtn" aria-expanded="false">Menu ▾</button>
      <nav class="nav" id="siteNav" aria-label="Primary">
        <a href="/index.html">Home</a>
        <a href="/upload.html">Upload</a>
        <a href="/report.html?report=/report.json" aria-current="page">Reports</a>
        <a href="/coming-soon.html">Coming&nbsp;Soon</a>
        <a href="/pricing.html">Pricing</a>
        <a href="/faq.html">FAQ</a>
        <a href="/contact.html">Contact</a>
        <a href="/login.html">Login</a>
      </nav>
    </div>
  </header>

  <div class="scrim">
    <main class="wrap">
      <header class="hdr" style="margin-bottom:10px">
        <div>
          <div class="title">Swing Report — P1–P9</div>
          <div class="sub">Date: <span id="date"></span> • Mode: <span id="modeLabel">Full Swing</span></div>
        </div>
        <div><span class="badge">Swings: <span id="swingCount">1</span></span></div>
      </header>

      <div class="actions">
        <button id="btnDownload" class="btn primary">Download</button>
        <button id="btnSend" class="btn warn">Send to Coach</button>
        <button id="btnCopy" class="btn ghost">Copy Share Link</button>
      </div>

      <section class="card" id="phasesCard" style="margin-top:6px">
        <h3 class="hdr">
          <span>P1–P9</span>
          <details style="display:inline-block"><summary class="info">Info</summary>
            <div class="content">Nine checkpoints from setup to finish. Click “Video” to view inside this page.</div>
          </details>
        </h3>
        <div id="plist" class="content"></div>
      </section>

      <section class="grid2" style="margin-top:12px">
        <div class="card">
          <h3 class="hdr">
            <span>Position Consistency</span>
            <button class="qbtn" data-pop="position-consistency" aria-label="What is Position Consistency?">?</button>
            <div class="pop" id="pop-position-consistency">
              <h4>Position Consistency</h4>
              <p>How reliably each swing matches the target window at the nine P-positions (P1–P9).</p>
              <ul>
                <li><strong>Source:</strong> pose landmarks vs. reference “windows.”</li>
                <li><strong>Weighting:</strong> P2, P4, P6, P7 count the most (setup, top, shaft-parallel down, impact).</li>
                <li><strong>Score:</strong> 0–100. 100 = you’re in-window nearly every swing.</li>
              </ul>
            </div>
          </h3>
          <div id="position" class="content"></div>
        </div>
        <div class="card">
          <h3 class="hdr">
            <span>Swing Consistency</span>
            <button class="qbtn" data-pop="swing-consistency" aria-label="What is Swing Consistency?">?</button>
            <div class="pop" id="pop-swing-consistency">
              <h4>Swing Consistency</h4>
              <p>How repeatable your swings are across the session.</p>
              <ul>
                <li><strong>Tempo ratio</strong> stability (backswing : downswing, e.g., ≈3:1).</li>
                <li><strong>Club path & face</strong> variance (lower spread is better).</li>
                <li><strong>Release timing</strong> variance (how consistently you time speed).</li>
                <li><strong>Score:</strong> 0–100. 100 = extremely repeatable.</li>
              </ul>
            </div>
          </h3>
          <div id="swing" class="content"></div>
        </div>
      </section>

      <section class="card" style="margin-top:12px">
        <h3 class="hdr">
          <span>Power Score Summary</span>
          <button class="qbtn" data-pop="power-summary" aria-label="What is Power Score?">?</button>
          <div class="pop" id="pop-power-summary">
            <h4>Power Score</h4>
            <p>Composite of speed proxies and sequencing (scaled 0–100).</p>
            <ul>
              <li><strong>Kinematic sequence:</strong> pelvis → thorax → arm → club.</li>
              <li><strong>Speed curve:</strong> build → peak near P7 (impact) without dumping early.</li>
              <li><strong>Release timing:</strong> later (but controlled) is typically better.</li>
              <li><strong>Note:</strong> Single-camera estimates; best accuracy with good filming.</li>
            </ul>
          </div>
        </h3>
        <div id="power" class="content"></div>
      </section>

      <!-- Key Terms mini card -->
      <section class="card" style="margin-top:12px">
        <h3 class="hdr">
          <span>Definitions & Key Terms</span>
          <button class="qbtn" data-pop="terms" aria-label="Key Terms">?</button>
          <div class="pop" id="pop-terms">
            <h4>Key Terms</h4>
            <ul>
              <li><strong>P2 (Takeaway – shaft parallel):</strong> club roughly parallel to target line, about hip-high.</li>
              <li><strong>P6 (Downswing – shaft parallel):</strong> club roughly parallel again, about thigh-high on the way down.</li>
              <li><strong>P7 (Impact):</strong> strike; reference for face, path, & lead-wrist conditions.</li>
              <li><strong>Hip / Shoulder Rotation:</strong> angle vs. target line (°); <em>X-Factor</em> = shoulders − hips.</li>
              <li><strong>Tempo Ratio:</strong> backswing time : downswing time (tour ≈ 3:1).</li>
              <li><strong>Release Timing:</strong> when club speed peaks relative to P7.</li>
            </ul>
            <p style="margin-top:8px"><em>Best results:</em> film from ~8–12 ft, down-the-line or face-on, landscape, whole body & club in frame.</p>
          </div>
        </h3>
        <div class="content sub">Tap the “?” to see definitions anytime.</div>
      </section>
    </main>
  </div>

  <!-- Modal viewer -->
  <div id="viewer" class="modal" role="dialog" aria-modal="true" aria-label="Video">
    <div class="box">
      <header class="mh"><h4>Video</h4><button class="closebtn" id="viewerClose">Close</button></header>
      <div class="content" id="viewerBody"></div>
    </div>
  </div>

<script>
  // ====== NAV (hamburger) ====================================================
  const header = document.getElementById('site-header');
  const btn = document.getElementById('menuBtn');
  btn.addEventListener('click', ()=>{
    const open = header.classList.toggle('open');
    btn.setAttribute('aria-expanded', open ? 'true' : 'false');
  });
  document.getElementById('siteNav').addEventListener('click', e=>{
    if(e.target.tagName==='A'){ header.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
  });

  // ====== UTILITIES & QUERY PARAMS ===========================================
  const $ = s => document.querySelector(s);
  const qp = new URLSearchParams(location.search);
  const src = (qp.get('src') || '').toLowerCase();
  const reportParam = qp.get('report');
  const keyParam = qp.get('key'); // NEW: uploads/<ts>-file.ext
  const fileSrc = (reportParam === 'local') ? null : (reportParam || '/report.json');

  // ====== RENDER HELPERS (unchanged) =========================================
  const fmt  = v => `${v}%`;
  const band = v => v>=75 ? 'ok' : v>=55 ? 'warn' : 'bad';
  const chip = g => (g==='good'?'g-good':g==='ok'?'g-ok':'g-bad');
  const metricRow = m => `<div class="metric"><div class="name">${m.label||m.p}</div><div class="bar"><span class="${band(m.value)}" style="width:${m.value}%"></span></div><div class="pct">${fmt(m.value)}</div></div>`;

  function toYouTubeEmbed(url){
    try{
      const u = new URL(url);
      if (u.hostname.includes('youtube.com')) {
        if (u.pathname === '/watch' && u.searchParams.get('v')) return `https://www.youtube.com/embed/${u.searchParams.get('v')}`;
        if (u.pathname.startsWith('/embed/')) return url;
      }
      if (u.hostname === 'youtu.be') return `https://www.youtube.com/embed/${u.pathname.slice(1)}`;
    }catch{}
    return null;
  }
  function openViewer(href){
    const viewer = $('#viewer');
    const body = $('#viewerBody');
    body.innerHTML = '';
    const yt = toYouTubeEmbed(href);
    if (yt){
      body.innerHTML = `<iframe src="${yt}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
    } else if (/^https?:/.test(href)){
      body.innerHTML = `<video controls playsinline src="${href}"></video>`;
    } else {
      window.open(href, '_blank', 'noopener'); return;
    }
    viewer.classList.add('open');
  }
  $('#viewerClose').addEventListener('click', ()=>$('#viewer').classList.remove('open'));
  $('#viewer').addEventListener('click', (e)=>{ if(e.target.id==='viewer') $('#viewer').classList.remove('open'); });

  function phaseRow(ph,i){
    const id = ph.id || ('P'+(i+1));
    const name = ph.name || '';
    const gRaw = String(ph.grade||'').toLowerCase();
    const grade = (gRaw==='bad') ? 'needs help' : (gRaw || 'ok');
    const short = ph.short || '';
    const long  = ph.long  || '';
    const ref   = ph.ref || ph.video || ph.video_url || '';
    const btnLabel = /youtu(\.be|be\.com)/.test(ref) ? 'YouTube' : 'Video';
    return `
    <details class="panel" ${i===0?'open':''}>
      <summary>
        <span class="pnum">${id}</span>
        <span class="pname">${name}</span>
        <span class="gchip ${chip(gRaw)}">${grade.toUpperCase()}</span>
        <span class="sub" style="margin-left:8px">${short}</span>
        <svg class="caret" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
      </summary>
      <div class="content">
        <div class="sub" style="margin-bottom:8px">${short}</div>
        <div style="margin-bottom:10px">${long}</div>
        ${ref?`<button class="btn videoBtn" data-href="${ref}">${btnLabel}</button>`:''}
      </div>
    </details>`;
  }
  function coachItem(item){
    const title = item.title || '';
    const short = item.short || '';
    const long  = item.long  || '';
    const ref   = item.ref || '';
    const btnLabel = /youtu(\.be|be\.com)/.test(ref) ? 'YouTube' : 'Video';
    return `<details class="panel">
      <summary><span class="pname">${title}</span><span class="sub" style="margin-left:8px">${short}</span>
        <svg class="caret" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
      </summary>
      <div class="content">
        <div style="margin-bottom:10px">${long}</div>
        ${ref?`<button class="btn videoBtn" data-href="${ref}">${btnLabel}</button>`:''}
      </div>
    </details>`;
  }

  let last = null;
  function renderReport(data){
    last = data || {};
    document.getElementById('date').textContent = new Date().toLocaleDateString();
    if(data.discipline){
      document.getElementById('modeLabel').textContent =
        /putt/i.test(data.discipline) ? 'Putting' :
        /chip/i.test(data.discipline) ? 'Chipping' : 'Full Swing';
    }
    if(data.swings!=null){ document.getElementById('swingCount').textContent = String(data.swings); }

    const phases = Array.isArray(data.phases)? data.phases : [];
    document.getElementById('plist').innerHTML = phases.map(phaseRow).join('') || '<div class="content sub">No phases found in report.</div>';

    const pri = (data.coaching && Array.isArray(data.coaching.priority_fixes)) ? data.coaching.priority_fixes : [];
    const pow = (data.coaching && Array.isArray(data.coaching.power_fixes)) ? data.coaching.power_fixes : [];
    document.getElementById('coachPriority').innerHTML = pri.map(coachItem).join('') || '<div class="sub">No priority fixes in report.</div>';
    document.getElementById('coachPower').innerHTML    = pow.map(coachItem).join('')    || '<div class="sub">No power fixes in report.</div>';

    document.getElementById('position').innerHTML = (data.position_metrics||[]).map(metricRow).join('') || '<div class="sub">No position metrics.</div>';
    document.getElementById('swing').innerHTML    = (data.swing_metrics||[]).map(metricRow).join('')    || '<div class="sub">No swing metrics.</div>';

    const p = data.power||{score:0, tempo:'—', release_timing:0};
    document.getElementById('power').innerHTML = `
      <div class="metric"><div class="name">Power Score</div><div class="bar"><span class="${band(+p.score||0)}" style="width:${+p.score||0}%"></span></div><div class="pct">${+p.score||0}%</div></div>
      <div class="metric"><div class="name">Tempo</div><div class="bar"><span class="ok" style="width:76%"></span></div><div class="pct">${p.tempo||'—'}</div></div>
      <div class="metric"><div class="name">Release Timing</div><div class="bar"><span class="${band(+p.release_timing||0)}" style="width:${+p.release_timing||0}%"></span></div><div class="pct">${+p.release_timing||0}%</div></div>`;

    document.querySelectorAll('.videoBtn').forEach(b=> b.addEventListener('click', ()=> openViewer(b.dataset.href)));

    // Sprinkle inline glossary tooltips after content is rendered
    __annotateAll();
  }

  // ====== STATUS PILL (added programmatically) ===============================
  function ensureStatusPill(){
    let pill = document.getElementById('statusPill');
    if (!pill) {
      const hdr = document.querySelector('.hdr');
      pill = document.createElement('span');
      pill.id = 'statusPill';
      pill.className = 'badge';
      pill.style.marginLeft = '8px';
      hdr && hdr.appendChild(pill);
    }
    return pill;
  }
  function setPill(text, ok){
    const pill = ensureStatusPill();
    pill.textContent = text;
    pill.style.borderColor = ok ? '#2a6' : 'rgba(255,255,255,.18)';
    pill.style.background = ok ? 'rgba(25,195,125,.18)' : 'rgba(255,255,255,.10)';
  }

  // ====== DATA LOADERS =======================================================
  async function loadReport(url){
    try{
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const txt = await res.text();
      const data = JSON.parse(txt.trim().replace(/^\uFEFF/, ''));
      renderReport(data);
      try{ localStorage.setItem('vc_last_report', JSON.stringify(data)); }catch{}
      setPill('Loaded ✓', true);
    }catch(err){
      console.error('Report load failed:', err);
      setPill('Load failed', false);
      document.querySelector('main').insertAdjacentHTML('afterbegin',
        `<div class="card" style="margin-bottom:10px"><div class="content" style="color:#ffd1d1">Failed to load report: ${String(err.message||err)}</div></div>`);
    }
  }
  function tryLocal() {
    try {
      const rawLocal = localStorage.getItem('vc_last_report') || sessionStorage.getItem('vc_report') || '';
      if (rawLocal) { renderReport(JSON.parse(rawLocal)); setPill('Loaded (cached) ✓', true); return true; }
    } catch(e) {}
    return false;
  }

  // NEW: Poll /api/analyze?key=... until ready
  async function fetchAnalyze(key){
    const r = await fetch(`/api/analyze?key=${encodeURIComponent(key)}`, { cache: 'no-store' });
    if (!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }
  let __pollTimer = null;
  async function bootFromKey(key){
    setPill('Checking…', false);
    const tick = async ()=>{
      try{
        const data = await fetchAnalyze(key);
        if (data.status === 'ready') {
          clearInterval(__pollTimer); __pollTimer = null;
          setPill('Ready ✓', true);
          if (data.report) {
            renderReport(data.report);
            try{ localStorage.setItem('vc_last_report', JSON.stringify(data.report)); }catch{}
          } else {
            // Fallback: if API returns {format:'html', key:...}, just link it
            document.querySelector('main').insertAdjacentHTML('afterbegin',
              `<div class="card"><div class="content">Your report is ready: <a class="btn primary" href="/${data.key}" target="_blank" rel="noopener">Open HTML Report</a></div></div>`);
          }
        } else {
          setPill('Processing…', false);
        }
      }catch(e){
        console.warn('Status check failed:', e);
        setPill('Checking…', false);
      }
    };
    await tick();
    if (!__pollTimer) __pollTimer = setInterval(tick, 7000);
  }

  // ====== BOOT SEQUENCE ======================================================
  (function boot(){
    document.getElementById('date').textContent = new Date().toLocaleDateString();

    if (keyParam) {         // Preferred: dynamic via /api/analyze
      bootFromKey(keyParam);
      return;
    }

    if (src === 'session' || src === 'local') {  // Fallback: from storage
      if (tryLocal()) return;
      if (fileSrc) return loadReport(fileSrc);
      alert('No saved report found. Go to Upload and try again.');
    } else if (fileSrc) {   // Static JSON path
      setPill('Loading…', false);
      loadReport(fileSrc);
    } else if (!tryLocal()) {
      alert('No report found.');
    }
  })();

  // ====== SHARE / SEND / DOWNLOAD (unchanged) ================================
  function shareUrl(){
    try{
      const u = new URL(location.href);
      u.searchParams.delete('src');
      if (keyParam) {
        u.searchParams.set('key', keyParam);
        u.searchParams.delete('report');
      } else {
        u.searchParams.set('report', reportParam || '/report.json');
      }
      return u.toString();
    }catch{ return location.href; }
  }
  document.getElementById('btnCopy').addEventListener('click', async ()=>{
    const link = shareUrl();
    try{ await navigator.clipboard.writeText(link); alert('Share link copied'); }
    catch{ prompt('Copy link:', link); }
  });
  document.getElementById('btnSend').addEventListener('click', ()=>{
    const email = prompt('Coach email (e.g. coach@example.com):'); if(!email) return;
    const p = (last && last.power) ? `Power ${last.power.score||'-'}%  Tempo ${last.power.tempo||'-'}  Release ${last.power.release_timing||'-'}%` : '';
    const subject = encodeURIComponent('Virtual Coach AI Swing Report');
    const body = encodeURIComponent(`Here is my swing report:\n${shareUrl()}\n\n${p}\n\n— sent from virtualcoachai.net`);
    location.href = `mailto:${email}?subject=${subject}&body=${body}`;
  });
  document.getElementById('btnDownload').addEventListener('click', ()=>{
    const html = document.documentElement.outerHTML;
    const blob = new Blob([html], {type:'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'swing-report.html';
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  });

  // === Inline glossary auto-tooltips ========================================
  const __TERMS = [
    { re: /\bP1\b/, tip: 'Address / setup.' },
    { re: /\bP2\b/, tip: 'Takeaway — shaft roughly parallel to target line (club hip-high).' },
    { re: /\bP3\b/, tip: 'Lead arm parallel to the ground.' },
    { re: /\bP4\b/, tip: 'Top of backswing.' },
    { re: /\bP5\b/, tip: 'Early downswing.' },
    { re: /\bP6\b/, tip: 'Downswing — shaft roughly parallel again (club thigh-high).' },
    { re: /\bP7\b/, tip: 'Impact (ball strike).' },
    { re: /\bP8\b/, tip: 'Early follow-through.' },
    { re: /\bP9\b/, tip: 'Finish — shaft roughly parallel on exit.' },
    { re: /X[\s-]?Factor/iu, tip: 'Shoulder rotation minus hip rotation (°).' },
    { re: /\btempo(?:\s*ratio)?\b/i, tip: 'Backswing : downswing time (tour ≈ 3:1).' },
    { re: /release timing/i, tip: 'When club speed peaks relative to impact (P7).' },
    { re: /kinematic sequence/i, tip: 'Energy transfer pelvis → thorax → arm → club.' },
    { re: /hip(?:s)? rotation|pelvis rotation/i, tip: 'Pelvis angle vs. target line (°).' },
    { re: /shoulder rotation|thorax rotation/i, tip: 'Thorax angle vs. target line (°).' },
    { re: /shaft parallel/i, tip: 'Club roughly parallel to the target line.' },
    { re: /down-?the-?line/i, tip: 'Camera along target line, ~8–12 ft behind the player.' },
    { re: /face-?on/i, tip: 'Camera perpendicular to target line, ~8–12 ft in front of player.' }
  ];

  function __wrapOnce(node, re, tip){
    re = new RegExp(re.source, re.flags.replace('g','')); // first match only
    const m = re.exec(node.nodeValue);
    if (!m) return false;
    const before = node.nodeValue.slice(0, m.index);
    const match  = node.nodeValue.slice(m.index, m.index + m[0].length);
    const after  = node.nodeValue.slice(m.index + m[0].length);
    const span = document.createElement('span');
    span.className = 'hint'; span.setAttribute('data-tip', tip); span.textContent = match;
    const parent = node.parentNode;
    if (before) parent.insertBefore(document.createTextNode(before), node);
    parent.insertBefore(span, node);
    if (after) parent.insertBefore(document.createTextNode(after), node);
    parent.removeChild(node);
    return true;
  }

  function __annotateRoot(root){
    if (!root) return;
    const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT);
    const nodes = [];
    let n; while(n = walker.nextNode()) nodes.push(n);
    nodes.forEach(node=>{
      if (!node.nodeValue || !node.nodeValue.trim()) return;
      const pe = node.parentElement;
      if (!pe || pe.closest('script,style,code,pre,.hint,.qbtn,.pop,button,a,svg')) return;
      for (const t of __TERMS){
        if (t.re.test(node.nodeValue)) { __wrapOnce(node, t.re, t.tip); break; }
      }
    });
  }

  function __annotateAll(){
    ['#plist', '#coachPriority', '#coachPower', '#position', '#swing', '#power'].forEach(sel=>{
      __annotateRoot(document.querySelector(sel));
    });
  }

  // === popover logic (for the little “?” clouds) =============================
  (function helpPopovers(){
    let openPop = null;

    function togglePop(btn){
      const id = 'pop-' + btn.dataset.pop;
      const pop = document.getElementById(id);
      if (!pop) return;
      if (openPop && openPop !== pop) { openPop.classList.remove('show'); openPop = null; }
      pop.classList.toggle('show');
      openPop = pop.classList.contains('show') ? pop : null;

      // basic right-edge nudge
      if (openPop) {
        const rect = pop.getBoundingClientRect();
        if (rect.right > window.innerWidth - 8) {
          pop.style.right = `${Math.max(0, rect.right - window.innerWidth + 16)}px`;
        }
      }
    }

    document.querySelectorAll('.qbtn').forEach(btn=>{
      btn.addEventListener('click', (e)=>{ e.stopPropagation(); togglePop(btn); });
    });

    document.addEventListener('click', ()=>{ if(openPop){ openPop.classList.remove('show'); openPop=null; }});
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && openPop){ openPop.classList.remove('show'); openPop=null; }});
  })();
</script>
</body>
</html>

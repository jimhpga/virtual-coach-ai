<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Virtual Coach AI - Swing Report</title>
  <style>
    :root{
      --panel:#ffffff;
      --muted:#345a72;
      --ink:#0c1f2b;
      --txt:#0f2330;
      --accent:#5eb3ff;
      --ok:#19c37d; --warn:#f6c453; --bad:#ff6b6b;
      --radius:16px; --shadow:0 8px 24px rgba(0,0,0,.25);
      --border:#d3e3ee;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;color:var(--txt);font:16px/1.45 system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;background:#e9f4fb}

    /* Bright golf-course background with gradient always on top.
       Fallback order: homepage-background.png -> golf-course-bg.jpg -> virtualcoach-bg.png */
    .bg{
      position:fixed; inset:0; z-index:-1;
      background:
        linear-gradient(0deg, rgba(255,255,255,.58), rgba(255,255,255,.58)),
        url('/homepage-background.png') center/cover no-repeat fixed,
        url('/golf-course-bg.jpg') center/cover no-repeat fixed,
        url('/virtualcoach-bg.png') center/cover no-repeat fixed;
      background-color:#e9f4fb;
    }

    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{font-size:26px;font-weight:800;letter-spacing:.2px;color:var(--ink)}
    .sub{color:var(--muted);font-size:13px}

    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn,.select{background:#ffffffd9;border:1px solid var(--border);border-radius:12px;color:var(--ink);padding:8px 12px;box-shadow:var(--shadow);cursor:pointer}
    .select{appearance:none;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#083048" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>');background-repeat:no-repeat;background-position:right 10px center;padding-right:36px}
    .badge{background:#fff;border:1px solid var(--border);color:var(--ink);padding:6px 10px;border-radius:999px;font-size:12px}

    .card,details.panel{background:#ffffffe6;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card h3{margin:0;padding:14px 16px;border-bottom:1px solid #e0edf5;color:var(--ink)}
    .card .content{padding:12px 16px}
    summary{list-style:none;display:flex;gap:10px;align-items:center;padding:14px 16px;cursor:pointer}
    summary::-webkit-details-marker{display:none}
    .pnum{width:34px;height:34px;border-radius:10px;background:#eef6fb;border:1px solid var(--border);display:grid;place-items:center;font-weight:800;color:var(--ink)}
    .pname{font-weight:700;color:var(--ink)}
    .caret{margin-left:auto;transition:transform .2s ease}
    details[open] .caret{transform:rotate(180deg)}
    .gchip{font-size:12px;font-weight:700;padding:3px 8px;border-radius:8px;border:1px solid var(--border);background:#fff}
    .g-good{color:#0a8c5b}.g-ok{color:#a97800}.g-bad{color:#c73838}

    .metric{display:flex;align-items:center;gap:10px;margin:9px 0}
    .metric .name{flex:0 0 230px;color:#10344a}
    .bar{flex:1;height:10px;border-radius:999px;background:#e8f2f9;border:1px solid var(--border);position:relative;overflow:hidden}
    .bar>span{position:absolute;left:0;top:0;bottom:0;border-radius:999px}
    .ok{background:linear-gradient(90deg,#19c37d,#2bd897)}
    .warn{background:linear-gradient(90deg,#f6c453,#ffd479)}
    .bad{background:linear-gradient(90deg,#ff6b6b,#ff8f8f)}
    .pct{width:52px;text-align:right;color:#0c2433}

    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}

    .busy{position:fixed;top:12px;right:12px;background:#ffffff;border:1px solid var(--border);border-radius:999px;padding:8px 12px;display:flex;gap:8px;align-items:center;box-shadow:var(--shadow);z-index:10000}
    .busy[hidden]{display:none!important}
    .spinner{width:18px;height:18px;border:3px solid #e0edf5;border-top-color:#5eb3ff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body data-report-src="/report.json">
  <div class="bg" aria-hidden="true"></div>

  <div id="busy" class="busy" hidden><span class="spinner" aria-hidden="true"></span><span id="busyText">Processing...</span></div>

  <div class="wrap">
    <header>
      <div>
        <div class="title">Swing Report - P1-P9</div>
        <div class="sub">Date: <span id="date"></span> â€¢ Mode: <span id="modeLabel">Full Swing</span></div>
      </div>
      <div class="toolbar">
        <label class="badge">Swings: <span id="swingCount">1</span></label>
        <select id="discipline" class="select" title="Shot type">
          <option value="full-swing" selected>Full Swing</option>
          <option value="chipping">Chipping</option>
          <option value="putting">Putting</option>
        </select>
        <select id="focus" class="select" title="Focus filter">
          <option value="all" selected>Focus: All</option>
          <optgroup label="Upper Body">
            <option value="right-wrist">Right Wrist</option>
            <option value="left-wrist">Left Wrist</option>
            <option value="arm-bend">Arm Bend</option>
            <option value="hand-path">Hand Path</option>
            <option value="shoulder-turn">Shoulder Turn</option>
          </optgroup>
          <optgroup label="Lower Body">
            <option value="hip-movement">Hip Movement</option>
            <option value="knee-movement">Knee Movement</option>
            <option value="foot-movement">Foot / Pressure</option>
            <option value="lead-leg-brake">Lead Leg Braking</option>
          </optgroup>
          <optgroup label="Club">
            <option value="club-path">Club Path</option>
            <option value="face-angle">Club Face Angle</option>
            <option value="tempo">Timing & Tempo</option>
          </optgroup>
        </select>
        <button id="expandAll" class="btn" type="button">Expand All</button>
        <button id="collapseAll" class="btn" type="button">Collapse All</button>
        <button id="reload" class="btn" type="button">Reload Report</button>
        <button id="sample" class="btn" type="button">Load Sample</button>
      </div>
    </header>

    <!-- P1-P9 FIRST -->
    <section id="plistWrap">
      <div class="sub">Click a P-section to expand. Use the Focus filter to dim everything except what you care about.</div>
      <div id="plist"></div>
    </section>

    <!-- Coaching Card -->
    <section class="card" style="margin-top:12px">
      <h3>Coaching Card</h3>
      <div class="content">
        <details class="panel" open>
          <summary><span class="pname">Top 3 Priority Fixes</span><svg class="caret" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></summary>
          <div id="coachPriority"></div>
        </details>
        <details class="panel" style="margin-top:10px">
          <summary><span class="pname">Top 3 Power Fixes</span><svg class="caret" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></summary>
          <div id="coachPower"></div>
        </details>
      </div>
    </section>

    <!-- 14-Day Practice Plan -->
    <section class="card" style="margin-top:12px">
      <h3>14-Day Practice Plan</h3>
      <div id="practice" class="content"></div>
    </section>

    <!-- Charts last -->
    <section class="grid" style="margin-top:12px">
      <div class="card">
        <h3>Position Consistency</h3>
        <div id="position" class="content"></div>
      </div>
      <div class="card">
        <h3>Swing Consistency</h3>
        <div id="swing" class="content"></div>
      </div>
    </section>

    <section class="card" style="margin-top:12px">
      <h3>Power Score Summary</h3>
      <div id="power" class="content"></div>
    </section>

    <div id="status" class="sub" style="margin-top:8px"></div>
    <div id="error" class="sub" style="color:#b42323"></div>
    <details id="debug" class="sub" style="margin-top:6px">
      <summary>Debug</summary>
      <pre id="debugOut" style="white-space:pre-wrap;background:#f3f9fd;border:1px solid var(--border);padding:8px;border-radius:8px;max-height:260px;overflow:auto"></pre>
    </details>
  </div>

  <script>
  // Tiny helpers
  const $ = s => document.querySelector(s), $$ = s => document.querySelectorAll(s);
  document.getElementById('date').textContent = new Date().toLocaleDateString();

  // Keep gradient + pick the first background image that loads
  (function(){
    try{
      const bg = document.querySelector('.bg');
      const picks = ['/homepage-background.png','/golf-course-bg.jpg','/virtualcoach-bg.png'];
      function tryOne(i){
        if(!bg || i >= picks.length) return;
        const raw = picks[i];
        const img = new Image();
        img.onload = () => {
          bg.style.backgroundImage =
            'linear-gradient(0deg, rgba(255,255,255,.58), rgba(255,255,255,.58)),' +
            'url(\"' + raw + '\")';
        };
        img.onerror = () => tryOne(i+1);
        img.src = raw + '?v=' + Date.now();
      }
      const cur = getComputedStyle(bg).backgroundImage;
      if(!cur || cur === 'none') tryOne(0);
    }catch(_){}
  })();

  // Renderer helpers
  const fmt = v => (v|0) + '%';
  const band = v => v>=75 ? 'ok' : v>=55 ? 'warn' : 'bad';
  const metricRow = m => '<div class=\"metric\" data-tags=\"'+(m.tags||[]).join(' ')+'\">'
    + '<div class=\"name\">'+m.label+'</div>'
    + '<div class=\"bar\"><span class=\"'+band(m.value)+'\" style=\"width:'+m.value+'%\"></span></div>'
    + '<div class=\"pct\">'+fmt(m.value)+'</div>'
    + '</div>';
  const posRow = p => '<div class=\"metric\">'
    + '<div class=\"name\">'+p.p+'</div>'
    + '<div class=\"bar\"><span class=\"'+band(p.value)+'\" style=\"width:'+p.value+'%\"></span></div>'
    + '<div class=\"pct\">'+fmt(p.value)+'</div>'
    + '</div>';

  // Long explanation defaults (ASCII-only)
  const long = {
    P1: 'Neutral grip (trail hand in fingers), soft knees, pelvis neutral. Pressure 55/45 lead-to-trail; ball position matches club. Spine tall, shoulders relaxed, eye line level.',
    P2: 'Shaft parallel with width; hands in front of chest; wrists set gradually. Face near neutral (toe-up); pressure loads trail foot without sway.',
    P3: 'Lead arm parallel with full torso turn. Trail elbow folds in front of ribcage; maintain width (about a forearm off chest). Club on plane; head steady.',
    P4: 'Top: pressure mostly trail heel; trail hip deep. Lead wrist nearer flat/bowed to manage face. Avoid across-the-line or laid-off extremes.',
    P5: 'Transition: pelvis -> torso -> arms. Shaft shallows; trail elbow in front of side seam. Maintain lead-wrist flexion; pressure into lead mid-foot.',
    P6: 'Delivery: shaft parallel; hands slightly ahead. Trail elbow tucked; face in window. Pelvis keeps turning (no stall).',
    P7: 'Impact: forward shaft lean; low point forward. Pelvis 30-45 deg open; chest 10-20 deg open; lead leg braced. Face close to square to path.',
    P8: 'Post-impact: trail arm extends; handle works around (not down the line). Control rate of closure (no flip); chest up/left.',
    P9: 'Finish: pressure fully lead side; belt buckle/chest to target; trail toe down. Hold the pose without wobble.'
  };

  function renderReport(d){
    if(d.discipline){ document.getElementById('modeLabel').textContent = /putt/i.test(d.discipline)?'Putting':/chip/i.test(d.discipline)?'Chipping':'Full Swing'; }
    if(d.swings!=null){ document.getElementById('swingCount').textContent = String(d.swings); }

    // Charts
    document.getElementById('swing').innerHTML = (d.swing_metrics||[]).map(metricRow).join('') || '<div class=\"sub\">No swing metrics.</div>';
    document.getElementById('position').innerHTML = (d.position_metrics||[]).map(posRow).join('') || '<div class=\"sub\">No position metrics.</div>';

    // Power summary
    const p = d.power||{score:0, tempo:'--', release_timing:0};
    document.getElementById('power').innerHTML =
      '<div class=\"metric\"><div class=\"name\">Power Score</div><div class=\"bar\"><span class=\"'+band(p.score)+'\" style=\"width:'+p.score+'%\"></span></div><div class=\"pct\">'+fmt(p.score)+'</div></div>' +
      '<div class=\"metric\"><div class=\"name\">Tempo</div><div class=\"bar\"><span class=\"ok\" style=\"width:76%\"></span></div><div class=\"pct\">'+(p.tempo||'--')+'</div></div>' +
      '<div class=\"metric\"><div class=\"name\">Release Timing</div><div class=\"bar\"><span class=\"'+band(+p.release_timing)+'\" style=\"width:'+(+p.release_timing||0)+'%\"></span></div><div class=\"pct\">'+(+p.release_timing||0)+'%</div></div>';

    // Build phases (P1-P9)
    let phases = Array.isArray(d.phases) ? d.phases.slice() : [];
    if(!phases.length){
      const names = ['Setup','Shaft Parallel (Backswing)','Lead Arm Parallel (Backswing)','Top of Swing','Lead Arm Parallel (Downswing)','Shaft Parallel (Downswing)','Impact','Trail Arm Parallel (Follow-Through)','Finish'];
      const pm = d.position_metrics||[];
      for(var i=0;i<9;i++){
        var pid = 'P'+(i+1);
        var m = pm.find(x=>String(x.p).toUpperCase()===pid) || {value:0};
        var g = m.value>=75?'good':m.value>=55?'ok':'bad';
        phases.push({id:pid, name:names[i], short:'', long:'', grade:g});
      }
    }
    document.getElementById('plist').innerHTML = phases.map(function(ph,i){
      var pid = ph.id || ('P'+(i+1));
      var longText = (ph.long && ph.long.trim() && ph.long.trim() !== (ph.short||'').trim()) ? ph.long : (long[pid]||'');
      return '<details '+(i===0?'open':'')+' class=\"panel\">'
           + '<summary>'
           +   '<span class=\"pnum\">'+pid+'</span>'
           +   '<span class=\"pname\">'+(ph.name||'')+'</span>'
           +   '<span class=\"gchip g-'+(ph.grade||'ok')+'\" style=\"margin-left:8px\">'+String(ph.grade||'OK').toUpperCase()+'</span>'
           +   '<span class=\"sub\" style=\"margin-left:8px\">'+(ph.short||'')+'</span>'
           +   '<svg class=\"caret\" width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"6 9 12 15 18 9\"/></svg>'
           + '</summary>'
           + '<div class=\"content\">'
           +   '<div class=\"sub\" style=\"margin-bottom:8px\">'+(ph.short||'')+'</div>'
           +   '<div style=\"margin-bottom:10px\">'+longText+'</div>'
           +   '<button class=\"btn view-video\" data-url=\"'+(ph.video||ph.video_url||'')+'\">View Video</button>'
           + '</div>'
           + '</details>';
    }).join('');

    // Coaching
    var pri = (d.coaching && Array.isArray(d.coaching.priority_fixes)) ? d.coaching.priority_fixes : [
      {title:'Clubface control at P7 (impact)', short:'Match face to path window.', long:'Face drifting open from P6->P7. Neutral grip check + lead-wrist flexion from P5->P6. 8 half-swings keeping glove logo at target through P7; video 2 reps.'},
      {title:'Lower body sequence', short:'Clear hips before hands.', long:'Hands fire early. Feel lead hip clear as pressure shifts to lead heel from P4. Step-through drill: backswing, step toward target as you start down.'},
      {title:'Hand path width', short:'Avoid collapse at P3.', long:'At P3 width narrows. Pump-downs: P3 -> mini P4 -> P5 with trail elbow connected. 10 rehearsals, then 3 balls.'}
    ];
    var pow = (d.coaching && Array.isArray(d.coaching.power_fixes)) ? d.coaching.power_fixes : [
      {title:'Tempo 3:1', short:'Smooth it out.', long:'Backswing too quick. Count 1-2-3 back, 1 through. Metronome 72 bpm, strike on every 4th tick x 12.'},
      {title:'Lead-leg brake', short:'Post into lead side.', long:'Plant lead heel from P4; straighten lead leg through P5-6. Towel under lead heel for feedback; 10 reps, then 5 balls.'},
      {title:'Late release timing', short:'Deliver speed at P7-P8.', long:'Hold wrist angles to P6, then unhinge. Two-tee gate at ball; clip both tees post-impact. 2x5.'}
    ];
    var mk = function(i){ return '<details class=\"panel\"><summary><span class=\"pname\">'+i.title+'</span><span class=\"sub\" style=\"margin-left:8px\">'+(i.short||'')+'</span><svg class=\"caret\" width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"6 9 12 15 18 9\"/></svg></summary><div class=\"content\">'+(i.long||'')+'</div></details>'; };
    document.getElementById('coachPriority').innerHTML = pri.map(mk).join('');
    document.getElementById('coachPower').innerHTML = pow.map(mk).join('');

    // Practice plan
    var plan = (d.practice_plan && Array.isArray(d.practice_plan)) ? d.practice_plan : Array.from({length:14}, function(_,i){
      return { day:i+1, title:(i%2 ? 'Contact + Face' : 'Tempo + Sequence'), drills:['9-to-3 x 15 (clip P6->P8).','Step-through x 10 (lead-leg brake).','Gate drill x 15.'] };
    });
    document.getElementById('practice').innerHTML = plan.map(function(dd){
      return '<details class=\"panel\" '+(dd.day===1?'open':'')+'>'
           + '<summary><span class=\"pname\">Day '+dd.day+'</span> <span class=\"sub\" style=\"margin-left:8px\">'+(dd.title||'')+'</span><svg class=\"caret\" width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"6 9 12 15 18 9\"/></svg></summary>'
           + '<div class=\"content\">'+((dd.drills||[]).map(x=>'<div>* '+x+'</div>').join('') || '<div class=\"sub\">No drills provided.</div>')+'</div>'
           + '</details>';
    }).join('');
  }

  // Sanitize incoming JSON text (ASCII-safe)
  function sanitize(t){
    return (t||'')
      .replace(/^\uFEFF/, '')               // strip BOM
      .replace(/[\u200B-\u200F\u202A-\u202E]/g,'') // zero-width + bidi
      .replace(/^[^\[{]*/,'')               // trim junk before JSON
      .replace(/[^\]}]*$/,'')               // trim junk after JSON
      .replace(/[\x00-\x1F\x7F-\x9F]/g,'')  // control chars
      .trim();
  }

  async function loadReport(url){
    const s = document.getElementById('status');
    const e = document.getElementById('error');
    e.textContent='';
    s.innerHTML='Loading <a href=\"'+url+'\" target=\"_blank\" rel=\"noopener\">'+url+'</a>...';
    let raw='';
    try{
      const res = await fetch(url,{cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      raw = await res.text();
      const cleaned = sanitize(raw);
      let data;
      try{ data = JSON.parse(cleaned); }
      catch(parseErr){
        const a = cleaned.indexOf('{'), b = cleaned.lastIndexOf('}');
        if(a>-1 && b>a) data = JSON.parse(cleaned.slice(a,b+1)); else throw parseErr;
      }
      renderReport(data);
      s.innerHTML='Loaded: <a href=\"'+url+'\" target=\"_blank\" rel=\"noopener\">'+url+'</a>';
    }catch(err){
      e.textContent='Failed to load report: '+(err && err.message ? err.message : String(err));
      const dbg = document.getElementById('debugOut');
      if(dbg){ try{ dbg.textContent='Raw first 240:\n'+(raw||'').slice(0,240)+'\n\nCleaned first 240:\n'+sanitize(raw||'').slice(0,240); }catch(_){} }
      renderReport(sample);
      try{ document.getElementById('debug').open = true; }catch(_){}; 
      s.textContent='Loaded SAMPLE (parse failed): '+url;
    }
  }

  // Sample data (ASCII-only) used when JSON fails
  const sample = {
    swings: 1, discipline: 'full-swing', power: {score: 78, tempo: '3.0:1', release_timing: 62},
    swing_metrics: [
      {label:'Right Arm Angle', value:84, tags:['arm-bend']},
      {label:'Club Face Angle', value:79, tags:['face-angle']},
      {label:'Shoulder Turn', value:72, tags:['shoulder-turn']},
      {label:'Hip Turn', value:68, tags:['hip-movement']},
      {label:'X-Factor (Shoulder-Hip)', value:64, tags:['sequence']},
      {label:'Club Path', value:71, tags:['club-path']},
      {label:'Face-to-Path', value:66, tags:['face-angle']},
      {label:'Attack Angle', value:62, tags:['delivery']}
    ],
    position_metrics: [{p:'P1',value:90},{p:'P2',value:74},{p:'P3',value:61},{p:'P4',value:55},{p:'P5',value:63},{p:'P6',value:70},{p:'P7',value:81},{p:'P8',value:86},{p:'P9',value:78}],
    phases: [
      {id:'P1',name:'Setup',short:'Athletic stance, posture aligned',long:'',grade:'good'},
      {id:'P2',name:'Shaft Parallel (Backswing)',short:'Club parallel, early width',long:'',grade:'ok'},
      {id:'P3',name:'Lead Arm Parallel (Backswing)',short:'Good extension, slight flat',long:'',grade:'ok'},
      {id:'P4',name:'Top of Swing',short:'Full coil',long:'',grade:'bad'},
      {id:'P5',name:'Lead Arm Parallel (Downswing)',short:'Arm drops inside',long:'',grade:'good'},
      {id:'P6',name:'Shaft Parallel (Downswing)',short:'Shallowing, trail elbow leads',long:'',grade:'good'},
      {id:'P7',name:'Impact',short:'Hips open, shaft lean',long:'',grade:'ok'},
      {id:'P8',name:'Trail Arm Parallel (Follow-Through)',short:'Balanced extension',long:'',grade:'good'},
      {id:'P9',name:'Finish',short:'Upright, balanced',long:'',grade:'good'}
    ]
  };

  // UI binds and autoload
  (function(){
    const getPath = () => new URLSearchParams(location.search).get('report') || document.body.dataset.reportSrc || '/report.json';
    const r = document.getElementById('reload'); if(r) r.addEventListener('click',()=>loadReport(getPath()));
    const s = document.getElementById('sample'); if(s) s.addEventListener('click',()=>{ renderReport(sample); document.getElementById('status').textContent='Loaded sample (no fetch).'; });
    const ex = document.getElementById('expandAll'); if(ex) ex.addEventListener('click',()=>{ document.querySelectorAll('details.panel').forEach(d=>d.open=true); });
    const co = document.getElementById('collapseAll'); if(co) co.addEventListener('click',()=>{ document.querySelectorAll('details.panel').forEach(d=>d.open=false); });
    const auto = getPath();
    if(auto) loadReport(auto);
  })();
  </script>
</body>
</html>

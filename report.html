<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Virtual Coach AI — Swing Report (Stable)</title>
  <style>
    :root{ --ink:#0c1f2b; --muted:#3b6178; --ok:#19c37d; --warn:#f6c453; --bad:#ff6b6b; --radius:16px; --shadow:0 8px 24px rgba(0,0,0,.18); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;color:#0f2330;font:16px/1.45 system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;background:#e9f4fb}
    .bg{position:fixed;inset:0;z-index:-1;background:url('/homepage-background.png') center/cover no-repeat fixed}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{font-size:26px;font-weight:800;letter-spacing:.2px;color:var(--ink)}
    .sub{color:var(--muted);font-size:13px}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn,.select{background:rgba(255,255,255,.85);border:1px solid #d3e3ee;border-radius:12px;color:var(--ink);padding:8px 12px;box-shadow:var(--shadow);cursor:pointer}
    .badge{background:#fff;border:1px solid #d3e3ee;color:var(--ink);padding:6px 10px;border-radius:999px;font-size:12px}

    .card,details.panel{background:rgba(255,255,255,.30);border:1px solid #d8eaf6;border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:saturate(120%) blur(2px)}
    .card h3{margin:0;padding:14px 16px;border-bottom:1px solid #e0edf5;color:var(--ink)}
    .card .content{padding:12px 16px}

    summary{list-style:none;display:flex;gap:10px;align-items:center;padding:14px 16px;cursor:pointer}
    summary::-webkit-details-marker{display:none}
    .pnum{width:34px;height:34px;border-radius:10px;background:#eef6fb;border:1px solid #d3e3ee;display:grid;place-items:center;font-weight:800;color:var(--ink)}
    .pname{font-weight:700;color:var(--ink)}
    .caret{margin-left:auto;transition:transform .2s ease}
    details[open] .caret{transform:rotate(180deg)}
    .gchip{font-size:12px;font-weight:700;padding:3px 8px;border-radius:8px;border:1px solid transparent;background:transparent;color:#fff}
    .g-good{background:#19c37d;border-color:#19c37d} .g-ok{background:#f5b301;border-color:#f5b301} .g-bad{background:#e03131;border-color:#e03131}

    .metric{display:flex;align-items:center;gap:10px;margin:9px 0}
    .metric .name{flex:0 0 230px;color:#10344a}
    .bar{flex:1;height:10px;border-radius:999px;background:#e8f2f9;border:1px solid #d3e3ee;position:relative;overflow:hidden}
    .bar>span{position:absolute;left:0;top:0;bottom:0;border-radius:999px}
    .ok{background:linear-gradient(90deg,#19c37d,#2bd897)}
    .warn{background:linear-gradient(90deg,#f6c453,#ffd479)}
    .bad{background:linear-gradient(90deg,#ff6b6b,#ff8f8f)}
    .pct{width:52px;text-align:right;color:#0c2433}

    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body data-report-src="/report.json">
  <div class="bg" aria-hidden="true"></div>
  <div class="wrap">
    <header>
      <div>
        <div class="title">Swing Report — P1–P9</div>
        <div class="sub">Date: <span id="date"></span> • Mode: <span id="modeLabel">Full Swing</span></div>
      </div>
      <div class="toolbar">
        <label class="badge">Swings: <span id="swingCount">1</span></label>
        <select id="discipline" class="select"><option value="full-swing" selected>Full Swing</option><option value="chipping">Chipping</option><option value="putting">Putting</option></select>
        <button id="reload" class="btn" type="button">Reload</button>
        <button id="sample" class="btn" type="button">Load Sample</button>
      </div>
    </header>

    <section id="plistWrap">
      <div class="sub">P1–P9 (click a row to expand)</div>
      <div id="plist"></div>
    </section>

    <section class="card" style="margin-top:12px"><h3>Coaching Card</h3><div class="content"><details class="panel" open><summary><span class="pname">Top 3 Priority Fixes</span><svg class="caret" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></summary><div id="coachPriority"></div></details><details class="panel" style="margin-top:10px"><summary><span class="pname">Top 3 Power Fixes</span><svg class="caret" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></summary><div id="coachPower"></div></details></div></section>

    <section class="grid" style="margin-top:12px">
      <div class="card"><h3>Position Consistency</h3><div id="position" class="content"></div></div>
      <div class="card"><h3>Swing Consistency</h3><div id="swing" class="content"></div></div>
    </section>

    <section class="card" style="margin-top:12px"><h3>Power Score Summary</h3><div id="power" class="content"></div></section>

    <div id="status" class="sub" style="margin-top:8px"></div>
    <div id="error" class="sub" style="color:#b42323"></div>
    <details id="debug" class="sub" style="margin-top:6px"><summary>Debug</summary><pre id="debugOut" style="white-space:pre-wrap;background:#f3f9fd;border:1px solid #d3e3ee;padding:8px;border-radius:8px;max-height:260px;overflow:auto"></pre></details>
  </div>

<script>
// --- Init
const $ = s => document.querySelector(s);
$('#date').textContent = new Date().toLocaleDateString();

// --- Helpers
const band = v => v>=75?'ok':v>=55?'warn':'bad';
const fmt  = v => `${v}%`;
const metricRow = m => `<div class="metric"><div class="name">${m.label}</div><div class="bar"><span class="${band(m.value)}" style="width:${m.value}%"></span></div><div class="pct">${fmt(m.value)}</div></div>`;
const posRow    = p => `<div class="metric"><div class="name">${p.p}</div><div class="bar"><span class="${band(p.value)}" style="width:${p.value}%"></span></div><div class="pct">${fmt(p.value)}</div></div>`;

const defaultNames=['Setup','Shaft Parallel (Backswing)','Lead Arm Parallel (Backswing)','Top of Swing','Lead Arm Parallel (Downswing)','Shaft Parallel (Downswing)','Impact','Trail Arm Parallel (Follow-Through)','Finish'];
const defaultLong={
  P1:'Neutral grip (trail hand in fingers), soft knees, pelvis neutral. Pressure 55/45 lead-to-trail; ball position matches club. Spine tall, shoulders relaxed, eye line level.',
  P2:'Shaft parallel with width; hands in front of chest; wrists set gradually. Face near neutral (toe-up); pressure loads trail foot without sway.',
  P3:'Lead arm parallel with full torso turn. Trail elbow folds in front of ribcage; maintain width (~a forearm off chest). Club on plane; head steady.',
  P4:'Top: pressure mostly trail heel; trail hip deep. Lead wrist nearer flat/bowed to manage face. Avoid across-the-line/laid-off extremes.',
  P5:'Transition: pelvis -> torso -> arms. Shaft shallows; trail elbow in front of side seam. Maintain lead-wrist flexion; pressure into lead mid-foot.',
  P6:'Delivery: shaft parallel; hands slightly ahead. Trail elbow tucked; face in window. Pelvis keeps turning (no stall).',
  P7:'Impact: forward shaft lean; low point forward. Pelvis 30-45 deg open; chest 10-20 deg open; lead leg braced. Face close to square to path.',
  P8:'Post-impact: trail arm extends; handle works around (not down the line). Control rate of closure (no flip); chest up/left.',
  P9:'Finish: pressure fully lead side; belt buckle/chest to target; trail toe down. Hold the pose.'
};

// --- Renderer
function renderReport(d){
  if(d.discipline){ $('#modeLabel').textContent = /putt/i.test(d.discipline)?'Putting':/chip/i.test(d.discipline)?'Chipping':'Full Swing'; }
  if(d.swings!=null){ $('#swingCount').textContent = String(d.swings); }

  const swingArr = Array.isArray(d.swing_metrics)?d.swing_metrics:[];
  const posArr   = Array.isArray(d.position_metrics)?d.position_metrics:[];
  $('#swing').innerHTML   = swingArr.map(metricRow).join('') || '<div class="sub">No swing metrics.</div>';
  $('#position').innerHTML= posArr.map(posRow).join('')     || '<div class="sub">No position metrics.</div>';

  const p=d.power||{score:0,tempo:'—',release_timing:0};
  $('#power').innerHTML=
    `<div class="metric"><div class="name">Power Score</div><div class="bar"><span class="${band(p.score)}" style="width:${p.score}%"></span></div><div class="pct">${fmt(p.score)}</div></div>`+
    `<div class="metric"><div class="name">Tempo</div><div class="bar"><span class="ok" style="width:76%"></span></div><div class="pct">${p.tempo}</div></div>`+
    `<div class="metric"><div class="name">Release Timing</div><div class="bar"><span class="${band(+p.release_timing)}" style="width:${+p.release_timing||0}%"></span></div><div class="pct">${+p.release_timing||0}%</div></div>`;

  // Build P1–P9 robustly
  const pm = Array.isArray(d.position_metrics)?d.position_metrics:[];
  let phases = Array.isArray(d.phases)?d.phases.slice():[];
  const gradeFromVal = v => v>=75?'good':v>=55?'ok':'bad';
  const getPmVal = id => { const m=pm.find(x=>String(x.p).toUpperCase()===id); return m?+m.value||0:0; };
  for(let i=0;i<9;i++){
    const id='P'+(i+1);
    const base = phases.find(x=>String(x.id||'').toUpperCase()===id) || {};
    phases[i] = {
      id,
      name: base.name || defaultNames[i],
      short: base.short || '',
      long: (base.long && base.long.trim() && base.long.trim()!==(base.short||'').trim()) ? base.long : (defaultLong[id]||''),
      grade: base.grade || gradeFromVal(getPmVal(id))
    };
  }
  const gradeLabel={good:'Good', ok:'OK', bad:'Needs Help'};
  $('#plist').innerHTML = phases.map((ph,i)=>
    `<details ${i===0?'open':''} class="panel">
       <summary>
         <span class="pnum">${ph.id}</span>
         <span class="pname">${ph.name}</span>
         <span class="gchip g-${ph.grade}" style="margin-left:8px">${gradeLabel[ph.grade]||'OK'}</span>
         <span class="sub" style="margin-left:8px">${ph.short||''}</span>
         <svg class="caret" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
       </summary>
       <div class="content">
         <div class="sub" style="margin-bottom:8px">${ph.short||''}</div>
         <div style="margin-bottom:10px">${ph.long||''}</div>
       </div>
     </details>`
  ).join('');

  // Coaching
  const pri=(d.coaching&&Array.isArray(d.coaching.priority_fixes))?d.coaching.priority_fixes:defaultPri;
  const pow=(d.coaching&&Array.isArray(d.coaching.power_fixes))?d.coaching.power_fixes:defaultPow;
  const mk=i=>`<details class="panel"><summary><span class="pname">${i.title}</span><span class="sub" style="margin-left:8px">${i.short||''}</span><svg class="caret" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></summary><div class="content">${i.long||''}</div></details>`;
  $('#coachPriority').innerHTML = pri.map(mk).join('');
  $('#coachPower').innerHTML   = pow.map(mk).join('');
}

const defaultPri=[
  {title:'Clubface control at P7 (impact)', short:'Match face to path', long:'Face drifting open from P6->P7. Grip audit; bow lead wrist from P5->P6. Rehearse 8 half-swings keeping glove logo at target; video 2.'},
  {title:'Lower body sequence', short:'Clear hips before hands', long:'From P4 shift to lead heel then rotate pelvis while chest stays closed a beat. Step-through swings x10 slow + x10 normal.'},
  {title:'Hand path width', short:'Keep width at P3', long:'Pump-downs P3 -> mini P4 -> P5 with trail elbow in front of side seam. 3x10 rehearsals, then 3 balls each set.'}
];
const defaultPow=[
  {title:'Tempo 3:1', short:'Smooth rhythm', long:'Count 1-2-3 back, 1 through. 72 bpm; strike every 4th tick x12, rest, repeat x3.'},
  {title:'Lead-leg brake', short:'Post into lead side', long:'Plant lead heel from P4, straighten through P5-6. Towel under lead heel; 10 reps then 5 balls.'},
  {title:'Late release timing', short:'Speed at P7-8', long:'Hold to P6 then unhinge. Two-tee gate; clip both tees post-impact. 2x5; video last 2.'}
];

// --- JSON cleaning without regex traps
function cleanJson(t){
  if(!t) return '';
  // strip BOM
  if(t.charCodeAt(0)===0xFEFF) t=t.slice(1);
  // drop control chars except tab/newline/cr
  let out='';
  for(let i=0;i<t.length;i++){ const c=t.charCodeAt(i); if(c===9||c===10||c===13||(c>=32&&c!==127)) out+=t[i]; }
  // trim to first { or [ and last } or ]
  let a=out.indexOf('{'); let a2=out.indexOf('['); if(a===-1||(a2!==-1&&a2<a)) a=a2; const b=Math.max(out.lastIndexOf('}'),out.lastIndexOf(']'));
  if(a>-1&&b>a) out=out.slice(a,b+1);
  return out.trim();
}

async function loadReport(url){
  const st=$('#status'), er=$('#error'), dbg=$('#debugOut');
  er.textContent=''; st.textContent='Loading '+url+'...'; if(dbg) dbg.textContent='';
  try{
    const res=await fetch(url,{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const raw=await res.text();
    const cleaned=cleanJson(raw);
    if (dbg) {
    dbg.textContent = `RAW (first 240):
${raw.slice(0,240)}

CLEAN (first 240):
${cleaned.slice(0,240)}`;
    document.getElementById('debug').open = true;
  }
    const data=JSON.parse(cleaned);
    renderReport(data);
    st.textContent='Loaded: '+url;
  }catch(err){
    er.textContent='Failed to load report: '+(err&&err.message?err.message:String(err));
    if (dbg) {
      dbg.textContent += `

ERROR: ${err && err.stack ? err.stack : err}`;
      document.getElementById('debug').open = true;
    }
    renderReport(sample);
    st.textContent='Loaded SAMPLE (parse failed): '+url;
  }
}

const sample={
  swings:1, discipline:'full-swing', power:{score:78, tempo:'3.0:1', release_timing:62},
  swing_metrics:[
    {label:'Right Arm Angle',value:84}, {label:'Club Face Angle',value:79}, {label:'Shoulder Turn',value:72}, {label:'Hip Turn',value:68},
    {label:'X-Factor (Shoulder-Hip)',value:64}, {label:'Club Path',value:71}, {label:'Face-to-Path',value:66}, {label:'Attack Angle',value:62}
  ],
  position_metrics:[{p:'P1',value:90},{p:'P2',value:74},{p:'P3',value:61},{p:'P4',value:55},{p:'P5',value:63},{p:'P6',value:70},{p:'P7',value:81},{p:'P8',value:86},{p:'P9',value:78}],
  phases:[]
};

(function(){
  const getPath=()=> new URLSearchParams(location.search).get('report') || document.body.dataset.reportSrc || '/report.json';
  document.getElementById('reload').addEventListener('click',()=>loadReport(getPath()));
  document.getElementById('sample').addEventListener('click',()=>{ renderReport(sample); document.getElementById('status').textContent='Loaded sample (no fetch).'; });
  loadReport(getPath());
})();
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Virtual Coach AI - Swing Report</title>
<style>
:root{--bd:#d3e3ee;--ink:#0c1f2b;--txt:#102e40;--muted:#446477;--ok:#19c37d;--warn:#f6c453;--bad:#ff6b6b;--r:14px;--sh:0 6px 18px rgba(0,0,0,.18)}
*{box-sizing:border-box}body{margin:0;font:16px/1.45 system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;color:var(--txt);background:#e9f4fb}
.bg{position:fixed;inset:0;z-index:-1;background:linear-gradient(0deg,rgba(255,255,255,.70),rgba(255,255,255,.70)),url('/homepage-background.png') center/cover no-repeat fixed,url('/golf-course-bg.jpg') center/cover no-repeat fixed}
.wrap{max-width:1080px;margin:28px auto;padding:0 14px}
header{display:flex;justify-content:space-between;align-items:center;gap:12px}
.title{font-size:24px;font-weight:800;color:var(--ink)}
.sub{color:var(--muted);font-size:13px}
.toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.btn,.select{background:#fff;border:1px solid var(--bd);border-radius:10px;padding:7px 10px;box-shadow:var(--sh);cursor:pointer;color:var(--ink)}
.badge{background:#fff;border:1px solid var(--bd);border-radius:999px;padding:6px 10px;font-size:12px}
.card,details.panel{background:#fff;border:1px solid var(--bd);border-radius:var(--r);box-shadow:var(--sh);margin-top:12px}
.card h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--bd);font-size:18px}
.card .content{padding:12px 14px}
summary{list-style:none;display:flex;gap:10px;align-items:center;padding:12px 14px;cursor:pointer}
summary::-webkit-details-marker{display:none}.caret{margin-left:auto}
.pnum{width:32px;height:32px;border-radius:9px;border:1px solid var(--bd);background:#f3f9fd;display:grid;place-items:center;font-weight:800}
.pname{font-weight:700}
.gchip{font-size:12px;font-weight:700;padding:2px 8px;border:1px solid var(--bd);border-radius:8px;background:#fff}
.g-good{color:#0a8c5b}.g-ok{color:#9a7a00}.g-bad{color:#b93131}
.metric{display:flex;align-items:center;gap:10px;margin:9px 0}.metric .name{flex:0 0 230px}
.bar{flex:1;height:10px;border-radius:999px;background:#eef6fb;border:1px solid var(--bd);position:relative;overflow:hidden}
.bar>span{position:absolute;left:0;top:0;bottom:0;border-radius:999px}
.ok{background:linear-gradient(90deg,#19c37d,#2bd897)}.warn{background:linear-gradient(90deg,#f6c453,#ffd479)}.bad{background:linear-gradient(90deg,#ff6b6b,#ff8f8f)}
.pct{width:52px;text-align:right}
.grid{display:grid;grid-template-columns:1fr;gap:12px}@media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<div class="bg" aria-hidden="true"></div>
<div class="wrap">
  <header>
    <div><div class="title">Swing Report - P1–P9</div><div class="sub">Date: <span id="date"></span> • Mode: <span id="mode">Full Swing</span></div></div>
    <div class="toolbar">
      <label class="badge">Swings: <span id="swings">1</span></label>
      <button id="expandAll" class="btn">Expand All</button>
      <button id="collapseAll" class="btn">Collapse All</button>
      <button id="reload" class="btn">Reload</button>
      <button id="sample" class="btn">Load Sample</button>
    </div>
  </header>

  <!-- P1-P9 FIRST -->
  <section id="plistWrap" class="card"><h3>P1–P9</h3><div class="content"><div class="sub">Click a row to expand.</div><div id="plist"></div></div></section>

  <!-- Coaching Card -->
  <section class="card"><h3>Coaching Card</h3><div class="content">
    <details class="panel" open><summary><span class="pname">Top 3 Priority Fixes</span><span class="caret">▼</span></summary><div id="coachPriority" class="content"></div></details>
    <details class="panel"><summary><span class="pname">Top 3 Power Fixes</span><span class="caret">▼</span></summary><div id="coachPower" class="content"></div></details>
  </div></section>

  <!-- Practice Plan -->
  <section class="card"><h3>14-Day Practice Plan</h3><div id="practice" class="content"></div></section>

  <!-- Charts -->
  <section class="grid">
    <div class="card"><h3>Position Consistency</h3><div id="position" class="content"></div></div>
    <div class="card"><h3>Swing Consistency</h3><div id="swing" class="content"></div></div>
  </section>

  <!-- Power -->
  <section class="card"><h3>Power Score Summary</h3><div id="power" class="content"></div></section>

  <div id="status" class="sub" style="margin-top:8px"></div>
  <div id="error" class="sub" style="margin-top:4px;color:#b42323"></div>
</div>

<script>
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
$('#date').textContent=new Date().toLocaleDateString();

const band=v=>v>=75?'ok':v>=55?'warn':'bad';
const gradeTxt=g=>g==='good'?'Good':g==='ok'?'OK':'Needs Help';
const metricRow=m=>'<div class="metric"><div class="name">'+m.label+'</div><div class="bar"><span class="'+band(m.value)+'" style="width:'+m.value+'%"></span></div><div class="pct">'+(m.value|0)+'%</div></div>';
const posRow=p=>'<div class="metric"><div class="name">'+p.p+'</div><div class="bar"><span class="'+band(p.value)+'" style="width:'+p.value+'%"></span></div><div class="pct">'+(p.value|0)+'%</div></div>';

const long={
P1:'Neutral grip, soft knees, pelvis neutral. Pressure 55/45 lead-to-trail; ball position matches club. Spine tall, shoulders relaxed, eyes level.',
P2:'Shaft parallel with width; hands in front of chest; gradual wrist set. Face near neutral; pressure loads trail foot without sway.',
P3:'Lead arm parallel with full torso turn. Trail elbow in front of ribcage; keep width. Club on plane; head steady.',
P4:'Top: pressure mostly trail heel; trail hip deep. Lead wrist flatter/bowed to manage face. Avoid across-the-line or laid off.',
P5:'Transition: pelvis then torso then arms. Shaft shallows; trail elbow in front of side seam. Maintain lead-wrist flexion.',
P6:'Delivery: shaft parallel; hands slightly ahead. Trail elbow tucked; face in window. Pelvis keeps turning.',
P7:'Impact: forward shaft lean; low point forward. Pelvis 30-45 deg open; chest 10-20 deg; lead leg braced; face close to square to path.',
P8:'Post-impact: trail arm extends; handle works around. Control rate of closure; chest up and left.',
P9:'Finish: pressure fully lead side; belt buckle and chest at target; trail toe down. Hold the pose.'
};

function renderReport(d){
  if(d.discipline) $('#mode').textContent=/putt/i.test(d.discipline)?'Putting':/chip/i.test(d.discipline)?'Chipping':'Full Swing';
  if(d.swings!=null) $('#swings').textContent=String(d.swings);

  // Charts
  $('#swing').innerHTML=(d.swing_metrics||[]).map(metricRow).join('')||'<div class="sub">No swing metrics.</div>';
  $('#position').innerHTML=(d.position_metrics||[]).map(posRow).join('')||'<div class="sub">No position metrics.</div>';

  // Power summary
  const p=d.power||{score:0,tempo:'--',release_timing:0};
  $('#power').innerHTML=
    '<div class="metric"><div class="name">Power Score</div><div class="bar"><span class="'+band(p.score)+'" style="width:'+p.score+'%"></span></div><div class="pct">'+(p.score|0)+'%</div></div>'+
    '<div class="metric"><div class="name">Tempo</div><div class="bar"><span class="ok" style="width:76%"></span></div><div class="pct">'+(p.tempo||'--')+'</div></div>'+
    '<div class="metric"><div class="name">Release Timing</div><div class="bar"><span class="'+band(+p.release_timing)+'" style="width:'+(+p.release_timing||0)+'%"></span></div><div class="pct">'+(+p.release_timing||0)+'%</div></div>';

  // P1–P9
  let phases=Array.isArray(d.phases)?d.phases.slice():[];
  if(!phases.length){
    const names=['Setup','Shaft Parallel (Backswing)','Lead Arm Parallel (Backswing)','Top of Swing','Lead Arm Parallel (Downswing)','Shaft Parallel (Downswing)','Impact','Trail Arm Parallel (Follow-Through)','Finish'];
    const pm=d.position_metrics||[];
    for(let i=0;i<9;i++){const pid='P'+(i+1);const m=pm.find(x=>String(x.p).toUpperCase()===pid)||{value:0};const g=m.value>=75?'good':m.value>=55?'ok':'bad'; phases.push({id:pid,name:names[i],short:'',long:'',grade:g});}
  }
  $('#plist').innerHTML=phases.map((ph,i)=>{
    const id=ph.id||('P'+(i+1)), lg=(ph.long&&ph.long.trim()&&ph.long.trim()!==(ph.short||'').trim())?ph.long:(long[id]||'');
    return '<details class="panel" '+(i===0?'open':'')+'><summary><span class="pnum">'+id+'</span><span class="pname">'+(ph.name||'')+'</span> <span class="gchip g-'+(ph.grade||'ok')+'">'+gradeTxt(ph.grade||'ok')+'</span> <span class="sub" style="margin-left:8px">'+(ph.short||'')+'</span><span class="caret">▼</span></summary><div class="content"><div class="sub" style="margin-bottom:8px">'+(ph.short||'')+'</div><div style="margin-bottom:8px">'+lg+'</div><button class="btn view-video" data-url="'+(ph.video||ph.video_url||'')+'">View Video</button></div></details>';
  }).join('');

  // Coaching (with long defaults)
  const pri=(d.coaching&&Array.isArray(d.coaching.priority_fixes))?d.coaching.priority_fixes:[];
  const powFix=(d.coaching&&Array.isArray(d.coaching.power_fixes))?d.coaching.power_fixes:[];
  const priDef=[
    {title:'Clubface control at P7 (impact)',short:'Match face to path.',long:'Face drifting open from P6 to P7 causes blocks/fades. Fix: neutral grip check; add lead-wrist flexion from P5 to P6. Drill: 8 half-swings stopping at P6, then to soft P8 keeping glove logo at target. Use an alignment stick just outside the ball for feedback.'},
    {title:'Lower body sequence',short:'Clear hips before hands.',long:'Hands outracing pelvis steepens the path. From P4, shift pressure to lead heel and rotate pelvis as chest stays closed a beat; let arms drop. Step-through swings x10 to feel pressure and rotation leading.'},
    {title:'Hand path width',short:'Keep width at P3.',long:'Width collapses at P3 -> across-the-line. Pump-downs: P3 to mini P4 to P5 keeping trail elbow in front of the side seam. 3x10 rehearsals, then 3 balls per set.'}
  ];
  const powDef=[
    {title:'Tempo 3:1',short:'Smooth rhythm.',long:'Target 3:1 backswing:downswing. Count 1-2-3 back, 1 through. Use 72 bpm metronome; strike every 4th tick, 3 sets of 12 balls. Expect tighter face control without forcing speed.'},
    {title:'Lead-leg brake',short:'Post up.',long:'Plant lead heel from P4; straighten lead leg through P5-6 to sling the handle. Towel under lead heel for feedback; 10 slow reps then 5 balls; cue zipper to target while head stays behind ball.'},
    {title:'Late release timing',short:'Deliver speed at P7-8.',long:'Hold wrist angles to P6; unhinge through impact. Two-tee gate (one at ball, one 4 in forward). Clip both tees after impact. 2 sets of 5; video 2 swings to confirm hands ahead at P7.'}
  ];
  function ensure3(arr,defs){const out=(arr&&arr.length?arr:defs).slice(0,3);while(out.length<3) out.push(defs[out.length%defs.length]);return out.map((x,i)=>({title:x.title||defs[i].title,short:x.short||defs[i].short,long:(x.long&&x.long.trim())?x.long:defs[i].long}))}
  const mk=i=>'<details class="panel"><summary><span class="pname">'+i.title+'</span><span class="sub" style="margin-left:8px">'+(i.short||'')+'</span><span class="caret">▼</span></summary><div class="content">'+(i.long||'')+'</div></details>';
  $('#coachPriority').innerHTML=ensure3(pri,priDef).map(mk).join('');
  $('#coachPower').innerHTML=ensure3(powFix,powDef).map(mk).join('');

  // Practice (long paragraph + drills)
  const plan=(d.practice_plan&&Array.isArray(d.practice_plan))?d.practice_plan:Array.from({length:14},(_,i)=>({day:i+1,title:(i%2?'Contact + Face':'Tempo + Sequence'),drills:['9-to-3 x 15 (clip P6->P8)','Step-through x 10 (lead-leg brake)','Gate drill x 15']}));
  $('#practice').innerHTML=plan.map(dd=>{
    const t=dd.title||'Practice';
    const desc=(dd.desc&&dd.desc.trim())?dd.desc:(t.indexOf('Tempo')>-1?'Goal: groove relaxed 3:1 rhythm and synced sequence. Do 3 blocks of 10: A tempo-only half swings, B step-through for sequence, C full swings same cadence. Video 2 swings each block.':t.indexOf('Contact')>-1?'Goal: tighten start-line and face delivery. Two sets of 15 with 9-to-3 swings; add a tee gate for feedback; track strike pattern.':'Goal: quality reps with feedback. 5 rehearsals, 10 constraint-drill balls, 5 full swings keeping the same feels.');
    const drills=(dd.drills||[]).map(x=>'<div>* '+x+'</div>').join('');
    return '<details class="panel'+(dd.day===1?'":"')+'"><summary><span class="pname">Day '+dd.day+'</span><span class="sub" style="margin-left:8px">'+t+'</span><span class="caret">▼</span></summary><div class="content"><p>'+desc+'</p>'+drills+'</div></details>';
  }).join('');
}

async function loadReport(url){
  const s=$('#status'), e=$('#error'); e.textContent=''; s.textContent='Loading '+url+' ...';
  try{
    const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error('HTTP '+res.status);
    const txt=await res.text(); let data;
    try{ data=JSON.parse(txt.trim()); }catch(_){ const a=txt.indexOf('{'), b=txt.lastIndexOf('}'); if(a>-1&&b>a) data=JSON.parse(txt.slice(a,b+1)); else throw _; }
    renderReport(data); s.textContent='Loaded: '+url;
  }catch(err){ e.textContent='Failed to load report: '+(err&&err.message?err.message:String(err)); renderReport(sample); s.textContent='Loaded SAMPLE (parse failed): '+url; }
}

const sample={swings:1,discipline:'full-swing',power:{score:82,tempo:'3.2:1',release_timing:68},
swing_metrics:[{label:'Right Arm Angle',value:84},{label:'Club Face Angle',value:79},{label:'Shoulder Turn',value:72},{label:'Hip Turn',value:68},{label:'X-Factor (Shoulder-Hip)',value:64},{label:'Club Path',value:71},{label:'Face-to-Path',value:66},{label:'Attack Angle',value:62}],
position_metrics:[{p:'P1',value:90},{p:'P2',value:74},{p:'P3',value:61},{p:'P4',value:55},{p:'P5',value:63},{p:'P6',value:70},{p:'P7',value:81},{p:'P8',value:86},{p:'P9',value:78}],
phases:[{id:'P1',name:'Setup',short:'Athletic stance, posture aligned',long:'',grade:'good'},{id:'P2',name:'Shaft Parallel (Backswing)',short:'Club parallel, early width',long:'',grade:'ok'},{id:'P3',name:'Lead Arm Parallel (Backswing)',short:'Good extension',long:'',grade:'ok'},{id:'P4',name:'Top of Swing',short:'Full coil',long:'',grade:'bad'},{id:'P5',name:'Lead Arm Parallel (Downswing)',short:'Arm drops inside',long:'',grade:'good'},{id:'P6',name:'Shaft Parallel (Downswing)',short:'Shallowing',long:'',grade:'good'},{id:'P7',name:'Impact',short:'Hips open, shaft lean',long:'',grade:'ok'},{id:'P8',name:'Trail Arm Parallel (Follow-Through)',short:'Balanced extension',long:'',grade:'good'},{id:'P9',name:'Finish',short:'Upright, balanced',long:'',grade:'good'}]};

(function(){
  const qp=new URLSearchParams(location.search); const url=qp.get('report')||'/report.json'; loadReport(url);
  $('#reload').onclick=()=>loadReport(qp.get('report')||'/report.json');
  $('#sample').onclick=()=>{ renderReport(sample); $('#status').textContent='Loaded sample (no fetch).'; };
  $('#expandAll').onclick=()=>$$('details.panel').forEach(d=>d.open=true);
  $('#collapseAll').onclick=()=>$$('details.panel').forEach(d=>d.open=false);
})();
</script>
</body>
</html>

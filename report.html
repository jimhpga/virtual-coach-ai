<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Virtual Coach AI — Swing Report</title>
  <style>
    :root{
      --bg:#0e1a22; --panel:#16242e; --muted:#8aa5b5; --text:#ecf3f7; --accent:#5eb3ff;
      --ok:#19c37d; --warn:#f6c453; --bad:#ff6b6b; --chip:#1d2f3b; --radius:16px;
      --shadow:0 8px 24px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;color:var(--text);font:16px/1.45 system-ui, -apple-system, Segoe UI, Inter, Roboto, Helvetica, Arial, sans-serif;background:#0e1a22}

    /* full-bleed golf course background */
    .bg{position:fixed;inset:0;background:url('/homepage-background.png') center/cover no-repeat fixed;opacity:.36;z-index:-1}
    .bg::after{content:"";position:absolute;inset:0;background:linear-gradient(180deg,rgba(10,18,24,.35),rgba(10,18,24,.35))}

    .wrap{max-width:1080px;margin:28px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{font-size:26px;font-weight:800;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px}

    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn,.select{background:rgba(22,36,46,.92);border:1px solid #223743;border-radius:12px;color:var(--text);padding:8px 12px;box-shadow:var(--shadow);cursor:pointer}
    .select{appearance:none;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>');background-repeat:no-repeat;background-position:right 10px center;padding-right:36px}
    .badge{background:var(--chip);border:1px solid #263b48;color:#cfe3ee;padding:6px 10px;border-radius:999px;font-size:12px}

    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}

    .card,details.panel{background:rgba(22,36,46,.9);border:1px solid #223743;border-radius:var(--radius);box-shadow:var(--shadow)}
    .card h3{margin:0;padding:14px 16px;border-bottom:1px solid #1f3340}
    .card .content{padding:12px 16px}
    details.panel+details.panel{margin-top:10px}
    summary{list-style:none;display:flex;gap:10px;align-items:center;padding:14px 16px;cursor:pointer}
    summary::-webkit-details-marker{display:none}
    .pnum{width:34px;height:34px;border-radius:10px;background:#0c1820;border:1px solid #223743;display:grid;place-items:center;font-weight:800}
    .pname{font-weight:700}
    .caret{margin-left:auto;transition:transform .2s ease}
    details[open] .caret{transform:rotate(180deg)}
    .gchip{font-size:12px;font-weight:700;padding:3px 8px;border-radius:8px;border:1px solid #27404f;background:var(--chip)}
    .g-good{color:var(--ok)} .g-ok{color:var(--warn)} .g-bad{color:var(--bad)}

    /* metric rows */
    .metric{display:flex;align-items:center;gap:10px;margin:9px 0}
    .metric .name{flex:0 0 210px;color:#cfe3ee}
    .bar{flex:1;height:10px;border-radius:999px;background:#10222c;border:1px solid #22404f;position:relative;overflow:hidden}
    .bar>span{position:absolute;left:0;top:0;bottom:0;border-radius:999px}
    .ok{background:linear-gradient(90deg,var(--ok),#2bd897)}
    .warn{background:linear-gradient(90deg,var(--warn),#ffd479)}
    .bad{background:linear-gradient(90deg,var(--bad),#ff8f8f)}
    .pct{width:52px;text-align:right;color:#cfe3ee}
    .focus-dim{opacity:.35;filter:saturate(.5)}

    .footnote{color:var(--muted);font-size:12px;margin-top:6px}

    /* overlays */
    .overlay{position:fixed;inset:0;background:rgba(8,16,22,.72);backdrop-filter:saturate(120%) blur(2px);display:grid;place-items:center;z-index:9999}
    .overlay[hidden]{display:none !important}
    .overlay-card{width:min(720px,92vw);background:var(--panel);border:1px solid #224355;border-radius:18px;box-shadow:var(--shadow);padding:20px}
    .overlay h2{margin:0 0 8px 0;font-size:20px}
    .overlay .sub{color:var(--muted);margin-bottom:12px}
    .progress{height:14px;border-radius:999px;background:#0f2230;border:1px solid #22404f;overflow:hidden}
    .progress>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,#4aa3ff,#19c37d)}
    .status-list{list-style:none;margin:12px 0 0 0;padding:0;display:grid;gap:8px}
    .status-item{display:flex;align-items:center;gap:10px;color:#cfe3ee}
    .status-item .dot{width:10px;height:10px;border-radius:50%;background:#2a3f4d;border:1px solid #3a5566}
    .status-item.active .dot{background:#4aa3ff;border-color:#4aa3ff}
    .status-item.done .dot{background:#19c37d;border-color:#19c37d}
    .eta{color:var(--muted);font-size:12px}
    .overlay-actions{display:none;margin-top:10px}
    .overlay-actions.show{display:flex;gap:8px;flex-wrap:wrap}

    /* busy pill */
    .busy{position:fixed;top:12px;right:12px;background:var(--panel);border:1px solid #224355;border-radius:999px;padding:8px 12px;display:flex;gap:8px;align-items:center;box-shadow:var(--shadow);z-index:10000}
    .spinner{width:18px;height:18px;border:3px solid #2a3f4d;border-top-color:#5eb3ff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body data-report-src="/reports/demo/report.json">
  <div class="bg" aria-hidden="true"></div>

  <!-- Busy indicator (hidden until used) -->
  <div id="busy" class="busy" hidden><span class="spinner" aria-hidden="true"></span><span id="busyText">Processing…</span></div>

  <div class="wrap">
    <header>
      <div>
        <div class="title">Swing Report — P1–P9</div>
        <div class="sub">Date: <span id="date"></span> • Mode: <span id="modeLabel">Full Swing</span></div>
      </div>
      <div class="toolbar">
        <label class="badge">Swings: <span id="swingCount">1</span></label>
        <select id="discipline" class="select" title="Shot type">
          <option value="full-swing" selected>Full Swing</option>
          <option value="chipping">Chipping</option>
          <option value="putting">Putting</option>
        </select>
        <select id="focus" class="select" title="Focus filter">
          <option value="all" selected>Focus: All</option>
          <optgroup label="Upper Body">
            <option value="right-wrist">Right Wrist</option>
            <option value="left-wrist">Left Wrist</option>
            <option value="arm-bend">Arm Bend</option>
            <option value="hand-path">Hand Path</option>
            <option value="shoulder-turn">Shoulder Turn</option>
          </optgroup>
          <optgroup label="Lower Body">
            <option value="hip-movement">Hip Movement</option>
            <option value="knee-movement">Knee Movement</option>
            <option value="foot-movement">Foot / Pressure</option>
            <option value="lead-leg-brake">Lead Leg Braking</option>
          </optgroup>
          <optgroup label="Club">
            <option value="club-path">Club Path</option>
            <option value="face-angle">Club Face Angle</option>
            <option value="tempo">Timing & Tempo</option>
          </optgroup>
        </select>
        <button id="expandAll" class="btn" type="button">Expand All</button>
        <button id="collapseAll" class="btn" type="button">Collapse All</button>
        <button id="reload" class="btn" type="button">Reload Report</button>
        <button id="sample" class="btn" type="button">Load Sample</button>
        <button id="hideOverlay" class="btn" type="button">Hide Overlay</button>
      </div>
    </header>

    <div id="status" class="sub"></div>
    <div id="error" class="sub" style="color:#ff9a9a"></div>

    <section class="grid">
      <div class="card">
        <h3>Swing Consistency</h3>
        <div id="swing" class="content"></div>
      </div>
      <div class="card">
        <h3>Position Consistency</h3>
        <div id="position" class="content"></div>
      </div>
    </section>

    <section class="card" style="margin-top:12px">
      <h3>Power Score Summary</h3>
      <div id="power" class="content"></div>
    </section>

    <section style="margin-top:12px">
      <div class="sub">Click a P-section to expand. Use the Focus filter to dim everything except what you care about.</div>
      <div id="plist"></div>
    </section>
  </div>

  <!-- Progress Overlay -->
  <div id="progressOverlay" class="overlay" hidden>
    <div class="overlay-card">
      <h2><span class="spinner" style="margin-right:8px"></span>Analyzing your swing…</h2>
      <div class="sub" id="progressSub">Preparing</div>
      <div class="progress"><span id="progressFill"></span></div>
      <ul class="status-list" id="statusList"></ul>
      <div class="eta" id="eta"></div>
      <div class="eta" id="overlayMsg"></div>
      <div id="overlayActions" class="overlay-actions">
        <button id="overlayRetry" class="btn" type="button">Retry</button>
        <button id="overlayCancel" class="btn" type="button">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Video Modal -->
  <div id="videoOverlay" class="overlay" hidden>
    <div class="overlay-card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <h2 id="videoTitle">Swing Video</h2>
        <button id="videoClose" class="btn" type="button"
          onclick="(function(){try{const v=document.querySelector('#videoMount video'); if(v){v.pause()} }catch(e){}; document.getElementById('videoOverlay').hidden=true; document.getElementById('videoMount').innerHTML=''; })()">Close</button>
      </div>
      <div id="videoMount" class="content" style="aspect-ratio:16/9;display:grid;place-items:center;border:1px dashed #29424f;border-radius:12px;color:var(--muted)">No video</div>
    </div>
  </div>

  <script>
  // ---------- State ----------
  const busy = document.getElementById('busy');
  const setBusy = (on, text) => { try{ busy.hidden = !on; if(text) document.getElementById('busyText').textContent = text; }catch(_){} };
  document.getElementById('date').textContent = new Date().toLocaleDateString();

  const fmt = v => `${v}%`;
  const band = v => v>=75 ? 'ok' : v>=55 ? 'warn' : 'bad';
  const metricRow = m => `<div class="metric" data-tags="${(m.tags||[]).join(' ')}"><div class="name">${m.label}</div><div class="bar"><span class="${band(m.value)}" style="width:${m.value}%"></span></div><div class="pct">${fmt(m.value)}</div></div>`;
  const posRow    = p => `<div class="metric"><div class="name">${p.p}</div><div class="bar"><span class="${band(p.value)}" style="width:${p.value}%"></span></div><div class="pct">${fmt(p.value)}</div></div>`;

  function renderReport(data){
    if(data.discipline){ document.getElementById('modeLabel').textContent = /putt/i.test(data.discipline)?'Putting':/chip/i.test(data.discipline)?'Chipping':'Full Swing'; }
    if(data.swings!=null){ document.getElementById('swingCount').textContent = String(data.swings); }

    const swingHtml = (data.swing_metrics||[]).map(metricRow).join('') || '<div class="sub">No swing metrics.</div>';
    const posHtml   = (data.position_metrics||[]).map(posRow).join('')   || '<div class="sub">No position metrics.</div>';
    document.getElementById('swing').innerHTML = swingHtml;
    document.getElementById('position').innerHTML = posHtml;

    const p = data.power||{score:0, tempo:'—', release_timing:0};
    document.getElementById('power').innerHTML = `
      <div class="metric"><div class="name">Power Score</div><div class="bar"><span class="${band(p.score)}" style="width:${p.score}%"></span></div><div class="pct">${fmt(p.score)}</div></div>
      <div class="metric"><div class="name">Tempo</div><div class="bar"><span class="ok" style="width:76%"></span></div><div class="pct">${p.tempo}</div></div>
      <div class="metric"><div class="name">Release Timing</div><div class="bar"><span class="${band(+p.release_timing)}" style="width:${+p.release_timing||0}%"></span></div><div class="pct">${+p.release_timing||0}%</div></div>`;

    const phases = data.phases||[];
    const plist = document.getElementById('plist');
    plist.innerHTML = phases.map((ph,i)=>`
      <details ${i===0?'open':''} class="panel">
        <summary><span class="pnum">${ph.id||('P'+(i+1))}</span> <span class="pname">${ph.name||''}</span> <span class="gchip g-${(ph.grade||'ok')}" style="margin-left:8px">${String(ph.grade||'OK').toUpperCase()}</span> <span class="sub" style="margin-left:8px">${ph.short||''}</span><svg class="caret" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></summary>
        <div class="content">
          <div class="sub" style="margin-bottom:8px">${ph.short||''}</div>
          <div style="margin-bottom:10px">${ph.long||''}</div>
          <button class="btn view-video" data-url="${ph.video||ph.video_url||''}">View Video</button>
        </div>
      </details>
    `).join('') || '<div class="sub">No phases.</div>';
  }

  async function loadReport(url){
    const s=document.getElementById('status'), e=document.getElementById('error');
    e.textContent=''; s.textContent='Loading '+url+'…'; setBusy(true,'Loading report…');
    try{
      const res = await fetch(url,{cache:'no-store'});
      if(!res.ok){ s.textContent=''; e.textContent='Could not load report ('+res.status+'). Check path: '+url; setBusy(false); return; }
      const data = await res.json();
      renderReport(data); s.textContent='Loaded report: '+url; setBusy(false);
    }catch(err){ s.textContent=''; e.textContent='Failed to load report: '+(err?.message||String(err)); setBusy(false); }
  }

  // sample data to prove UI without fetch
  const sample = { swings:1, discipline:'full-swing', power:{score:78, tempo:'3.0:1', release_timing:62},
    swing_metrics:[{label:'Right Arm Angle',value:84,tags:['arm-bend']},{label:'Club Face Angle',value:79,tags:['face-angle']}],
    position_metrics:[{p:'P1',value:90},{p:'P2',value:74},{p:'P3',value:61},{p:'P4',value:55},{p:'P5',value:63},{p:'P6',value:70},{p:'P7',value:81},{p:'P8',value:86},{p:'P9',value:78}],
    phases:[
      {id:'P1',name:'Setup',short:'Athletic stance, posture aligned',long:'Neutral spine…',grade:'good'},
      {id:'P2',name:'Shaft Parallel (Backswing)',short:'Club parallel, early width',long:'—',grade:'ok'},
      {id:'P3',name:'Lead Arm Parallel (Backswing)',short:'Good extension, slight flat',long:'—',grade:'ok'},
      {id:'P4',name:'Top of Swing',short:'Full coil',long:'—',grade:'bad'},
      {id:'P5',name:'Lead Arm Parallel (Downswing)',short:'Arm drops inside',long:'—',grade:'good'},
      {id:'P6',name:'Shaft Parallel (Downswing)',short:'Shallowing, trail elbow leads',long:'—',grade:'good'},
      {id:'P7',name:'Impact',short:'Hips open, shaft lean',long:'—',grade:'ok'},
      {id:'P8',name:'Trail Arm Parallel (Follow-Through)',short:'Balanced extension',long:'—',grade:'good'},
      {id:'P9',name:'Finish',short:'Upright, balanced',long:'—',grade:'good'}] };

  // ---------- Overlay / meter ----------
  const Overlay = (()=>{
    const root = document.getElementById('progressOverlay');
    const fill = document.getElementById('progressFill');
    const sub  = document.getElementById('progressSub');
    const list = document.getElementById('statusList');
    const msg  = document.getElementById('overlayMsg');
    const eta  = document.getElementById('eta');
    const actions = document.getElementById('overlayActions');
    const steps = [
      {key:'upload', label:'Uploading video'},
      {key:'extract',label:'Extracting frames (P1–P9)'},
      {key:'pose',   label:'Pose estimation'},
      {key:'analyze',label:'Biomechanics + club math'},
      {key:'report', label:'Building reports & thumbnails'}
    ];
    let last=0, watchdog=null;
    function renderList(active){ list.innerHTML = steps.map((s,i)=>`<li class='status-item ${i<active?"done":i===active?"active":""}'><span class='dot'></span><span>${s.label}</span></li>`).join(''); }
    function notice(text='', error=false){ msg.textContent=text; msg.className='eta '+(error?'error':(text?'notice':'')); }
    return {
      start(){ root.hidden=false; fill.style.width='0%'; sub.textContent='Preparing'; renderList(0); notice(''); actions.classList.remove('show'); setBusy(true,'Uploading video…'); last=Date.now(); this.startWatchdog(); },
      set(p,label){ fill.style.width = Math.max(0,Math.min(100,p))+'%'; if(label) sub.textContent = label; last=Date.now(); notice(''); },
      complete(){ clearInterval(watchdog); setBusy(false); setTimeout(()=>root.hidden=true, 300); },
      fail(reason='Something went wrong'){ clearInterval(watchdog); notice(reason,true); actions.classList.add('show'); setBusy(true,'Error'); },
      renderList,
      startWatchdog(){ clearInterval(watchdog); const STALL=30000,HARD=180000; watchdog=setInterval(()=>{ const idle=Date.now()-last; if(idle>HARD) this.fail('Processing stalled. Please retry.'); else if(idle>STALL) { notice('Still working… taking longer than expected. You can Retry or Cancel.'); actions.classList.add('show'); } },1000); },
      steps
    };
  })();

  document.getElementById('overlayRetry').onclick = ()=>{ Overlay.start(); demoProgress(); };
  document.getElementById('overlayCancel').onclick = ()=>{ Overlay.complete(); };
  document.getElementById('hideOverlay').onclick   = ()=>{ document.getElementById('progressOverlay').hidden=true; document.getElementById('videoOverlay').hidden=true; setBusy(false); };

  function demoProgress(){
    const durs=[800,1000,1200,1000,800], pcts=[10,40,70,90,100];
    let i=0; (function run(){ if(i>=pcts.length){ Overlay.complete(); return; }
      Overlay.renderList(i); const label=Overlay.steps[i].label+'…'; const start=i? pcts[i-1]:0; const end=pcts[i]; const st=performance.now();
      (function loop(now){ const t=Math.min(1,(now-st)/durs[i]); const pct=Math.round(start+(end-start)*t); Overlay.set(pct,label); if(t<1){ requestAnimationFrame(loop);} else { i++; setTimeout(run,120);} })(st);
    })();
  }

  // ---------- Events ----------
  document.getElementById('reload').onclick = ()=>{
    const u = new URLSearchParams(location.search).get('report') || document.body.dataset.reportSrc || '/reports/demo/report.json';
    loadReport(u);
  };
  document.getElementById('sample').onclick = ()=>{ renderReport(sample); document.getElementById('status').textContent='Loaded sample (no fetch).'; };
  document.getElementById('expandAll').onclick = ()=>{ document.querySelectorAll('details.panel').forEach(d=>d.open=true); };
  document.getElementById('collapseAll').onclick = ()=>{ document.querySelectorAll('details.panel').forEach(d=>d.open=false); };
  document.getElementById('focus').addEventListener('change', e=>{
    const val=e.target.value; document.querySelectorAll('.metric').forEach(el=>{ el.classList.remove('focus-dim'); if(val==='all') return; const tags=(el.getAttribute('data-tags')||'').split(' '); if(!tags.includes(val)) el.classList.add('focus-dim'); });
  });

  // phase video buttons
  document.getElementById('plist').addEventListener('click', e=>{
    const btn = e.target.closest('.view-video'); if(!btn) return; const url = btn.getAttribute('data-url');
    const mount = document.getElementById('videoMount'); mount.innerHTML='';
    if(url){ const v=document.createElement('video'); v.controls=true; v.playsInline=true; v.style.width='100%'; v.src=url; mount.appendChild(v); }
    else { mount.textContent='No video for this phase.'; }
    document.getElementById('videoOverlay').hidden=false;
  });

  // auto-load report if provided
  const auto = new URLSearchParams(location.search).get('report') || document.body.dataset.reportSrc;
  if(auto){ loadReport(auto); }
  </script>
</body>
</html>

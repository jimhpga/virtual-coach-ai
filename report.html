<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Virtual Coach AI — Swing Report</title>
<link rel="preload" as="image" href="/homepage-background.png" />
<style>
  :root{
    --scrim: rgba(0,0,0,.06);
    --panel: rgba(10,18,24,.24);
    --line:  rgba(255,255,255,.08);
    --text:  #ecf3f7; --muted:#cfe0e6;
    --radius:16px; --shadow:0 8px 24px rgba(0,0,0,.20);
    --ok:#19c37d; --warn:#f6c453; --bad:#ff6b6b;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;color:var(--text);
    background:url('/homepage-background.png') center/cover fixed no-repeat;
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial
  }
  .scrim{min-height:100vh;background:var(--scrim)}
  .wrap{width:min(1080px,92%);margin:0 auto;padding:18px 0 42px}

  .title{font-size:26px;font-weight:800}
  .sub{color:var(--muted);font-size:13px}
  .badge{background:rgba(255,255,255,.06);border:1px solid var(--line);color:#dff3ff;padding:6px 10px;border-radius:999px;font-size:12px}
  .card,details.panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(1.5px)}
  .card h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--line)}
  .card .content{padding:12px 16px}
  .hdr{display:flex;align-items:center;justify-content:space-between;gap:10px}

  .actions{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
  .btn{border:1px solid var(--line);background:rgba(255,255,255,.10);color:#fff;padding:8px 12px;border-radius:10px;text-decoration:none;display:inline-flex;gap:8px;align-items:center;cursor:pointer}
  .btn:hover{background:rgba(255,255,255,.16)}
  .btn.primary{background:rgba(25,195,125,.18);border-color:#2a6;}
  .btn.warn{background:rgba(246,196,83,.18);border-color:#b8860b;}
  .btn.ghost{background:rgba(255,255,255,.06);}

  summary{list-style:none;display:flex;gap:10px;align-items:center;padding:14px 16px;cursor:pointer}
  summary::-webkit-details-marker{display:none}
  .pnum{width:34px;height:34px;border-radius:10px;background:#0c1820;border:1px solid var(--line);display:grid;place-items:center;font-weight:800}
  .pname{font-weight:700}
  .caret{margin-left:auto;transition:transform .2s}
  details[open] .caret{transform:rotate(180deg)}
  .gchip{font-size:12px;font-weight:800;padding:4px 8px;border-radius:999px;margin-left:8px}
  .g-good{background:var(--ok);color:#fff}
  .g-ok{background:var(--warn);color:#2a2300}
  .g-bad{background:var(--bad);color:#fff}

  .metric{display:flex;align-items:center;gap:10px;margin:9px 0}
  .metric .name{flex:0 0 210px;color:#d8ebf2}
  .bar{flex:1;height:10px;border-radius:999px;background:#10222c;border:1px solid #22404f;position:relative;overflow:hidden}
  .bar>span{position:absolute;left:0;top:0;bottom:0;border-radius:999px}
  .ok{background:linear-gradient(90deg,#19c37d,#2bd897)}
  .warn{background:linear-gradient(90deg,#f6c453,#ffd479)}
  .bad{background:linear-gradient(90deg,#ff6b6b,#ff8f8f)}
  .pct{width:52px;text-align:right;color:#cfe3ee}

  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media(max-width:960px){.grid2{grid-template-columns:1fr}}
  .info{border:1px solid var(--line);background:rgba(255,255,255,.10);color:#fff;padding:6px 10px;border-radius:10px;cursor:pointer}
  .info:hover{background:rgba(255,255,255,.16)}

  /* Modal for in-site video */
  dialog#ytModal{
    border:none; padding:0; width:min(1024px,96vw);
    background:transparent;
  }
  dialog#ytModal::backdrop{ background:rgba(0,0,0,.65) }
  .mwrap{
    background:rgba(0,0,0,.85);
    border:1px solid rgba(255,255,255,.12);
    border-radius:14px; overflow:hidden;
  }
  .mhead{
    display:flex; align-items:center; justify-content:space-between;
    padding:8px 12px; border-bottom:1px solid rgba(255,255,255,.12)
  }
  .mhead h4{margin:0; font-size:14px; color:#cfe0e6}
  .mclose{background:transparent; border:1px solid rgba(255,255,255,.2); color:#fff; padding:6px 10px; border-radius:10px; cursor:pointer}
  .mbody{width:min(1024px,96vw); height:min(576px, 56vw); background:#000}
  .mbody iframe, .mbody video{width:100%; height:100%; display:block}
</style>
</head>
<body>
  <!-- Shared nav -->
  <div id="navMount"></div>
  <script src="/nav.js?v=9" defer></script>

  <div class="scrim">
    <main class="wrap">
      <header class="hdr" style="margin-bottom:10px">
        <div>
          <div class="title">Swing Report — P1–P9</div>
          <div class="sub">Date: <span id="date"></span> • Mode: <span id="modeLabel">Full Swing</span></div>
        </div>
        <div><span class="badge">Swings: <span id="swingCount">1</span></span></div>
      </header>

      <!-- Actions -->
      <div class="actions">
        <button id="btnDownload" class="btn primary">Download</button>
        <button id="btnSend" class="btn warn">Send to Coach</button>
        <button id="btnCopy" class="btn ghost">Copy Share Link</button>
      </div>

      <!-- P1–P9 -->
      <section class="card" id="phasesCard" style="margin-top:6px">
        <h3 class="hdr">
          <span>P1–P9</span>
          <details style="display:inline-block"><summary class="info">Info</summary>
            <div class="content">Nine checkpoints from setup to finish. Short shows in the header; expand for the long explanation. Video buttons open inside this site.</div>
          </details>
        </h3>
        <div id="plist" class="content"></div>
      </section>

      <!-- Coaching -->
      <section class="card" style="margin-top:12px">
        <h3>Coaching Card</h3>
        <div class="content">
          <details class="panel" open>
            <summary><span class="pname">Top 3 Priority Fixes</span>
              <svg class="caret" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
            </summary>
            <div id="coachPriority" class="content"></div>
          </details>
          <details class="panel" style="margin-top:10px">
            <summary><span class="pname">Top 3 Power Fixes</span>
              <svg class="caret" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
            </summary>
            <div id="coachPower" class="content"></div>
          </details>
        </div>
      </section>

      <!-- Consistency -->
      <section class="grid2" style="margin-top:12px">
        <div class="card">
          <h3 class="hdr"><span>Position Consistency</span>
            <details style="display:inline-block"><summary class="info">Info</summary>
              <div class="content">How reliably you match each P-position (P1–P9) to its target window.</div>
            </details>
          </h3>
          <div id="position" class="content"></div>
        </div>
        <div class="card">
          <h3 class="hdr"><span>Swing Consistency</span>
            <details style="display:inline-block"><summary class="info">Info</summary>
              <div class="content">Repeatability across swings (tempo, face, path, etc.).</div>
            </details>
          </h3>
          <div id="swing" class="content"></div>
        </div>
      </section>

      <!-- Power -->
      <section class="card" style="margin-top:12px">
        <h3 class="hdr"><span>Power Score Summary</span>
          <details style="display:inline-block"><summary class="info">Info</summary>
            <div class="content">Overall power, tempo ratio, and release timing.</div>
          </details>
        </h3>
        <div id="power" class="content"></div>
      </section>
    </main>
  </div>

  <!-- In-site video modal -->
  <dialog id="ytModal">
    <div class="mwrap">
      <div class="mhead">
        <h4 id="mTitle">Video</h4>
        <button class="mclose" id="mClose" type="button">Close</button>
      </div>
      <div class="mbody" id="mBody"></div>
    </div>
  </dialog>

<script>
const $ = s => document.querySelector(s);
const qp = new URLSearchParams(location.search);
const reportParam = qp.get('report');
const srcParam    = qp.get('src') || '';
const reportSrc   = (reportParam === 'local') ? null : (reportParam || '/report.json');

const fmt  = v => `${v}%`;
const band = v => v>=75 ? 'ok' : v>=55 ? 'warn' : 'bad';
const chip = g => (g==='good'?'g-good':g==='ok'?'g-ok':'g-bad');
const metricRow = m => `<div class="metric"><div class="name">${m.label||m.p}</div><div class="bar"><span class="${band(m.value)}" style="width:${m.value}%"></span></div><div class="pct">${fmt(m.value)}</div></div>`;

// Build a button that we'll intercept to open modal
const linkBtn = (ref,label) =>
  `<a class="btn videolink" data-ref="${encodeURIComponent(ref)}" href="${ref}" target="_blank" rel="noopener">${label}</a>`;

function phaseRow(ph,i){
  const id = ph.id || ('P'+(i+1));
  const name = ph.name || '';
  const gRaw = String(ph.grade||'').toLowerCase();
  const grade = (gRaw==='bad') ? 'needs help' : (gRaw || 'ok');
  const short = ph.short || '';
  const long  = ph.long  || '';
  // Prefer explicit links; else fallback to a searchable query we can embed as a playlist
  const fallbackSearch = `P${i+1} ${name} golf checkpoint`;
  const ref = ph.ref || ph.video || ph.video_url || `ytsearch:${fallbackSearch}`;
  const label = ref.startsWith('blob:') ? 'Video' : 'YouTube';

  return `
  <details class="panel" ${i===0?'open':''}>
    <summary>
      <span class="pnum">${id}</span>
      <span class="pname">${name}</span>
      <span class="gchip ${chip(grade)}">${grade.toUpperCase()}</span>
      <span class="sub" style="margin-left:8px">${short}</span>
      <svg class="caret" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
    </summary>
    <div class="content">
      <div class="sub" style="margin-bottom:8px">${short}</div>
      <div style="margin-bottom:10px">${long}</div>
      ${linkBtn(ref,label)}
    </div>
  </details>`;
}

function coachItem(item){
  const title = item.title || '';
  const short = item.short || '';
  const long  = item.long  || '';
  const ref   = item.ref || `ytsearch:${title} golf drill`;
  const label = ref.startsWith('blob:') ? 'Video' : 'YouTube';
  return `<details class="panel">
    <summary><span class="pname">${title}</span><span class="sub" style="margin-left:8px">${short}</span>
      <svg class="caret" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
    </summary>
    <div class="content">
      <div style="margin-bottom:10px">${long}</div>
      ${linkBtn(ref,label)}
    </div>
  </details>`;
}

let last = null;
function renderReport(data){
  last = data || {};
  $('#date').textContent = new Date().toLocaleDateString();
  if(data.discipline){
    $('#modeLabel').textContent =
      /putt/i.test(data.discipline) ? 'Putting' :
      /chip/i.test(data.discipline) ? 'Chipping' : 'Full Swing';
  }
  if(data.swings!=null){ $('#swingCount').textContent = String(data.swings); }

  const phases = Array.isArray(data.phases)? data.phases : [];
  $('#plist').innerHTML = phases.map(phaseRow).join('') || '<div class="content sub">No phases found in report.</div>';

  const pri = (data.coaching && Array.isArray(data.coaching.priority_fixes)) ? data.coaching.priority_fixes : [];
  const pow = (data.coaching && Array.isArray(data.coaching.power_fixes)) ? data.coaching.power_fixes : [];
  $('#coachPriority').innerHTML = pri.map(coachItem).join('') || '<div class="sub">No priority fixes in report.</div>';
  $('#coachPower').innerHTML    = pow.map(coachItem).join('')    || '<div class="sub">No power fixes in report.</div>';

  $('#position').innerHTML = (data.position_metrics||[]).map(metricRow).join('') || '<div class="sub">No position metrics.</div>';
  $('#swing').innerHTML    = (data.swing_metrics||[]).map(metricRow).join('')    || '<div class="sub">No swing metrics.</div>';

  const p = data.power||{score:0, tempo:'—', release_timing:0};
  $('#power').innerHTML = `
    <div class="metric"><div class="name">Power Score</div><div class="bar"><span class="${band(+p.score||0)}" style="width:${+p.score||0}%"></span></div><div class="pct">${+p.score||0}%</div></div>
    <div class="metric"><div class="name">Tempo</div><div class="bar"><span class="ok" style="width:76%"></span></div><div class="pct">${p.tempo||'—'}</div></div>
    <div class="metric"><div class="name">Release Timing</div><div class="bar"><span class="${band(+p.release_timing||0)}" style="width:${+p.release_timing||0}%"></span></div><div class="pct">${+p.release_timing||0}%</div></div>`;
}

/* ---------- loading ---------- */
async function loadReport(url){
  try{
    const res = await fetch(url, { cache:'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const txt = await res.text();
    const data = JSON.parse(txt.trim().replace(/^\uFEFF/, ''));
    renderReport(data);
  }catch(err){
    console.error('Report load failed:', err);
    document.querySelector('main').insertAdjacentHTML('afterbegin',
      `<div class="card" style="margin-bottom:10px"><div class="content" style="color:#ffd1d1">Failed to load report: ${String(err.message||err)}</div></div>`);
  }
}

/* ---------- share & actions ---------- */
function shareUrl(){
  try{
    const u = new URL(location.href);
    if (srcParam === 'session') {
      u.searchParams.delete('src');
      u.searchParams.set('report', reportParam || '/report.json');
    } else {
      u.searchParams.set('report', reportParam || '/report.json');
    }
    return u.toString();
  }catch{ return location.href; }
}

document.getElementById('date').textContent = new Date().toLocaleDateString();

document.getElementById('btnCopy').addEventListener('click', async ()=>{
  const link = shareUrl();
  try{ await navigator.clipboard.writeText(link); alert('Share link copied'); }
  catch{ prompt('Copy link:', link); }
});

document.getElementById('btnSend').addEventListener('click', ()=>{
  const email = prompt('Coach email (e.g. coach@example.com):');
  if(!email) return;
  const p = (last && last.power) ? `Power ${last.power.score||'-'}%  Tempo ${last.power.tempo||'-'}  Release ${last.power.release_timing||'-'}%` : '';
  const subject = encodeURIComponent('Virtual Coach AI Swing Report');
  const body = encodeURIComponent(`Here is my swing report:\n${shareUrl()}\n\n${p}\n\n— sent from virtualcoachai.net`);
  location.href = `mailto:${email}?subject=${subject}&body=${body}`;
});

document.getElementById('btnDownload').addEventListener('click', ()=>{
  const html = document.documentElement.outerHTML;
  const blob = new Blob([html], {type:'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'swing-report.html';
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
});

/* ---------- in-site video: modal & embed logic ---------- */
const modal = document.getElementById('ytModal');
const mTitle = document.getElementById('mTitle');
const mBody  = document.getElementById('mBody');
document.getElementById('mClose').addEventListener('click', ()=> modal.close());
modal.addEventListener('click', (e)=>{ if(e.target === modal) modal.close(); });

function toEmbed(refRaw){
  if (!refRaw) return null;
  const ref = decodeURIComponent(refRaw);
  if (ref.startsWith('blob:')) return { kind:'blob', src:ref };
  if (ref.startsWith('ytsearch:')) {
    const q = ref.slice('ytsearch:'.length);
    return { kind:'embed', src:`https://www.youtube.com/embed?autoplay=1&rel=0&modestbranding=1&listType=search&list=${encodeURIComponent(q)}` };
  }
  try{
    const u = new URL(ref);
    const host = u.hostname.replace(/^www\./,'');
    // watch / youtu.be -> embed
    if (host === 'youtube.com' || host === 'youtube-nocookie.com'){
      const v = u.searchParams.get('v');
      if (v) return { kind:'embed', src:`https://www.youtube-nocookie.com/embed/${v}?autoplay=1&rel=0&modestbranding=1` };
      // handle /embed/VID too
      const m = u.pathname.match(/\/embed\/([A-Za-z0-9_-]{11})/);
      if (m) return { kind:'embed', src:`https://www.youtube-nocookie.com/embed/${m[1]}?autoplay=1&rel=0&modestbranding=1` };
      // search page
      const sq = u.searchParams.get('search_query');
      if (sq) return { kind:'embed', src:`https://www.youtube.com/embed?autoplay=1&rel=0&modestbranding=1&listType=search&list=${encodeURIComponent(sq)}` };
    }
    if (host === 'youtu.be'){
      const m = u.pathname.match(/^\/([A-Za-z0-9_-]{11})/);
      if (m) return { kind:'embed', src:`https://www.youtube-nocookie.com/embed/${m[1]}?autoplay=1&rel=0&modestbranding=1` };
    }
    // Unknown site: try iframe anyway (may block). Fallback handled by caller.
    return { kind:'page', src: ref };
  }catch{
    // Treat as plain search query
    return { kind:'embed', src:`https://www.youtube.com/embed?autoplay=1&rel=0&modestbranding=1&listType=search&list=${encodeURIComponent(ref)}` };
  }
}

function openModal(ref, title){
  const spec = toEmbed(ref);
  if (!spec){ window.open(ref, '_blank', 'noopener'); return; }
  mTitle.textContent = title || 'Video';
  mBody.innerHTML = '';
  if (spec.kind === 'blob'){
    const v = document.createElement('video');
    v.controls = true; v.playsInline = true; v.src = spec.src;
    mBody.appendChild(v);
  } else if (spec.kind === 'embed'){
    const f = document.createElement('iframe');
    f.src = spec.src; f.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
    f.allowFullscreen = true; f.frameBorder = "0";
    mBody.appendChild(f);
  } else {
    // Try iframe; if it errors, user still has the original link as fallback (target=_blank)
    const f = document.createElement('iframe');
    f.src = spec.src; f.referrerPolicy = "no-referrer";
    mBody.appendChild(f);
  }
  modal.showModal();
}

// Intercept clicks on video buttons
document.addEventListener('click', (e)=>{
  const a = e.target.closest('a.videolink');
  if (!a) return;
  e.preventDefault();
  const ref = a.getAttribute('data-ref');
  const title = a.closest('details')?.querySelector('.pname')?.textContent?.trim() || 'Video';
  openModal(ref, title);
});

/* ---------- boot (session or file) ---------- */
if (srcParam === 'session') {
  try{
    const raw = sessionStorage.getItem('vc_report');
    if (!raw) throw new Error('No session report found. Go to Upload and create a report.');
    renderReport(JSON.parse(raw));
  }catch(err){ console.error(err); alert(err.message || String(err)); }
} else if (reportSrc) {
  loadReport(reportSrc);
}
</script>
</body>
</html>

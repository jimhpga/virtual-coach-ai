<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Virtual Coach AI — Swing Report</title>
  <style>
    :root{
      --bg:#0e1a22; --panel:#16242e; --muted:#8aa5b5; --text:#ecf3f7; --accent:#5eb3ff;
      --ok:#19c37d; --warn:#f6c453; --bad:#ff6b6b; --chip:#1d2f3b; --radius:16px;
      --shadow:0 8px 24px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;color:var(--text);font:16px/1.45 system-ui, -apple-system, Segoe UI, Inter, Roboto, Helvetica, Arial, sans-serif;background:#0e1a22}

    /* fuller golf-course background */
    .bg{position:fixed;inset:0;background:url('/homepage-background.png') center/cover no-repeat fixed;opacity:.12;z-index:-1}
    .bg::after{content:"";position:absolute;inset:0;background:linear-gradient(180deg,rgba(10,18,24,.03),rgba(10,18,24,.03))}

    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{font-size:26px;font-weight:800;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px}

    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn,.select{background:rgba(22,36,46,.92);border:1px solid #223743;border-radius:12px;color:var(--text);padding:8px 12px;box-shadow:var(--shadow);cursor:pointer}
    .select{appearance:none;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>');background-repeat:no-repeat;background-position:right 10px center;padding-right:36px}
    .badge{background:var(--chip);border:1px solid #263b48;color:#cfe3ee;padding:6px 10px;border-radius:999px;font-size:12px}

    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}

    .card,details.panel{background:rgba(22,36,46,.9);border:1px solid #223743;border-radius:var(--radius);box-shadow:var(--shadow)}
    .card h3{margin:0;padding:14px 16px;border-bottom:1px solid #1f3340}
    .card .content{padding:12px 16px}
    details.panel+details.panel{margin-top:10px}
    summary{list-style:none;display:flex;gap:10px;align-items:center;padding:14px 16px;cursor:pointer}
    summary::-webkit-details-marker{display:none}
    .pnum{width:34px;height:34px;border-radius:10px;background:#0c1820;border:1px solid #223743;display:grid;place-items:center;font-weight:800}
    .pname{font-weight:700}
    .caret{margin-left:auto;transition:transform .2s ease}
    details[open] .caret{transform:rotate(180deg)}
    .gchip{font-size:12px;font-weight:700;padding:3px 8px;border-radius:8px;border:1px solid #27404f;background:var(--chip)}
    .g-good{color:var(--ok)} .g-ok{color:var(--warn)} .g-bad{color:var(--bad)}

    .metric{display:flex;align-items:center;gap:10px;margin:9px 0}
    .metric .name{flex:0 0 210px;color:#cfe3ee}
    .bar{flex:1;height:10px;border-radius:999px;background:#10222c;border:1px solid #22404f;position:relative;overflow:hidden}
    .bar>span{position:absolute;left:0;top:0;bottom:0;border-radius:999px}
    .ok{background:linear-gradient(90deg,var(--ok),#2bd897)}
    .warn{background:linear-gradient(90deg,var(--warn),#ffd479)}
    .bad{background:linear-gradient(90deg,var(--bad),#ff8f8f)}
    .pct{width:52px;text-align:right;color:#cfe3ee}
    .focus-dim{opacity:.35;filter:saturate(.5)}
    .footnote{color:var(--muted);font-size:12px;margin-top:6px}

    /* print for Save as PDF */
    @media print{
      body{background:white;color:black}
      .bg{opacity:.06}
      .toolbar,.busy,#status,#error,#hideOverlay{display:none!important}
      .wrap{max-width:100%}
      .card,details.panel{box-shadow:none}
    }

    /* overlays + busy */
    .overlay{position:fixed;inset:0;background:rgba(8,16,22,.72);backdrop-filter:saturate(120%) blur(2px);display:grid;place-items:center;z-index:9999}
    .overlay[hidden]{display:none !important}
    .overlay-card{width:min(720px,92vw);background:var(--panel);border:1px solid #224355;border-radius:18px;box-shadow:var(--shadow);padding:20px}
    .overlay h2{margin:0 0 8px 0;font-size:20px}
    .overlay .sub{color:var(--muted);margin-bottom:12px}
    .progress{height:14px;border-radius:999px;background:#0f2230;border:1px solid #22404f;overflow:hidden}
    .progress>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,#4aa3ff,#19c37d)}
    .busy{position:fixed;top:12px;right:12px;background:var(--panel);border:1px solid #224355;border-radius:999px;padding:8px 12px;display:flex;gap:8px;align-items:center;box-shadow:var(--shadow);z-index:10000}
    .busy[hidden]{display:none!important}
    .spinner{width:18px;height:18px;border:3px solid #2a3f4d;border-top-color:#5eb3ff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body data-report-src="/reports/demo/report.json">
  <div class="bg" aria-hidden="true"></div>

  <div id="busy" class="busy" hidden><span class="spinner" aria-hidden="true"></span><span id="busyText">Processing…</span></div>

  <div class="wrap">
    <header>
      <div>
        <div class="title">Swing Report — P1–P9</div>
        <div class="sub">Date: <span id="date"></span> • Mode: <span id="modeLabel">Full Swing</span></div>
      </div>
      <div class="toolbar">
        <label class="badge">Swings: <span id="swingCount">1</span></label>
        <select id="discipline" class="select" title="Shot type">
          <option value="full-swing" selected>Full Swing</option>
          <option value="chipping">Chipping</option>
          <option value="putting">Putting</option>
        </select>
        <select id="focus" class="select" title="Focus filter">
          <option value="all" selected>Focus: All</option>
          <optgroup label="Upper Body">
            <option value="right-wrist">Right Wrist</option>
            <option value="left-wrist">Left Wrist</option>
            <option value="arm-bend">Arm Bend</option>
            <option value="hand-path">Hand Path</option>
            <option value="shoulder-turn">Shoulder Turn</option>
          </optgroup>
          <optgroup label="Lower Body">
            <option value="hip-movement">Hip Movement</option>
            <option value="knee-movement">Knee Movement</option>
            <option value="foot-movement">Foot / Pressure</option>
            <option value="lead-leg-brake">Lead Leg Braking</option>
          </optgroup>
          <optgroup label="Club">
            <option value="club-path">Club Path</option>
            <option value="face-angle">Club Face Angle</option>
            <option value="tempo">Timing & Tempo</option>
          </optgroup>
        </select>
        <button id="expandAll" class="btn" type="button">Expand All</button>
        <button id="collapseAll" class="btn" type="button">Collapse All</button>
        <button id="reload" class="btn" type="button">Reload</button>
        <button id="sample" class="btn" type="button">Load Sample</button>

        <!-- Share / Export -->
        <button id="shareBtn" class="btn" type="button" title="Share via device">Share</button>
        <button id="emailBtn" class="btn" type="button" title="Email this report">Email</button>
        <button id="smsBtn" class="btn" type="button" title="Text this report">Text</button>
        <button id="printBtn" class="btn" type="button" title="Print / Save PDF">Print/PDF</button>
        <button id="exportJsonBtn" class="btn" type="button" title="Download JSON">Export JSON</button>

        <button id="hideOverlay" class="btn" type="button">Hide Overlay</button>
      </div>
    </header>

    <div id="status" class="sub"></div>
    <div id="error" class="sub" style="color:#ff9a9a"></div>

    <section class="grid">
      <div class="card">
        <h3>Swing Consistency</h3>
        <div id="swing" class="content"></div>
      </div>
      <div class="card">
        <h3>Position Consistency</h3>
        <div id="position" class="content"></div>
      </div>
    </section>

    <section class="card" style="margin-top:12px">
      <h3>Power Score Summary</h3>
      <div id="power" class="content"></div>
    </section>

    <section style="margin-top:12px">
      <div class="sub">Click a P-section to expand. Use the Focus filter to dim everything except what you care about.</div>
      <div id="plist"></div>
    </section>

    <section class="card" style="margin-top:12px">
      <h3>Coaching Card</h3>
      <div class="content">
        <details class="panel" open>
          <summary><span class="pname">Top 3 Priority Fixes</span><svg class="caret" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></summary>
          <div id="coachPriority"></div>
        </details>
        <details class="panel" style="margin-top:10px">
          <summary><span class="pname">Top 3 Power Fixes</span><svg class="caret" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></summary>
          <div id="coachPower"></div>
        </details>
      </div>
    </section>

    <section class="card" style="margin-top:12px">
      <h3>14-Day Practice Plan</h3>
      <div id="practice" class="content"></div>
    </section>
  </div>

  <!-- Progress Overlay -->
  <div id="progressOverlay" class="overlay" hidden>
    <div class="overlay-card">
      <h2><span class="spinner" style="margin-right:8px"></span>Analyzing your swing…</h2>
      <div class="sub" id="progressSub">Preparing</div>
      <div class="progress"><span id="progressFill"></span></div>
      <div class="eta" id="eta"></div>
      <div class="eta" id="overlayMsg"></div>
      <div id="overlayActions" class="overlay-actions">
        <button id="overlayRetry" class="btn" type="button">Retry</button>
        <button id="overlayCancel" class="btn" type="button">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Video Modal -->
  <div id="videoOverlay" class="overlay" hidden>
    <div class="overlay-card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <h2 id="videoTitle">Swing Video</h2>
        <button id="videoClose" class="btn" type="button"
          onclick="(function(){try{const v=document.querySelector('#videoMount video'); if(v){v.pause()} }catch(e){}; document.getElementById('videoOverlay').hidden=true; document.getElementById('videoMount').innerHTML=''; })()">Close</button>
      </div>
      <div id="videoMount" class="content" style="aspect-ratio:16/9;display:grid;place-items:center;border:1px dashed #29424f;border-radius:12px;color:var(--muted)">No video</div>
    </div>
  </div>

  <script>
    // ---------- State & helpers ----------
    const busy = document.getElementById('busy');
    const setBusy = (on, text) => { try{ busy.hidden = !on; if(text) document.getElementById('busyText').textContent = text; }catch(_){} };
    document.getElementById('date').textContent = new Date().toLocaleDateString();

    let lastData = null;
    let currentReportURL = null;

    const fmt = v => `${v}%`;
    const band = v => v>=75 ? 'ok' : v>=55 ? 'warn' : 'bad';
    const metricRow = m => `<div class="metric" data-tags="${(m.tags||[]).join(' ')}"><div class="name">${m.label}</div><div class="bar"><span class="${band(m.value)}" style="width:${m.value}%"></span></div><div class="pct">${fmt(m.value)}</div></div>`;
    const posRow    = p => `<div class="metric"><div class="name">${p.p}</div><div class="bar"><span class="${band(p.value)}" style="width:${p.value}%"></span></div><div class="pct">${fmt(p.value)}</div></div>`;

    // -------- Expanded P1–P9 guidance --------
    const defaultLong = {
      P1: `<strong>Setup — Checklist</strong><br><ul><li>Stance shoulder-width; weight 55/45 lead/trail under the arches (not toes).</li><li>Neutral grip: lead wrist flat, V’s toward trail shoulder; trail hand supports from below.</li><li>Pelvis neutral (no dump), chest proud, chin off chest; eye line level.</li><li>Ball position: wedges center, mid-irons one ball forward, driver inside lead heel.</li></ul><em>Common misses:</em> slumped spine, too-strong/weak grip, weight in toes. <em>Fix:</em> club-across-hips for neutral tilt; 3-breath reset.`,
      P2: `<strong>Shaft Parallel (Backswing) — Keys</strong><br><ul><li>Shaft parallel to ground/target; width maintained (hands in front of chest).</li><li>Lead wrist trending flat; trail wrist sets—no snatch.</li><li>Clubface near toe-up (neutral), not skyward or shut.</li></ul><em>Check:</em> butt end just outside toes. <em>Drill:</em> half-back to P2 × 10, freeze, then through.`,
      P3: `<strong>Lead Arm Parallel — Structure</strong><br><ul><li>Lead arm parallel; trail elbow folds in front of ribcage (no flyaway).</li><li>Hands keep a forearm’s width from chest; width preserved.</li><li>Shaft on plane; pelvis turns (no sway).</li></ul><em>Misses:</em> across-the-line, lift, collapse. <em>Feel:</em> rotate ribcage, not just arms.`,
      P4: `<strong>Top — Loaded & Organized</strong><br><ul><li>Pressure into trail heel; trail hip deep (space behind pelvis).</li><li>Lead wrist nearer flat/bowed; club not wildly across/laid off.</li><li>Head stable; thorax over trail thigh (no reverse spine).</li></ul><em>Self-test:</em> can you start down without shifting right? If not, you swayed. <em>Drill:</em> wall-hip depth—light glute contact.`,
      P5: `<strong>Transition — Sequencing</strong><br><ul><li>Lower body leads: pressure to lead mid-foot; pelvis opens before chest.</li><li>Shaft shallows slightly; trail elbow in front of side seam.</li><li>Lead-wrist flexion sustains face control; handle lowers as chest stays on it.</li></ul><em>Keys:</em> bump → open → deliver. <em>Drill:</em> step-through × 8, then normal × 4.`,
      P6: `<strong>Delivery — On-Plane Speed</strong><br><ul><li>Shaft parallel again; hands slightly ahead; clubhead trails with retained lag.</li><li>Face square to path window; trail elbow tucked; pelvis keeps turning.</li><li>Hand path slightly in-to-out (irons) unless shot shape dictates.</li></ul><em>Checkpoint:</em> lead wrist near flat; handle height echoes setup.`,
      P7: `<strong>Impact — Ball First, Face Square</strong><br><ul><li>Forward shaft lean; low point forward (irons).</li><li>Pelvis 30–45° open; chest 10–20°; lead leg posting (not collapsing).</li><li>Face near square to path; strike ball then turf.</li></ul><em>Drills:</em> two-tee gate; line-strike; “press-and-go” preset for lean.`,
      P8: `<strong>Post-Impact — Extension & Rotation</strong><br><ul><li>Trail arm extends; hands work up/left; chest rises and rotates left.</li><li>Rate of closure controlled—no flip; divot continues target-side.</li><li>Pressure into lead heel; trail foot rolls to instep.</li></ul><em>Feel:</em> knuckles to the sky by waist-high as handle moves around.`,
      P9: `<strong>Finish — Balanced & Reproducible</strong><br><ul><li>Weight fully lead-side; belt buckle & sternum to target; trail toe down.</li><li>Club wraps around body; spine tall; hold pose 2–3 seconds.</li></ul><em>Test:</em> hold the finish and talk—if you’re huffing, you over-swung.`
    };

    function renderReport(data){
      lastData = data;
      if(data.discipline){ document.getElementById('modeLabel').textContent = /putt/i.test(data.discipline)?'Putting':/chip/i.test(data.discipline)?'Chipping':'Full Swing'; }
      if(data.swings!=null){ document.getElementById('swingCount').textContent = String(data.swings); }

      const swingHtml = (data.swing_metrics||[]).map(metricRow).join('') || '<div class="sub">No swing metrics.</div>';
      const posHtml   = (data.position_metrics||[]).map(posRow).join('')   || '<div class="sub">No position metrics.</div>';
      document.getElementById('swing').innerHTML = swingHtml;
      document.getElementById('position').innerHTML = posHtml;

      const p = data.power||{score:0, tempo:'—', release_timing:0};
      document.getElementById('power').innerHTML = `
        <div class="metric"><div class="name">Power Score</div><div class="bar"><span class="${band(p.score)}" style="width:${p.score}%"></span></div><div class="pct">${fmt(p.score)}</div></div>
        <div class="metric"><div class="name">Tempo</div><div class="bar"><span class="ok" style="width:76%"></span></div><div class="pct">${p.tempo}</div></div>
        <div class="metric"><div class="name">Release Timing</div><div class="bar"><span class="${band(+p.release_timing)}" style="width:${+p.release_timing||0}%"></span></div><div class="pct">${+p.release_timing||0}%</div></div>`;

      // P1–P9
      let phases = Array.isArray(data.phases) ? data.phases.slice() : [];
      if(!phases.length){
        const names = ['Setup','Shaft Parallel (Backswing)','Lead Arm Parallel (Backswing)','Top of Swing','Lead Arm Parallel (Downswing)','Shaft Parallel (Downswing)','Impact','Trail Arm Parallel (Follow-Through)','Finish'];
        const pm = data.position_metrics||[];
        for(let i=0;i<9;i++){
          const pid = 'P'+(i+1);
          const m = pm.find(x=>String(x.p).toUpperCase()===pid) || {value:0};
          const g = m.value>=75?'good':m.value>=55?'ok':'bad';
          phases.push({id:pid,name:names[i],short:'',long:'',grade:g});
        }
      }
      const plist = document.getElementById('plist');
      plist.innerHTML = phases.map((ph,i)=>`
        <details ${i===0?'open':''} class="panel">
          <summary><span class="pnum">${ph.id||('P'+(i+1))}</span> <span class="pname">${ph.name||''}</span> <span class="gchip g-${(ph.grade||'ok')}" style="margin-left:8px">${String(ph.grade||'OK').toUpperCase()}</span> <span class="sub" style="margin-left:8px">${ph.short||''}</span><svg class="caret" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></summary>
          <div class="content">
            <div class="sub" style="margin-bottom:8px">${ph.short||''}</div>
            <div style="margin-bottom:10px">${(ph.long && ph.long.trim() && ph.long.trim() !== (ph.short||'').trim()) ? ph.long : (defaultLong[ph.id||('P'+(i+1))]||'')}</div>
            <button class="btn view-video" data-url="${ph.video||ph.video_url||''}">View Video</button>
          </div>
        </details>
      `).join('');

      renderCoaching(data);
      renderPractice(data);
    }

    function renderCoaching(data){
      const pri = (data.coaching && Array.isArray(data.coaching.priority_fixes)) ? data.coaching.priority_fixes : [
        {title:'Face Control from P5→P7', short:'Stabilize the clubface through delivery.',
         long:'Problem: face drifts open in transition and slams shut late. Solution: keep lead-wrist flexion from P5 to P6 while pelvis opens. Maintain logo-to-target feel through P7. Micro-drills: P5→P6 pump × 3 then strike (8 sets); impact bag with bowed lead wrist × 8; two-tee gate at ball.'},
        {title:'Lower-Body Sequence & Pressure', short:'Open the hips before the hands.',
         long:'Problem: hands fire first and pelvis stalls. Solution: shift pressure to lead mid-foot as belt buckle opens while chest stays on the ball. Drills: step-through × 10; split-stance downswing × 10; med-ball bump-and-open throws × 6.'},
        {title:'Width & Hand-Path', short:'Keep space; avoid across-the-line.',
         long:'Problem: width collapses at P3; handle across chest. Solution: keep a forearm’s width from sternum; trail elbow in front of ribcage. Drills: alignment-stick across chest turns × 10; P3→mini-P4→P5 wide pumps × 6; towel under trail arm × 10.'}
      ];
      const pow = (data.coaching && Array.isArray(data.coaching.power_fixes)) ? data.coaching.power_fixes : [
        {title:'Tempo to ~3:1', short:'Smooth backswing, crisp through.',
         long:'Backswing outruns transition. Count one-two-three back, one through. Use 72–76 bpm and strike on every 4th tick. Ladder: 10 balls @70%, 10 @80%, 10 @90%—same cadence.'},
        {title:'Lead-Leg Brake', short:'Post harder to transfer speed.',
         long:'Turn linear speed into rotation by posting into the lead leg from P4; straighten through P5–P6. Drills: stick outside lead hip—miss it left × 12; jump-stop swings × 10; step-plant-post × 10.'},
        {title:'Late Release Timing', short:'Deliver max speed at P7→P8.',
         long:'Hold wrist angles until P6; unhinge through the ball, not at it. Drills: two-tee gate; smash-factor ladder with half swings; “throw the clubhead past the hands” feel after impact.'}
      ];
      const mk = item=>`<details class="panel"><summary><span class="pname">${item.title}</span><span class="sub" style="margin-left:8px">${item.short||''}</span><svg class="caret" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></summary><div class="content">${item.long||''}</div></details>`;
      document.getElementById('coachPriority').innerHTML = pri.map(mk).join('');
      document.getElementById('coachPower').innerHTML   = pow.map(mk).join('');
    }

    function renderPractice(data){
      const plan = (data.practice_plan && Array.isArray(data.practice_plan)) ? data.practice_plan : [
        {day:1, title:'Baseline & Tempo', drills:['Record front/side swings (5 each).','Metronome 72 bpm: 3:1 cadence × 20 swings.','Gate drill (two tees) × 20 focusing start line.']},
        {day:2, title:'Width & Hand-Path', drills:['Pump P3→mini-P4→P5 “wide” × 12.','Alignment-stick across chest turns × 10.','9-to-3 contact set × 25 (centered).']},
        {day:3, title:'Transition Sequencing', drills:['Step-through drill × 12 (lead hip opens).','Split-stance downswing × 10.','Normal swings × 20; film P4→P6.']},
        {day:4, title:'Face Control', drills:['Impact bag with bowed lead wrist × 12.','Hold-to-P6 rehearsals × 10, then strike × 10.','Start-line ladder: 5L/5R/10 straight.']},
        {day:5, title:'Low-Point & Compression', drills:['Line-strike on turf: clip in front × 20.','Ball-then-turf brush swings × 20.','9-iron contact test × 15 filmed.']},
        {day:6, title:'Lead-Leg Brake', drills:['Stick outside lead hip—miss left × 12.','Jump-stop swings × 10.','Full swings × 20 (track carry if possible).']},
        {day:7, title:'Review (Light)', drills:['Pick weakest of Days 1–6: 2 drills × 10.','Tempo calibration × 15.','Film two swings for compare.']},
        {day:8, title:'Pressure Shift & Footwork', drills:['Feet-together → normal swings × 12.','Step-plant-post sequence × 12.','Hold finish 3s × 15.']},
        {day:9, title:'Delivery Window (P6)', drills:['Freeze at P6 then hit × 12.','Two-tee gate (narrow) × 15.','Face-to-path mini-ladder × 15.']},
        {day:10,title:'Speed Without Effort', drills:['Speed sticks/overspeed 3×5 (if available).','90% intent with 3:1 tempo × 15.','Finish-hold test × 10.']},
        {day:11,title:'Trajectory & Start Line', drills:['Knock-down 9-to-3 × 15.','High-flight with same face control × 10.','Start-line randomizer: aim gates × 20.']},
        {day:12,title:'On-Course Transfer', drills:['Randomize clubs/targets × 20.','Pre-shot routine: 2 rehearsals then go.','Keep score for 20-ball set (FW/GIR).']},
        {day:13,title:'Gap Plug — Weakest Link', drills:['Pick the lowest metric (e.g., P4 or face).','Run two targeted drills × 12 each.','Film before/after (2 swings each).']},
        {day:14,title:'Retest & Lock-In', drills:['Re-record front/side like Day 1.','Best-of-10 with routine.','Write 3 cues that worked—keep for next block.']}
      ];
      document.getElementById('practice').innerHTML = plan.map(d=>`
        <details class="panel" ${d.day===1?'open':''}>
          <summary><span class="pname">Day ${d.day}</span> <span class="sub" style="margin-left:8px">${d.title||''}</span><svg class="caret" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></summary>
          <div class="content">${(d.drills||[]).map(x=>`<div>• ${x}</div>`).join('')||'<div class="sub">No drills provided.</div>'}</div>
        </details>
      `).join('');
    }

    // -------- Loader (simple + clear error) --------
    function loadReport(url){
      const s=document.getElementById('status'), e=document.getElementById('error');
      e.textContent=''; s.innerHTML='Loading <a href="'+url+'" target="_blank" rel="noopener">'+url+'</a>…';
      fetch(url,{cache:'no-store'})
        .then(res=>{ if(!res.ok) throw new Error('HTTP '+res.status); return res.json(); })
        .then(data=>{ currentReportURL=url; renderReport(data); s.innerHTML='Loaded: <a href="'+url+'" target="_blank" rel="noopener">'+url+'</a>'; })
        .catch(err=>{ e.textContent='Failed to load report: '+(err&&err.message?err.message:String(err)); });
    }

    // -------- Share / Export --------
    function shareURL(){
      const base = location.origin + location.pathname;
      const u = currentReportURL || new URLSearchParams(location.search).get('report') || document.body.dataset.reportSrc;
      return base + '?report=' + encodeURIComponent(u||'');
    }
    function emailBody(data){
      const p = data && data.power ? data.power : {};
      const parts = [
        'Virtual Coach AI — Swing Report',
        'Date: '+new Date().toLocaleDateString(),
        'Swings: '+(data&&data.swings!=null? data.swings : '—'),
        'Power: '+(p.score!=null? p.score+'%' : '—'),
        'Tempo: '+(p.tempo||'—'),
        'Priorities: '+(((data&&data.coaching&&data.coaching.priority_fixes)||[]).slice(0,3).map((x,i)=> (i+1)+'. '+x.title).join(' | ')||'(see report)'),
        'View: '+shareURL()
      ];
      return parts.join(' | ');
    }

    const sample = { swings:1, discipline:'full-swing', power:{score:78, tempo:'3.0:1', release_timing:62},
      swing_metrics:[
        {label:'Right Arm Angle',value:84,tags:['arm-bend']},
        {label:'Club Face Angle',value:79,tags:['face-angle']},
        {label:'Shoulder Turn',value:72,tags:['shoulder-turn']},
        {label:'Hip Turn',value:68,tags:['hip-movement']},
        {label:'X-Factor (Shoulder–Hip)',value:64,tags:['sequence']},
        {label:'Club Path',value:71,tags:['club-path']},
        {label:'Face-to-Path',value:66,tags:['face-angle']},
        {label:'Attack Angle',value:62,tags:['delivery']}
      ],
      position_metrics:[{p:'P1',value:90},{p:'P2',value:74},{p:'P3',value:61},{p:'P4',value:55},{p:'P5',value:63},{p:'P6',value:70},{p:'P7',value:81},{p:'P8',value:86},{p:'P9',value:78}],
      phases:[
        {id:'P1',name:'Setup',short:'Athletic stance, posture aligned',long:'',grade:'good'},
        {id:'P2',name:'Shaft Parallel (Backswing)',short:'Club parallel, early width',long:'',grade:'ok'},
        {id:'P3',name:'Lead Arm Parallel (Backswing)',short:'Good extension, slight flat',long:'',grade:'ok'},
        {id:'P4',name:'Top of Swing',short:'Full coil',long:'',grade:'bad'},
        {id:'P5',name:'Lead Arm Parallel (Downswing)',short:'Arm drops inside',long:'',grade:'good'},
        {id:'P6',name:'Shaft Parallel (Downswing)',short:'Shallowing, trail elbow leads',long:'',grade:'good'},
        {id:'P7',name:'Impact',short:'Hips open, shaft lean',long:'',grade:'ok'},
        {id:'P8',name:'Trail Arm Parallel (Follow-Through)',short:'Balanced extension',long:'',grade:'good'},
        {id:'P9',name:'Finish',short:'Upright, balanced',long:'',grade:'good'}]
    };

    // Buttons
    document.getElementById('reload').onclick = ()=>{
      const u = new URLSearchParams(location.search).get('report') || document.body.dataset.reportSrc || '/reports/demo/report.json';
      currentReportURL = u; loadReport(u);
    };
    document.getElementById('sample').onclick = ()=>{ currentReportURL = '(sample)'; lastData = sample; renderReport(sample); document.getElementById('status').textContent='Loaded sample (no fetch).'; };
    document.getElementById('expandAll').onclick = ()=>{ document.querySelectorAll('details.panel').forEach(d=>d.open=true); };
    document.getElementById('collapseAll').onclick = ()=>{ document.querySelectorAll('details.panel').forEach(d=>d.open=false); };
    document.getElementById('focus').addEventListener('change', e=>{
      const val=e.target.value; document.querySelectorAll('.metric').forEach(el=>{ el.classList.remove('focus-dim'); if(val==='all') return; const tags=(el.getAttribute('data-tags')||'').split(' '); if(!tags.includes(val)) el.classList.add('focus-dim'); });
    });

    // Share / Export actions
    document.getElementById('printBtn').onclick = ()=> window.print();
    document.getElementById('exportJsonBtn').onclick = ()=>{
      try{
        const data = lastData || sample;
        const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        const name = 'swing-report-'+(data&&data.meta&&data.meta.player?data.meta.player:'player')+'-'+new Date().toISOString().slice(0,10)+'.json';
        a.download = name.replace(/\s+/g,'-'); a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href), 3000);
      }catch(err){ alert('Could not export JSON: '+(err&&err.message?err.message:String(err))); }
    };
    document.getElementById('shareBtn').onclick = async ()=>{
      try{
        const url = shareURL();
        if(navigator.share){ await navigator.share({title:'Virtual Coach AI — Swing Report', text:'My swing report', url}); }
        else{ await navigator.clipboard.writeText(url); alert('Share link copied:\n'+url); }
      }catch(err){ console.warn('Share failed', err); }
    };
    document.getElementById('emailBtn').onclick = ()=>{
      const data = lastData || sample;
      const subject = encodeURIComponent('Virtual Coach AI — Swing Report');
      const body = encodeURIComponent(emailBody(data));
      location.href = 'mailto:?subject='+subject+'&body='+body;
    };
    document.getElementById('smsBtn').onclick = ()=>{
      const data = lastData || sample;
      const body = encodeURIComponent(emailBody(data));
      location.href = 'sms:?&body='+body; // best on mobile
    };

    // Phase video modal
    document.getElementById('plist').addEventListener('click', e=>{
      const btn = e.target.closest('.view-video'); if(!btn) return; const url = btn.getAttribute('data-url');
      const mount = document.getElementById('videoMount'); mount.innerHTML='';
      if(url){ const v=document.createElement('video'); v.controls=true; v.playsInline=true; v.style.width='100%'; v.src=url; mount.appendChild(v); }
      else { mount.textContent='No video for this phase.'; }
      document.getElementById('videoOverlay').hidden=false;
    });

    // Auto-load report if provided
    const auto = new URLSearchParams(location.search).get('report') || document.body.dataset.reportSrc;
    if(auto){ currentReportURL = auto; loadReport(auto); }

    // safety: overlays off on load
    window.addEventListener('load', ()=>{ try{ busy.hidden=true; document.getElementById('progressOverlay').hidden=true; document.getElementById('videoOverlay').hidden=true; }catch(_){} });
    document.getElementById('hideOverlay').onclick = ()=>{ document.getElementById('progressOverlay').hidden=true; document.getElementById('videoOverlay').hidden=true; busy.hidden=true; };
  </script>
</body>
</html>

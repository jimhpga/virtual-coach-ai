<!doctype html>
<html lang="en">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Virtual Coach AI — Swing Report (P1–P9)</title>
<style>
  :root{--ink:#000;--mut:#333;--bd:#0002;--chip:#0001;--chipbd:#0003}
  html,body{background:#fff;color:var(--ink)}
  body{margin:0;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  main{max-width:1100px;margin:24px auto;padding:0 16px}
  .grid{display:grid;gap:14px}.g-2{grid-template-columns:repeat(2,1fr)}.g-3{grid-template-columns:repeat(3,1fr)}
  @media (max-width:900px){.g-3{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:640px){.g-2,.g-3{grid-template-columns:1fr}}
  .card{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:14px}
  .card h3{margin:0 0 8px;font-size:15px}
  .muted{color:var(--mut)} .score{font-size:34px;font-weight:800}
  .chip{display:inline-block;background:var(--chip);border:1px solid var(--chipbd);border-radius:999px;padding:4px 8px;margin:2px 4px}
  table{border-collapse:collapse;width:100%} th,td{border:1px solid var(--bd);padding:6px;text-align:left} th{background:#00000008}
  .sev{font-weight:700;text-transform:capitalize}.sev.high{color:#b02a37}.sev.medium{color:#b36b00}.sev.low{color:#0f7a56}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin:16px auto;max-width:1100px;padding:0 16px}
  header .right{display:flex;gap:8px;align-items:center}
  button,a.btn{font:inherit;padding:8px 10px;border:1px solid var(--bd);border-radius:8px;background:#fff;color:inherit;text-decoration:none;cursor:pointer}
  #log{max-width:1100px;margin:8px auto 0;padding:0 16px;color:#b02a37;white-space:pre-wrap}
  @page { size: Letter; margin: 12mm }
</style>

<header>
  <h1 style="margin:0">Virtual Coach AI — Swing Report (P1–P9)</h1>
  <div class="right">
    <span id="build-badge" class="muted">loading…</span>
    <a id="printLink" class="btn" target="_blank" rel="noopener">Print PDF</a>
  </div>
</header>

<main id="report-root">
  <div class="card"><h3>Status</h3><div class="muted">Loading…</div></div>
</main>
<div id="log"></div>

<script>
(function(){
  const els = {
    root: document.getElementById('report-root'),
    log:  document.getElementById('log'),
    print: document.getElementById('printLink'),
    badge: document.getElementById('build-badge'),
  };
  const log = (m,err=false)=>{ els.log.textContent = (err?'❌ ':'ℹ️ ')+m; (err?console.error:console.log)(m); };

  // ---------- helpers ----------
  function fullDecode(s){ let p; do{ p=s; try{s=decodeURIComponent(s)}catch{break} } while(s!==p); return s; }
  function normalizeReport(r){
    // produce a shape the UI expects without losing data
    const out = {...r};

    // meta → top-level convenience
    if (r && r.meta){
      out.mode   ??= r.meta.mode;
      out.swings ??= r.meta.swings;
      out.date   ??= r.meta.date;
    }

    // map topFixes → top3PriorityFixes (string or object with .code)
    if (!out.top3PriorityFixes && Array.isArray(r?.topFixes)){
      const arr = r.topFixes.map(x => typeof x === 'string' ? x : (x?.code || '')).filter(Boolean);
      if (arr.length) out.top3PriorityFixes = arr.slice(0,3);
    }

    // power → powerScoreSummary + swingScore fallback
    if (!out.powerScoreSummary){
      let sv = null;
      if (typeof r?.power === 'number') sv = r.power;
      else if (typeof r?.power?.score === 'number') sv = r.power.score;
      else if (typeof r?.consistency?.swing === 'number') sv = r.consistency.swing;
      if (sv == null) sv = 0;
      out.powerScoreSummary = { value: sv, notes: r?.note || '' };
    }
    if (out.swingScore == null) out.swingScore = out.powerScoreSummary.value;

    // consistency → swingConsistency / positionConsistency
    if (r?.consistency){
      if (!out.swingConsistency){
        const sv = r.consistency.swing;
        out.swingConsistency = (typeof sv === 'number') ? { value: sv } : (sv || undefined);
      }
      if (!out.positionConsistency && Array.isArray(r.consistency.position)){
        out.positionConsistency = r.consistency.position.map(p => ({
          position: p.position || p.pos || p.id || '',
          value:    (p.value ?? p.score ?? 0)
        }));
      }
    }

    // phases → checkpoints if checkpoints missing
    if (!out.checkpoints && Array.isArray(r?.phases)){
      const cp = {};
      r.phases.forEach(p=>{
        const id    = p.id || p.position || p.pos || '';
        const title = p.title || p.name || '';
        const label = p.label || p.note || '';
        if (id) cp[id] = { id, title, notes: label };
      });
      if (Object.keys(cp).length) out.checkpoints = cp;
    }

    // checkpoints fallback to P1–P9 labels
    if (!out.checkpoints){
      out.checkpoints = {
        P1:{id:'P1',title:'Address (Grip/Posture)',notes:''},
        P2:{id:'P2',title:'Takeaway',notes:''},
        P3:{id:'P3',title:'Lead Arm Parallel',notes:''},
        P4:{id:'P4',title:'Top of Backswing',notes:''},
        P5:{id:'P5',title:'Early Downswing',notes:''},
        P6:{id:'P6',title:'Delivery (Shaft Parallel)',notes:''},
        P7:{id:'P7',title:'Impact',notes:''},
        P8:{id:'P8',title:'Early Follow-Through',notes:''},
        P9:{id:'P9',title:'Finish',notes:''},
      };
    }

    // faults: normalize strings/objects; seed if empty
    const normFaults = (Array.isArray(r?.faults)? r.faults : []).map(f=>{
      if (typeof f === 'string') return { code:f, severity:'medium', desc:'' };
      return {
        code: f?.code || f?.name || 'unknown',
        severity: f?.severity || 'medium',
        desc: f?.desc || f?.description || ''
      };
    });
    if (!normFaults.length){
      const sv = out.swingScore ?? 75;
      if (sv < 85) normFaults.push({code:'Early Extension', severity:'high',   desc:'Hips move toward ball; crowding at impact'});
      if (sv < 90) normFaults.push({code:'Over-the-Top',    severity:'medium', desc:'Out-to-in path; pulls & weak fades'});
      if (!normFaults.length) normFaults.push({code:'Minor Tempo Drift',severity:'low',desc:'Keep backswing:downswing ~3:1'});
    }
    out.faults = normFaults;

    // drills: normalize strings/objects; seed from faults if empty
    let normDrills = (Array.isArray(r?.drills)? r.drills : []).map(d=>{
      if (typeof d === 'string') return {for:'',title:d,why:'',how:'',youtube:''};
      return {
        for: d?.for || d?.target || '',
        title: d?.title || d?.name || 'Drill',
        why: d?.why || d?.reason || '',
        how: d?.how || d?.steps || d?.instructions || '',
        youtube: d?.youtube || d?.video || ''
      };
    });
    if (!normDrills.length){
      normDrills = out.faults.map(f=>{
        if (/Early Extension/i.test(f.code)) return {for:'Early Extension', title:'Chair-Butt Drill', why:'Keeps pelvis back through impact', how:'Chair behind hips; maintain light contact P6–P8 (20 reps)', youtube:''};
        if (/Over-the-Top/i.test(f.code))    return {for:'Over-the-Top', title:'Pump & Pause Shallow', why:'Trains inside path & sequence', how:'From P4 pause, tuck trail elbow; shallow shaft; pump to P6 then go — 3×10', youtube:''};
        return {for:f.code||'Tempo', title:'Tempo Metronome 3:1', why:'Synchronize motion', how:'Backswing 3 counts, downswing 1; 20 balls', youtube:''};
      });
    }
    out.drills = normDrills;

    return out;
  }

  function chip(t){ return '<span class="chip">'+t+'</span>'; }
  function table(rows){ return '<table>'+rows+'</table>'; }

  function renderReport(r){
    const cps = r.checkpoints || {};
    const order = ['P1','P2','P3','P4','P5','P6','P7','P8','P9'];
    const pRows = order.map(id=>{
      const p = cps[id] || {};
      return `<tr><td>${id}</td><td>${p.title||'—'}</td><td>${p.notes||p.desc||''}</td></tr>`;
    }).join('');
    const pc = Array.isArray(r.positionConsistency) ? r.positionConsistency : [];
    const pcHtml = pc.length
      ? `<table><thead><tr><th>Position</th><th>Value</th></tr></thead><tbody>${
          pc.map(x=>`<tr><td>${x.position||''}</td><td>${x.value??''}</td></tr>`).join('')
        }</tbody></table>`
      : '<div class="muted">—</div>';
    const faults = Array.isArray(r.faults) ? r.faults : [];
    const faultsHtml = faults.length
      ? faults.map(f=>`<div style="display:flex;justify-content:space-between;gap:12px;padding:8px 0;border-bottom:1px dashed #0002">
            <div><b>${f.code||'unknown'}</b>${f.desc?`<div class="muted">${f.desc}</div>`:''}</div>
            <div class="sev ${f.severity||''}">${f.severity||''}</div>
         </div>`).join('')
      : '<div class="muted">—</div>';
    const drills = Array.isArray(r.drills) ? r.drills : [];
    const drillsHtml = drills.length
      ? drills.map(d=>`<div class="card" style="border-color:#0002;margin:6px 0">
            <h4 style="margin:0 0 6px 0">${d.title||'Drill'} ${d.for?`<span class="chip">for ${d.for}</span>`:''}</h4>
            ${d.why?`<div><b>Why</b>: ${d.why}</div>`:''}
            ${d.how?`<div><b>How</b>: ${d.how}</div>`:''}
         </div>`).join('')
      : '<div class="muted">—</div>';

    els.root.innerHTML = `
      <section class="grid g-3">
        <div class="card"><h3>Client</h3>
          <div><b>Client ID:</b> ${r.clientId||''}</div>
          <div><b>Status:</b> ${r.status||''}</div>
          <div><b>Mode:</b> ${r.mode||''}</div>
          <div><b>Swings:</b> ${r.swings??''}</div>
          <div><b>Date (UTC):</b> ${r.createdUtc||r.date||''}</div>
        </div>
        <div class="card"><h3>Swing Score</h3>
          <div class="score">${(r.powerScoreSummary && typeof r.powerScoreSummary.value==='number')?r.powerScoreSummary.value:(r.swingScore??'—')}</div>
          <div class="muted">${r.powerScoreSummary?.notes||r.note||''}</div>
        </div>
        <div class="card"><h3>Highlights</h3>
          <div>${(r.top3PriorityFixes||[]).map(chip).join(' ') || '<span class="muted">—</span>'}</div>
        </div>
      </section>

      <section class="grid g-2" style="margin-top:14px">
        <div class="card"><h3>P1–P9</h3>
          <table id="pgrid"><thead><tr><th>Pos</th><th>Label</th><th>Notes</th></tr></thead><tbody>${pRows}</tbody></table>
        </div>
        <div class="card"><h3>Position Consistency</h3>${pcHtml}</div>
      </section>

      <section class="card" style="margin-top:14px"><h3>Top Faults</h3>${faultsHtml}</section>
      <section class="card" style="margin-top:14px"><h3>Drill Prescriptions</h3>${drillsHtml}</section>

      <details style="margin-top:12px"><summary>Raw JSON</summary>
        <pre style="white-space:pre-wrap">${JSON.stringify(r,null,2)}</pre>
      </details>
    `;
  }

  async function load(){
    try{
      const u = new URL(location.href);
      const reportParam = u.searchParams.get('report');           // absolute URL (possibly double-encoded)
      const objKey = u.searchParams.get('objKey');                // compat path
      const key    = u.searchParams.get('key');

      let url = null, printUrl = null;

      if (reportParam){
        url = fullDecode(reportParam);
        const reportUrl = new URL(url);
        const k  = reportUrl.searchParams.get('key');
        const ok = reportUrl.searchParams.get('objKey');
        if (k && ok){
          printUrl = `https://api.virtualcoachai.net/api/print?key=${encodeURIComponent(k)}&objKey=${encodeURIComponent(ok)}`;
        }
      } else if (objKey && key){
        // same-origin compat (no CORS)
        url = `/api/report-compat?objKey=${encodeURIComponent(objKey)}&key=${encodeURIComponent(key)}`;
        printUrl = `https://api.virtualcoachai.net/api/print?key=${encodeURIComponent(key)}&objKey=${encodeURIComponent(objKey)}`;
      } else {
        throw new Error("Missing ?report= or (objKey+key) in URL.");
      }

      els.badge.textContent = 'loading…';
      const r = await fetch(url, { cache:'no-store' });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const j = await r.json();
      const payload = j?.data?.report || j?.report || j;   // tolerate any shape
      if (!payload) throw new Error("No report object in response.");

      const normalized = normalizeReport(payload);
      renderReport(normalized);

      els.badge.textContent = `schema ${normalized.version || '1.0'}`;
      if (printUrl) els.print.setAttribute('href', printUrl);
      log('Loaded.');
    }catch(e){
      log(e.message||String(e), true);
      els.root.innerHTML = `<div class="card"><h3>Error</h3><div class="muted">${(e.message||String(e))}</div></div>`;
    }
  }

  document.addEventListener('DOMContentLoaded', load);
})();
</script>
</html>

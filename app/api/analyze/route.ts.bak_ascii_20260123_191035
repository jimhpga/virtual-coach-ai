import { NextResponse } from "next/server";

const DEMO_TOP_FAULTS = [
  {
    key: "clubface_control",
    score: 60,
    label: "Clubface control (impact)",
    note: "Demo fallback",
    meaning: "Face-to-path is drifting — start line control suffers.",
    drills: [
      "9-to-3 punch shots: half swings, hold the face square through impact.",
      "Alignment stick gate: start the ball through a narrow start-line window."
    ]
  },
  {
    key: "low_point_control",
    score: 55,
    label: "Low point control (strike)",
    note: "Demo fallback",
    meaning: "Bottom of arc is inconsistent — contact and compression vary.",
    drills: [
      "Towel drill: place towel 4–6\" behind ball; miss towel, hit ball first.",
      "Line drill: draw a line, ball just ahead; strike the line in front every rep."
    ]
  },
  {
    key: "sequence_timing",
    score: 50,
    label: "Sequence timing (transition)",
    note: "Demo fallback",
    meaning: "Body/arms aren’t syncing — speed leaks and face gets flippy.",
    drills: [
      "Step-through drill: small step toward target to trigger pressure shift then turn.",
      "Pump drill (3 pumps): rehearse P5 slot, then swing through without flipping."
    ]
  }
];

function demoReport(reason?: string) {
  return {
    headline: "Demo report (safe)",
    swingScore: 72,
    tourDna: { label: "Tour DNA Match", match: 71, note: "Demo fallback" },
    priority: {
      title: "1 thing to fix first",
      text: "Start-line control + strike. Fix face first, then low point."
    },
    topFaults: DEMO_TOP_FAULTS.slice(0, 3),
    powerLeaks: [],
    topFixes: [],
    practicePlan: [],
    debug: { fallback: true, reason: String(reason || "") }
  };
}

export async function GET() {
  return NextResponse.json(
    { ok: true, message: "Use POST /api/analyze", report: demoReport("GET") },
    { status: 200 }
  );
}

export async function POST(req: Request) {
  try {
    let body: any = {};
    try { body = await req.json(); } catch {}

    const jobId =
      body?.jobId ||
      body?.id ||
      ("job_" + Date.now() + "_" + Math.random().toString(16).slice(2));

    // Always return a stable shape so UI never breaks
    return NextResponse.json({ ok: true, jobId, report: demoReport("POST") }, { status: 200 });
  } catch (e: any) {
    // Even in failure, do NOT 500 the demo
    const msg = e?.message ? String(e.message) : "unknown";
    return NextResponse.json({ ok: true, jobId: "job_fallback", report: demoReport(msg) }, { status: 200 });
  }
}
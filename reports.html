<!doctype html>
<meta charset="utf-8"/>
<title>Virtual Coach — Reports</title>
<style>
  :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  body{max-width:900px;margin:40px auto;padding:0 16px}
  h1{font-size:20px;margin:0 0 12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
  input,button,select{font-size:14px;padding:8px 10px;border:1px solid #ccc;border-radius:8px}
  button{cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;font-size:14px}
  .muted{color:#666}
  .actions button{margin-right:6px}
  pre{background:#f7f7f7;border:1px solid #eee;border-radius:10px;padding:12px;overflow:auto;max-height:300px}
  .pill{display:inline-block;background:#eef;border:1px solid #dde;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:8px}
</style>
<h1>Virtual Coach — Reports <span id="prefix" class="pill"></span></h1>

<div class="row">
  <label>API Key:</label>
  <input id="key" type="password" placeholder="REPORT_API_KEY" style="width:260px">
  <button id="saveKey">Save</button>
  <button id="clearKey">Clear</button>
  <span class="muted" id="keyState"></span>
</div>

<div class="row">
  <label>Client:</label>
  <input id="clientId" placeholder="e.g. jim-hartnett" style="width:220px">
  <label>Limit:</label>
  <select id="limit">
    <option>20</option><option selected>50</option><option>100</option><option>200</option>
  </select>
  <button id="load">Load</button>
  <span id="status" class="muted"></span>
</div>

<table id="tbl" hidden>
  <thead>
    <tr><th>Key</th><th>Size</th><th>Last Modified</th><th>Actions</th></tr>
  </thead>
  <tbody></tbody>
</table>

<div id="viewer" hidden>
  <h3>Report JSON</h3>
  <pre id="json"></pre>
</div>

<script>
const Base = location.origin; // same origin (api.virtualcoachai.net)
const els = {
  key: document.getElementById('key'),
  saveKey: document.getElementById('saveKey'),
  clearKey: document.getElementById('clearKey'),
  keyState: document.getElementById('keyState'),
  clientId: document.getElementById('clientId'),
  limit: document.getElementById('limit'),
  load: document.getElementById('load'),
  status: document.getElementById('status'),
  tbl: document.getElementById('tbl'),
  tbody: document.querySelector('#tbl tbody'),
  prefix: document.getElementById('prefix'),
  viewer: document.getElementById('viewer'),
  json: document.getElementById('json'),
};

function getKey(){ return localStorage.getItem('vc_key')?.trim() || ''; }
function setKey(v){ localStorage.setItem('vc_key', v.trim()); }
function clearKey(){ localStorage.removeItem('vc_key'); }

function fmtBytes(n){
  if (n == null) return '';
  const u = ['B','KB','MB','GB']; let i=0, x=Number(n);
  while(x>=1024 && i<u.length-1){ x/=1024; i++; }
  return `${x.toFixed(x<10?1:0)} ${u[i]}`;
}

async function listReports(){
  const key = getKey();
  if(!key){ els.status.textContent = 'Set API key first.'; return; }

  const clientId = els.clientId.value.trim();
  const limit = els.limit.value;
  els.status.textContent = 'Loading...';
  els.viewer.hidden = true;
  els.json.textContent = '';

  const qs = new URLSearchParams(); if(clientId) qs.set('clientId', clientId); qs.set('limit', limit);
  const url = `${Base}/api/reports?${qs.toString()}`;
  const r = await fetch(url, { headers: { 'x-api-key': key }});
  const text = await r.text();
  let data; try{ data = JSON.parse(text) }catch{}
  if(!r.ok){ els.status.textContent = `Error ${r.status}`; console.log(text); return; }

  els.prefix.textContent = data.prefix || '';
  els.tbody.innerHTML = '';
  (data.items||[]).forEach(item => {
    const tr = document.createElement('tr');
    const ts = item.key.replace(/^.*\//,'').replace('.json','');
    tr.innerHTML = `
      <td><code>${item.key}</code></td>
      <td>${fmtBytes(item.size)}</td>
      <td>${new Date(item.lastModified).toLocaleString()}</td>
      <td class="actions">
        <button data-k="${item.key}" data-ts="${ts}" class="view">View</button>
        <button data-k="${item.key}" class="link">Copy Link</button>
        <button data-k="${item.key}" data-ts="${ts}" class="email">Email</button>
      </td>`;
    els.tbody.appendChild(tr);
  });
  els.tbl.hidden = false;
  els.status.textContent = `${(data.items||[]).length} item(s)`;
}

async function viewJson(key){
  const r = await fetch(`${Base}/api/reports?objKey=${encodeURIComponent(key)}`, { headers: {'x-api-key': getKey()} });
  const text = await r.text();
  els.viewer.hidden = false;
  try{ els.json.textContent = JSON.stringify(JSON.parse(text), null, 2); }
  catch{ els.json.textContent = text; }
}

async function copyLink(key){
  const r = await fetch(`${Base}/api/share?objKey=${encodeURIComponent(key)}`, { headers: {'x-api-key': getKey()} });
  const { url } = await r.json();
  await navigator.clipboard.writeText(url);
  els.status.textContent = 'Signed link copied.';
}

async function emailReport(key, ts){
  let to = prompt('Send to email address:');
  if(!to) return;
  const share = await fetch(`${Base}/api/share?objKey=${encodeURIComponent(key)}`, { headers: {'x-api-key': getKey()} }).then(r=>r.json());
  const subject = `Swing report ${ts}`;
  const html = `<p>Your swing report:</p><p><a href="${share.url}">${share.url}</a></p>`;
  const body = { to, subject, html, key: getKey() }; // your /api/email accepts key in body or header
  const r = await fetch(`${Base}/api/email`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  const text = await r.text();
  if(r.ok){ els.status.textContent = 'Email sent.'; } else { els.status.textContent = `Email failed (${r.status})`; console.log(text); }
}

els.saveKey.onclick = ()=>{ setKey(els.key.value); els.key.value=''; els.keyState.textContent='Saved.'; };
els.clearKey.onclick = ()=>{ clearKey(); els.keyState.textContent='Cleared.'; };
els.load.onclick = listReports;

els.tbody.addEventListener('click', (e) => {
  const b = e.target.closest('button'); if(!b) return;
  const key = b.getAttribute('data-k'); const ts = b.getAttribute('data-ts') || '';
  if(b.classList.contains('view')) viewJson(key);
  if(b.classList.contains('link')) copyLink(key);
  if(b.classList.contains('email')) emailReport(key, ts);
});

// Convenience: support ?key= and ?clientId= in the URL once
const url = new URL(location.href);
if(url.searchParams.get('key')) { setKey(url.searchParams.get('key')); url.searchParams.delete('key'); history.replaceState({},'',url); }
if(url.searchParams.get('clientId')) { els.clientId.value = url.searchParams.get('clientId'); }

</script>

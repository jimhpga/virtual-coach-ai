<!doctype html>
<html lang="en">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>VC Reports</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:0;padding:24px;line-height:1.4}
  header{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  input,button,select{font:inherit;padding:8px;border:1px solid #ccc;border-radius:8px}
  button{cursor:pointer}
  .row{display:flex;gap:12px;align-items:center;margin-top:12px;flex-wrap:wrap}
  #log{margin-top:12px;color:#a00;white-space:pre-wrap}
  #json{margin-top:16px;padding:12px;background:#f7f7f7;border-radius:8px;max-height:50vh;overflow:auto;font-family:ui-monospace,Consolas,monospace}
</style>

<header>
  <strong>VC Reports</strong>
</header>

<div class="row">
  <label>API key</label>
  <input id="apiKey" type="password" placeholder="vc-..." size="36"/>
  <button id="saveKey">Save</button>
  <button id="clearKey">Clear</button>
</div>

<div class="row">
  <label>Client ID</label>
  <input id="clientId" placeholder="jim-hartnett" size="20"/>
  <button id="loadList">Load Reports</button>
  <select id="sel" style="min-width:320px"></select>
  <button id="openJson">Open JSON</button>
  <button id="share">Share URL</button>
</div>

<div id="log"></div>
<pre id="json"></pre>

<script>
const els = {
  key: document.getElementById('apiKey'),
  saveKey: document.getElementById('saveKey'),
  clearKey: document.getElementById('clearKey'),
  clientId: document.getElementById('clientId'),
  loadList: document.getElementById('loadList'),
  sel: document.getElementById('sel'),
  openJson: document.getElementById('openJson'),
  share: document.getElementById('share'),
  log: document.getElementById('log'),
  json: document.getElementById('json'),
};

function log(msg, isErr=false){
  els.log.textContent = (isErr ? "❌ " : "ℹ️ ") + msg;
  if(isErr) console.error(msg); else console.log(msg);
}

function getKey(){
  const u = new URL(location.href);
  const fromUrl = u.searchParams.get('key');
  if(fromUrl){ localStorage.setItem('vc_api_key', fromUrl); return fromUrl; }
  return localStorage.getItem('vc_api_key') || '';
}
function setKey(k){
  localStorage.setItem('vc_api_key', k || '');
  els.key.value = k || '';
}
function getClientId(){
  const u = new URL(location.href);
  return u.searchParams.get('clientId') || localStorage.getItem('vc_client_id') || 'jim-hartnett';
}
function setClientId(cid){
  localStorage.setItem('vc_client_id', cid || '');
  els.clientId.value = cid || '';
}
function setLastKey(objKey){ localStorage.setItem('vc_last_obj', objKey || ''); }
function getLastKey(){ return localStorage.getItem('vc_last_obj') || ''; }

async function api(path, opts={}){
  const key = getKey();
  const r = await fetch(path, {
    ...opts,
    headers: { 'x-api-key': key, 'content-type':'application/json', ...(opts.headers||{}) }
  });
  return r;
}

async function loadListAndMaybeSelect(preferredKey){
  const cid = els.clientId.value.trim();
  if(!cid){ log('Client ID required', true); return; }
  log('Loading list…');
  const r = await api(`/api/report-compat?clientId=${encodeURIComponent(cid)}`);
  if(!r.ok){ log(`List failed: HTTP ${r.status}`, true); return; }
  const { items=[] } = await r.json();
  els.sel.innerHTML = '';
  items.forEach(it=>{
    const opt = document.createElement('option');
    opt.value = it.key;
    opt.textContent = `${new Date(it.lastModified).toLocaleString()} — ${it.key.split('/').pop()}`;
    els.sel.appendChild(opt);
  });
  if(items.length===0){ log('No reports found for this client.', true); els.json.textContent=''; return; }

  let chosen = preferredKey || getLastKey();
  if(!chosen || !items.some(x=>x.key===chosen)){ chosen = items[0].key; }
  els.sel.value = chosen;
  await loadOne(chosen, /*on404Fallback*/ true);
}

async function loadOne(objKey, fallback){
  log('Loading report…');
  const r = await api(`/api/report-compat?objKey=${encodeURIComponent(objKey)}`);
  if(!r.ok){
    log(`Failed to load (HTTP ${r.status}).${fallback ? ' Trying latest…' : ''}`, true);
    if(fallback){
      setLastKey('');  // clear bad memory
      // refresh list and load newest
      return loadListAndMaybeSelect('');
    }
    return;
  }
  const data = await r.json();
  setLastKey(objKey);
  els.json.textContent = JSON.stringify(data.data || data, null, 2);
  log('Loaded.');
}

els.saveKey.onclick = ()=> setKey(els.key.value.trim());
els.clearKey.onclick = ()=> { setKey(''); setLastKey(''); log('Key cleared.'); };
els.loadList.onclick = ()=> { setClientId(els.clientId.value.trim()); loadListAndMaybeSelect(getLastKey()); };

els.sel.onchange = ()=> loadOne(els.sel.value, false);

els.openJson.onclick = ()=>{
  const k = els.sel.value;
  if(!k) return;
  const key = getKey();
  const u = `/api/report-compat?objKey=${encodeURIComponent(k)}&key=${encodeURIComponent(key)}`;
  window.open(u, '_blank');
};
els.share.onclick = async ()=>{
  const k = els.sel.value;
  if(!k) return;
  const r = await api(`/api/share?objKey=${encodeURIComponent(k)}`);
  const j = await r.json();
  if(!r.ok || !j.url){ log(`Share failed: HTTP ${r.status}`, true); return; }
  navigator.clipboard.writeText(j.url).catch(()=>{});
  log('Signed URL copied to clipboard.');
};

// boot
setKey(getKey());
setClientId(getClientId());
const url = new URL(location.href);
// optional ?clear=1 to wipe cached key/selection
if(url.searchParams.get('clear')==='1'){ localStorage.removeItem('vc_last_obj'); }
loadListAndMaybeSelect(url.searchParams.get('objKey') || '');
</script>
<script id="vc-normalize">
(function(){
  function normalizeReport(r){
    const out = {...r};

    // meta → top-level convenience
    if (r.meta){
      out.mode   = out.mode   ?? r.meta.mode;
      out.swings = out.swings ?? r.meta.swings;
      out.date   = out.date   ?? r.meta.date;
    }

    // top fixes / priority
    if (!out.top3PriorityFixes && Array.isArray(r.topFixes)) out.top3PriorityFixes = r.topFixes;
    if (!out.top3PowerFixes    && Array.isArray(r.powerFixes)) out.top3PowerFixes = r.powerFixes;

    // coaching card: string → object
    if (typeof r.coachingCard === 'string'){
      out.coachingCard = { summary: r.coachingCard, cues: [], drills: [] };
    }

    // consistency → split fields expected by UI
    if (r.consistency){
      if (!out.swingConsistency && (typeof r.consistency.swing === 'number' || typeof r.consistency.swing === 'object')){
        out.swingConsistency = typeof r.consistency.swing === 'number'
          ? { value: r.consistency.swing }
          : r.consistency.swing;
      }
      if (!out.positionConsistency && Array.isArray(r.consistency.position)){
        out.positionConsistency = r.consistency.position.map(p => ({
          position: p.position || p.pos || p.id || "",
          value:    p.value ?? p.score ?? 0
        }));
      }
    }

    // power → summary value (+keep breakdown if present)
    if (r.power){
      if (!out.powerScoreSummary && (typeof r.power.score === 'number' || typeof r.power === 'number')){
        out.powerScoreSummary = { value: (typeof r.power === 'number' ? r.power : r.power.score), notes: "" };
      }
    }

    // phases: ensure objects include id/title; tolerate name/label variants
    if (Array.isArray(r.phases)){
      out.phases = r.phases.map(p => ({
        id:    p.id    ?? p.position ?? p.pos ?? "",
        title: p.title ?? p.name ?? "",
        label: p.label ?? p.note ?? ""
      }));
    }

    // ensure swingScore exists at top-level (some renderers use this)
    if (out.swingScore == null && typeof r.power?.score === 'number') out.swingScore = r.power.score;

    return out;
  }

  // Hook: after fetch -> before render
  const _fetch = window.fetch;
  window.fetch = async function(url, init){
    const res = await _fetch(url, init);
    try{
      // Only intercept the report JSON call the page makes
      if (typeof url === 'string' && url.includes('/api/report-compat')){
        const clone = res.clone();
        const data  = await clone.json();
        if (data && data.data && data.data.report){
          data.data.report = normalizeReport(data.data.report);
          // Return a Response with the normalized payload
          return new Response(JSON.stringify(data), {
            status: res.status,
            statusText: res.statusText,
            headers: {'Content-Type':'application/json'}
          });
        }
      }
    }catch{}
    return res;
  };
})();
</script>
</html>



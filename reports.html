<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VCAI Report</title>
<style>
  :root { --fg:#111; --muted:#666; --card:#fff; --bg:#f7f7f8; --line:#e5e7eb; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Arial}
  .wrap{max-width:1024px;margin:24px auto;padding:0 16px}
  .row{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:900px){ .row{grid-template-columns:2fr 1fr} }
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
  h1{margin:12px 0 4px} h2{margin:0 0 8px;font-size:18px} h3{margin:0 0 6px;font-size:16px}
  .meta{color:var(--muted);font-size:13px;margin-bottom:8px}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;margin-right:6px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .kvs{display:grid;grid-template-columns:120px 1fr;gap:8px;align-items:center}
  .bar{height:10px;background:#ddd;border-radius:6px;overflow:hidden}
  .bar>i{display:block;height:100%;background:linear-gradient(90deg,#6ee7b7,#22d3ee);width:0%}
  video,iframe{width:100%;max-width:100%;border:0;border-radius:10px;display:block}
  pre{white-space:pre-wrap;background:#fafafa;border:1px solid var(--line);padding:12px;border-radius:10px}
  button{padding:8px 12px;border-radius:8px;border:1px solid var(--line);background:#fff;cursor:pointer}
  .chips{display:flex;flex-wrap:wrap;gap:6px}
  .list{display:grid;gap:10px}
  .fault{display:flex;justify-content:space-between;gap:8px}
  .severity{font-size:12px;color:#fff;border-radius:6px;padding:2px 6px}
  .sev-high{background:#ef4444}.sev-medium{background:#f59e0b}.sev-low{background:#10b981}
  .small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px;">
      <div><h1>Virtual Coach AI — Swing Report</h1></div>
      <div>
        <button onclick="window.print()">Print</button>
        <a id="jsonBtn" target="_blank"><button>View JSON</button></a>
      </div>
    </div>

    <div class="row">
      <div class="card" id="videoCard"><div class="meta">Loading video…</div></div>

      <div class="card" id="scoreCard">
        <h2>Summary</h2>
        <div class="meta" id="metaLine"></div>
        <div class="chips" id="topFixes"></div>
        <div style="margin-top:8px" class="small" id="noteLine"></div>
      </div>
    </div>

    <div class="row" style="margin-top:16px">
      <div class="card">
        <h2>Position Consistency</h2>
        <div id="posBars" class="list"></div>
      </div>
      <div class="card">
        <h2>Faults</h2>
        <div id="faults" class="list"></div>
        <h2 style="margin-top:16px">Drills</h2>
        <div id="drills" class="list"></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h2>Checkpoints (P1–P9)</h2>
      <div id="cps" class="grid"></div>
    </div>

    <details class="card" style="margin-top:16px">
      <summary>Raw JSON</summary>
      <pre id="raw">Loading…</pre>
    </details>
  </div>

<script>
(async function(){
  const params = new URL(location.href).searchParams;
  const report = params.get('report') || '/data/latest.json';
  document.getElementById('jsonBtn').href = report;

  let j;
  try {
    j = await (await fetch(report,{cache:'no-store'})).json();
  } catch (e) {
    document.getElementById('raw').textContent = String(e);
    return;
  }

  // ---- Title/meta
  document.title = `VCAI Report • Score ${j?.swingScore ?? ''}`;
  const meta = document.getElementById('metaLine');
  meta.textContent = `Score ${j?.swingScore ?? '—'} • Swings ${j?.meta?.swings ?? j?.swings ?? '—'} • ${j?.meta?.mode || j?.mode || '—'} • ${j?.meta?.date || j?.date || ''}`;

  // ---- Top fixes
  const fixes = (j?.top3PriorityFixes || []).slice(0,3);
  const fixesEl = document.getElementById('topFixes');
  fixes.forEach(f => {
    const s=document.createElement('span'); s.className='tag'; s.textContent=f; fixesEl.appendChild(s);
  });
  document.getElementById('noteLine').textContent = j?.powerScoreSummary?.notes || j?.note || '';

  // ---- Video
  const url = j?.video?.url || '';
  const vc = document.getElementById('videoCard');
  function ytId(u){ const m=String(u).match(/(?:youtu\.be\/|v=)([^&?#]+)/); return m?m[1]:null; }
  if (/youtu\.be|youtube\.com/i.test(url) && ytId(url)) {
    const id=ytId(url);
    vc.innerHTML = `<div class="meta">YouTube</div>
      <div style="aspect-ratio:16/9;"><iframe src="https://www.youtube.com/embed/${id}" allow="autoplay; encrypted-media" allowfullscreen></iframe></div>
      <div class="small">Source: ${url}</div>`;
  } else {
    const type = url.endsWith('.mov') ? 'video/quicktime' : 'video/mp4';
    vc.innerHTML = `<div class="meta">Local video</div>
      <video controls playsinline><source src="${url}" type="${type}"></video>
      <div class="small">Source: ${url}</div>`;
  }

  // ---- Faults
  const faults = Array.isArray(j?.faults)? j.faults : [];
  const fWrap = document.getElementById('faults');
  if (faults.length === 0) fWrap.innerHTML = '<div class="small">No faults listed.</div>';
  faults.forEach(f=>{
    const sev = (f.severity||'').toLowerCase();
    const sevClass = sev==='high'?'sev-high':sev==='medium'?'sev-medium':'sev-low';
    const div=document.createElement('div'); div.className='fault';
    div.innerHTML = `<div><strong>${f.code}</strong><div class="small">${f.desc||''}</div></div>
                     <div class="severity ${sevClass}">${f.severity||''}</div>`;
    fWrap.appendChild(div);
  });

  // ---- Drills (for the listed faults)
  const drills = Array.isArray(j?.drills)? j.drills : [];
  const dWrap = document.getElementById('drills');
  if (drills.length === 0) dWrap.innerHTML = '<div class="small">No drills listed.</div>';
  drills.forEach(d=>{
    const div=document.createElement('div'); div.className='card'; div.style.padding='12px'; div.style.margin='0';
    div.innerHTML = `<h3>${d.title}</h3>
      <div class="small" style="margin-bottom:6px">For: ${d.for||''}</div>
      <div><strong>How:</strong> ${d.how||''}</div>
      <div class="small" style="margin-top:6px"><strong>Why:</strong> ${d.why||''}</div>`;
    dWrap.appendChild(div);
  });

  // ---- Position Consistency bars
  const bars = Array.isArray(j?.positionConsistency)? j.positionConsistency : [];
  const pWrap = document.getElementById('posBars');
  if (bars.length === 0) pWrap.innerHTML = '<div class="small">No consistency data.</div>';
  bars.forEach(p=>{
    const row=document.createElement('div'); row.className='kvs';
    const label=document.createElement('div'); label.textContent = `${p.position||''}`;
    const bar=document.createElement('div'); bar.className='bar';
    const fill=document.createElement('i'); fill.style.width = ((+p.value||0)) + '%';
    bar.appendChild(fill);
    row.appendChild(label); row.appendChild(bar);
    pWrap.appendChild(row);
  });

  // ---- Checkpoints grid (ordered P1..P9)
  const order=['P1','P2','P3','P4','P5','P6','P7','P8','P9'];
  const cps = j?.checkpoints || {};
  const cpWrap = document.getElementById('cps');
  order.forEach(k=>{
    const c = cps[k]; if (!c) return;
    const cell=document.createElement('div'); cell.className='card';
    cell.innerHTML = `<h3>${k} — ${c.title||''}</h3><div class="small">${c.notes||''}</div>`;
    cpWrap.appendChild(cell);
  });

  // ---- Raw dump
  document.getElementById('raw').textContent = JSON.stringify(j,null,2);
})();
</script>
</body>
</html>

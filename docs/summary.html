<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Virtual Coach AI — Swing Summary</title>
  <link rel="stylesheet" href="style.css?v=12"/>
  <style>
    .tile { background: var(--card); border:1px solid var(--border); border-radius:14px; margin:10px 0; overflow:hidden; }
    .tile > button { width:100%; text-align:left; display:flex; justify-content:space-between; align-items:center;
      padding:14px 16px; background:transparent; border:none; color:var(--text); cursor:pointer; font-size:1.05rem; }
    .tile > button:hover { background: rgba(255,255,255,.06); }
    .tile-body { display:none; padding:14px 16px; border-top:1px solid var(--border); }
    .list { margin:0; padding-left:18px; }
    .bar { height:10px; background: rgba(255,255,255,.1); border-radius:10px; overflow:hidden; }
    .bar > span { display:block; height:100%; background: var(--accent); width:0%; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; }

    /* P1–P9 stacked (4 columns) */
    table.pstack { width:100%; border-collapse:collapse; }
    table.pstack th, table.pstack td { border:1px solid var(--border); padding:10px; vertical-align:top; }
    table.pstack thead { background: rgba(255,255,255,.06); }
    table.pstack colgroup col.c1 { width: 160px; }
    table.pstack colgroup col.c2 { width: 120px; }
    /* Short/Long flex with remaining width */
    .pname { white-space:nowrap; }
    .rating { text-align:center; }
    .badge { display:inline-block; padding:3px 8px; border-radius:999px; font-size:.9rem; border:1px solid var(--border); }
    .good  { background: rgba(0,200,0,.15);  color:#9ff39f; }
    .okay  { background: rgba(255,200,0,.15);color:#ffe28a; }
    .need  { background: rgba(255,0,0,.15);  color:#ffb3b3; }
    .muted { opacity:.75; font-size:.9rem; display:block; margin-top:4px; }
    @media (max-width: 900px){
      table.pstack colgroup col.c1 { width: 140px; }
      table.pstack colgroup col.c2 { width: 100px; }
    }
    @media (max-width: 640px){
      /* On small screens, stack Short/Long vertically inside their cells */
      .short, .long { display:block; }
    }

    /* Images */
    .img-actions { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
    .img-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    .img-grid img { width:100%; height:auto; border-radius:10px; border:1px solid var(--border); background: rgba(255,255,255,.05); }
    @media (max-width: 900px){ .img-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 600px){ .img-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="header">
      <img class="logo" src="virtualcoach-logo.png" onerror="this.src='virtualcoach-logo.png'" alt="Virtual Coach AI"/>
      <div>
        <h1 class="brand">Virtual Coach AI</h1>
        <p class="sub">Swing Summary</p>
      </div>
    </header>

    <div id="notice" class="notice"></div>

    <!-- Top bar: ID + Actions -->
    <section class="card" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <div id="reportId">ID: —</div>
      <div class="actions">
        <button id="exportJsonBtn" title="Download JSON">Export JSON</button>
        <button id="printBtn" title="Print or Save as PDF">Print / PDF</button>
      </div>
    </section>

    <!-- Summary -->
    <section class="tile">
      <button data-acc="summary"><span>Swing Summary</span><span>–¾</span></button>
      <div class="tile-body" id="tile-summary">
        <div class="grid two">
          <div class="card">
            <h3 class="section-title">Profile</h3>
            <div id="profile">—</div>
          </div>
          <div class="card">
            <h3 class="section-title">Tempo</h3>
            <div id="tempo">—</div>
          </div>
        </div>
        <div class="card" style="margin-top:10px;">
          <h3 class="section-title">Totals</h3>
          <div id="totals">—</div>
        </div>
      </div>
    </section>

    <!-- P1–P9 vertically stacked (Checkpoint | Rating | Short | Long) -->
    <section class="tile">
      <button data-acc="pstack"><span>P1–P9 Details</span><span>–¾</span></button>
      <div class="tile-body" id="tile-pstack">
        <table class="pstack" id="pTable">
          <colgroup>
            <col class="c1"/><!-- Checkpoint -->
            <col class="c2"/><!-- Rating -->
            <col/><!-- Short -->
            <col/><!-- Long -->
          </colgroup>
          <thead>
            <tr>
              <th>Checkpoint</th>
              <th>Rating</th>
              <th>Short</th>
              <th>Long</th>
            </tr>
          </thead>
          <tbody><!-- rows go here --></tbody>
        </table>
      </div>
    </section>

    <!-- Images on demand -->
    <section class="tile">
      <button data-acc="images"><span>P1–P9 Images</span><span>–¾</span></button>
      <div class="tile-body" id="tile-images">
        <div class="img-actions">
          <button id="showImagesBtn">Show Images</button>
          <a id="downloadZip" href="#" download>Download All (ZIP)</a>
        </div>
        <div id="imagesStatus" style="opacity:.8; margin-bottom:8px;"></div>
        <div class="img-grid" id="imgGrid"></div>
      </div>
    </section>

    <!-- Coaching tiles -->
    <section class="tile">
      <button data-acc="improve"><span>3 Things to Improve</span><span>–¾</span></button>
      <div class="tile-body">
        <ol class="list" id="tips3"></ol>
      </div>
    </section>

    <section class="tile">
      <button data-acc="power"><span>Power Assessment</span><span>–¾</span></button>
      <div class="tile-body" id="tile-power">
        <div style="margin-bottom:8px;">Overall Power: <b id="powerScore">—</b></div>
        <div class="bar"><span id="powerBar"></span></div>
        <ul class="list" id="powerNotes" style="margin-top:10px;"></ul>
      </div>
    </section>

    <section class="tile">
      <button data-acc="power-tips"><span>3 Power Things to Improve</span><span>–¾</span></button>
      <div class="tile-body">
        <ol class="list" id="powerTips3"></ol>
      </div>
    </section>

    <section class="tile">
      <button data-acc="lessons"><span>14-Day Lesson Plan</span><span>–¾</span></button>
      <div class="tile-body">
        <ol class="list" id="lessons14"></ol>
      </div>
    </section>
  </div>

  <script>
  // accordion
  (function(){
    document.querySelectorAll('.tile > button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const body = btn.parentElement.querySelector('.tile-body');
        const open = body.style.display === 'block';
        body.style.display = open ? 'none' : 'block';
        btn.lastElementChild.textContent = open ? '–¾' : '–´';
      });
    });
  })();
  </script>

  <script>
  (function(){
    const $ = (s)=>document.querySelector(s);
    const notice = $('#notice');
    const setNotice=(m,t='info')=>{ if(!notice) return; notice.textContent=m||''; notice.style.display=m?'block':'none'; notice.setAttribute('data-type',t); };
    const setText=(sel,val)=>{ const el=$(sel); if(el) el.textContent=(val??'—'); };

    // ID (fallback demo)
    const params = new URLSearchParams(location.search);
    const id = params.get('id') || '1754322283691';
    $('#reportId').textContent = 'ID: ' + id;

    // Export / Print
    let lastData = null;
    $('#exportJsonBtn').onclick = () => {
      if (!lastData) return setNotice('Nothing to export yet.', 'error');
      const blob = new Blob([JSON.stringify(lastData, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `swing-summary-${id}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    };
    $('#printBtn').onclick = () => window.print();

    // Fetch
    (async()=>{
      try{
        const r = await fetch('/api/get?id='+encodeURIComponent(id), { cache:'no-store' });
        let data; try { data = await r.json(); } catch { setNotice('Server returned non-JSON.','error'); return; }
        if (!r.ok) { setNotice(data?.error || ('Failed to load report ('+r.status+')'),'error'); return; }
        if (!data) { setNotice('Empty report payload.','error'); return; }
        lastData = data;

        setText('#profile', data.profile || '—');
        setText('#tempo', data.tempo || '—');
        setText('#totals', data.totals ? JSON.stringify(data.totals) : '—');

        // Build P1–P9 rows (Checkpoint | Rating | Short | Long)
        const tbody = document.querySelector('#pTable tbody');
        tbody.innerHTML = '';
        const order = ['P1','P2','P3','P4','P5','P6','P7','P8','P9'];
        order.forEach(k=>{
          const it = data.pstack?.[k] || {};
          const tr = document.createElement('tr');

          const tdCheckpoint = document.createElement('td');
          tdCheckpoint.className = 'pname';
          tdCheckpoint.innerHTML = `<div><b>${k}</b></div><div>${it.condition ?? '—'}</div>`;

          const tdRating = document.createElement('td');
          tdRating.className = 'rating';
          const status = (it.status || 'okay').toLowerCase();
          const badgeClass = status === 'good' ? 'good' : (status === 'need' ? 'need' : 'okay');
          tdRating.innerHTML = `<span class="badge ${badgeClass}">${status.toUpperCase()}</span><span class="muted">${it.rating ?? ''}</span>`;

          const tdShort = document.createElement('td');
          tdShort.className = 'short';
          tdShort.textContent = it.short ?? it.description ?? '—';

          const tdLong = document.createElement('td');
          tdLong.className = 'long';
          tdLong.textContent = it.long ?? '';

          tr.appendChild(tdCheckpoint);
          tr.appendChild(tdRating);
          tr.appendChild(tdShort);
          tr.appendChild(tdLong);
          tbody.appendChild(tr);
        });

        // Other tiles
        const tips3 = document.getElementById('tips3'); tips3.innerHTML='';
        (data.tips3 || []).slice(0,3).forEach(t=>{ const li=document.createElement('li'); li.textContent=t; tips3.appendChild(li); });
        if (!tips3.children.length) tips3.innerHTML = '<li>—</li>';

        const power = data.power || { score: 0, notes: [] };
        setText('#powerScore', (power.score ?? 0) + '/100');
        const bar = document.getElementById('powerBar'); bar.style.width = Math.max(0, Math.min(100, power.score || 0)) + '%';
        const pNotes = document.getElementById('powerNotes'); pNotes.innerHTML='';
        (power.notes || []).forEach(n=>{ const li=document.createElement('li'); li.textContent=n; pNotes.appendChild(li); });
        if (!pNotes.children.length) pNotes.innerHTML = '<li>—</li>';

        const powerTips3 = document.getElementById('powerTips3'); powerTips3.innerHTML='';
        (data.powerTips3 || []).slice(0,3).forEach(t=>{ const li=document.createElement('li'); li.textContent=t; powerTips3.appendChild(li); });
        if (!powerTips3.children.length) powerTips3.innerHTML = '<li>—</li>';

        const lessons = document.getElementById('lessons14'); lessons.innerHTML='';
        (data.lessons14 || []).slice(0,14).forEach((d,i)=>{
          const li=document.createElement('li'); li.innerHTML = `<b>Day ${i+1}:</b> ${d}`; lessons.appendChild(li);
        });
        if (!lessons.children.length) lessons.innerHTML = '<li>—</li>';

        // Open Summary + P1–P9 by default
        document.querySelector('#tile-summary').style.display = 'block';
        document.querySelector('#tile-pstack').style.display = 'block';
      } catch(e){
        setNotice('Error loading report: '+(e?.message||e),'error');
      }
    })();

    // Images (lazy)
    const imgStatus = document.getElementById('imagesStatus');
    const imgGrid = document.getElementById('imgGrid');
    const showBtn = document.getElementById('showImagesBtn');
    const zipLink = document.getElementById('downloadZip');
    if (zipLink) zipLink.href = '/api/frames-zip?id=' + encodeURIComponent(id);

    async function loadImages() {
      imgStatus.textContent = 'Loading thumbnails…';
      imgGrid.innerHTML = '';
      try {
        const r = await fetch('/api/frames?id=' + encodeURIComponent(id) + '&size=thumb', { cache: 'no-store' });
        let data; try { data = await r.json(); } catch { imgStatus.textContent = 'Server returned non-JSON.'; return; }
        if (!r.ok) { imgStatus.textContent = data?.error || ('Failed to load images ('+r.status+')'); return; }
        const urls = data?.urls || [];
        if (!urls.length) { imgStatus.textContent = 'No frames available.'; return; }
        imgStatus.textContent = '';
        urls.forEach((u, i) => {
          const a = document.createElement('a');
          a.href = '/api/frames?id=' + encodeURIComponent(id) + '&size=full&index=' + i;
          a.target = '_blank';
          const img = document.createElement('img');
          img.loading = 'lazy'; img.alt = 'P' + (i+1); img.src = u;
          a.appendChild(img); imgGrid.appendChild(a);
        });
      } catch (e) {
        imgStatus.textContent = 'Error loading images: ' + (e?.message || e);
      }
    }
    if (showBtn) showBtn.onclick = loadImages;
  })();
  </script>
<footer>© <span id="y"></span> Virtual Coach AI</footer>
<script id="vc-nav-js">
document.addEventListener('DOMContentLoaded', ()=>{
  const header=document.getElementById('site-header');
  const btn=document.getElementById('menuBtn');
  const nav=document.getElementById('siteNav');
  if(btn&&nav&&header){
    btn.addEventListener('click', ()=>{
      const open=header.classList.toggle('open');
      btn.setAttribute('aria-expanded', open?'true':'false');
    });
    nav.addEventListener('click', e=>{
      if(e.target&&e.target.tagName==='A'){ header.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
    });
  }
  const here=(location.pathname.split('/').pop()||'index.html').split('?')[0].toLowerCase();
  document.querySelectorAll('nav a').forEach(a=>{
    const h=(a.getAttribute('href')||'').split('?')[0].toLowerCase();
    if(h===here) a.setAttribute('aria-current','page');
  });
  const y=document.getElementById('y'); if(y) y.textContent=new Date().getFullYear();
});
</script>
</body>
</html>






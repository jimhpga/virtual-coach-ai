<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Virtual Coach AI — Upload</title>
  <link rel="stylesheet" href="site.css" />
  <style>
    .glass { background: rgba(28,28,28,.40); border: 1px solid rgba(255,255,255,.08);
             box-shadow: 0 20px 40px rgba(0,0,0,.35); border-radius: 18px; }
    .btn { appearance: none; background:#247a3a; color:#fff; border:0; border-radius:12px;
           padding:12px 16px; cursor:pointer; font-weight:600; }
    .btn:disabled { opacity:.55; cursor:not-allowed; }
    .pill { display:inline-block; font-size:12px; color:#bbb; margin-left:10px; }
    .log { white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
           background:#0c1116; color:#a7f3d0; border:1px solid rgba(255,255,255,.08); border-radius:12px;
           padding:14px; min-height:120px; }
    .grid { display:grid; grid-template-columns: 1fr; gap:18px; }
    @media (min-width: 900px){ .grid { grid-template-columns: 1fr 1fr; } }
  </style>
</head>
<body>

<div class="container" style="max-width:1100px;margin:42px auto;padding:0 18px;">
  <div class="grid">
    <section class="glass" style="padding:22px 22px 26px;">
      <h2 style="margin:0 0 6px 0; color:#b9f; font-weight:800;">Upload → Report → Improve</h2>
      <p style="margin:0 0 16px 0; color:#ddd;">Face-on or down-the-line; keep the camera steady and the full club in frame.</p>

      <div style="display:flex; align-items:center; gap:10px; margin-bottom:14px;">
        <input id="fileInput" type="file" accept="video/*,.mov,.mp4,.m4v" />
        <span id="fileLabel" class="pill">(no file)</span>
        <button id="uploadBtn" class="btn">Upload & Generate Report</button>
      </div>

      <div id="log" class="log">Ready.</div>
    </section>

    <aside class="glass" style="padding:22px 22px 26px;">
      <h3 style="margin:0 0 10px 0; color:#ddd;">How to film (best results)</h3>
      <ul style="color:#ddd; line-height:1.55; padding-left:20px; margin:0;">
        <li><b>Angles:</b> Take <i>Face-On</i> and <i>Down-the-Line</i>.</li>
        <li><b>Height & distance:</b> Phone roughly hip height, about 8–10 ft away.</li>
        <li><b>Keep the whole swing:</b> Entire clubhead in frame; hands & feet in frame.</li>
        <li><b>Stability:</b> Tripod if possible; 60 fps is great if your phone supports it.</li>
        <li><b>Lighting:</b> Avoid strong backlight; even lighting helps the tracker.</li>
      </ul>
    </aside>
  </div>

  <p style="text-align:center; color:#aaa; margin-top:18px;">© 2025 Virtual Coach AI</p>
</div>

<script>
(function(){
  const fileInput  = document.getElementById('fileInput');
  const fileLabel  = document.getElementById('fileLabel');
  const uploadBtn  = document.getElementById('uploadBtn');
  const logEl      = document.getElementById('log');

  function log(msg){ logEl.textContent += '\\n' + msg; logEl.scrollTop = logEl.scrollHeight; }
  function setBusy(b){ uploadBtn.disabled = !!b; fileInput.disabled = !!b; }

  window.addEventListener('error', e => log('JS error: ' + (e.message || e.error)));

  fileInput.addEventListener('change', e=>{
    const f = e.target.files?.[0];
    fileLabel.textContent = f ? `${f.name} (${f.type||'unknown'} ${f.size} bytes)` : '(no file)';
    if (f) log(`Selected: ${f.name} type=${f.type} size=${f.size}`);
  });

  uploadBtn.addEventListener('click', async ()=>{
    const file = fileInput.files?.[0];
    if (!file){ log('No file selected'); return; }

    setBusy(true);
    try {
      log('Step 1: asking backend for presigned POST…');
      const pres = await fetch('/api/presign', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ filename:file.name, type:file.type })
      });

      if (!pres.ok){
        const txt = await pres.text().catch(()=> '');
        throw new Error(`/api/presign ${pres.status} ${pres.statusText} ${txt}`);
      }
      const { url, fields, key } = await pres.json();
      if (!url || !fields || !key) throw new Error('presign missing url/fields/key');
      log('Presign OK: posting to S3…');

      // Build FormData for S3 *POST* (not PUT)
      const form = new FormData();
      Object.entries(fields).forEach(([k,v]) => form.append(k, v));
      form.append('Content-Type', file.type || 'video/mp4');
      form.append('file', file);

      const up = await fetch(url, { method:'POST', body: form });
      if (!(up.status === 201 || up.status === 204 || up.ok)) {
        const txt = await up.text().catch(()=> '');
        throw new Error(`S3 upload failed ${up.status} ${up.statusText} ${txt}`);
      }
      log('Upload complete ✔');

      log('Step 3: enqueue analysis / make report…');
      const mk = await fetch('/api/make-report', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ s3_key: key, name: file.name, type: file.type, size: file.size })
      });

      if (!mk.ok){
        const txt = await mk.text().catch(()=> '');
        throw new Error(`/api/make-report ${mk.status} ${mk.statusText} ${txt}`);
      }
      const r = await mk.json();
      log('Report response: ' + JSON.stringify(r));

      const viewerUrl = r.viewerUrl || '/report?report=/docs/report.json';
      log('Opening viewer: ' + viewerUrl);
      setTimeout(()=> location.href = viewerUrl, 600);
    } catch(err){
      log('Error: ' + err.message);
      console.error(err);
      setBusy(false);
    }
  });
})();
</script>
</body>
</html>

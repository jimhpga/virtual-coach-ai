/* Virtual Coach AI — Upload client (no inline JS, no weird escapes)
   - Select a video
   - POST /api/presign  -> { url, fields, key }
   - Upload to storage with a signed POST
   - POST /api/make-report -> { viewerUrl }
   - Redirect to viewer
*/
(() => {
  // ---- helpers ----
  const $ = (id) => document.getElementById(id);

  const fileInput = $('fileInput');
  const fileLabel = $('fileLabel');
  const uploadBtn = $('uploadBtn');
  const logEl     = $('log');

  function log(msg) {
    if (!logEl) return;
    logEl.textContent += '\n' + msg;
    logEl.scrollTop = logEl.scrollHeight;
  }

  function setBusy(busy) {
    if (uploadBtn) {
      uploadBtn.disabled = !!busy;
      uploadBtn.textContent = busy ? 'Uploading…' : 'Upload & Generate Report';
    }
    if (fileInput) fileInput.disabled = !!busy;
  }

  async function postJSON(url, body) {
    const r = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body || {})
    });

    // read as text first so we can surface server errors
    let text = '';
    try { text = await r.text(); } catch {}

    if (!r.ok) {
      throw new Error('HTTP ' + r.status + ' ' + r.statusText + ' from ' + url + (text ? ' — ' + text : ''));
    }

    try {
      return JSON.parse(text || '{}');
    } catch {
      throw new Error('Non-JSON response from ' + url + ': ' + text);
    }
  }

  // ---- UI bindings ----
  if (fileInput) {
    fileInput.addEventListener('change', function (e) {
      const f = (e.target.files && e.target.files[0]) || null;
      if (!f) {
        if (fileLabel) fileLabel.textContent = '(no file)';
        return;
      }
      const info = f.name + ' (' + (f.type || 'unknown') + ', ' + f.size + ' bytes)';
      if (fileLabel) fileLabel.textContent = info;
      log('Selected: ' + info);
    });
  }

  if (uploadBtn) {
    uploadBtn.addEventListener('click', async function () {
      const file = (fileInput && fileInput.files && fileInput.files[0]) || null;
      if (!file) { log('No file selected'); return; }

      setBusy(true);
      try {
        // 1) presign
        log('Step 1: requesting presigned POST…');
        const pres = await postJSON('/api/presign', {
          filename: file.name,
          type: file.type
        });

        if (!pres || !pres.url || !pres.fields || !pres.key) {
          throw new Error('Presign missing url/fields/key');
        }

        // 2) upload to storage (S3-style POST)
        log('Step 2: uploading to storage…');
        const form = new FormData();
        Object.keys(pres.fields).forEach(function (k) {
          form.append(k, pres.fields[k]);
        });
        form.append('Content-Type', file.type || 'video/mp4');
        form.append('file', file);

        const up = await fetch(pres.url, { method: 'POST', body: form });
        if (!(up.ok || up.status === 201 || up.status === 204)) {
          const errTxt = (await up.text().catch(function(){ return ''; })) || '';
          throw new Error('Upload failed ' + up.status + ' ' + up.statusText + (errTxt ? ' — ' + errTxt : ''));
        }
        log('Upload complete ✔');

        // 3) create the report
        log('Step 3: creating report…');
        const mk = await postJSON('/api/make-report', {
          s3_key: pres.key,
          name: file.name,
          type: file.type,
          size: file.size
        });

        const viewer = (mk && (mk.viewerUrl || mk.url || mk.reportUrl)) || '';
        if (viewer) {
          log('Opening viewer: ' + viewer);
          window.location.href = viewer;
        } else {
          log('Report created (no viewerUrl returned). Full response: ' + JSON.stringify(mk));
          setBusy(false);
        }
      } catch (err) {
        console.error(err);
        log('Error: ' + (err && err.message ? err.message : String(err)));
        setBusy(false);
      }
    });
  }

  // Global JS error surface → log panel
  window.addEventListener('error', function (e) {
    log('JS error: ' + (e.message || e.error || 'unknown'));
  });
})();

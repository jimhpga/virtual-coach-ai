<!doctype html>
<meta charset="utf-8">
<title>Upload → Report → Analyze</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;margin:24px}
  .row{margin:8px 0} button{padding:8px 14px;border-radius:8px;border:1px solid #ccc;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  #log{white-space:pre-wrap;background:#111;color:#ddd;padding:12px;border-radius:8px;min-height:120px}
</style>
<h1>Upload → Report → Analyze</h1>
<div class="row"><input id="file" type="file"><button id="go">Upload & Process</button></div>
<div class="row"><b>Key:</b> <span id="key">(none)</span></div>
<div class="row" id="log">Ready.</div>
<script>
const log = (m) => (document.getElementById('log').textContent += "\n" + m);
const setKey = (k) => (document.getElementById('key').textContent = k || "(none)");
function jobIdFromKey(key){ return String(key).replace(/^uploads\//,"").replace(/\.[^.]+$/,""); }

async function reportReady({ key, jobId, status="ready", data={} }){
  if (!jobId && key) jobId = jobIdFromKey(key);
  const r = await fetch("/api/report",{method:"POST",headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ jobId, status, data, key })});
  const j = await r.json().catch(()=>({}));
  if (!r.ok || j.ok===false) throw new Error(`reportReady failed: ${r.status} ${j.error||""}`);
  return j;
}
async function pollAnalyze({ key, jobId, intervalMs=1500, maxAttempts=40, onTick=()=>{} }){
  if (!jobId && key) jobId = jobIdFromKey(key); let attempt=0, delay=intervalMs;
  while (attempt < maxAttempts) {
    const qs = key ? `key=${encodeURIComponent(key)}` : `jobId=${encodeURIComponent(jobId)}`;
    const res = await fetch(`/api/analyze?${qs}`); const txt = await res.text();
    let j; try{ j = JSON.parse(txt);}catch{ j = {status:"error",error:"invalid JSON",raw:txt}; }
    onTick({ attempt, response:j });
    if (j.status === "ready") return j;
    if (j.status && j.status !== "pending"){ const e=new Error(j.error||j.status); e.details=j; throw e; }
    await new Promise(r=>setTimeout(r, delay)); delay = Math.min(Math.round(delay*1.5), 8000); attempt++;
  }
  throw new Error("pollAnalyze timeout");
}

document.getElementById('go').onclick = async () => {
  const btn = document.getElementById('go'); const f = document.getElementById('file').files[0];
  if (!f){ alert("Choose a file first."); return; }
  btn.disabled = true; document.getElementById('log').textContent = "Starting…";
  try {
    const safeName = f.name.replace(/[^a-zA-Z0-9._-]+/g, "_");
    const key = `uploads/${Date.now()}-${safeName}`; setKey(key);

    log("Requesting signed URL…");
    const up = await fetch("/api/upload",{method:"POST",headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ key, contentType: f.type || "application/octet-stream" })});
    const upj = await up.json().catch(()=>({})); log(`upload api: ${up.status} ${JSON.stringify(upj)}`);
    if (!up.ok || !upj.url) throw new Error(`upload api failed ${up.status}`);

    log("PUT to S3…");
    const put = await fetch(upj.url,{ method:"PUT", body:f });
    log(`PUT result: ${put.status}`); if (!(put.status===200 || put.status===204)) throw new Error(`PUT failed ${put.status}`);
    const etag = put.headers.get("etag") || null;

    log("Reporting ready…");
    const rep = await reportReady({ key, status:"ready", data:{ size:f.size, type:f.type||"application/octet-stream", etag, t:Date.now() }});
    log(`report: ${JSON.stringify(rep)}`);

    log("Polling analyze…");
    const result = await pollAnalyze({ key, onTick:({attempt,response})=>log(`tick ${attempt}: ${JSON.stringify(response)}`) });
    log(`DONE: ${JSON.stringify(result)}`);

    // If analyze embedded report or returned reportKey, jump straight to viewer:
    if (result.report) {
      // stash & open report UI
      sessionStorage.setItem('vc_report', JSON.stringify(result.report));
      location.href = "/report.html?src=session";
    } else if (result.reportKey) {
      location.href = `/report.html?key=${encodeURIComponent(key)}`;
    } else {
      alert("Processing complete (status updated).");
    }
  } catch(e) {
    log("ERROR: " + (e?.message || e)); console.error(e);
    alert("Upload failed: " + (e?.message || e));
  } finally { btn.disabled = false; }
};
</script>

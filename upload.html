<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Virtual Coach AI — Upload</title>
<link rel="preload" as="image" href="/homepage-background.png"/>
<style>
  :root{ --nav:#0b2b12; --brand:#0b2b12; --scrim: rgba(0,0,0,.06); --panel: rgba(10,18,24,.24); --line: rgba(255,255,255,.08); --text:#ecf3f7; --muted:#cfe0e6; --radius:16px; --shadow:0 8px 24px rgba(0,0,0,.20);}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;color:var(--text);background:url('/homepage-background.png') center/cover fixed no-repeat;font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial}
  .scrim{min-height:100vh;background:var(--scrim)}
  header.top{position:sticky;top:0;z-index:100;background:var(--nav);border-bottom:1px solid rgba(255,255,255,.1)}
  .navwrap{width:min(1080px,92%);margin:0 auto;padding:10px 0;display:flex;gap:12px;align-items:center;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:10px;color:#fff;text-decoration:none;font-weight:800}
  .brand-logo{width:160px;height:36px;background:var(--brand);
    -webkit-mask:url('/virtualcoach-logo-transparent.png') center/contain no-repeat;
            mask:url('/virtualcoach-logo-transparent.png') center/contain no-repeat;}
  .menu-toggle{display:none;align-items:center;gap:8px;color:#fff;background:transparent;border:1px solid rgba(255,255,255,.3);border-radius:10px;padding:6px 10px;cursor:pointer}
  nav.nav{display:flex;gap:8px}
  nav.nav a{color:#fff;text-decoration:none;padding:8px 10px;border-radius:10px;border:1px solid transparent;white-space:nowrap}
  nav.nav a:hover{background:rgba(255,255,255,.08)}
  nav.nav a[aria-current="page"]{border-color:rgba(255,255,255,.18);background:rgba(255,255,255,.10)}
  @media(max-width:820px){
    .menu-toggle{display:inline-flex}
    nav.nav{position:absolute;right:0;top:100%;background:var(--nav);border-bottom:1px solid rgba(255,255,255,.1);display:none;flex-direction:column;padding:8px}
    header.top.open nav.nav{display:flex}
  }

  .wrap{width:min(1080px,92%);margin:0 auto;padding:18px 0 42px}
  .title{font-size:26px;font-weight:800}
  .sub{color:var(--muted);font-size:13px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(1.5px)}
  .card .content{padding:16px}
  .row{margin:12px 0}
  .picker{border:1px dashed rgba(255,255,255,.25);border-radius:12px;padding:16px;display:flex;gap:12px;align-items:center;justify-content:space-between}
  input[type=file]{display:none}
  .btn{border:1px solid var(--line);background:rgba(255,255,255,.10);color:#fff;padding:10px 14px;border-radius:10px;text-decoration:none;display:inline-flex;gap:8px;align-items:center;cursor:pointer}
  .btn:hover{background:rgba(255,255,255,.16)}
  .btn.primary{background:rgba(25,195,125,.18);border-color:#2a6}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  #log{white-space:pre-wrap;background:#0b1520;border:1px solid #123;border-radius:10px;padding:12px;min-height:120px;color:#dfe9f2;font-size:13px}
  .badge{display:inline-block;background:rgba(255,255,255,.06);border:1px solid var(--line);color:#dff3ff;padding:6px 10px;border-radius:999px;font-size:12px}
  .right{margin-left:auto}
</style>
</head>
<body>
  <header class="top" id="site-header">
    <div class="navwrap">
      <a class="brand" href="/"><div class="brand-logo"></div><span>Virtual Coach AI</span></a>
      <button class="menu-toggle" id="menuBtn" aria-expanded="false">Menu ▾</button>
      <nav class="nav" id="siteNav" aria-label="Primary">
        <a href="/index.html">Home</a>
        <a href="/upload.html" aria-current="page">Upload</a>
        <a href="/report.html?report=/report.json">Reports</a>
        <a href="/coming-soon.html">Coming&nbsp;Soon</a>
        <a href="/pricing.html">Pricing</a>
        <a href="/faq.html">FAQ</a>
        <a href="/contact.html">Contact</a>
        <a href="/login.html">Login</a>
      </nav>
    </div>
  </header>

  <div class="scrim">
    <main class="wrap">
      <header style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
        <div class="title">Upload → Report → Analyze</div>
        <span class="badge right" id="keyBadge">(no file)</span>
      </header>

      <section class="card">
        <div class="content">
          <div class="picker">
            <label class="btn">Choose File <input id="file" type="file" accept="video/*,.mov,.mp4,.m4v"/></label>
            <button id="go" class="btn primary">Upload & Generate Report</button>
          </div>
          <div class="row" id="log">Ready.</div>
        </div>
      </section>
    </main>
  </div>

<script>
  // NAV
  const header = document.getElementById('site-header');
  const menuBtn = document.getElementById('menuBtn');
  menuBtn.addEventListener('click', ()=>{
    const open = header.classList.toggle('open');
    menuBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
  });
  document.getElementById('siteNav').addEventListener('click', e=>{
    if(e.target.tagName==='A'){ header.classList.remove('open'); menuBtn.setAttribute('aria-expanded','false'); }
  });

  // Helpers
  const log = (m)=>{ document.getElementById('log').textContent += "\\n" + m; };
  const setKey = (k)=>{ document.getElementById('keyBadge').textContent = k || "(no file)"; };
  function jobIdFromKey(key){ return String(key||"").replace(/^uploads\\//,"").replace(/\\.[^.]+$/,""); }

  async function reportReady({ key, jobId, status="ready", data={} }){
    if (!jobId && key) jobId = jobIdFromKey(key);
    const r = await fetch("/api/report",{
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ jobId, status, data, key })
    });
    const j = await r.json().catch(()=> ({}));
    if (!r.ok || j.ok===false) throw new Error("report api failed: "+(j.error||r.status));
    return j;
  }

  async function makeReport({ key, jobId }){
    const qs = key ? ("key="+encodeURIComponent(key)) : ("jobId="+encodeURIComponent(jobId));
    const r = await fetch("/api/make-report?"+qs, { cache:"no-store" });
    const j = await r.json().catch(()=> ({}));
    if (!r.ok || j.ok===false) throw new Error("make-report failed: "+(j.error||r.status));
    return j;
  }

  document.getElementById('go').onclick = async ()=>{
    const f = document.getElementById('file').files[0];
    if (!f){ alert("Pick a video first."); return; }
    const btn = document.getElementById('go'); btn.disabled = true;
    document.getElementById('log').textContent = "Starting…";

    try{
      // 1) Key
      const safeName = f.name.replace(/[^a-zA-Z0-9._-]+/g,"_");
      const key = `uploads/${Date.now()}-${safeName}`;
      const jobId = jobIdFromKey(key);
      setKey(key);

      // 2) Signed URL
      log("Requesting signed URL…");
      const up = await fetch("/api/upload",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ key, contentType: f.type || "application/octet-stream" })
      });
      const upj = await up.json().catch(()=> ({}));
      log("upload api: "+up.status+" "+JSON.stringify(upj));
      if (!up.ok || !upj.url) throw new Error("upload api failed");

      // 3) PUT to S3
      log("PUT to S3…");
      const put = await fetch(upj.url, { method:"PUT", body:f });
      log("PUT result: "+put.status);
      if (!(put.status===200 || put.status===204)) throw new Error("S3 PUT failed: "+put.status);
      const etag = put.headers.get("etag") || null;

      // 4) Report 'ready' status (so /api/analyze has context)
      log("Reporting ready…");
      await reportReady({
        key, status:"ready",
        data:{ size:f.size, type:f.type||"application/octet-stream", etag, t: Date.now() }
      });

      // 5) Build a report JSON on S3
      log("Generating report JSON…");
      const made = await makeReport({ key });
      log("make-report: "+JSON.stringify(made));

      // 6) Redirect into the report page
      const next = `/report.html?key=${encodeURIComponent(key)}`;
      log("Opening report: "+next);
      location.href = next;
    }catch(e){
      console.error(e);
      log("ERROR: "+(e?.message||e));
      alert("Upload failed: "+(e?.message||e));
    }finally{
      btn.disabled = false;
    }
  };
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>S3 Upload Test</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      padding: 1rem;
      line-height: 1.5;
    }
    #status {
      margin-top: 1rem;
      padding: 0.5rem;
      border: 1px solid #ccc;
      background: #f9f9f9;
      white-space: pre-wrap;
      word-break: break-word;
    }
    a {
      color: #0070f3;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>S3 Upload Test</h1>
  <input type="file" id="fileInput" />
  <br />
  <small>Accepted: .mov, .mp4 (H.264/HEVC), up to 500MB</small>
  <div id="status"></div>

  <script>
    const input = document.getElementById('fileInput');
    const status = document.getElementById('status');

    input.addEventListener('change', async () => {
      const file = input.files[0];
      if (!file) return;

      status.textContent = `Key: uploads/${file.name}\nStarting…`;

      // --- File size cap ---
      const MAX_MB = 500;
      if (file.size > MAX_MB * 1024 * 1024) {
        status.textContent = `Too big. Max ${MAX_MB} MB.`;
        return;
      }

      try {
        // --- Request presign URL ---
        status.textContent += `\nRequesting signed URL…`;
        const qs = new URLSearchParams({
          filename: file.name,
          contentType: file.type || 'application/octet-stream'
        });
        const pre = await fetch(`/api/s3-presign?${qs}`).then(r => r.json());

        // --- Upload to S3 ---
        await fetch(pre.url, {
          method: 'PUT',
          headers: { 'Content-Type': file.type || 'application/octet-stream' },
          body: file
        });

        const publicUrl = `https://${pre.bucket}.s3.${pre.region}.amazonaws.com/${pre.key}`;

        // --- Display success with clickable link ---
        const a = document.createElement('a');
        a.href = publicUrl;
        a.target = '_blank';
        a.textContent = publicUrl;
        status.replaceChildren(
          document.createTextNode('Upload complete:\n'),
          a
        );

        // --- Stub: notify backend to start processing (safe no-op if not implemented yet) ---
        await fetch('/api/process-upload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            key: pre.key,
            bucket: pre.bucket,
            size: file.size,
            contentType: file.type || 'application/octet-stream'
          })
        }).catch(() => {});

      } catch (err) {
        console.error(err);
        status.textContent = `Upload failed: ${err.message || err}`;
      }
    });
  </script>
</body>
</html>

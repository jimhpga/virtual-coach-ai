<!DOCTYPE html>
const inputVideo=document.getElementById('video');
const vid=document.getElementById('preview');
const status=document.getElementById('status');
const filemeta=document.getElementById('filemeta');
const progressCard=document.getElementById('progress-card');
const progressDesc=document.getElementById('progress-desc');
const bar=document.getElementById('bar');


inputVideo.addEventListener('change',()=>{
const file=inputVideo.files?.[0];
if(!file){status.textContent='Idle'; vid.style.display='none'; vid.removeAttribute('src'); filemeta.style.display='none'; return;}
const url=URL.createObjectURL(file);
vid.src=url; vid.style.display='block';
status.textContent='Selected • Ready to upload';
filemeta.style.display='block';
filemeta.textContent=`File: ${file.name} • ${Math.round(file.size/1024)} KB`;
});


document.getElementById('clear-video').addEventListener('click',()=>{
inputVideo.value=""; vid.pause(); vid.removeAttribute('src'); vid.load(); vid.style.display='none';
status.textContent='Idle'; filemeta.style.display='none';
localStorage.removeItem('vca_processing');
document.getElementById('progress-card').style.display='none';
});


const submit=document.getElementById('submit');
const payload=document.getElementById('payload');


submit.addEventListener('click',()=>{
const intake=localStorage.getItem('vca_intake');
const file=inputVideo.files?.[0];
if(!file){ alert('Choose a swing video.'); return; }


status.textContent='Uploading…';
const formData=new FormData();
if(intake) formData.append('intake',intake);
formData.append('video',file,file.name);


payload.style.display='block';
payload.textContent=`POST /api/analyze
Headers: (multipart/form-data)
Intake:
${intake||'(none)'}


Video: ${file.name} (${Math.round(file.size/1024)} KB)`;


// Show processing immediately and persist state so it survives reload/navigation
status.textContent='Uploaded • Processing';
showProcessing(file.name);
localStorage.setItem('vca_processing', JSON.stringify({file:file.name, ts:Date.now()}));
});


function showProcessing(filename){
progressCard.style.display='block';
progressDesc.textContent=`We received ${filename} and started analysis. You can head to Reports — it will appear there when ready.`;
animateBar();
document.getElementById('to-reports').focus();
}


function animateBar(){
let w=0; bar.style.width='0%';
clearInterval(window.__vcaBar);
window.__vcaBar=setInterval(()=>{w=(w+5)%105; bar.style.width=w+'%';},120);
}


(function restoreProcessing(){
const raw=localStorage.getItem('vca_processing');
if(!raw) return; try{const {file}=JSON.parse(raw); if(file) showProcessing(file);}catch{}
})();


(function checkQuery(){
const q=new URLSearchParams(window.location.search);
if(q.get('processing')){showProcessing('your video');}
})();
</script>
</body>
</html>

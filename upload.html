<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Upload — Virtual Coach AI</title>
<link rel="preload" as="image" href="/homepage-background.png" />
<style>
  :root{
    --nav:#0b2b12; --scrim: rgba(0,0,0,.05);
    --panel: rgba(0,0,0,.30); --line: rgba(255,255,255,.12);
    --text:#f2f7f9; --muted:#cfe0e6; --maxw:980px; --radius:14px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;background:url('/homepage-background.png') center/cover fixed no-repeat;}
  .scrim{min-height:100vh;background:var(--scrim);}
  .wrap{width:min(var(--maxw),94%);margin:0 auto;padding:16px 0 40px}
  .card{padding:16px;border:1px solid var(--line);border-radius:var(--radius);background:var(--panel);backdrop-filter:blur(2px)}
  .row{display:grid;gap:12px}
  .hint{color:var(--muted)}
  .btn{border:1px solid var(--line);background:rgba(255,255,255,.12);color:#fff;padding:10px 14px;border-radius:12px;text-decoration:none;font-weight:600;cursor:pointer}
  .btn.primary{background:rgba(0,255,153,.16);border-color:#0a7}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:6px;color:#dfecef;font-size:.95rem;margin-top:8px}
  footer{width:min(var(--maxw),94%);margin:10px auto 26px;text-align:center;color:#cbd9de;font-size:12px}
</style>
</head>
<body>
  <div id="navMount"></div>
  <script src="/nav.js" defer></script>

  <div class="scrim">
    <main class="wrap">
      <h1 style="margin:6px 0 12px">Upload Your Swing</h1>
      <div class="card">
        <p class="hint">iPhone: use <strong>Record Video</strong> (camera) or <strong>Choose from Library</strong> (Photos). Desktop works, too.</p>

        <!-- hidden inputs -->
        <input id="file-record" type="file" accept="video/*" capture="environment" style="display:none" />
        <input id="file-choose" type="file" accept="video/*" style="display:none" />

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
          <button id="btnRecord" class="btn">Record Video</button>
          <button id="btnChoose" class="btn">Choose from Library</button>
          <button id="make" class="btn primary" disabled>Submit Video</button>
          <button id="reset" class="btn" disabled>Reset</button>
        </div>

        <div id="meta" style="display:none;margin-top:10px">
          <div class="kv"><div>Filename</div><div id="m_name"></div></div>
          <div class="kv"><div>Size</div><div id="m_size"></div></div>
          <div class="kv"><div>Duration</div><div id="m_dur"></div></div>
        </div>

        <p id="err" style="color:#ffd1d1;margin-top:10px"></p>
      </div>
    </main>

    <footer>© <span id="y"></span> Virtual Coach AI</footer>
  </div>

<script>
  document.getElementById('y').textContent = new Date().getFullYear();

  // Simple gate
  try{ if (localStorage.getItem('vc_auth') !== 'ok') location.href = '/login.html?next=upload'; }catch{}

  const fileRecord = document.getElementById('file-record');
  const fileChoose = document.getElementById('file-choose');
  const btnRecord  = document.getElementById('btnRecord');
  const btnChoose  = document.getElementById('btnChoose');
  const makeBtn    = document.getElementById('make');
  const resetBtn   = document.getElementById('reset');
  const errEl      = document.getElementById('err');
  const metaBox    = document.getElementById('meta');
  const mName      = document.getElementById('m_name');
  const mSize      = document.getElementById('m_size');
  const mDur       = document.getElementById('m_dur');

  let chosenFile = null;
  let duration = 0;

  const fmtBytes = b=>{ if(b==null) return '—'; const u=['B','KB','MB','GB']; let i=0,n=b; while(n>=1024&&i<u.length-1){n/=1024;i++;} return n.toFixed(1)+' '+u[i]; };
  const fmtSec = s=>{ if(!s) return '—'; const m=Math.floor(s/60); const r=Math.round(s%60); return `${m}:${String(r).padStart(2,'0')}`; };

  function showMeta(f){
    metaBox.style.display='';
    mName.textContent = f.name || '(camera video)';
    mSize.textContent = fmtBytes(f.size);
  }

  async function probeDuration(file){
    try{
      const v = document.createElement('video');
      v.preload='metadata'; v.muted=true; v.playsInline=true;
      v.src = URL.createObjectURL(file);
      await new Promise((res,rej)=>{
        const to=setTimeout(()=>rej(new Error('metadata timeout')),12000);
        v.onloadedmetadata=()=>{clearTimeout(to);res();};
        v.onerror=()=>{clearTimeout(to);rej(new Error('metadata error'));};
      });
      const d = isFinite(v.duration)?v.duration:0;
      URL.revokeObjectURL(v.src);
      return d;
    }catch{return 0;}
  }

  function clearAll(){
    errEl.textContent='';
    metaBox.style.display='none';
    mName.textContent=mSize.textContent=mDur.textContent='';
    fileRecord.value=''; fileChoose.value='';
    chosenFile=null; duration=0;
    makeBtn.disabled=true; resetBtn.disabled=true;
  }

  btnRecord.addEventListener('click', ()=> fileRecord.click());
  btnChoose.addEventListener('click', ()=> fileChoose.click());
  resetBtn.addEventListener('click', clearAll);

  async function onPicked(file){
    errEl.textContent='';
    if(!file || !/^video\//i.test(file.type||'')){ errEl.textContent='Please choose a video.'; return; }
    chosenFile = file;
    showMeta(file);
    duration = await probeDuration(file);
    mDur.textContent = fmtSec(duration);
    makeBtn.disabled=false; resetBtn.disabled=false;
  }
  fileRecord.addEventListener('change', e=>{ if(e.target.files&&e.target.files[0]) onPicked(e.target.files[0]); });
  fileChoose.addEventListener('change', e=>{ if(e.target.files&&e.target.files[0]) onPicked(e.target.files[0]); });

  makeBtn.addEventListener('click', async ()=>{
    if(!chosenFile){ errEl.textContent='Choose a video first.'; return; }
    try{
      // 1) Presign
      const q = new URLSearchParams({ filename: chosenFile.name || 'swing.mp4', contentType: chosenFile.type || 'video/mp4' });
      const presignRes = await fetch(`/api/sign-upload?${q.toString()}`, { method:'GET' });
      if(!presignRes.ok) throw new Error('Presign failed');
      const { uploadUrl, publicUrl, viewUrl } = await presignRes.json();

      // 2) Upload
      const put = await fetch(uploadUrl, { method:'PUT', headers:{ 'Content-Type': chosenFile.type || 'video/mp4' }, body: chosenFile });
      if(!put.ok) throw new Error('S3 upload failed');

      // 3) Build report (use signed viewUrl so private buckets still play)
      const now = new Date();
      const durScore = Math.max(40, Math.min(95, Math.round((duration||3)*8)));
      const relScore = Math.max(35, Math.min(90, Math.round(60 + ((duration||0)-3)*5)));
      const videoHref = viewUrl || publicUrl;

      const phases = [
        ['P1','Setup'],['P2','Takeaway'],['P3','Lead Arm Parallel'],['P4','Top'],
        ['P5','Delivery'],['P6','Shaft Parallel'],['P7','Impact'],['P8','Post-Impact'],['P9','Finish']
      ].map(([id,name])=>({ id, name, grade:'ok', short:'Review with coach', long:'Tap Video to view your swing for this checkpoint.', ref: videoHref }));

      const report = {
        discipline:'Full Swing', date: now.toISOString(), swings:1,
        phases,
        coaching:{
          priority_fixes:[
            { title:'One Key Feel', short:'Pick one cue only', long:'Use one external cue for the next 15 balls (e.g., finish tall).', ref:''},
            { title:'Tempo Baseline', short:'~3:1', long:'Count “one-two-three-hit” to smooth transition.', ref:''},
            { title:'Impact Check', short:'Ball then turf', long:'Half swings with a mid-iron; video two reps to confirm.', ref:''}
          ],
          power_fixes:[
            { title:'Finish Tall', short:'No stall', long:'Let your chest face the target and stand tall.', ref:''}
          ]
        },
        position_metrics:[{label:'Setup Match',value:72},{label:'Top Position',value:66},{label:'Impact Alignments',value:70}],
        swing_metrics:[{label:'Tempo Repeatability',value:76},{label:'Face-to-Path Stability',value:64}],
        power:{ score:durScore, tempo:'~3:1', release_timing:relScore }
      };

      // Save both places; redirect with src=local (more reliable on iPhone)
      try{
        sessionStorage.setItem('vc_report', JSON.stringify(report));
        localStorage.setItem('vc_last_report', JSON.stringify(report));
      }catch(e){ console.warn('Storage issue:', e); }

      location.href = '/report.html?src=local';
    }catch(e){
      console.error(e);
      errEl.textContent = e.message || String(e);
    }
  });
</script>
</body>
</html>

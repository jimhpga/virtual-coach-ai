<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="Cache-Control" content="no-store, max-age=0" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Virtual Coach AI — Upload</title>
<link rel="preload" as="image" href="/homepage-background.png" />
<style>
  :root{ --nav:#0b2b12; --brand:#0b2b12; --scrim: rgba(0,0,0,.06);
         --panel: rgba(10,18,24,.24); --line: rgba(255,255,255,.08);
         --text:#ecf3f7; --muted:#cfe0e6; --radius:16px; --shadow:0 8px 24px rgba(0,0,0,.20);
         --ok:#19c37d; --warn:#f6c453; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;color:var(--text);background:url('/homepage-background.png') center/cover fixed no-repeat;font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial}
  .scrim{min-height:100vh;background:var(--scrim)}

  /* NAV */
  header.top{position:sticky;top:0;z-index:100;background:var(--nav);border-bottom:1px solid rgba(255,255,255,.1)}
  .navwrap{width:min(1080px,92%);margin:0 auto;padding:10px 0;display:flex;gap:12px;align-items:center;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:10px;color:#fff;text-decoration:none;font-weight:800}
  .brand-logo{width:160px;height:36px;background:var(--brand);
    -webkit-mask:url('/virtualcoach-logo-transparent.png') center/contain no-repeat;
            mask:url('/virtualcoach-logo-transparent.png') center/contain no-repeat;}
  .menu-toggle{display:none;align-items:center;gap:8px;color:#fff;background:transparent;border:1px solid rgba(255,255,255,.3);border-radius:10px;padding:6px 10px;cursor:pointer}
  nav.nav{display:flex;gap:8px}
  nav.nav a{color:#fff;text-decoration:none;padding:8px 10px;border-radius:10px;border:1px solid transparent;white-space:nowrap}
  nav.nav a:hover{background:rgba(255,255,255,.08)}
  nav.nav a[aria-current="page"]{border-color:rgba(255,255,255,.18);background:rgba(255,255,255,.10)}
  @media(max-width:820px){
    .menu-toggle{display:inline-flex}
    nav.nav{position:absolute;right:0;top:100%;background:var(--nav);border-bottom:1px solid rgba(255,255,255,.1);display:none;flex-direction:column;padding:8px}
    header.top.open nav.nav{display:flex}
  }

  .wrap{width:min(1080px,92%);margin:0 auto;padding:18px 0 42px}

  h1{margin:8px 0 6px;font-size:28px;font-weight:900}
  .lead{color:var(--muted);max-width:68ch}
  .badge{background:rgba(255,255,255,.06);border:1px solid var(--line);color:#dff3ff;padding:6px 10px;border-radius:999px;font-size:12px}

  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px;margin-top:12px}
  @media(max-width:960px){.grid{grid-template-columns:1fr}}

  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--line)}
  .card .content{padding:12px 16px}

  label{display:block;font-weight:700;margin:8px 0 6px}
  .req{color:#ffd479}
  .hint{color:var(--muted);font-size:12px}
  input[type="text"], input[type="email"], input[type="number"], select, button, .filebox{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:rgba(255,255,255,.08); color:#fff;
  }
  input::placeholder{color:#cfe0e699}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:700px){.row{grid-template-columns:1fr}}

  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .btn{border:1px solid var(--line);background:rgba(255,255,255,.10);color:#fff;padding:10px 14px;border-radius:10px;text-decoration:none;display:inline-flex;gap:8px;align-items:center;cursor:pointer}
  .btn:hover{background:rgba(255,255,255,.16)}
  .btn.primary{background:rgba(25,195,125,.18);border-color:#2a6;}
  .btn.warn{background:rgba(246,196,83,.18);border-color:#b8860b;}
  .btn.ghost{background:rgba(255,255,255,.06);}
  .btn[disabled], .btn.disabled{opacity:.55;cursor:not-allowed;pointer-events:none}

  .stepper{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .step{display:flex;align-items:center;gap:8px}
  .dot{width:20px;height:20px;border-radius:50%;border:2px solid #456;display:inline-block;background:transparent}
  .step.active .dot{background:var(--warn);border-color:var(--warn)}
  .step.done .dot{background:var(--ok);border-color:var(--ok)}
  .step label{font-size:13px;color:#cfe0e6}
  .progress{height:10px;border-radius:999px;background:#10222c;border:1px solid #22404f;position:relative;overflow:hidden}
  .progress>span{position:absolute;left:0;top:0;bottom:0;border-radius:999px;background:linear-gradient(90deg,#19c37d,#2bd897);width:0%}
  .filebox{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .filebox .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#dfefff}

  pre{margin:0;padding:12px;background:rgba(0,0,0,.28);border:1px solid var(--line);border-radius:12px;white-space:pre-wrap;word-wrap:break-word}

  /* Make dropdown list readable on all browsers */
  select option{color:#111;background:#fff}
</style>
</head>
<body>
  <header class="top" id="site-header">
    <div class="navwrap">
      <a class="brand" href="/"><div class="brand-logo"></div><span>Virtual Coach AI</span></a>
      <button class="menu-toggle" id="menuBtn" aria-expanded="false">Menu ▾</button>
      <nav class="nav" id="siteNav" aria-label="Primary">
        <a href="/index.html">Home</a>
        <a href="/upload.html" aria-current="page">Upload</a>
        <a href="/report.html?report=/report.json">Reports</a>
        <a href="/pricing.html">Pricing</a>
        <a href="/faq.html">FAQ</a>
        <a href="/team.html">Team</a>
        <a href="/contact.html">Contact</a>
        <a href="/login.html">Login</a>
      </nav>
    </div>
  </header>

  <div class="scrim">
    <main class="wrap">
      <header style="margin-bottom:8px">
        <h1>Best Results Come From Good Footage</h1>
        <p class="lead">Record from ~8–12 ft, <strong>down-the-line</strong> or <strong>face-on</strong>, landscape, with your whole body and club in frame.</p>
        <details class="tips"><summary>Recording tips (quick)</summary>
          <div class="content">• Steady camera (tripod). • Bright, even light. • Avoid extreme wide-angle. • Ball & hands visible at impact.</div>
        </details>
      </header>

      <section class="grid">
        <!-- LEFT: Intake + Upload -->
        <div class="card">
          <h3>Upload Swing</h3>
          <div class="content">
            <div class="row">
              <div>
                <label for="first">First name</label>
                <input id="first" type="text" placeholder="e.g., Jim" autocomplete="off" />
              </div>
              <div>
                <label for="email">Email <span class="hint">(optional)</span></label>
                <input id="email" type="email" placeholder="Add if you want the report emailed to you" autocomplete="off" />
              </div>
            </div>

            <div class="row">
              <div>
                <label for="eye">Eye dominance <span class="req">*</span></label>
                <select id="eye" required>
                  <option value="" selected disabled>Select…</option>
                  <option value="right">Right eye</option>
                  <option value="left">Left eye</option>
                  <option value="unknown">Not sure</option>
                </select>
              </div>
              <div>
                <label for="hand">Handedness</label>
                <select id="hand">
                  <option value="" selected disabled>Select…</option>
                  <option value="right">Right</option>
                  <option value="left">Left</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label for="gender">Gender</label>
                <select id="gender">
                  <option value="" selected>Prefer not to say</option>
                  <option value="man">Man</option>
                  <option value="woman">Woman</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div>
                <label for="height">Height (inches) <span class="req">*</span></label>
                <input id="height" type="number" min="40" max="90" placeholder="e.g., 70 for 5'10&quot;" required />
              </div>
            </div>

            <div class="row">
              <div>
                <label for="bodyShape">Body build (optional)</label>
                <select id="bodyShape">
                  <option value="" selected>— Select —</option>
                  <option value="slim">Slim / Lean</option>
                  <option value="average">Average / Athletic</option>
                  <option value="muscular">Muscular / Stocky</option>
                  <option value="tall-lean">Tall / Lean</option>
                  <option value="short-compact">Short / Compact</option>
                </select>
              </div>
              <div>
                <label for="focus">Focus area (optional)</label>
                <select id="focus">
                  <option value="" selected>— None —</option>
                  <option>Setup</option><option>Grip</option><option>Takeaway (P2)</option>
                  <option>Backswing (P3)</option><option>Top (P4)</option><option>Transition</option>
                  <option>Downswing</option><option>Shaft Parallel Down (P6)</option><option>Impact (P7)</option>
                  <option>Release</option><option>Finish</option><option>Swing Plane</option>
                  <option>Club Path</option><option>Face Control</option><option>Tempo</option>
                  <option>Kinematic Sequence</option><option>Posture</option><option>Ball Position</option>
                  <option>Alignment</option>
                </select>
              </div>
            </div>

            <div style="margin-top:10px">
              <label for="file">Swing video</label>
              <div class="filebox">
                <input id="file" type="file" accept="video/*" />
                <span class="name" id="fname">No file chosen</span>
              </div>
              <div class="hint" id="fmeta" style="margin-top:6px"></div>
            </div>

            <div class="actions">
              <button class="btn primary" id="btnUpload" type="button">Start upload</button>
              <button class="btn ghost" id="btnReset" type="button">Reset</button>
              <a class="btn warn disabled" id="btnOpenReport" href="#" target="_blank" rel="noopener" aria-disabled="true">Open Report</a>
            </div>
          </div>
        </div>

        <!-- RIGHT: Status + Steps + Summary -->
        <div class="card">
          <h3>Status</h3>
          <div class="content">
            <div class="stepper" style="margin-bottom:10px">
              <div class="step" id="s1"><span class="dot"></span><label>1. Upload</label></div>
              <div class="step" id="s2"><span class="dot"></span><label>2. Processing</label></div>
              <div class="step" id="s3"><span class="dot"></span><label>3. Ready</label></div>
              <span class="badge" id="pill" style="margin-left:auto">Idle</span>
              <span class="badge" id="qcPill" style="display:none">QC</span>
            </div>
            <div class="progress" aria-label="Progress"><span id="bar"></span></div>
            <div class="hint" id="statusLine" style="margin-top:8px">Waiting for a file…</div>

            <h3 style="margin-top:16px;border:none;padding-top:16px">Your Info</h3>
            <ul id="summaryList" style="margin:0 0 8px 18px;color:#cfe0e6"></ul>
            <details>
              <summary style="cursor:pointer;color:#dff3ff">Show details (JSON)</summary>
              <pre id="summary">{}</pre>
            </details>
          </div>
        </div>
      </section>
    </main>
  </div>

<script>
(function(){
  // NAV
  var header = document.getElementById('site-header');
  var menuBtn = document.getElementById('menuBtn');
  if (menuBtn) menuBtn.addEventListener('click', function(){
    var open = header.classList.toggle('open');
    menuBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
  });
  var siteNav = document.getElementById('siteNav');
  if (siteNav) siteNav.addEventListener('click', function(e){
    if(e.target && e.target.tagName === 'A'){ header.classList.remove('open'); menuBtn && menuBtn.setAttribute('aria-expanded','false'); }
  });

  // Shortcuts
  function $(sel){ return document.querySelector(sel); }
  var fileInput = $('#file'), fname = $('#fname'), fmeta = $('#fmeta');
  var bar = $('#bar'), pill = $('#pill'), qcPill = $('#qcPill'), statusLine = $('#statusLine');
  var btnUpload = $('#btnUpload'), btnReset = $('#btnReset'), btnOpenReport = $('#btnOpenReport');

  var fields = ['first','email','eye','hand','gender','height','bodyShape','focus'];
  var data = {}; fields.forEach(function(k){ data[k]=''; });

  function deriveHints(d){
    var hand = (d.hand||'').toLowerCase();
    var eye  = (d.eye||'').toLowerCase();
    var cross = (hand && eye) ? (hand.charAt(0) !== eye.charAt(0)) : false;
    var aim = 'neutral';
    if (hand==='right' && eye==='left') aim='left';
    if (hand==='left' && eye==='right') aim='right';
    var h = Number(d.height||0);
    var scale = h ? +(h/70).toFixed(2) : '';
    return { cross_dominant: !!cross, aim_bias: aim, scale_factor: scale };
  }

  function inchesToFeetIn(n){
    n = Number(n||0); if(!n) return '';
    var ft = Math.floor(n/12), inch = n%12;
    return ft + '′' + inch + '″ (' + n + '")';
  }

  function renderSummaryList(d){
    var derived = deriveHints(d);
    var items = [
      ['Name', d.first || '—'],
      ['Email', d.email ? 'On file' : '—'],
      ['Eye', d.eye || '—'],
      ['Hand', d.hand || '—'],
      ['Gender', d.gender || '—'],
      ['Height', d.height ? inchesToFeetIn(d.height) : '—'],
      ['Body build', d.bodyShape || '—'],
      ['Focus', d.focus || '—'],
      ['Notes', 'Cross-dominant: ' + (derived.cross_dominant?'Yes':'No') + ' • Aim bias: ' + derived.aim_bias + ' • Scale: ' + (derived.scale_factor||'—')]
    ];
    var ul = document.getElementById('summaryList');
    ul.innerHTML = items.map(function(x){ return '<li><strong>'+x[0]+':</strong> '+x[1]+'</li>'; }).join('');
    document.getElementById('summary').textContent = JSON.stringify({ ...d, derived }, null, 2);
  }

  function updateSummary(){
    fields.forEach(function(k){
      var el = document.getElementById(k);
      if (!el) return;
      if (el.tagName === 'INPUT' && el.type === 'number'){
        data[k] = el.value ? Number(el.value) : '';
      } else {
        data[k] = (el.value||'').trim();
      }
    });
    renderSummaryList(data);
    try{
      var saved = JSON.parse(localStorage.getItem('vc_prefill')||'{}');
      fields.forEach(function(k){ saved[k]=data[k]; });
      localStorage.setItem('vc_prefill', JSON.stringify(saved));
    }catch(e){}
  }

  function prefillFromLocal(){
    try{
      var p = JSON.parse(localStorage.getItem('vc_prefill')||'{}');
      var li = JSON.parse(localStorage.getItem('vc_last_intake')||'null');
      var merged = {};
      [p, (li && li.intake)||{}].forEach(function(src){
        Object.keys(src||{}).forEach(function(k){ if (src[k]!==undefined && src[k]!==null && src[k]!=='') merged[k]=src[k]; });
      });
      fields.forEach(function(k){
        var el = document.getElementById(k);
        if (el && merged[k] !== undefined){
          el.value = String(merged[k]);
        }
      });
    }catch(e){}
  }

  function wireInputs(){
    fields.forEach(function(k){
      var el = document.getElementById(k);
      if (el) el.addEventListener('input', updateSummary);
    });
  }

  // File UI
  if (fileInput) fileInput.addEventListener('change', function(){
    var f = fileInput.files && fileInput.files[0];
    if (!f){ fname.textContent = 'No file chosen'; fmeta.textContent = ''; return; }
    fname.textContent = f.name;
    fmeta.textContent = (f.size/1024/1024).toFixed(1)+' MB • '+(f.type||'video');
    status('File selected. Ready to upload.', 'warn');
  });

  // Stepper helpers
  function step(n){
    ['#s1','#s2','#s3'].forEach(function(sel, i){
      var el = $(sel);
      if (!el) return;
      el.classList.remove('active','done');
      if (i < n-1) el.classList.add('done');
      if (i === n-1) el.classList.add('active');
    });
  }
  function progress(pct){ if (bar) bar.style.width = Math.max(0, Math.min(100, pct)) + '%'; }
  function status(text, tone){
    if (statusLine) statusLine.textContent = text;
    if (pill){
      pill.textContent = text.split('.')[0];
      pill.style.background = tone==='ok'?'rgba(25,195,125,.18)':tone==='warn'?'rgba(246,196,83,.18)':'rgba(255,255,255,.10)';
      pill.style.borderColor = tone==='ok'?'#2a6':tone==='warn'?'#b8860b':'rgba(255,255,255,.18)';
    }
  }

  // QC badge
  function showQC(result){
    if (!qcPill) return;
    if (!result || !result.status){ qcPill.style.display='none'; return; }
    qcPill.style.display='inline-flex';
    if (result.status === 'ok'){ qcPill.textContent='QC: Passed'; qcPill.style.background='rgba(25,195,125,.18)'; qcPill.style.borderColor='#2a6'; }
    else if (result.status === 'warn'){ qcPill.textContent='QC: Warnings'; qcPill.style.background='rgba(246,196,83,.18)'; qcPill.style.borderColor='#b8860b'; }
    else { qcPill.textContent='QC: Failed'; qcPill.style.background='rgba(255,107,107,.18)'; qcPill.style.borderColor='#c44'; btnOpenReport.classList.add('disabled'); btnOpenReport.setAttribute('aria-disabled','true'); }
  }
  async function runQC(key){
    try{
      var r = await fetch('/api/qc?key='+encodeURIComponent(key), { cache:'no-store' });
      if (!r.ok) throw new Error('HTTP '+r.status);
      var out = await r.json();
      showQC(out);
      return out;
    }catch(e){ showQC(null); return null; }
  }

  // Upload helpers
  function makeKey(file){
    var safe = (file.name||'video').replace(/[^a-z0-9_.-]+/gi,'_').toLowerCase();
    return 'uploads/'+Date.now()+'-'+safe;
  }
  async function getUploadTarget(file, key){
    var res = await fetch('/api/upload', {
      method:'POST', headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ filename: file.name, type: file.type, key })
    });
    if (!res.ok) throw new Error('Upload init failed: HTTP '+res.status);
    return res.json();
  }
  async function postIntake(key, intake){
    try{
      var res = await fetch('/api/intake', {
        method:'POST', headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ key, intake })
      });
      if (!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }catch(e){ return { ok:false, error:String(e.message||e) }; }
  }
  function putWithProgress(url, file){
    return new Promise(function(resolve, reject){
      var xhr = new XMLHttpRequest();
      xhr.open('PUT', url, true);
      xhr.setRequestHeader('Content-Type', file.type || 'application/octet-stream');
      xhr.upload.onprogress = function(e){ if (e.lengthComputable){ progress( Math.round((e.loaded/e.total)*80) ); } };
      xhr.onload = function(){ (xhr.status>=200 && xhr.status<300) ? resolve() : reject(new Error('Upload error: HTTP '+xhr.status)); };
      xhr.onerror = function(){ reject(new Error('Network error during upload')); };
      xhr.send(file);
    });
  }
  async function postForm(url, fields, file){
    var fd = new FormData();
    Object.keys(fields||{}).forEach(function(k){ fd.append(k, fields[k]); });
    fd.append('file', file);
    var tick = setInterval(function(){ var cur = parseFloat(bar.style.width)||0; if (cur < 78) progress(cur + 2); else clearInterval(tick); }, 200);
    var res = await fetch(url, { method:'POST', body:fd });
    clearInterval(tick);
    if (!res.ok) throw new Error('Upload error: HTTP '+res.status);
  }

  async function startUpload(){
    var f = fileInput && fileInput.files && fileInput.files[0];
    if (!f){ alert('Choose a swing video first.'); return; }
    if (!document.getElementById('eye').value){ alert('Pick eye dominance.'); document.getElementById('eye').focus(); return; }
    if (!document.getElementById('height').value){ alert('Enter height (inches).'); document.getElementById('height').focus(); return; }

    btnUpload.disabled = true; btnOpenReport.classList.add('disabled'); btnOpenReport.setAttribute('aria-disabled','true');
    step(1); progress(2); status('Uploading…', 'warn');

    var clientKey = makeKey(f);
    var finalKey = clientKey;

    try{
      var target;
      try{ target = await getUploadTarget(f, clientKey); } catch(_){ target = { key: clientKey }; }
      if (target.key) finalKey = target.key;

      if (target.putUrl){ await putWithProgress(target.putUrl, f); }
      else if (target.url && target.fields){ await postForm(target.url, target.fields, f); }
      else {
        var fd = new FormData(); fd.append('file', f); fd.append('key', finalKey);
        var r = await fetch('/api/upload', { method:'POST', body:fd });
        if (!r.ok) throw new Error('Upload error: HTTP '+r.status);
      }

      progress(82); step(2); status('Processing…', 'warn');
      saveIntake(finalKey);
      postIntake(finalKey, { ...data, derived: deriveHints(data) });
      pollAnalyze(finalKey);
    }catch(err){
      status('Upload failed',''); progress(0); step(1);
      alert('Upload failed: '+(err.message||err));
      btnUpload.disabled = false;
    }
  }

  function saveIntake(key){
    try{ localStorage.setItem('vc_last_intake', JSON.stringify({ key, intake: data, ts: Date.now() })); }catch(e){}
  }

  var pollTimer = null;
  async function checkAnalyze(key){
    var r = await fetch('/api/analyze?key='+encodeURIComponent(key), { cache:'no-store' });
    if (!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }
  async function pollAnalyze(key){
    async function tick(){
      try{
        var out = await checkAnalyze(key);
        if (out.status === 'ready'){
          clearInterval(pollTimer); pollTimer = null;
          progress(100); step(3); status('Ready ✓', 'ok');
          await runQC(key);
          var url = '/report.html?key='+encodeURIComponent(key);
          btnOpenReport.href = url; btnOpenReport.classList.remove('disabled'); btnOpenReport.removeAttribute('aria-disabled');
          if (out.report){ try{ localStorage.setItem('vc_last_report', JSON.stringify(out.report)); }catch(e){} }
          return;
        }
        var cur = parseFloat(bar.style.width)||82;
        progress( Math.min(98, cur + Math.random()*2) );
        status('Processing…', 'warn');
      }catch(e){
        status('Checking…', 'warn');
      }
    }
    await tick();
    pollTimer = setInterval(tick, 7000);
  }

  if (btnUpload) btnUpload.addEventListener('click', startUpload);
  if (btnReset) btnReset.addEventListener('click', function(){
    fields.forEach(function(k){ var el = document.getElementById(k); if(el) el.value=''; });
    updateSummary(); if (fileInput){ fileInput.value=''; fname.textContent='No file chosen'; fmeta.textContent=''; }
    step(1); progress(0); status('Idle',''); btnUpload.disabled=false;
    btnOpenReport.classList.add('disabled'); btnOpenReport.setAttribute('aria-disabled','true'); btnOpenReport.href='#';
    showQC(null);
  });

  // Boot
  step(1); progress(0); status('Idle','');
  prefillFromLocal();
  wireInputs();
  updateSummary();
})();
</script>
</body>
</html>

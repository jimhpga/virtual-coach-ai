<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Virtual Coach AI – Upload</title>
  <style>
    :root{ --green:#003300; }
    html,body{ height:100%; margin:0; }
    body{
      font-family: Arial, sans-serif; color:#fff; text-align:center;
      background:#000 url('homepage-background.png') no-repeat center/cover fixed;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    nav{position:sticky;top:0;background:var(--green);padding:8px 0}
    nav a{color:#fff;text-decoration:none;font-weight:700;margin:0 12px}
    main{max-width:840px;margin:30px auto;padding:16px;background:rgba(0,0,0,.35);border-radius:12px}
    h1{margin-top:0}
    .row{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap}
    input[type="file"]{
      background: rgba(0,0,0,0.28); color:#fff;
      border:1px solid rgba(255,255,255,.35); border-radius:6px; padding:6px;
    }
    input[type="file"]::file-selector-button{
      background:var(--green); color:#fff; border:none; border-radius:4px; padding:6px 10px; cursor:pointer;
    }
    button{ background:var(--green); color:#fff; border:none; border-radius:6px; padding:8px 14px; cursor:pointer; }
    #status{ margin-top:12px; font-weight:600; white-space:pre-wrap; text-align:left; background:#1118; padding:10px; border-radius:8px; }
    video{ width:100%; max-height:400px; margin-top:16px; display:none; }
    small{ display:block; color:#ccc; margin-top:6px; }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">Home</a>
    <a href="about.html">About</a>
    <a href="coming-soon.html">Coming Soon</a>
    <a href="contact.html">Contact</a>
    <a href="/upload.html" aria-current="page">Upload</a>
  </nav>

  <main>
    <h1>Upload Your Swing</h1>
    <div class="row">
      <input type="file" id="fileInput" accept="video/*" />
      <button id="uploadBtn">Upload</button>
    </div>
    <small>iPhone videos (.mov) are fine — uploaded as-is to the cloud.</small>

    <div id="status">Idle</div>
    <video id="preview" controls></video>
  </main>

  <script>
    // --- Element refs
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const statusBox = document.getElementById('status');
    const preview = document.getElementById('preview');

    // --- Helpers used by the bottom block
    function setStatus(text, isError=false){
      statusBox.textContent = text;
      statusBox.style.color = isError ? '#ffd7d7' : '#bfffc7';
    }
    function guessContentType(file){
      if (file.type) return file.type;
      const n = (file.name||'').toLowerCase();
      if (n.endsWith('.mp4')) return 'video/mp4';
      if (n.endsWith('.mov')) return 'video/quicktime';
      return 'application/octet-stream';
    }

    // live preview when a file is chosen
    fileInput.addEventListener('change', () => {
      const f = fileInput.files[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      preview.src = url;
      preview.style.display = 'block';
    });

    // --- YOUR BOTTOM BLOCK (unchanged) ---
    uploadBtn.addEventListener('click', async () => {
      const file = fileInput.files[0];
      if (!file){ setStatus('Please select a video file first.', true); return; }

      setStatus('Requesting upload link…');
      let presign;
      try{
        const res = await fetch('/api/s3-presign', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            filename: file.name,
            contentType: guessContentType(file)
          })
        });
        if (!res.ok){
          const t = await res.text().catch(()=> '');
          setStatus(`Failed to get upload URL. Status ${res.status}\n${t}`, true);
          return;
        }
        presign = await res.json();
      }catch(e){
        setStatus(`Error contacting /api/s3-presign: ${e.message}`, true);
        return;
      }

      const { url, fields, publicUrl } = presign || {};
      if (!url || !fields){ setStatus('Bad presign response from server.', true); return; }

      setStatus('Uploading to S3…');
      const formData = new FormData();
      Object.entries(fields).forEach(([k,v]) => formData.append(k,v));
      formData.append('file', file);

      let s3Res, s3Text='';
      try{
        s3Res = await fetch(url, { method:'POST', body: formData });
        // S3 may return 204 No Content, we still read text() in case of error
        s3Text = await s3Res.text().catch(()=> '');
      }catch(e){
        setStatus(`Network error posting to S3: ${e.message}`, true);
        return;
      }

      if (!s3Res.ok){
        setStatus(`S3 upload failed: ${s3Res.status} ${s3Res.statusText}\n---\n${s3Text}`, true);
        return;
      }

      try{ sessionStorage.setItem('uploadedVideoUrl', publicUrl); }catch{}
      setStatus('Upload complete. Redirecting…');
      window.location.href = 'report.html';
    });
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Upload — Virtual Coach AI</title>
<link rel="preload" as="image" href="/homepage-background.png" />
<style>
  :root{
    --nav:#0b2b12; --brand:#0b2b12; --scrim: rgba(0,0,0,.05);
    --panel: rgba(0,0,0,.30); --line: rgba(255,255,255,.12);
    --text:#f2f7f9; --muted:#cfe0e6; --maxw:980px; --radius:14px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;background:url('/homepage-background.png') center/cover fixed no-repeat;}
  .scrim{min-height:100vh;background:var(--scrim);}

  /* NAV (hamburger) */
  header.top{position:sticky;top:0;z-index:100;background:var(--nav);border-bottom:1px solid rgba(255,255,255,.1)}
  .navwrap{width:min(var(--maxw),94%);margin:0 auto;padding:10px 0;display:flex;gap:12px;align-items:center;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:10px;color:#fff;text-decoration:none;font-weight:800}
  .brand-logo{width:160px;height:36px;background:var(--brand);
    -webkit-mask:url('/virtualcoach-logo-transparent.png') center/contain no-repeat;
            mask:url('/virtualcoach-logo-transparent.png') center/contain no-repeat;}
  .menu-toggle{display:none;align-items:center;gap:8px;color:#fff;background:transparent;border:1px solid rgba(255,255,255,.3);border-radius:10px;padding:6px 10px;cursor:pointer}
  nav.nav{display:flex;gap:8px}
  nav.nav a{color:#fff;text-decoration:none;padding:8px 10px;border-radius:10px;border:1px solid transparent;white-space:nowrap}
  nav.nav a:hover{background:rgba(255,255,255,.08)}
  nav.nav a[aria-current="page"]{border-color:rgba(255,255,255,.18);background:rgba(255,255,255,.10)}
  @media(max-width:820px){
    .menu-toggle{display:inline-flex}
    nav.nav{position:absolute;right:0;top:100%;background:var(--nav);border-bottom:1px solid rgba(255,255,255,.1);display:none;flex-direction:column;padding:8px}
    header.top.open nav.nav{display:flex}
  }

  .wrap{width:min(var(--maxw),94%);margin:0 auto;padding:16px 0 40px}
  .card{padding:16px;border:1px solid var(--line);border-radius:var(--radius);background:var(--panel);backdrop-filter:blur(2px)}
  .hint{color:var(--muted)}
  .btn{border:1px solid var(--line);background:rgba(255,255,255,.12);color:#fff;padding:10px 14px;border-radius:12px;text-decoration:none;font-weight:600;cursor:pointer}
  .btn.primary{background:rgba(0,255,153,.16);border-color:#0a7}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:6px;color:#dfecef;font-size:.95rem;margin-top:8px}
  footer{width:min(var(--maxw),94%);margin:10px auto 26px;text-align:center;color:#cbd9de;font-size:12px}
</style>
</head>
<body>
  <header class="top" id="site-header">
    <div class="navwrap">
      <a class="brand" href="/"><div class="brand-logo"></div><span>Virtual Coach AI</span></a>
      <button class="menu-toggle" id="menuBtn" aria-expanded="false">Menu ▾</button>
      <nav class="nav" id="siteNav" aria-label="Primary">
        <a href="/index.html">Home</a>
        <a href="/upload.html" aria-current="page">Upload</a>
        <a href="/report.html?report=/report.json">Reports</a>
        <a href="/coming-soon.html">Coming&nbsp;Soon</a>
        <a href="/pricing.html">Pricing</a>
        <a href="/faq.html">FAQ</a>
        <a href="/contact.html">Contact</a>
        <a href="/login.html">Login</a>
      </nav>
    </div>
  </header>

  <div class="scrim">
    <main class="wrap">
      <h1 style="margin:6px 0 12px">Upload Your Swing</h1>
      <div class="card">
        <p class="hint">iPhone: <strong>Record Video</strong> (camera) or <strong>Choose from Library</strong> (Photos). Desktop works too.</p>

        <!-- Hidden real inputs -->
        <input id="file-record" type="file" accept="video/*" capture="environment" style="display:none" />
        <input id="file-choose" type="file" accept="video/*" style="display:none" />

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
          <button id="btnRecord" class="btn">Record Video</button>
          <button id="btnChoose" class="btn">Choose from Library</button>
          <button id="make" class="btn primary" disabled>Submit Video</button>
          <button id="reset" class="btn" disabled>Reset</button>
        </div>

        <div id="meta" style="display:none;margin-top:10px">
          <div class="kv"><div>Filename</div><div id="m_name"></div></div>
          <div class="kv"><div>Size</div><div id="m_size"></div></div>
          <div class="kv"><div>Duration</div><div id="m_dur"></div></div>
        </div>

        <p id="err" style="color:#ffd1d1;margin-top:10px"></p>
      </div>
    </main>

    <footer>© <span id="y"></span> Virtual Coach AI</footer>
  </div>

<script>
  document.getElementById('y').textContent = new Date().getFullYear();

  // Require code once (simple gate). If this is getting in your way, comment it out.
  try{ if (localStorage.getItem('vc_auth') !== 'ok') location.href = '/login.html?next=upload'; }catch{}

  // Hamburger
  const header = document.getElementById('site-header');
  const btn = document.getElementById('menuBtn');
  btn.addEventListener('click', ()=>{
    const open = header.classList.toggle('open');
    btn.setAttribute('aria-expanded', open ? 'true' : 'false');
  });
  document.getElementById('siteNav').addEventListener('click', e=>{
    if(e.target.tagName==='A'){ header.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
  });

  const fileRecord = document.getElementById('file-record');
  const fileChoose = document.getElementById('file-choose');
  const btnRecord  = document.getElementById('btnRecord');
  const btnChoose  = document.getElementById('btnChoose');
  const makeBtn    = document.getElementById('make');
  const resetBtn   = document.getElementById('reset');
  const errEl      = document.getElementById('err');
  const metaBox    = document.getElementById('meta');
  const mName      = document.getElementById('m_name');
  const mSize      = document.getElementById('m_size');
  const mDur       = document.getElementById('m_dur');

  let chosenFile = null;
  let duration = 0;

  const fmtBytes = b=>{ if(b==null) return '—'; const u=['B','KB','MB','GB']; let i=0,n=b; while(n>=1024&&i<u.length-1){n/=1024;i++;} return n.toFixed(1)+' '+u[i]; };
  const fmtSec = s=>{ if(!s) return '—'; const m=Math.floor(s/60); const r=Math.round(s%60); return `${m}:${String(r).padStart(2,'0')}`; };

  // duration probe (iOS friendly)
  async function probeDuration(file){
    try{
      const v = document.createElement('video');
      v.preload='metadata'; v.muted=true; v.playsInline=true;
      v.src = URL.createObjectURL(file);
      await new Promise((res,rej)=>{
        const to=setTimeout(()=>rej(new Error('metadata timeout')),12000);
        v.onloadedmetadata=()=>{clearTimeout(to);res();};
        v.onerror=()=>{clearTimeout(to);rej(new Error('metadata error'));};
      });
      const d = isFinite(v.duration)?v.duration:0;
      URL.revokeObjectURL(v.src);
      return d;
    }catch{return 0;}
  }

  function showMeta(f){
    metaBox.style.display='';
    mName.textContent = f.name || '(camera video)';
    mSize.textContent = fmtBytes(f.size);
  }

  function clearAll(){
    errEl.textContent='';
    metaBox.style.display='none';
    mName.textContent=mSize.textContent=mDur.textContent='';
    fileRecord.value=''; fileChoose.value='';
    chosenFile=null; duration=0;
    makeBtn.disabled=true; resetBtn.disabled=true;
  }

  btnRecord.addEventListener('click', ()=> fileRecord.click());
  btnChoose.addEventListener('click', ()=> fileChoose.click());
  resetBtn.addEventListener('click', clearAll);

  async function onPicked(file){
    errEl.textContent='';
    if(!file || !/^video\//i.test(file.type||'')){ errEl.textContent='Please choose a video.'; return; }
    chosenFile = file;
    showMeta(file);
    duration = await probeDuration(file);
    mDur.textContent = fmtSec(duration);
    makeBtn.disabled=false; resetBtn.disabled=false;
  }
  fileRecord.addEventListener('change', e=>{ if(e.target.files&&e.target.files[0]) onPicked(e.target.files[0]); });
  fileChoose.addEventListener('change', e=>{ if(e.target.files&&e.target.files[0]) onPicked(e.target.files[0]); });

  // Simple deterministic pseudo-random (so results look real but repeat for the same file)
  function seedFrom(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=(h*16777619)>>>0; } return h; }
  function rand01(seed){ seed = (seed*1664525+1013904223)>>>0; return [seed, (seed>>>8)/0xFFFFFF]; }

  function variedGrades(file, dur){
    const base = `${file.name}|${file.size}|${Math.round(dur*10)}`;
    let seed = seedFrom(base);
    const grades = [];
    const names = ['P1','P2','P3','P4','P5','P6','P7','P8','P9'];
    for(let i=0;i<9;i++){
      let r; [seed,r]=rand01(seed);
      let g = r<0.25 ? 'bad' : r<0.6 ? 'ok' : 'good';
      grades.push({id:names[i], grade:g});
    }
    return grades;
  }

  makeBtn.addEventListener('click', ()=>{
    if(!chosenFile){ errEl.textContent='Choose a video first.'; return; }

    const grades = variedGrades(chosenFile, duration);
    const now = new Date();
    const durScore = Math.max(40, Math.min(95, Math.round((duration||3)*8)));
    const relScore = Math.max(35, Math.min(90, Math.round(60 + ((duration||0)-3)*5)));
    const blobUrl  = URL.createObjectURL(chosenFile);

    const LABELS = ['Setup','Takeaway','Lead Arm Parallel','Top','Delivery','Shaft Parallel','Impact','Post-Impact','Finish'];
    const phases = grades.map((g,i)=>({
      id:g.id, name:LABELS[i], grade:g.grade,
      short: g.grade==='bad' ? 'Needs attention' : g.grade==='good' ? 'Solid' : 'Workable',
      long: 'Tap Video to review this checkpoint with your coach.',
      ref: blobUrl
    }));

    const report = {
      discipline:'Full Swing', date: now.toISOString(), swings:1,
      phases,
      coaching:{
        priority_fixes:[
          { title:'One Key Feel', short:'Pick one cue only', long:'Use one external cue for 15 balls (e.g., finish tall).', ref:''},
          { title:'Tempo Baseline', short:'~3:1', long:'Count “one-two-three-hit” to smooth transition.', ref:''},
          { title:'Impact Check', short:'Ball then turf', long:'Half swings with a mid-iron; video two reps to confirm.', ref:''}
        ],
        power_fixes:[{ title:'Finish Tall', short:'No stall', long:'Let chest face target; stand tall.', ref:''}]
      },
      position_metrics:[{label:'Setup Match',value:72},{label:'Top Position',value:66},{label:'Impact Alignments',value:70}],
      swing_metrics:[{label:'Tempo Repeatability',value:76},{label:'Face-to-Path Stability',value:64}],
      power:{ score:durScore, tempo:'~3:1', release_timing:relScore }
    };

    try{
      sessionStorage.setItem('vc_report', JSON.stringify(report));
      localStorage.setItem('vc_last_report', JSON.stringify(report));
    }catch(e){ console.warn('Storage issue:', e); }

    location.href = '/report.html?src=session';
  });
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>S3 Upload Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    .row { margin: 12px 0; }
    #status { white-space: pre-wrap; }
    progress { width: 100%; }
    code { background: #f4f4f4; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>S3 Upload Test</h1>

  <div class="row">
    <input id="file" type="file" />
  </div>

  <div class="row">
    <button id="btn">Upload</button>
  </div>

  <div class="row">
    <progress id="bar" value="0" max="100" style="display:none"></progress>
  </div>

  <div class="row">
    <div id="status"></div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const fileInput = $('file');
    const btn = $('btn');
    const bar = $('bar');
    const status = $('status');

    function log(msg, obj) {
      const line = (typeof obj === 'undefined') ? msg : msg + ' ' + JSON.stringify(obj);
      status.textContent += (status.textContent ? '\n' : '') + line;
      console.log(msg, obj);
    }

    btn.addEventListener('click', async () => {
      const file = fileInput.files?.[0];
      if (!file) {
        log('Choose a file first.');
        return;
      }
      status.textContent = '';
      bar.style.display = 'block';
      bar.value = 0;

      try {
        log('Starting…');

        const contentType = file.type || 'application/octet-stream';
        const qs = new URLSearchParams({
          filename: file.name,
          contentType
        });

        log('Requesting signed URL…');
        const res = await fetch(`/api/s3-presign?${qs.toString()}`);
        if (!res.ok) {
          const txt = await res.text().catch(()=>'');
          throw new Error(`presign failed ${res.status} ${txt}`);
        }
        const pre = await res.json();
        log('Got URL.');

        // Upload with PUT to S3 (streamed + progress UI)
        await uploadWithProgress(pre.url, file, contentType, (pct) => {
          bar.value = pct;
        });

        log('S3 PUT complete.');

        // Public URL to verify
        const publicUrl = `https://${pre.bucket}.s3.${pre.region}.amazonaws.com/${pre.key}`;
        log('Upload complete:');
        const a = document.createElement('a');
        a.href = publicUrl;
        a.target = '_blank';
        a.rel = 'noopener';
        a.textContent = publicUrl;
        status.appendChild(document.createElement('br'));
        status.appendChild(a);
      } catch (e) {
        console.error(e);
        log('ERROR: ' + (e?.message || e));
      } finally {
        setTimeout(() => { bar.style.display = 'none'; }, 800);
      }
    });

    async function uploadWithProgress(url, file, contentType, onPct) {
      // Use XHR for reliable progress events
      onPct?.(0);
      await new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('PUT', url, true);
        xhr.setRequestHeader('Content-Type', contentType);

        xhr.upload.onprogress = (evt) => {
          if (evt.lengthComputable) {
            const pct = Math.round((evt.loaded / evt.total) * 100);
            onPct?.(pct);
          }
        };
        xhr.onload = () => {
          if (xhr.status >= 200 && xhr.status < 300) resolve();
          else reject(new Error(`S3 PUT failed ${xhr.status}`));
        };
        xhr.onerror = () => reject(new Error('Network error during S3 PUT'));
        xhr.send(file);
      });
      onPct?.(100);
    }
  </script>
</body>
</html>

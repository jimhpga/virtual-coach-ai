<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
  <script>
/* visit /upload.html?resetSW=1 once to nuke old SW + caches */
if (location.search.includes('resetSW=1')) {
  (async () => {
    try {
      if (navigator.serviceWorker) {
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.unregister()));
      }
      if (window.caches) {
        const keys = await caches.keys();
        await Promise.all(keys.map(k => caches.delete(k)));
      }
    } catch(e) {}
    // reload with a new cache-busting version
    location.replace(location.pathname + '?v=v14');
  })();
}
</script>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Virtual Coach AI — Upload</title>
<link rel="preload" as="image" href="/homepage-background.png" />
<style>
  :root{ --nav:#0b2b12; --brand:#0b2b12; --scrim: rgba(0,0,0,.06); --panel: rgba(10,18,24,.24); --line: rgba(255,255,255,.08); --text:#ecf3f7; --muted:#cfe0e6; --radius:16px; --shadow:0 8px 24px rgba(0,0,0,.20); --ok:#19c37d; --warn:#f6c453; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;color:var(--text);background:url('/homepage-background.png') center/cover fixed no-repeat;font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial}
  .scrim{min-height:100vh;background:var(--scrim)}
/* Drop-downs: readable closed + open states */
select{appearance:menulist;-webkit-appearance:menulist;-moz-appearance:menulist;color:#fff;background:rgba(255,255,255,.08)}
select option{color:#111;background:#fff}
@media (prefers-color-scheme: dark){
  select option{color:#fff;background:#222}
}

/* Pretty key–value summary (replaces the JSON <pre>) */
#summary.kv{
  display:grid;grid-template-columns:auto 1fr;gap:6px 10px;
  background:rgba(0,0,0,.28);border:1px solid var(--line);border-radius:12px;padding:12px
}
#summary.kv .k{color:#cfe0e6}
#summary.kv .v.muted{opacity:.6}

  /* NAV (keep same color as Home) */
  header.top{position:sticky;top:0;z-index:100;background:var(--nav);border-bottom:1px solid rgba(255,255,255,.1)}
  .navwrap{width:min(1080px,92%);margin:0 auto;padding:10px 0;display:flex;gap:12px;align-items:center;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:10px;color:#fff;text-decoration:none;font-weight:800}
  .brand-logo{width:160px;height:36px;background:var(--brand);
    -webkit-mask:url('/virtualcoach-logo-transparent.png') center/contain no-repeat;
            mask:url('/virtualcoach-logo-transparent.png') center/contain no-repeat;}
  .menu-toggle{display:none;align-items:center;gap:8px;color:#fff;background:transparent;border:1px solid rgba(255,255,255,.3);border-radius:10px;padding:6px 10px;cursor:pointer}
  nav.nav{display:flex;gap:8px}
  nav.nav a{color:#fff;text-decoration:none;padding:8px 10px;border-radius:10px;border:1px solid transparent;white-space:nowrap}
  nav.nav a:hover{background:rgba(255,255,255,.08)}
  nav.nav a[aria-current="page"]{border-color:rgba(255,255,255,.18);background:rgba(255,255,255,.10)}
  @media(max-width:820px){
    .menu-toggle{display:inline-flex}
    nav.nav{position:absolute;right:0;top:100%;background:var(--nav);border-bottom:1px solid rgba(255,255,255,.1);display:none;flex-direction:column;padding:8px}
    header.top.open nav.nav{display:flex}
  }

  .wrap{width:min(1080px,92%);margin:0 auto;padding:18px 0 42px}

  h1{margin:8px 0 6px;font-size:28px;font-weight:900}
  .lead{color:var(--muted);max-width:68ch}
  .build-tag{color:#dff3ff;opacity:.65;font-size:12px;margin-top:4px}
  .badge{background:rgba(255,255,255,.06);border:1px solid var(--line);color:#dff3ff;padding:6px 10px;border-radius:999px;font-size:12px}

  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px;margin-top:12px}
  @media(max-width:960px){.grid{grid-template-columns:1fr}}

  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(1.5px)}
  .card h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--line)}
  .card .content{padding:12px 16px}

  label{display:block;font-weight:700;margin:8px 0 6px}
  .req{color:#ffd479}
  .hint{color:var(--muted);font-size:12px}

  /* Inputs */
  input[type="text"], input[type="email"], input[type="number"], select, button, .filebox{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:rgba(255,255,255,.08); color:#fff;
    -webkit-text-fill-color:#fff; /* closed control text on iOS */
  }
  input::placeholder{color:#cfe0e699}

  /* Keep dropdowns readable on iPad without breaking Windows/Firefox */
  select{appearance:menulist; -webkit-appearance:menulist; -moz-appearance:menulist; color:#fff;}
  /* Only apply option colors on WebKit (iOS Safari) */
  @supports (-webkit-touch-callout: none){
    select option{ color:#111 !important; background:#fff !important; }
  }

  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:700px){.row{grid-template-columns:1fr}}

  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .btn{border:1px solid var(--line);background:rgba(255,255,255,.10);color:#fff;padding:10px 14px;border-radius:10px;text-decoration:none;display:inline-flex;gap:8px;align-items:center;cursor:pointer}
  .btn:hover{background:rgba(255,255,255,.16)}
  .btn.primary{background:rgba(25,195,125,.18);border-color:#2a6;}
  .btn.warn{background:rgba(246,196,83,.18);border-color:#b8860b;}
  .btn.ghost{background:rgba(255,255,255,.06);}
  .btn[disabled]{opacity:.55;cursor:not-allowed}

  /* Stepper + progress */
  .stepper{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .step{display:flex;align-items:center;gap:8px}
  .dot{width:20px;height:20px;border-radius:50%;border:2px solid #456;display:inline-block;background:transparent}
  .step.active .dot{background:var(--warn);border-color:var(--warn)}
  .step.done .dot{background:var(--ok);border-color:var(--ok)}
  .step label{font-size:13px;color:#cfe0e6}
  .progress{height:10px;border-radius:999px;background:#10222c;border:1px solid #22404f;position:relative;overflow:hidden}
  .progress>span{position:absolute;left:0;top:0;bottom:0;border-radius:999px;background:linear-gradient(90deg,#19c37d,#2bd897);width:0%}
  .filebox{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .filebox .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#dfefff}

  /* Intake Summary list (not code) */
  .kv{display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:start}
  .k{color:#cfe0e6}
  .v{color:#ecf3f7}
  .muted{color:#cfe0e6}
</style>
</head>
<body>
  <header class="top" id="site-header">
    <div class="navwrap">
      <a class="brand" href="/"><div class="brand-logo"></div><span>Virtual Coach AI</span></a>
      <button class="menu-toggle" id="menuBtn" aria-expanded="false">Menu ▾</button>
      <nav class="nav" id="siteNav" aria-label="Primary">
        <a href="/index.html">Home</a>
        <a href="/upload.html" aria-current="page">Upload</a>
        <a href="/report.html?report=/report.json">Reports</a>
        <a href="/pricing.html">Pricing</a>
        <a href="/faq.html">FAQ</a>
        <a href="/team.html">Team</a>
        <a href="/contact.html">Contact</a>
        <a href="/login.html">Login</a>
      </nav>
    </div>
  </header>

  <div class="scrim">
    <main class="wrap">
      <header style="margin-bottom:8px">
        <h1>Best Results Come From Good Footage</h1>
        <div class="build-tag">BUILD v13</div>
        <p class="lead">Results are estimates from a single-camera video. For best accuracy, record from ~8–12 ft either <strong>down-the-line</strong> (along the target line) or <strong>face-on</strong> (perpendicular), in landscape, with your whole body and club in frame.</p>
        <details class="tips"><summary>Recording tips (quick)</summary>
          <div class="content">
            • Keep the camera steady (tripod if possible). • Bright, even light. • Avoid extreme wide-angle. • Ball and hands visible at impact.
          </div>
        </details>
      </header>

      <section class="grid">
        <!-- LEFT: Intake + Upload -->
        <div class="card">
          <h3>Upload Swing</h3>
          <div class="content">
            <div class="row">
              <div>
                <label for="first">First name</label>
                <input id="first" type="text" placeholder="e.g., Jim" />
              </div>
              <div>
                <label for="email">Email <span class="hint">(optional)</span></label>
                <input id="email" type="email" placeholder="Add if you want the report emailed to you" />
              </div>
            </div>

            <div class="row">
              <div>
                <label for="eye">Eye dominance <span class="req">*</span></label>
                <select id="eye" required>
                  <option value="">Select…</option>
                  <option value="right">Right eye</option>
                  <option value="left">Left eye</option>
                  <option value="unknown">Not sure</option>
                </select>
              </div>
              <div>
                <label for="hand">Handedness</label>
                <select id="hand">
                  <option value="">Select…</option>
                  <option value="right">Right</option>
                  <option value="left">Left</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label for="gender">Gender</label>
                <select id="gender">
                  <option value="">Prefer not to say</option>
                  <option value="man">Man</option>
                  <option value="woman">Woman</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div>
                <label for="height">Height (inches) <span class="req">*</span></label>
                <input id="height" type="number" min="40" max="90" placeholder="e.g., 70 for 5'10&quot;" required />
              </div>
            </div>

            <div class="row">
              <div>
                <label for="bodyShape">Body build (optional)</label>
                <select id="bodyShape">
                  <option value="">— Select —</option>
                  <option value="slim">Slim / Lean</option>
                  <option value="average">Average / Athletic</option>
                  <option value="muscular">Muscular / Stocky</option>
                  <option value="tall-lean">Tall / Lean</option>
                  <option value="short-compact">Short / Compact</option>
                </select>
              </div>
              <div>
                <label for="focus">Focus area (optional)</label>
                <select id="focus">
                  <option value="">— None —</option>
                  <option>Setup</option><option>Grip</option><option>Takeaway (P2)</option>
                  <option>Backswing (P3)</option><option>Top (P4)</option><option>Transition</option>
                  <option>Downswing</option><option>Shaft Parallel Down (P6)</option><option>Impact (P7)</option>
                  <option>Release</option><option>Finish</option><option>Swing Plane</option>
                  <option>Club Path</option><option>Face Control</option><option>Tempo</option>
                  <option>Kinematic Sequence</option><option>Posture</option><option>Ball Position</option>
                  <option>Alignment</option>
                </select>
              </div>
            </div>

            <div style="margin-top:10px">
              <label for="file">Swing video</label>
              <div class="filebox">
                <input id="file" type="file" accept="video/*" />
                <span class="name" id="fname">No file chosen</span>
              </div>
              <div class="hint" id="fmeta" style="margin-top:6px"></div>
            </div>

            <div class="actions">
              <button class="btn primary" id="btnUpload">Start upload</button>
              <button class="btn ghost" id="btnReset" type="button">Reset</button>
              <a class="btn warn" id="btnOpenReport" href="#" target="_blank" rel="noopener" aria-disabled="true">Open Report</a>
            </div>
          </div>
        </div>

        <!-- RIGHT: Status + Steps + Summary -->
        <div class="card">
          <h3>Status</h3>
          <div class="content">
            <div class="stepper" style="margin-bottom:10px">
              <div class="step" id="s1"><span class="dot"></span><label>1. Upload</label></div>
              <div class="step" id="s2"><span class="dot"></span><label>2. Processing</label></div>
              <div class="step" id="s3"><span class="dot"></span><label>3. Ready</label></div>
              <span class="badge" id="pill" style="margin-left:auto">Idle</span>
              <span class="badge" id="qcPill" style="display:none">QC</span>
            </div>
            <div class="progress" aria-label="Progress"><span id="bar"></span></div>
            <div class="hint" id="statusLine" style="margin-top:8px">Waiting for a file…</div>

            <h3 style="margin-top:16px;border:none;padding-top:16px">Intake Summary</h3>
            <!-- Clean list, and JS will auto-create this if an old <pre> is present -->
            <div id="summary" class="kv">
              <div class="k">First</div><div class="v muted">—</div>
              <div class="k">Email</div><div class="v muted">—</div>
              <div class="k">Eye dominance</div><div class="v muted">—</div>
              <div class="k">Handedness</div><div class="v muted">—</div>
              <div class="k">Gender</div><div class="v muted">—</div>
              <div class="k">Height</div><div class="v muted">—</div>
              <div class="k">Body build</div><div class="v muted">—</div>
              <div class="k">Focus</div><div class="v muted">—</div>
              <div class="k">Cross-dominant</div><div class="v muted">—</div>
              <div class="k">Aim bias</div><div class="v muted">—</div>
              <div class="k">Scale factor</div><div class="v muted">—</div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

<script>
  /* ---------- NAV ---------- */
  const header = document.getElementById('site-header');
  document.getElementById('menuBtn')?.addEventListener('click', ()=>{
    const open = header.classList.toggle('open');
    document.getElementById('menuBtn').setAttribute('aria-expanded', open ? 'true' : 'false');
  });
  document.getElementById('siteNav').addEventListener('click', e=>{
    if(e.target.tagName==='A'){ header.classList.remove('open'); document.getElementById('menuBtn')?.setAttribute('aria-expanded','false'); }
  });

  /* ---------- Shortcuts ---------- */
  const $ = s => document.querySelector(s);
  const fileInput = $('#file');
  const fname = $('#fname');
  const fmeta = $('#fmeta');
  const bar = $('#bar');
  const pill = $('#pill');
  const qcPill = document.getElementById('qcPill');
  const statusLine = $('#statusLine');
  const btnUpload = $('#btnUpload');
  const btnReset = $('#btnReset');
  const btnOpenReport = $('#btnOpenReport');

  /* ---------- Fields/model ---------- */
  const fields = ['first','email','eye','hand','gender','height','bodyShape','focus'];
  const data = Object.fromEntries(fields.map(k=>[k,'']));

  /* If the build system left you the OLD <pre id="summary">…JSON…</pre>, replace it */
  (function migrateOldSummary(){
    const oldPre = document.querySelector('pre#summary');
    if (!oldPre) return;
    const wrap = document.createElement('div');
    wrap.id = 'summary';
    wrap.className = 'kv';
    wrap.innerHTML = `
      <div class="k">First</div><div class="v muted">—</div>
      <div class="k">Email</div><div class="v muted">—</div>
      <div class="k">Eye dominance</div><div class="v muted">—</div>
      <div class="k">Handedness</div><div class="v muted">—</div>
      <div class="k">Gender</div><div class="v muted">—</div>
      <div class="k">Height</div><div class="v muted">—</div>
      <div class="k">Body build</div><div class="v muted">—</div>
      <div class="k">Focus</div><div class="v muted">—</div>
      <div class="k">Cross-dominant</div><div class="v muted">—</div>
      <div class="k">Aim bias</div><div class="v muted">—</div>
      <div class="k">Scale factor</div><div class="v muted">—</div>
    `;
    oldPre.replaceWith(wrap);
  })();

  /* If any dropdown got stripped by a build/minifier, repopulate it here */
  function ensureOptions(id, items){
    const sel = document.getElementById(id);
    if (!sel) return;
    // If there's already more than the placeholder, leave it.
    if (sel.options && sel.options.length > 1) return;
    sel.innerHTML = ''; // clear
    items.forEach(([label, value])=>{
      const opt = document.createElement('option');
      opt.textContent = label;
      if (value != null) opt.value = value;
      sel.appendChild(opt);
    });
  }
  ensureOptions('eye', [
    ['Select…',''],
    ['Right eye','right'],
    ['Left eye','left'],
    ['Not sure','unknown']
  ]);
  ensureOptions('hand', [
    ['Select…',''],
    ['Right','right'],
    ['Left','left']
  ]);
  ensureOptions('gender', [
    ['Prefer not to say',''],
    ['Man','man'],
    ['Woman','woman'],
    ['Other','other']
  ]);
  ensureOptions('bodyShape', [
    ['— Select —',''],
    ['Slim / Lean','slim'],
    ['Average / Athletic','average'],
    ['Muscular / Stocky','muscular'],
    ['Tall / Lean','tall-lean'],
    ['Short / Compact','short-compact']
  ]);
  ensureOptions('focus', [
    ['— None —',''],
    ['Setup'],['Grip'],['Takeaway (P2)'],['Backswing (P3)'],['Top (P4)'],
    ['Transition'],['Downswing'],['Shaft Parallel Down (P6)'],['Impact (P7)'],
    ['Release'],['Finish'],['Swing Plane'],['Club Path'],['Face Control'],
    ['Tempo'],['Kinematic Sequence'],['Posture'],['Ball Position'],['Alignment']
  ]);

  function toFeetInches(inches){
    const n = Number(inches||0);
    if (!n) return '';
    const ft = Math.floor(n/12);
    const inch = Math.round(n - ft*12);
    return `${ft}'${inch}"`;
  }

  function deriveHints(d){
    const hand = (d.hand||'').toLowerCase();
    const eye  = (d.eye||'').toLowerCase();
    const cross = (hand && eye) ? (hand[0] !== eye[0]) : false;
    let aim = 'neutral';
    if (hand==='right' && eye==='left') aim = 'left';
    if (hand==='left'  && eye==='right') aim = 'right';
    const h = Number(d.height||0);
    const scale = h ? (h/70).toFixed(2) : '';
    return { cross_dominant: !!cross, aim_bias: aim, scale_factor: scale };
  }

  function setRow(label, value){
    const all = document.querySelectorAll('#summary .k');
    for (const k of all){
      if (k.textContent.trim().toLowerCase() === label.toLowerCase()){
        const v = k.nextElementSibling;
        v.textContent = (value===''||value==null) ? '—' : value;
        v.classList.toggle('muted', value===''||value==null);
        break;
      }
    }
  }

  function updateSummary(){
    fields.forEach(k=>{
      const el = document.getElementById(k);
      if (!el) return;
      data[k] = (el.type === 'number') ? (el.value ? Number(el.value) : '') : el.value.trim();
    });
    const d = data;
    const hint = deriveHints(d);

    setRow('First', d.first);
    setRow('Email', d.email);
    setRow('Eye dominance', d.eye);
    setRow('Handedness', d.hand);
    setRow('Gender', d.gender);
    setRow('Height', d.height ? `${d.height} in (${toFeetInches(d.height)})` : '');
    setRow('Body build', d.bodyShape);
    setRow('Focus', d.focus);
    setRow('Cross-dominant', hint.cross_dominant ? 'Yes' : 'No');
    setRow('Aim bias', hint.aim_bias);
    setRow('Scale factor', hint.scale_factor || '');

    try{
      const saved = JSON.parse(localStorage.getItem('vc_prefill')||'{}');
      Object.assign(saved, d);
      localStorage.setItem('vc_prefill', JSON.stringify(saved));
    }catch{}
  }

  function prefillFromLocal(){
    try{
      const merged = {};
      const p = JSON.parse(localStorage.getItem('vc_prefill')||'{}');
      Object.assign(merged, p);
      const li = JSON.parse(localStorage.getItem('vc_last_intake')||'null');
      const intake = li && li.intake ? li.intake : null;
      if (intake) Object.assign(merged, intake);
      fields.forEach(k=>{
        const el = document.getElementById(k);
        if (el && merged[k] != null && merged[k] !== '') el.value = String(merged[k]);
      });
    }catch{}
  }

  fields.forEach(k=>{
    const el = document.getElementById(k);
    if (el) el.addEventListener('input', updateSummary);
  });
  prefillFromLocal();
  updateSummary();

  fileInput.addEventListener('change', ()=>{
    const f = fileInput.files && fileInput.files[0];
    if (!f){ fname.textContent = 'No file chosen'; fmeta.textContent = ''; return; }
    fname.textContent = f.name;
    fmeta.textContent = `${(f.size/1024/1024).toFixed(1)} MB • ${f.type||'video'}`;
    status('File selected. Ready to upload.', 'warn');
  });

  /* ---------- Stepper helpers ---------- */
  function step(n){
    [$('#s1'),$('#s2'),$('#s3')].forEach((el,i)=>{
      el.classList.remove('active','done');
      if (i < n-1) el.classList.add('done');
      if (i === n-1) el.classList.add('active');
    });
  }
  function progress(pct){ bar.style.width = Math.max(0, Math.min(100, pct)) + '%'; }
  function status(text, tone){
    statusLine.textContent = text;
    pill.textContent = text.split('.')[0];
    pill.style.background = tone==='ok'?'rgba(25,195,125,.18)':tone==='warn'?'rgba(246,196,83,.18)':'rgba(255,255,255,.10)';
    pill.style.borderColor = tone==='ok'?'#2a6':tone==='warn'?'#b8860b':'rgba(255,255,255,.18)';
  }

  /* ---------- (optional) QC badge ---------- */
  async function runQC(key){
    try{
      const r = await fetch(`/api/qc?key=${encodeURIComponent(key)}`, { cache:'no-store' });
      if (!r.ok) throw new Error('HTTP '+r.status);
      const out = await r.json();
      if (qcPill){
        qcPill.style.display = 'inline-flex';
        if (out.status === 'ok'){ qcPill.textContent='QC: Passed'; qcPill.style.background='rgba(25,195,125,.18)'; qcPill.style.borderColor='#2a6'; }
        else if (out.status === 'warn'){ qcPill.textContent='QC: Warnings'; qcPill.style.background='rgba(246,196,83,.18)'; qcPill.style.borderColor='#b8860b'; }
        else { qcPill.textContent='QC: Failed'; qcPill.style.background='rgba(255,107,107,.18)'; qcPill.style.borderColor='#c44'; btnOpenReport.setAttribute('aria-disabled','true'); btnOpenReport.classList.add('disabled'); }
      }
      return out;
    }catch(e){
      console.warn('QC call failed:', e);
      if (qcPill) qcPill.style.display='none';
      return null;
    }
  }

  /* ---------- Upload plumbing ---------- */
  function makeKey(file){
    const safe = file.name.replace(/[^a-z0-9_.-]+/gi,'_').toLowerCase();
    return `uploads/${Date.now()}-${safe}`;
  }
  async function getUploadTarget(file, key){
    const res = await fetch('/api/upload', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ filename: file.name, type: file.type, key })
    });
    if (!res.ok) throw new Error('Upload init failed: HTTP '+res.status);
    return res.json();
  }
  async function postIntake(key, intake) {
    try{
      const res = await fetch('/api/intake', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ key, intake })
      });
      if (!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }catch(e){
      console.warn('Intake save failed:', e);
      return { ok:false, error: String(e.message || e) };
    }
  }
  function putWithProgress(url, file){
    return new Promise((resolve, reject)=>{
      const xhr = new XMLHttpRequest();
      xhr.open('PUT', url, true);
      xhr.setRequestHeader('Content-Type', file.type || 'application/octet-stream');
      xhr.upload.onprogress = (e)=>{ if (e.lengthComputable){ progress( Math.round((e.loaded/e.total)*80) ); } };
      xhr.onload = ()=> (xhr.status>=200 && xhr.status<300) ? resolve() : reject(new Error('Upload error: HTTP '+xhr.status));
      xhr.onerror = ()=> reject(new Error('Network error during upload'));
      xhr.send(file);
    });
  }
  async function postForm(url, fields, file){
    const fd = new FormData();
    Object.entries(fields||{}).forEach(([k,v])=> fd.append(k,v));
    fd.append('file', file);
    const tick = setInterval(()=>{
      const cur = parseFloat(bar.style.width)||0;
      if (cur < 78) progress(cur + 2);
      else clearInterval(tick);
    }, 200);
    const res = await fetch(url, { method:'POST', body:fd });
    clearInterval(tick);
    if (!res.ok) throw new Error('Upload error: HTTP '+res.status);
  }

  async function startUpload(){
    const f = fileInput.files && fileInput.files[0];
    if (!f){ alert('Choose a swing video first.'); return; }
    if (!$('#eye').value){ alert('Pick eye dominance.'); $('#eye').focus(); return; }
    if (!$('#height').value){ alert('Enter height (inches).'); $('#height').focus(); return; }

    btnUpload.disabled = true; btnOpenReport.setAttribute('aria-disabled','true'); btnOpenReport.classList.add('disabled');
    step(1); progress(2); status('Uploading…', 'warn');

    const clientKey = makeKey(f);
    let finalKey = clientKey;

    try{
      let target;
      try{ target = await getUploadTarget(f, clientKey); }
      catch(_){ target = { key: clientKey }; }

      if (target.key) finalKey = target.key;
      if (target.putUrl){
        await putWithProgress(target.putUrl, f);
      } else if (target.url && target.fields){
        await postForm(target.url, target.fields, f);
      } else {
        const fd = new FormData(); fd.append('file', f); fd.append('key', finalKey);
        const r = await fetch('/api/upload', { method:'POST', body:fd });
        if (!r.ok) throw new Error('Upload error: HTTP '+r.status);
      }

      progress(82); step(2); status('Processing…', 'warn');
      try{ localStorage.setItem('vc_last_intake', JSON.stringify({ key: finalKey, intake: data, ts: Date.now() })); }catch{}
      postIntake(finalKey, { ...data, derived: deriveHints(data) });
      pollAnalyze(finalKey);
    }catch(err){
      console.error(err);
      status('Upload failed', ''); progress(0); step(1);
      alert('Upload failed: '+(err.message||err));
      btnUpload.disabled = false;
    }
  }

  let pollTimer = null;
  async function checkAnalyze(key){
    const r = await fetch(`/api/analyze?key=${encodeURIComponent(key)}`, { cache:'no-store' });
    if (!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }
  async function pollAnalyze(key){
    async function tick(){
      try{
        const out = await checkAnalyze(key);
        if (out.status === 'ready'){
          clearInterval(pollTimer); pollTimer = null;
          progress(100); step(3); status('Ready ✓', 'ok');
          await runQC(key);
          btnOpenReport.href = `/report.html?key=${encodeURIComponent(key)}`;
          btnOpenReport.removeAttribute('aria-disabled');
          btnOpenReport.classList.remove('disabled');
          if (out.report){ try{ localStorage.setItem('vc_last_report', JSON.stringify(out.report)); }catch{} }
          return;
        }
        const cur = parseFloat(bar.style.width)||82;
        progress( Math.min(98, cur + Math.random()*2) );
        status('Processing…', 'warn');
      }catch(e){
        console.warn('Check failed', e);
        status('Checking…', 'warn');
      }
    }
    await tick();
    pollTimer = setInterval(tick, 7000);
  }

  btnUpload.addEventListener('click', startUpload);
  btnReset.addEventListener('click', ()=>{
    fields.forEach(k=>{ const el = document.getElementById(k); if(el) el.value=''; });
    updateSummary(); fileInput.value=''; fname.textContent='No file chosen'; fmeta.textContent='';
    step(1); progress(0); status('Idle',''); btnUpload.disabled=false;
    btnOpenReport.setAttribute('aria-disabled','true'); btnOpenReport.classList.add('disabled'); btnOpenReport.href='#';
    if (qcPill){ qcPill.style.display='none'; }
  });

  // Init
  step(1); progress(0); status('Idle','');
</script>
</body>
</html>

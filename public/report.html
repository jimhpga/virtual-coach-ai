<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Virtual Coach AI — Swing Report</title>
<link rel="stylesheet" href="/styles.css" />
<style>
  .wrap { max-width: 1100px; margin: 0 auto; padding: 20px; }
  .pill { background:#0f1b22;border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-weight:700 }
  .meta-row { display:flex; flex-wrap:wrap; gap:8px; align-items:center }
  .card h3 { margin: 0 0 10px; }
  .muted { color: var(--muted); }
  .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
  .bar { height:8px; border-radius:999px; background:#0f1b22; border:1px solid var(--line); overflow:hidden; }
  .bar > i { display:block; height:100%; width:0%; background:var(--accent, #4ad0ff); transition: width .5s ease; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
  .pill-tiny { font-size: 12px; padding: 3px 8px; border-radius: 999px; border:1px solid var(--line); background:#0f1b22 }
  .pcol { display:block }
  .p-card { background:rgba(255,255,255,.03); border:1px solid var(--line); border-radius:14px; padding:12px; margin:12px 0; box-shadow:0 6px 14px rgba(0,0,0,.25); }
  .p-card h4 { margin:0 0 6px; font-size:16px }
  .p-card .short { color:var(--muted); margin:10px 0 10px; line-height:1.55 }
  .p-card .subrow { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:4px }
  .btn-sm { border:1px solid var(--line); padding:6px 10px; border-radius:8px; background:#0f1b22; color:#fff; text-decoration:none; cursor:pointer }
  .btn-sm:hover { background:#122734 }
  details.p1long { margin-top:8px }
  details.p1long summary { cursor:pointer; list-style:none; font-weight:700; }
  details.p1long summary::-webkit-details-marker{ display:none }
  details.p1long summary .caret { display:inline-block; transform: rotate(0deg); transition: transform .2s ease; margin-right:6px }
  details[open].p1long summary .caret { transform: rotate(90deg); }
  .accordion { border:1px solid var(--line); border-radius:14px; overflow:hidden }
  .ac-head { background:rgba(255,255,255,.03); padding:10px 12px; display:flex; align-items:center; justify-content:space-between; cursor:pointer }
  .ac-body { padding:12px; display:none }
  .ac-open .ac-body { display:block }
  .ac-open .caret { transform: rotate(90deg); }
  .pill-grade { font-weight:800; text-transform:uppercase }
  .g-good{ background:#19c37d; color:#001e0d }
  .g-ok  { background:#f6c453; color:#2a2300 }
  .g-bad { background:#ff6b6b; color:#fff }
  .fix { margin:6px 0; }
  .fix h4 { margin:0 0 4px; font-size:14px }
  .fix p { margin:2px 0; color:var(--muted) }
  @media (max-width: 900px) { .grid2 { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<header class="site">
  <div class="navwrap">
    <a class="brand" href="/"><img src="/virtualcoach-logo-transparent.png" alt="Virtual Coach AI"><span>Virtual Coach AI</span></a>
    <nav aria-label="Primary">
      <a href="/">Home</a>
      <a href="/upload">Upload</a>
      <a href="/reports">Reports</a>
      <a href="/coming-soon">Coming&nbsp;Soon</a>
      <a href="/pricing">Pricing</a>
      <a href="/faq">FAQ</a>
      <a href="/contact">Contact</a>
      <a href="/about">About</a>
    </nav>
  </div>
</header>

<div class="scrim">
  <main class="wrap" id="app">
    <h1 style="margin-bottom:6px">Swing Report — P1–P9</h1>
    <div class="meta-row muted" id="metaRow"></div>

    <!-- POWER & CONSISTENCY + COACHING CARD -->
    <section class="grid2" style="margin-top:14px">
      <div class="card">
        <h3>Coaching Card</h3>
        <div class="grid2">
          <div>
            <div class="muted" style="font-weight:700; margin-bottom:6px">Top 3 Priority Fixes</div>
            <div id="topPriority" class="list-tight"></div>
          </div>
          <div>
            <div class="muted" style="font-weight:700; margin-bottom:6px">Top 3 Power Fixes</div>
            <div id="topPower" class="list-tight"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Power & Consistency</h3>
        <div class="grid2">
          <div>
            <div class="muted">Power Score</div>
            <div class="bar"><i id="barScore"></i></div>
            <div class="mono" id="txtScore"></div>
            <div class="muted" style="margin-top:6px">Tempo</div>
            <div class="mono" id="txtTempo">—</div>
            <div class="muted" style="margin-top:6px">Release Timing</div>
            <div class="bar"><i id="barRelease"></i></div>
            <div class="mono" id="txtRelease"></div>
          </div>
          <div>
            <div class="muted" style="font-weight:700; margin-bottom:6px">Position Consistency</div>
            <div id="posConsistency" class="infobox">—</div>
            <div class="muted" style="font-weight:700; margin:10px 0 6px">Swing Consistency</div>
            <div id="swingConsistency" class="infobox">—</div>
          </div>
        </div>
      </div>
    </section>

    <!-- LONGER AI SUMMARY -->
    <section class="card" style="margin-top:14px">
      <h3>Summary of Your Swing</h3>
      <div id="summaryText" class="muted">—</div>
    </section>

    <!-- PRACTICE PLAN ACCORDION -->
    <section style="margin-top:14px">
      <div class="accordion" id="planAcc">
        <div class="ac-head" role="button" tabindex="0">
          <div style="display:flex; gap:10px; align-items:center">
            <span class="caret">▶</span>
            <h3 style="margin:0">Practice Plan (14 days)</h3>
          </div>
          <span class="pill-tiny" id="planCount">0 items</span>
        </div>
        <div class="ac-body">
          <div id="planList"></div>
        </div>
      </div>
    </section>

    <!-- P1–P9 -->
    <section style="margin-top:14px">
      <h2 style="margin:0 0 8px">P1–P9</h2>
      <div class="pcol" id="pCol"></div>
      <div class="infobox" id="pEmpty" style="margin-top:8px"></div>
    </section>

    <!-- Note area -->
    <section id="noteBox" class="card" style="margin-top:14px;display:none">
      <h3 style="margin:0 0 8px">Note</h3>
      <div id="noteTxt" class="muted"></div>
    </section>
  </main>
</div>

<script>
/* ----------- CONFIG ----------- */
window.BLOB_PUBLIC_BASE =
  window.BLOB_PUBLIC_BASE || "https://yw0bpv5czlbqowjq.public.blob.vercel-storage.com";

/* ----------- helpers ----------- */
const $ = s => document.querySelector(s);
const qp = new URLSearchParams(location.search);
const rid = qp.get('id');
const directUrl = qp.get('url');

const blobFromId = id =>
  `${window.BLOB_PUBLIC_BASE.replace(/\/+$/,'')}/reports/${encodeURIComponent(id)}.json?cb=${Date.now()}`;

async function fetchJson(url){
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error(`Fetch ${res.status} for ${url}`);
  const txt = await res.text();
  return JSON.parse(txt.trim().replace(/^\uFEFF/, ''));
}
function pct(n){ if(n == null || isNaN(n)) return 0; return Math.max(0, Math.min(100, Number(n))); }
function gradeChip(grade){
  const g = String(grade||'').toLowerCase();
  const cls = (g==='good')?'g-good':(g==='ok')?'g-ok':'g-bad';
  const s = document.createElement('span');
  s.className = `pill-tiny pill-grade ${cls}`;
  s.textContent = g ? g : '—';
  return s;
}

/* ----------- UI FILL ----------- */
function fillMeta(data){
  const row = $('#metaRow'); row.innerHTML = '';
  const pills = [
    ['Score', (data.swingScore ?? data.score ?? '—')],
    ['Status', (data.status ?? '—')],
    ['Level', (data.level ?? data?.meta?.level ?? '—')],
    ['Goal', (data.goal ?? data?.meta?.goal ?? '—')],
  ];
  for (const [k,v] of pills) {
    const s = document.createElement('span'); s.className='pill'; s.textContent = `${k}: ${v}`; row.appendChild(s);
  }
  const created = document.createElement('span');
  created.className = 'muted';
  created.style.marginLeft='8px';
  created.textContent = `Created: ${new Date().toLocaleString()}`;
  row.appendChild(created);
}

function setBars(data){
  const score = pct(data.power?.score ?? data.swingScore ?? 0);
  $('#barScore').style.width = score + '%';
  $('#txtScore').textContent = `${score}%`;

  const rel = pct(data.power?.release_timing ?? 0);
  $('#barRelease').style.width = rel + '%';
  $('#txtRelease').textContent = `${rel}%`;

  $('#txtTempo').textContent = data.power?.tempo ?? '—';
}

function setConsistency(data){
  const pos = data.positionConsistency?.notes ?? data.position_consistency?.notes ?? '—';
  const sw  = data.swingConsistency?.notes ?? data.swing_consistency?.notes ?? '—';
  $('#posConsistency').textContent = pos;
  $('#swingConsistency').textContent = sw;
}

function renderFixList(listOrStrings, mount) {
  mount.innerHTML = '';
  if (!listOrStrings || !listOrStrings.length) {
    mount.textContent = '—';
    return;
  }
  // Back-compat: allow simple strings OR rich objects {title, why, how}
  listOrStrings.slice(0,3).forEach(item => {
    const wrap = document.createElement('div'); wrap.className = 'fix';
    if (typeof item === 'string') {
      const h = document.createElement('h4'); h.textContent = '• ' + item; wrap.appendChild(h);
    } else {
      const h = document.createElement('h4'); h.textContent = item.title || '• Fix'; wrap.appendChild(h);
      if (item.why) { const p = document.createElement('p'); p.innerHTML = `<b>Why:</b> ${item.why}`; wrap.appendChild(p); }
      if (item.how) { const p = document.createElement('p'); p.innerHTML = `<b>How:</b> ${item.how}`; wrap.appendChild(p); }
    }
    mount.appendChild(wrap);
  });
}

function setCoachingCard(data){
  renderFixList(data.topPriorityFixes || data.top_priority_fixes || [], $('#topPriority'));
  renderFixList(data.topPowerFixes    || data.top_power_fixes    || [], $('#topPower'));
}

function youtubeLink(name){
  const q = encodeURIComponent(`${name} golf checkpoint`);
  return `https://www.youtube.com/results?search_query=${q}`;
}

function renderPList(data){
  const list = Array.isArray(data.p1p9 || data.phases) ? (data.p1p9 || data.phases) : [];
  const col = $('#pCol'); col.innerHTML = '';
  const empty = $('#pEmpty'); empty.textContent='';

  if(!list.length){
    empty.textContent = 'No P1–P9 items in this report.';
    return;
  }
  list.forEach((p,i)=>{
    const idTxt = p.id || `P${i+1}`;
    const name  = p.name || p.title || `Position ${i+1}`;
    const grade = p.grade || 'ok';
    const short = p.short || p.note || '—';
    const long  = p.long  || p.details || '';
    const video = p.video || youtubeLink(name);

    const card = document.createElement('div');
    card.className='p-card';

    const h4 = document.createElement('h4');
    h4.textContent = `${idTxt}. ${name}`;
    card.appendChild(h4);

    const sub = document.createElement('div');
    sub.className = 'subrow';
    sub.appendChild(gradeChip(grade));
    const aWatch = document.createElement('a');
    aWatch.className='btn-sm';
    aWatch.target = '_blank';
    aWatch.href = video;
    aWatch.textContent = 'Watch';
    sub.appendChild(aWatch);
    card.appendChild(sub);

    const s = document.createElement('div');
    s.className='short';
    s.textContent = short;
    card.appendChild(s);

    if(long){
      const det = document.createElement('details');
      det.className='p1long';
      const sum = document.createElement('summary');
      const caret = document.createElement('span');
      caret.className='caret';
      caret.textContent = '▶';
      sum.appendChild(caret);
      sum.appendChild(document.createTextNode('  Expanded coaching notes'));
      det.appendChild(sum);

      const body = document.createElement('div');
      body.style.marginTop='8px';
      body.style.lineHeight = '1.55';
      body.textContent = long;
      det.appendChild(body);
      card.appendChild(det);
    }

    col.appendChild(card);
  });
}

function setPracticePlan(data){
  const list = data.practicePlan || data.practice_plan || [];
  const root = $('#planAcc');
  const count = $('#planCount');
  const out  = $('#planList');
  out.innerHTML='';
  count.textContent = `${list.length} items`;
  if(!list.length) {
    out.innerHTML = '<div class="muted">No plan found.</div>';
  } else {
    const ul = document.createElement('ul');
    ul.style.paddingLeft = '18px';
    list.forEach(it=>{
      const li = document.createElement('li');
      const d = it.day != null ? `Day ${it.day}: ` : '';
      const title = it.title || it.name || '';
      const items = Array.isArray(it.items) ? ` — ${it.items.join('; ')}` : '';
      li.textContent = `${d}${title}${items}`;
      ul.appendChild(li);
    });
    out.appendChild(ul);
  }
  const head = root.querySelector('.ac-head');
  head.onclick = () => root.classList.toggle('ac-open');
  head.onkeydown = (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); root.classList.toggle('ac-open'); }};
}

function setNote(data){
  const n = (data.note || '').trim();
  if(!n){ $('#noteBox').style.display='none'; return; }
  $('#noteTxt').textContent = n;
  $('#noteBox').style.display='';
}

function renderAll(data){
  fillMeta(data);
  setBars(data);
  setConsistency(data);
  setCoachingCard(data);
  renderPList(data);
  setPracticePlan(data);
  setNote(data);
  // Prefer long summary if present
  $('#summaryText').textContent = data.summary_long || data.summary || data.aiSummary || '—';
}

/* ----------- BOOT ----------- */
(async ()=>{
  try{
    let url = null;
    if (directUrl) url = directUrl;
    else if (rid)   url = blobFromId(rid);
    else {
      const raw = sessionStorage.getItem('vc_report') || localStorage.getItem('vc_last_report');
      if (!raw) throw new Error('Missing ?url or ?id. Use upload or reports.');
      renderAll(JSON.parse(raw.trim().replace(/^\uFEFF/, '')));
      return;
    }
    const data = await fetchJson(url);
    renderAll(data);
  }catch(err){
    alert(err?.message || String(err));
  }
})();
</script>
</body>
</html>

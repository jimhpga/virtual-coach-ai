<!-- ... head & styles from previous version are unchanged ... -->
<body>
<!-- ... header ... -->

<div class="scrim">
  <main class="wrap">
    <h1 style="margin:0 0 8px">Swing Report — P1–P9</h1>
    <div id="meta" class="row muted"></div>

    <!-- AI PERSONALIZER -->
    <section class="card" style="margin-top:12px">
      <div class="row" style="align-items:flex-end">
        <div>
          <div class="small muted">Golfer level</div>
          <select id="level">
            <option value="beginner">Beginner (plain language)</option>
            <option value="intermediate" selected>Intermediate (balanced)</option>
            <option value="advanced">Advanced (technical)</option>
          </select>
        </div>
        <div style="flex:1;min-width:260px">
          <div class="small muted">What do you want to work on? (multi-select)</div>
          <select id="focus" multiple size="5" style="width:100%">
            <option value="swing_plane">Swing plane</option>
            <option value="hand_path">Hand path</option>
            <option value="clubface_control">Clubface control</option>
            <option value="tempo">Tempo</option>
            <option value="ground_forces">Ground forces</option>
            <option value="wrist_angles">Wrist angles</option>
            <option value="release_timing">Release timing</option>
            <option value="start_line">Start line</option>
            <option value="low_point">Low point</option>
          </select>
        </div>
        <div>
          <button id="btnGen" class="btn">Generate with AI</button>
        </div>
        <div class="muted small" id="aiMsg"></div>
      </div>
    </section>

    <!-- top strip (unchanged) -->

    <!-- P1–P9 -->
    <section style="margin-top:14px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="h2" style="margin:0">P1–P9</div>
        <div class="row small muted">
          <!-- pre-checked so it stacks by default -->
          <label><input type="checkbox" id="stackChk" checked> Stack vertically</label>
        </div>
      </div>
      <div id="pWrap" class="grid2" style="margin-top:8px"></div>
      <div id="pEmpty" class="muted small" style="margin-top:6px"></div>
    </section>

    <!-- summary + note (unchanged) -->
  </main>
</div>

<script>
  const $ = s => document.querySelector(s);
  const qp = new URLSearchParams(location.search);
  const rid = qp.get('id');
  const directUrl = qp.get('url');
  const BLOB = "https://yw0bpv5czlbqowjq.public.blob.vercel-storage.com";

  function urlForId(id){ return BLOB.replace(/\/+$/,'') + "/reports/" + encodeURIComponent(id) + ".json?cb=" + Date.now(); }
  async function fetchJson(u){ const r = await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error("Fetch "+r.status); const t=await r.text(); return JSON.parse(t.trim().replace(/^\uFEFF/,'')); }
  function bar(i,p){ i.style.width = Math.max(0,Math.min(100,+p||0)) + "%"; }
  function list(el,arr){ el.innerHTML=""; (arr||[]).forEach(s=>{ const li=document.createElement('li'); li.textContent=s; el.appendChild(li); }); if(!el.children.length) el.innerHTML='<li class="muted">—</li>'; }

  function metaPills(data){
    const row=$('#meta'); row.innerHTML='';
    [['Score', data.swingScore ?? data.power?.score ?? '—'],
     ['Status', data.status ?? 'ready'],
     ['Tempo', data.power?.tempo ?? '—'],
     ['Release', (data.power?.release_timing ?? '—') + (data.power?.release_timing!=null?'%':'')],
     ['Created', new Date().toLocaleString()]].forEach(([k,v])=>{
       const s=document.createElement('span'); s.className='pill'; s.textContent=k+': '+v; row.appendChild(s);
     });
  }

  function renderTop(d){
    list($('#prio'), d.topPriorityFixes || d.top_priority_fixes);
    list($('#pfix'),  d.topPowerFixes    || d.top_power_fixes);
    bar($('#bScore'), d.power?.score ?? d.swingScore ?? 0); $('#tScore').textContent = (d.power?.score ?? d.swingScore ?? 0) + '%';
    bar($('#bRel'),   d.power?.release_timing ?? 0);        $('#tRel').textContent   = (d.power?.release_timing ?? 0) + '%';
    $('#tTempo').textContent = d.power?.tempo ?? '—';
    $('#posScore').textContent   = (d.consistency?.position?.score ?? '—') + (d.consistency?.position?.score!=null?'%':'');
    $('#posNotes').textContent   = d.consistency?.position?.notes ?? '—';
    $('#swingScore').textContent = (d.consistency?.swing?.score ?? '—') + (d.consistency?.swing?.score!=null?'%':'');
    $('#swingNotes').textContent = d.consistency?.swing?.notes ?? '—';
  }

  function youtubeLink(q){ return 'https://www.youtube.com/results?search_query='+encodeURIComponent(q); }

  function renderP1P9(d){
    const arr=Array.isArray(d.p1p9)?d.p1p9:[];
    const wrap=$('#pWrap'); wrap.innerHTML=''; $('#pEmpty').textContent='';
    if(!arr.length){ $('#pEmpty').textContent='No P1–P9 items in this report.'; return; }

    const left=document.createElement('div'); left.className='p-col';
    const right=document.createElement('div'); right.className='p-col';

    arr.forEach((p,i)=>{
      const card=document.createElement('div'); card.className='p-card';
      const h=document.createElement('div');
      h.innerHTML='<span class="tag">'+(p.id||'P?')+'</span> <b>'+(p.name||'')+'</b> <span class="tag" style="margin-left:8px">grade: '+(p.grade||'—')+'</span>';
      card.appendChild(h);

      const s=document.createElement('div'); s.className='small muted'; s.style.margin='6px 0'; s.textContent=p.short||'—'; card.appendChild(s);

      const det=document.createElement('details'); det.className='p'; const sum=document.createElement('summary'); sum.textContent='Details'; det.appendChild(sum);
      const body=document.createElement('div'); body.className='small'; body.style.marginTop='8px'; body.textContent=p.long||'—'; det.appendChild(body);
      const row=document.createElement('div'); row.className='row small'; const a=document.createElement('a'); a.className='btn'; a.textContent='Watch'; a.target='_blank'; a.href=p.video||youtubeLink(p.name||'golf swing checkpoint'); row.appendChild(a); det.appendChild(row);
      card.appendChild(det);

      (i%2===0?left:right).appendChild(card);
    });

    wrap.appendChild(left); wrap.appendChild(right);
  }

  function renderPlan(d){
    const ul=$('#plan'); ul.innerHTML='';
    (d.practicePlan || d.practice_plan || []).forEach(it=>{
      const li=document.createElement('li');
      li.innerHTML='<b>Day '+(it.day??'?')+':</b> '+(it.title||'')+(Array.isArray(it.items)?' — '+it.items.join('; '):'');
      ul.appendChild(li);
    });
    if(!ul.children.length) ul.innerHTML='<li class="muted">No plan found.</li>';
  }

  function renderSummary(d){
    list($('#sumGood'),  d.swingSummary?.whatYouDoWell);
    list($('#sumNeed'),  d.swingSummary?.needsAttention);
    list($('#sumGoals'), d.swingSummary?.goals);
    $('#sumParagraph').textContent = d.swingSummary?.paragraph || '—';
  }

  function showNote(d){ const t=(d.note||'').trim(); if(!t){ $('#noteBox').style.display='none'; return; } $('#note').textContent=t; $('#noteBox').style.display='block'; }

  function applyStack(on){
    const wrap=$('#pWrap');
    if(on){ wrap.classList.add('stackP'); wrap.classList.remove('grid2'); }
    else  { wrap.classList.remove('stackP'); wrap.classList.add('grid2'); }
  }

  function renderAll(d){
    metaPills(d); renderTop(d); renderPlan(d); renderP1P9(d); renderSummary(d); showNote(d);
  }

  async function generateWithAI(base){
    const level=$('#level').value;
    const focus=Array.from($('#focus').selectedOptions).map(o=>o.value);
    $('#aiMsg').textContent='Thinking…'; $('#btnGen').disabled=true;
    try{
      const r=await fetch('/api/generate-report-llm',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({report:base,level,focusAreas:focus})});
      const j=await r.json(); if(!r.ok) throw new Error(j?.error||'AI error');
      j.swingScore = j.power?.score ?? base.swingScore;
      j.status     = base.status || 'ready';
      j.note       = base.note || j.note;
      renderAll(j);
      try{ localStorage.setItem('vc_last_report', JSON.stringify(j)); }catch{}
      $('#aiMsg').textContent='Personalized by AI ✓';
    }catch(e){ $('#aiMsg').textContent='Error: '+(e?.message||e); }
    finally{ $('#btnGen').disabled=false; }
  }

  (async ()=>{
    try{
      let data;
      if(directUrl) data = await fetchJson(directUrl);
      else if(rid)  data = await fetchJson(urlForId(rid));
      else {
        const raw=sessionStorage.getItem('vc_report')||localStorage.getItem('vc_last_report');
        if(!raw) throw new Error('Missing ?url or ?id and no cached report.');
        data=JSON.parse(raw);
      }

      // set level from report if exists
      if(data.meta?.level) $('#level').value = (data.meta.level||'intermediate');

      // Stack vertically by default
      $('#stackChk').checked = true;
      applyStack(true);
      $('#stackChk').onchange = (e)=> applyStack(e.target.checked);

      // Initial render (so there is something on screen)
      renderAll(data);

      // Auto-AI: if this report is not yet enhanced, try to enhance immediately
      if (!data.aiEnhanced) {
        // let the user see something, then enhance
        setTimeout(()=> generateWithAI(data), 200);
      }

      // Manual regenerate
      $('#btnGen').onclick = ()=> generateWithAI(data);
    }catch(e){ alert(e?.message||e); }
  })();
</script>
</body>
</html>

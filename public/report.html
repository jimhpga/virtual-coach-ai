<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="Cache-Control" content="no-store, max-age=0, must-revalidate"/>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Virtual Coach AI — Swing Report</title>
<link rel="stylesheet" href="/styles.css" />
<style>
  /* ---- Local polish exclusive to the report viewer ---- */
  .wrap { max-width: 1100px; margin: 0 auto; padding: 20px; }
  .pill { background:#0f1b22;border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-weight:700 }
  .pill-tiny { font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid var(--line);background:#0f1b22 }
  .muted { color: var(--muted); }
  .card h3 { margin: 0 0 10px; }
  .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
  .grid3 { display:grid; grid-template-columns: repeat(3, 1fr); gap:14px; }
  .section-title { display:flex; align-items:center; justify-content:space-between; margin:0 0 8px; gap:12px; }
  .bar { height:8px; border-radius:999px; background:#0f1b22; border:1px solid var(--line); overflow:hidden; }
  .bar > i { display:block; height:100%; width:0%; background:var(--accent, #4ad0ff); transition: width .5s ease; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }

  /* Summary block styles */
  .summary-block { border:1px solid var(--line); border-radius:14px; background:rgba(255,255,255,.03); box-shadow:0 6px 14px rgba(0,0,0,.25); padding:16px; margin-top:14px; }
  .summary-flex { display:flex; flex-wrap:wrap; gap:20px; align-items:flex-start; }
  .summary-score { min-width:120px; }
  .summary-score-number { font-size:32px; font-weight:700; line-height:1; color:var(--accent,#33b5ff); }
  .summary-score-label { font-size:13px; line-height:1.4; margin-top:4px; }
  .summary-col { flex:1; min-width:240px; font-size:14px; line-height:1.5; }
  .summary-heading { font-size:14px; font-weight:600; color:#fff; margin-bottom:4px; }

  /* P1–P9 stacked vertically */
  .pgrid { display:grid; grid-template-columns: 1fr; gap: 14px; }
  .p-card { background:rgba(255,255,255,.03); border:1px solid var(--line); border-radius:14px; padding:12px; box-shadow:0 6px 14px rgba(0,0,0,.25); max-width: 900px; margin: 0 auto; }
  .p-card h4 { margin:0 0 6px; font-size:15px }
  .p-card .short { color:var(--muted); margin-bottom:8px }
  .btn-sm { border:1px solid var(--line); padding:6px 10px; border-radius:8px; background:#0f1b22; color:#fff; text-decoration:none; cursor:pointer; display:inline-block }
  .btn-sm:hover { background:#122734 }
  details.p1long { margin-top:8px }
  details.p1long summary { cursor:pointer; list-style:none; }
  details.p1long summary::-webkit-details-marker{ display:none }
  details.p1long summary .caret { display:inline-block; transform: rotate(0deg); transition: transform .2s ease; }
  details[open].p1long summary .caret { transform: rotate(90deg); }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap }

  .accordion { border:1px solid var(--line); border-radius:14px; overflow:hidden }
  .ac-head { background:rgba(255,255,255,.03); padding:10px 12px; display:flex; align-items:center; justify-content:space-between; cursor:pointer }
  .ac-body { padding:12px; display:none }
  .ac-open .ac-body { display:block }
  .ac-open .caret { transform: rotate(90deg); }
  .list-dot { padding-left:18px }
  .list-dot li { margin:4px 0 }
  .infobox { font-size:12px; color:var(--muted) }
  .actions { display:flex; flex-wrap:wrap; gap:8px; margin:10px 0 }
  .btn { border:1px solid var(--line); background:#0f1b22; color:#fff; padding:8px 12px; border-radius:10px; text-decoration:none; cursor:pointer }

  /* Skeleton */
  .skeleton .bar { position:relative; overflow:hidden }
  .skeleton .bar::after{
    content:""; position:absolute; inset:0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.08), transparent);
    animation: shimmer 1.2s infinite;
  }
  @keyframes shimmer{ 0%{transform:translateX(-100%)} 100%{transform:translateX(100%)} }

  @media (max-width: 900px) {
    .grid3 { grid-template-columns: 1fr; }
    .grid2 { grid-template-columns: 1fr; }
  }

  /* Print */
  @media print{
    header.site,
    .navwrap,
    .accordion .ac-head,
    .actions,
    .brand,
    .scrim #focusBar,
    #qrBox { display:none !important; }
    .wrap{ max-width: 100%; margin:0; padding:0; }
    .card{ break-inside: avoid; box-shadow:none; }
    body{ background:#fff; color:#000; }
    .p-card{ border-color:#ddd; }
  }
</style>
</head>
<body>
  <!-- Header -->
  <header class="site">
    <div class="navwrap">
      <a class="brand" href="/"><img src="/virtualcoach-logo-transparent.png" alt="Virtual Coach AI"><span>Virtual Coach AI</span></a>
      <nav aria-label="Primary">
        <a href="/">Home</a>
        <a href="/upload">Upload</a>
        <a href="/reports">Reports</a>
        <a href="/coming-soon">Coming&nbsp;Soon</a>
        <a href="/pricing">Pricing</a>
        <a href="/faq">FAQ</a>
        <a href="/contact">Contact</a>
        <a href="/about">About</a>
      </nav>
    </div>
  </header>

  <div class="scrim">
    <main class="wrap" id="app">
      <!-- HEADER / ACTIONS -->
      <h1 style="margin-bottom:6px">Swing Report — P1–P9</h1>
      <div class="actions">
        <button id="btnCopy" class="btn">Copy link</button>
        <button id="btnDownload" class="btn">Download HTML</button>
        <button id="btnQR" class="btn">QR</button>
        <button id="btnPrint" class="btn">Print / PDF</button>
      </div>

      <!-- META ROW (badges like Score, Tempo, etc.) -->
      <div class="meta-row muted" id="metaRow" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap"></div>

      <!-- FOCUS SELECTOR (biases language in view only) -->
      <section id="focusBar" class="card" style="margin-top:10px">
        <div class="section-title">
          <h3>Focus this report on…</h3>
          <select id="focusSelect">
            <option value="">Balanced</option>
            <option value="swing plane">Swing Plane</option>
            <option value="hand path">Hand Path</option>
            <option value="face control">Face Control</option>
            <option value="low point">Low Point</option>
            <option value="speed">Speed</option>
          </select>
        </div>
        <div class="infobox">This changes how we talk about your swing here on-screen. Your saved report stays the same.</div>
      </section>

      <!-- LOADING STATE -->
      <div id="skeleton" class="card skeleton" style="padding:16px; margin-top:12px">
        <div class="muted">Loading your swing report…</div>
        <div class="bar" style="height:12px; border-radius:6px; margin-top:10px"></div>
      </div>

      <!-- COACH SUMMARY BLOCK -->
      <section id="coachSummary" class="summary-block" hidden>
        <!-- SCORE + PROFILE -->
        <div class="summary-flex">
          <div class="summary-score">
            <div id="swingScore" class="summary-score-number">—</div>
            <div class="summary-score-label muted">
              Swing Score<br/>
              (higher = more repeatable)
            </div>
          </div>
          <div class="summary-col">
            <div class="summary-heading">Profile Read</div>
            <div id="profileRead" class="muted">
              <!-- example:
              This is an advanced, tour-pattern swing. Lower body starts first,
              shaft shallows correctly, and impact is athletic. We’re tightening windows,
              not rebuilding from scratch.
              -->
            </div>
          </div>
        </div>

        <!-- ELITE TRAITS -->
        <div style="margin-top:20px;">
          <div class="summary-heading">Elite Traits (keep these)</div>
          <ul id="eliteTraits" class="muted" style="font-size:14px; line-height:1.5; padding-left:18px; margin:0;">
            <!-- <li>P6 delivery is tour-level: shaft under trail forearm, handle forward.</li> -->
          </ul>
        </div>

        <!-- PRIMARY FOCUS -->
        <div style="margin-top:20px;">
          <div class="summary-heading">Primary Focus (this is the thing)</div>
          <div id="primaryFocus" class="muted" style="font-size:14px; line-height:1.5;">
            <!-- Clubface is a little active at impact (P7). Stabilize it and your start line tightens. -->
          </div>
        </div>

        <!-- 14-DAY PLAN HIGH-LEVEL -->
        <div style="margin-top:20px;">
          <div class="summary-heading">14-Day Plan</div>
          <div id="planHighLevel" class="muted" style="font-size:14px; line-height:1.5;">
            <!-- Days 1–4: Impact drill... -->
          </div>
        </div>
      </section>

      <!-- SUMMARY STRIP (PRIORITY / POWER / CONSISTENCY) -->
      <section class="grid3" style="margin-top:14px" id="summaryStrip" hidden>
        <div class="card">
          <div class="section-title">
            <h3>Coaching Card</h3>
          </div>
          <div class="grid2">
            <div>
              <div class="muted" style="font-weight:700; margin-bottom:6px">Top 3 Priority Fixes</div>
              <div id="topPriority" class="list-tight"></div>
            </div>
            <div>
              <div class="muted" style="font-weight:700; margin-bottom:6px">Top 3 Power Fixes</div>
              <div id="topPower" class="list-tight"></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="section-title"><h3>Power / Tempo</h3></div>
          <div class="list-tight">
            <div>
              <div class="muted">Power Score</div>
              <div class="bar"><i id="barScore"></i></div>
              <div class="mono" id="txtScore"></div>
            </div>
            <div>
              <div class="muted">Tempo</div>
              <div class="mono" id="txtTempo">—</div>
            </div>
            <div>
              <div class="muted">Release Timing</div>
              <div class="bar"><i id="barRelease"></i></div>
              <div class="mono" id="txtRelease"></div>
            </div>

            <div class="muted" style="font-weight:700; margin-top:8px">Likely Power Leaks</div>
            <ul id="powerLeaks" class="list-dot" style="margin-top:6px"></ul>
          </div>
        </div>

        <div class="card">
          <div class="section-title"><h3>Consistency</h3></div>
          <div class="grid2">
            <div>
              <div class="muted" style="font-weight:700; margin-bottom:6px">Position Consistency</div>
              <div id="posConsistency" class="infobox">—</div>
            </div>
            <div>
              <div class="muted" style="font-weight:700; margin-bottom:6px">Swing Consistency</div>
              <div id="swingConsistency" class="infobox">—</div>
            </div>
          </div>
        </div>
      </section>

      <!-- PRACTICE PLAN ACCORDION -->
      <section style="margin-top:14px" id="practiceBlock" hidden>
        <div class="accordion" id="planAcc">
          <div class="ac-head" role="button" tabindex="0">
            <div style="display:flex; gap:10px; align-items:center">
              <span class="caret">▶</span>
              <h3 style="margin:0">Practice Plan (14 days)</h3>
            </div>
            <span class="pill-tiny" id="planCount">0 items</span>
          </div>
          <div class="ac-body">
            <div id="planList" class="list-dot"></div>
          </div>
        </div>
      </section>

      <!-- P1–P9 CHECKPOINTS -->
      <section style="margin-top:14px">
        <h2 style="margin:0 0 8px">P1–P9 Checkpoints</h2>
        <div class="pgrid" id="pGrid"></div>
        <div class="infobox" id="pGridEmpty" style="margin-top:8px"></div>
      </section>

      <!-- NARRATIVE SUMMARY -->
      <section class="card" style="margin-top:14px" id="summaryCard" hidden>
        <h3 style="margin:0 0 8px">Full Swing Summary</h3>
        <div id="summaryText" class="muted"></div>
      </section>

      <!-- OPTIONAL COACH NOTE -->
      <section id="noteBox" class="card" style="margin-top:14px; display:none">
        <h3 style="margin:0 0 8px">Coach Note</h3>
        <div id="noteTxt" class="muted"></div>
      </section>

      <!-- QR CONTAINER -->
      <div id="qrBox" class="card" style="display:none;margin-top:10px;padding:10px"></div>
    </main>
  </div>

<script>
/* ----------- CONFIG ----------- */
window.BLOB_PUBLIC_BASE =
  window.BLOB_PUBLIC_BASE || "https://yw0bpv5czlbqowjq.public.blob.vercel-storage.com";

/* ----------- helpers ----------- */
const $ = s => document.querySelector(s);
const qp = new URLSearchParams(location.search);
const rid = qp.get('id');
const directUrl = qp.get('url');

const blobFromId = id =>
  `${window.BLOB_PUBLIC_BASE.replace(/\/+$/,'')}/reports/${encodeURIComponent(id)}.json?cb=${Date.now()}`;

function showErr(msg){ alert(msg); }

async function fetchJson(url, tries=3){
  let last;
  for(let i=0;i<tries;i++){
    const res = await fetch(url, {cache:'no-store'});
    if (res.ok){
      const txt = await res.text();
      return JSON.parse(txt.trim().replace(/^\uFEFF/, ''));
    }
    last = res.status;
    await new Promise(r=>setTimeout(r, 400*(i+1)));
  }
  throw new Error(`Fetch ${last} for ${url}`);
}

function shareUrl(){
  const u = new URL(location.href);
  if (directUrl) { u.searchParams.set('url', directUrl); u.searchParams.delete('id'); }
  else if (rid) { u.searchParams.set('id', rid); u.searchParams.delete('url'); }
  return u.toString();
}
$("#btnCopy").addEventListener('click', async ()=>{
  const link = shareUrl();
  try{ await navigator.clipboard.writeText(link); alert('Share link copied'); }
  catch{ prompt('Copy link:', link); }
});
$("#btnDownload").addEventListener('click', ()=>{
  const html = document.documentElement.outerHTML;
  const blob = new Blob([html], {type:'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'swing-report.html';
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
});
$("#btnQR")?.addEventListener('click', ()=>{
  const link = shareUrl();
  const img = new Image();
  img.alt = 'QR';
  img.src = 'https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=' + encodeURIComponent(link);
  const box = $("#qrBox");
  box.innerHTML = ''; box.appendChild(img); box.style.display='block';
});
$("#btnPrint")?.addEventListener('click', ()=> window.print());

/* ----------- render helpers ----------- */
let lastReport = null;

const pct = n => Math.max(0, Math.min(100, Number(n||0)));

function fillMeta(data){
  const row = $('#metaRow'); row.innerHTML = '';

  // badge if AI enhanced
  if (data.enhanced || (data.ai && data.ai.enhanced)){
    const s = document.createElement('span');
    s.className = 'pill';
    s.textContent = (data.ai && data.ai.enhanced)
      ? `AI Enhanced ✓ (${data.ai.model||'LLM'})`
      : 'AI Enhanced ✓';
    row.appendChild(s);
  }

  const pills = [
    ['Score', (data.power?.score ?? data.swingScore ?? '—')],
    ['Status', (data.status ?? '—')],
    ['Tempo', (data.power?.tempo ?? '—')],
    ['Release', (data.power?.release_timing != null ? (data.power.release_timing + '%') : '—')],
    ['Level', (data.level || data.meta?.level || '—')],
    ['Goal', (data.goal || data.meta?.goal || '—')],
  ];

  pills.forEach(([k,v])=>{
    const x = document.createElement('span');
    x.className='pill';
    x.textContent=`${k}: ${v}`;
    row.appendChild(x);
  });

  const created = document.createElement('span');
  created.className = 'muted';
  created.style.marginLeft='8px';
  created.textContent = `Created: ${new Date().toLocaleString()}`;
  row.appendChild(created);
}

function setBars(data){
  const scoreVal = pct(data.power?.score ?? data.swingScore ?? 0);
  $('#barScore').style.width = scoreVal + '%';
  $('#txtScore').textContent = `${scoreVal}%`;

  const rel = pct(data.power?.release_timing ?? 0);
  $('#barRelease').style.width = rel + '%';
  $('#txtRelease').textContent = `${rel}%`;

  $('#txtTempo').textContent = data.power?.tempo ?? '—';

  // also feed Swing Score into coachSummary section
  $('#swingScore').textContent = scoreVal ? scoreVal : '—';
}

function setConsistency(data){
  const pos = data.positionConsistency?.notes
          || data.position_consistency?.notes
          || "Setup and transition are repeating. Minor variability shows up around clubface delivery.";
  const sw  = data.swingConsistency?.notes
          || data.swing_consistency?.notes
          || "Tempo is mostly stable; rehearse a few slow-motion reps between full swings to lock timing.";
  $('#posConsistency').textContent = pos;
  $('#swingConsistency').textContent = sw;
}

function setPowerLeaks(data){
  const out = [];
  const s = Number(data.power?.score ?? data.swingScore ?? 0);
  const rel = Number(data.power?.release_timing ?? 0);
  const tempo = String(data.power?.tempo || '3:1');

  if (s < 85) out.push('Add lead-side post / bracing at transition for more efficient speed transfer.');
  if (rel < 70) out.push('Clubface is getting “saved” late. Stabilize face through impact (P7) for tighter start line.');
  if (!/3:1/.test(tempo)) out.push('Tempo drifting. Hold rehearsals at slow speed between full swings.');

  const ul = $('#powerLeaks');
  ul.innerHTML = out.length
    ? out.slice(0,3).map(t=>`<li>${t}</li>`).join('')
    : '<li>No obvious power leaks detected.</li>';
}

function itemDiv(txt){
  const d = document.createElement('div');
  d.textContent = txt;
  return d;
}

function setCoachingCard(data){
  const focus = data._focus;
  const pri = (data.topPriorityFixes || data.top_priority_fixes || []).slice(0,3);
  const pow = (data.topPowerFixes || data.top_power_fixes || []).slice(0,3);

  const priBox = $('#topPriority');
  const powBox = $('#topPower');
  priBox.innerHTML=''; powBox.innerHTML='';

  if(!pri.length) priBox.appendChild(itemDiv('—'));
  if(!pow.length) powBox.appendChild(itemDiv('—'));

  pri.forEach(x => {
    const text = typeof x === 'string'
      ? x
      : (x.title ? `${x.title} — ${x.how||x.why||''}` : JSON.stringify(x));
    priBox.appendChild(itemDiv('• ' + text + (focus ? ` (focus: ${focus})` : '')));
  });

  pow.forEach(x => {
    const text = typeof x === 'string'
      ? x
      : (x.title ? `${x.title} — ${x.how||x.why||''}` : JSON.stringify(x));
    powBox.appendChild(itemDiv('• ' + text + (focus ? ` (focus: ${focus})` : '')));
  });

  // show strip
  $('#summaryStrip').hidden = false;
}

function youtubeLink(name){
  const q = encodeURIComponent(`${name} golf checkpoint`);
  return `https://www.youtube.com/results?search_query=${q}`;
}

function renderPGrid(data){
  const list = Array.isArray(data.p1p9 || data.phases) ? (data.p1p9 || data.phases) : [];
  const grid = $('#pGrid'); grid.innerHTML = '';
  const empty = $('#pGridEmpty'); empty.textContent='';
  if(!list.length){ empty.textContent = 'No P1–P9 items in this report.'; return; }

  const focus = data._focus;

  list.forEach((p,i)=>{
    const name  = p.name || p.title || `P${i+1}`;
    const grade = (p.grade || '').toString();
    const short = p.short || p.note || '—';
    const long  = p.long  || p.details || '';
    const video = p.video || youtubeLink(name);
    const idTxt = p.id || `P${i+1}`;

    const c = document.createElement('div');
    c.className='p-card';

    // header row
    const head = document.createElement('div');
    head.style.display = 'flex';
    head.style.alignItems = 'center';
    head.style.justifyContent = 'space-between';
    head.style.gap = '8px';

    const h4 = document.createElement('h4');
    h4.textContent = `${idTxt}. ${name}`;
    head.appendChild(h4);

    const g = document.createElement('span');
    g.className='pill-tiny';
    g.textContent = grade ? `grade: ${grade}` : 'grade: —';
    head.appendChild(g);
    c.appendChild(head);

    // watch link
    const watch = document.createElement('a');
    watch.className = 'btn-sm';
    watch.target = '_blank';
    watch.href = video;
    watch.textContent = 'Watch';
    watch.style.marginTop = '4px';
    c.appendChild(watch);

    // short summary
    const s = document.createElement('div');
    s.className='short';
    s.textContent = short;
    c.appendChild(s);

    // details/expansion
    if(long || focus){
      const det = document.createElement('details');
      det.className='p1long';

      const sum = document.createElement('summary');
      const caret = document.createElement('span');
      caret.className='caret';
      caret.textContent = '▶';
      sum.appendChild(caret);

      const t = document.createElement('span');
      t.textContent = ' Details';
      sum.appendChild(t);

      det.appendChild(sum);

      const body = document.createElement('div');
      body.style.marginTop='8px';
      body.textContent = long || '';

      if (focus){
        const extra = document.createElement('div');
        extra.className = 'infobox';
        extra.style.marginTop = '6px';
        extra.textContent = `Focus note: relate this checkpoint to ${focus}.`;
        body.appendChild(document.createElement('br'));
        body.appendChild(extra);
      }

      det.appendChild(body);
      c.appendChild(det);
    }

    grid.appendChild(c);
  });
}

function setPracticePlan(data){
  const list = data.practicePlan || data.practice_plan || [];
  const root = $('#planAcc');
  const count = $('#planCount');
  const out  = $('#planList');

  out.innerHTML='';
  count.textContent = `${list.length} items`;

  if(!list.length) {
    out.innerHTML = '<div class="infobox">No plan found.</div>';
  } else {
    const ul = document.createElement('ul');
    ul.className='list-dot';

    list.forEach(it=>{
      const li = document.createElement('li');
      const d = it.day != null ? `Day ${it.day}: ` : '';
      const title = it.title || it.name || '';
      const items = Array.isArray(it.items) ? ` — ${it.items.join('; ')}` : '';
      li.textContent = `${d}${title}${items}`;
      ul.appendChild(li);
    });

    out.appendChild(ul);
  }

  // High-level summary of first ~3 plan items for the "14-Day Plan" block at the top
  const highLevel = list.slice(0,3).map(it=>{
    const d = (it.day != null) ? `Day ${it.day}: ` : '';
    return d + (it.title || it.name || '');
  }).join(' • ');
  $('#planHighLevel').textContent = highLevel || 'Structured 14-day plan is attached below. Work in order, not all at once.';

  // Toggle open/close
  const head = root.querySelector('.ac-head');
  head.onclick = () => root.classList.toggle('ac-open');
  head.onkeydown = (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); root.classList.toggle('ac-open'); }};

  document.getElementById('practiceBlock').hidden = false;
}

function setSummary(data){
  const txt = (data.summary_long || '').trim();
  if(!txt){
    document.getElementById('summaryCard').hidden = true;
    return;
  }
  document.getElementById('summaryText').textContent = txt;
  document.getElementById('summaryCard').hidden = false;
}

function setNote(data){
  const n = (data.note || '').trim();
  const box = $('#noteBox');
  if(!n){
    box.style.display='none';
    return;
  }
  $('#noteTxt').textContent = n;
  box.style.display='block';
}

/* NEW: coach summary block population */
function setCoachSummary(data){
  // Profile Read / Elite Traits / Primary Focus all depend on data we have.
  // We’ll do safe fallbacks so the report never looks empty.

  // Profile Read
  const profile =
    data.profileRead ||
    data.profile_read ||
    "This swing uses an athletic lower-body sequence and delivers the club on-plane. We're not rebuilding — we're tightening windows.";

  $('#profileRead').textContent = profile;

  // Elite Traits
  const traitsBox = $('#eliteTraits');
  traitsBox.innerHTML = '';
  const traits = data.eliteTraits || data.elite_traits || [
    "Transition starts from the ground up. Lower body leads, not the hands.",
    "Delivery into P6 shows the shaft under the trail forearm — tour-style compression.",
    "Balanced, stable finish (P9). You're not falling out of the shot."
  ];
  traits.forEach(t=>{
    const li = document.createElement('li');
    li.textContent = t;
    traitsBox.appendChild(li);
  });

  // Primary Focus
  const focus =
    data.primaryFocus ||
    data.primary_focus ||
    "Clubface is a little active at impact (P7). Quiet the face through the ball so your start line tightens under pressure.";
  $('#primaryFocus').textContent = focus;

  // planHighLevel is set in setPracticePlan, so nothing else needed here.

  // Un-hide block
  $('#coachSummary').hidden = false;
}

function renderAll(data){
  lastReport = data || {};
  $('#skeleton')?.remove();

  fillMeta(data);
  setBars(data);
  setConsistency(data);
  setPowerLeaks(data);
  setCoachingCard(data);
  renderPGrid(data);
  setPracticePlan(data);
  setSummary(data);
  setNote(data);
  setCoachSummary(data);

  // Make sure summary strip is visible even if data was light
  document.getElementById('summaryStrip').hidden = false;
}

/* ----------- boot ----------- */
(async ()=> {
  try{
    let url = null;
    if (directUrl) url = directUrl;
    else if (rid)   url = blobFromId(rid);
    else {
      // fallback: last viewed report from session/local storage
      const raw = sessionStorage.getItem('vc_report') || localStorage.getItem('vc_last_report');
      if (!raw) throw new Error('Missing ?url or ?id. Use upload flow or reports page.');
      renderAll(JSON.parse(raw.trim().replace(/^\uFEFF/, '')));
      return;
    }
    const data = await fetchJson(url);
    renderAll(data);
  }catch(err){
    $('#skeleton')?.remove();
    showErr(err?.message || String(err));
  }
})();

/* focus changes: re-render with focus context baked into text */
document.getElementById('focusSelect')?.addEventListener('change', (e)=>{
  if (!lastReport) return;
  const focused = { ...lastReport, _focus: e.target.value || null };
  renderAll(focused);
});
</script>
</body>
</html>

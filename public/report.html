<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Virtual Coach AI — Swing Report</title>
<link rel="stylesheet" href="/styles.css" />
<style>
  /* ---------- MVP viewer look ---------- */
  :root{
    --panel: rgba(10,18,24,.24);
    --line:  rgba(255,255,255,.10);
    --muted:#bcd2db;
    --ok:#19c37d; --warn:#f6c453; --bad:#ff6b6b;
  }
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  .pill{background:#0f1b22;border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-weight:700}
  .muted{color:var(--muted)}
  .card{background:rgba(255,255,255,.04);border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.25);padding:14px 16px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  @media(max-width:900px){.grid3,.grid2{grid-template-columns:1fr}}
  .section-title{display:flex;align-items:center;justify-content:space-between;margin:0 0 8px}
  .bar{height:8px;border:1px solid var(--line);border-radius:999px;background:#0f1b22;overflow:hidden}
  .bar>i{display:block;height:100%;width:0%}
  .pct{font-family:ui-monospace,Menlo,Consolas,monospace}
  .krow{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .pill.s{font-size:12px;padding:3px 8px}
  .pcol{display:flex;flex-direction:column;gap:12px}
  /* P1–P9 stacked cards */
  .p-card{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:14px;padding:12px}
  .p-head{display:flex;gap:10px;align-items:center;justify-content:space-between}
  .p-id{font-weight:800}
  .p-grade{border:1px solid var(--line);border-radius:999px;padding:3px 8px;font-size:12px}
  .g-good{background:rgba(25,195,125,.18);color:#eafff4}
  .g-ok{background:rgba(246,196,83,.18);color:#2a2300}
  .g-bad{background:rgba(255,107,107,.18);color:#fff}
  .p-short{color:var(--muted);margin:6px 0 8px}
  .btn-sm{border:1px solid var(--line);padding:6px 10px;border-radius:8px;background:#0f1b22;color:#fff;text-decoration:none;cursor:pointer}
  .btn-sm:hover{background:#122734}
  details.px{margin-top:6px}
  details.px summary{list-style:none;cursor:pointer}
  details.px summary::-webkit-details-marker{display:none}
  .caret{display:inline-block;transform:rotate(0deg);transition:transform .2s}
  details[open].px .caret{transform:rotate(90deg)}
  /* small info */
  .infobox{font-size:13px;color:var(--muted)}
  /* hide raw json forever in MVP */
  #raw{display:none!important}
</style>
</head>
<body>
<header class="site">
  <div class="navwrap">
    <a class="brand" href="/"><img src="/virtualcoach-logo-transparent.png" alt="Virtual Coach AI"><span>Virtual Coach AI</span></a>
    <nav aria-label="Primary">
      <a href="/">Home</a>
      <a href="/upload">Upload</a>
      <a href="/reports">Reports</a>
      <a href="/coming-soon">Coming&nbsp;Soon</a>
      <a href="/pricing">Pricing</a>
      <a href="/faq">FAQ</a>
      <a href="/contact">Contact</a>
      <a href="/about">About</a>
    </nav>
  </div>
</header>

<div class="scrim">
  <main class="wrap">
    <h1 style="margin:0 0 6px">Swing Report — P1–P9</h1>
    <div id="metaRow" class="krow muted"></div>

    <!-- TOP STRIP: Coaching • Power • Consistency -->
    <section class="grid3" style="margin-top:14px">
      <div class="card">
        <div class="section-title"><h3 style="margin:0">Coaching Card</h3></div>
        <div class="grid2">
          <div>
            <div class="muted" style="font-weight:700;margin-bottom:6px">Top 3 Priority Fixes</div>
            <div id="fixPriority" class="pcol"></div>
          </div>
          <div>
            <div class="muted" style="font-weight:700;margin-bottom:6px">Top 3 Power Fixes</div>
            <div id="fixPower" class="pcol"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="section-title"><h3 style="margin:0">Power Score Summary</h3></div>
        <div class="pcol">
          <div>
            <div class="muted">Power Score</div>
            <div class="bar"><i id="barScore"></i></div>
            <div class="pct" id="txtScore">—</div>
          </div>
          <div>
            <div class="muted">Tempo</div>
            <div class="pct" id="txtTempo">—</div>
          </div>
          <div>
            <div class="muted">Release Timing</div>
            <div class="bar"><i id="barRelease"></i></div>
            <div class="pct" id="txtRelease">—</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="section-title"><h3 style="margin:0">Consistency</h3></div>
        <div class="grid2">
          <div>
            <div class="muted" style="font-weight:700;margin-bottom:6px">Position Consistency</div>
            <div class="krow">
              <span id="posScore" class="pill s">—</span>
            </div>
            <div id="posNotes" class="infobox" style="margin-top:6px">—</div>
          </div>
          <div>
            <div class="muted" style="font-weight:700;margin-bottom:6px">Swing Consistency</div>
            <div class="krow">
              <span id="swingScore" class="pill s">—</span>
            </div>
            <div id="swingNotes" class="infobox" style="margin-top:6px">—</div>
          </div>
        </div>
      </div>
    </section>

    <!-- PRACTICE PLAN (collapsible) -->
    <section style="margin-top:14px">
      <div class="card">
        <details id="planBox">
          <summary style="cursor:pointer;list-style:none">
            <span class="caret">▶</span> <b>Practice Plan (optional)</b>
            <span id="planCount" class="pill s" style="margin-left:8px">0 items</span>
          </summary>
          <div id="planList" class="infobox" style="margin-top:10px"></div>
        </details>
      </div>
    </section>

    <!-- P1–P9 stacked vertically -->
    <section style="margin-top:14px">
      <h2 style="margin:0 0 8px">P1–P9</h2>
      <div id="pList" class="pcol"></div>
      <div id="pEmpty" class="infobox" style="margin-top:8px"></div>
    </section>

    <!-- Written summary -->
    <section id="summaryCard" class="card" style="margin-top:14px;display:none">
      <h3 style="margin:0 0 8px">Swing Summary</h3>
      <div id="sumPara" class="muted" style="margin-bottom:8px"></div>
      <div class="grid2">
        <div>
          <div class="muted" style="font-weight:700">What’s Good</div>
          <ul id="sumGood" class="infobox" style="margin-top:6px"></ul>
        </div>
        <div>
          <div class="muted" style="font-weight:700">Needs Work</div>
          <ul id="sumBad" class="infobox" style="margin-top:6px"></ul>
        </div>
      </div>
      <div style="margin-top:8px">
        <div class="muted" style="font-weight:700">Goals</div>
        <ul id="sumGoals" class="infobox" style="margin-top:6px"></ul>
      </div>
    </section>
  </main>
</div>

<script>
/* ---------------- config ---------------- */
window.BLOB_PUBLIC_BASE =
  window.BLOB_PUBLIC_BASE || "https://yw0bpv5czlbqowjq.public.blob.vercel-storage.com";

/* ---------------- utils ---------------- */
const $ = s => document.querySelector(s);
const qp = new URLSearchParams(location.search);
const rid = qp.get("id");
const directUrl = qp.get("url");

const blobFromId = (id) =>
  `${window.BLOB_PUBLIC_BASE.replace(/\/+$/,'')}/reports/${encodeURIComponent(id)}.json?cb=${Date.now()}`;

const clampPct = v => Math.max(0, Math.min(100, Number(v||0)));
const bandColor = (v) => v>=75 ? "ok" : v>=55 ? "warn" : "bad";

/* ---------------- mapping ---------------- */
function fillMeta(d){
  const row = $("#metaRow"); row.innerHTML = "";
  const chips = [
    ["Score", d.swingScore ?? d.score ?? "—"],
    ["Status", d.status ?? "—"],
    ["Tempo", d.power?.tempo ?? "—"],
    ["Release", (d.power?.release_timing!=null ? d.power.release_timing+"%" : "—")]
  ];
  chips.forEach(([k,v])=>{
    const s = document.createElement("span");
    s.className = "pill";
    s.textContent = `${k}: ${v}`;
    row.appendChild(s);
  });
  const created = document.createElement("span");
  created.className = "muted";
  created.style.marginLeft = "8px";
  created.textContent = `Created: ${new Date().toLocaleString()}`;
  row.appendChild(created);
}

function setPower(d){
  const score = clampPct(d.power?.score ?? d.swingScore ?? 0);
  const rel   = clampPct(d.power?.release_timing ?? 0);
  const scoreBar = $("#barScore");
  const relBar   = $("#barRelease");
  const setBar = (el, val) => {
    el.style.width = val + "%";
    el.style.background = val>=75 ? "var(--ok)" : val>=55 ? "var(--warn)" : "var(--bad)";
  };
  setBar(scoreBar, score);
  setBar(relBar, rel);
  $("#txtScore").textContent = score + "%";
  $("#txtRelease").textContent = rel + "%";
  $("#txtTempo").textContent = d.power?.tempo ?? "—";
}

function setConsistency(d){
  const posScore = d.positionConsistency?.score ?? d.position_consistency?.score;
  const posNotes = d.positionConsistency?.notes ?? d.position_consistency?.notes;
  const swScore  = d.swingConsistency?.score ?? d.swing_consistency?.score;
  const swNotes  = d.swingConsistency?.notes ?? d.swing_consistency?.notes;

  const setPill = (el, v) => {
    const n = clampPct(v);
    el.textContent = isFinite(n) && v!=null ? (n + "%") : "—";
    el.style.background = isFinite(n) ? (n>=75?"rgba(25,195,125,.18)":n>=55?"rgba(246,196,83,.18)":"rgba(255,107,107,.18)") : "#0f1b22";
  };
  setPill($("#posScore"), posScore);
  setPill($("#swingScore"), swScore);
  $("#posNotes").textContent = posNotes || "—";
  $("#swingNotes").textContent = swNotes || "—";
}

function chipClass(g){
  const t = String(g||"ok").toLowerCase();
  if (t==="good") return "p-grade g-good";
  if (t==="bad"||t==="needs help") return "p-grade g-bad";
  return "p-grade g-ok";
}

function ytSearch(q){
  return `https://www.youtube.com/results?search_query=${encodeURIComponent(q)}`;
}

function renderP(d){
  const list = Array.isArray(d.phases||d.p1p9) ? (d.phases||d.p1p9) : [];
  const root = $("#pList"); root.innerHTML = "";
  $("#pEmpty").textContent = list.length ? "" : "No P1–P9 items in this report.";
  list.forEach((p,i)=>{
    const cid = p.id || `P${i+1}`;
    const name = p.name || p.title || cid;
    const short = p.short || p.note || "";
    const long  = p.long  || p.details || "";
    const grade = p.grade || "ok";
    const video = p.video || p.video_url || ytSearch(`${cid} ${name} golf checkpoint`);

    const card = document.createElement("div");
    card.className = "p-card";

    const head = document.createElement("div");
    head.className = "p-head";
    const left = document.createElement("div");
    left.innerHTML = `<span class="p-id">${cid}.</span> <b>${name}</b>`;
    const g = document.createElement("span");
    g.className = chipClass(grade);
    g.textContent = `grade: ${String(grade).toLowerCase()}`;
    head.appendChild(left); head.appendChild(g);
    card.appendChild(head);

    if (short) {
      const s = document.createElement("div");
      s.className = "p-short";
      s.textContent = short;
      card.appendChild(s);
    }

    const row = document.createElement("div");
    row.className = "krow";
    const a = document.createElement("a");
    a.className = "btn-sm"; a.target = "_blank"; a.rel="noopener";
    a.href = video; a.textContent = "Watch";
    row.appendChild(a);
    card.appendChild(row);

    if (long) {
      const det = document.createElement("details");
      det.className = "px";
      const sum = document.createElement("summary");
      sum.innerHTML = `<span class="caret">▶</span> Details`;
      const body = document.createElement("div");
      body.style.marginTop = "8px";
      body.style.whiteSpace = "pre-wrap";
      body.textContent = long;
      det.appendChild(sum); det.appendChild(body);
      card.appendChild(det);
    }

    root.appendChild(card);
  });
}

function setPlan(d){
  const list = d.practicePlan || d.practice_plan || [];
  const count = $("#planCount");
  const pl = $("#planList"); pl.innerHTML = "";
  count.textContent = `${list.length} items`;
  if (!list.length){
    pl.textContent = "No plan included in this report.";
    return;
  }
  const ul = document.createElement("ul");
  ul.style.margin = "6px 0 0";
  list.forEach(it=>{
    const li = document.createElement("li");
    const day = it.day!=null ? `Day ${it.day}: ` : "";
    const title = it.title || it.name || "";
    const items = Array.isArray(it.items) ? ` — ${it.items.join("; ")}` : "";
    li.textContent = `${day}${title}${items}`;
    ul.appendChild(li);
  });
  pl.appendChild(ul);
}

function setSummary(d){
  const box = $("#summaryCard");
  const para = d.swingSummary?.paragraph || d.summary?.paragraph || "";
  const good = d.swingSummary?.good || d.summary?.good || [];
  const bad  = d.swingSummary?.bad  || d.summary?.bad  || [];
  const goals= d.swingSummary?.goals|| d.summary?.goals|| [];
  if (!para && !good.length && !bad.length && !goals.length){
    box.style.display = "none";
    return;
  }
  $("#sumPara").textContent = para || "—";
  const fillList = (ul, arr)=>{
    ul.innerHTML = "";
    if (!arr.length){ ul.innerHTML = "<li>—</li>"; return; }
    arr.forEach(t=>{ const li=document.createElement("li"); li.textContent = String(t); ul.appendChild(li); });
  };
  fillList($("#sumGood"),  good);
  fillList($("#sumBad"),   bad);
  fillList($("#sumGoals"), goals);
  box.style.display = "";
}

/* ---------------- boot ---------------- */
(async ()=>{
  try{
    let url = null;
    if (directUrl) url = directUrl;
    else if (rid)   url = blobFromId(rid);
    else {
      const raw = sessionStorage.getItem("vc_report") || localStorage.getItem("vc_last_report");
      if (!raw) throw new Error("Missing ?url or ?id. Open from Upload or Reports.");
      const data = JSON.parse(raw.trim().replace(/^\uFEFF/,""));
      fillMeta(data); setPower(data); setConsistency(data); renderP(data); setPlan(data); setSummary(data);
      return;
    }
    const res = await fetch(url, {cache:"no-store"});
    if (!res.ok) throw new Error(`Fetch ${res.status} for ${url}`);
    const txt = await res.text();
    const data = JSON.parse(txt.trim().replace(/^\uFEFF/,""));
    fillMeta(data); setPower(data); setConsistency(data); renderP(data); setPlan(data); setSummary(data);
  } catch(err){
    alert(err?.message || String(err));
  }
})();
</script>
</body>
</html>

<script>
  const $ = s => document.querySelector(s);
  const qp = new URLSearchParams(location.search);
  const urlParam = qp.get('url');     // preferred
  const idParam  = qp.get('id');      // fallback

  const fmt = v => `${v}%`;
  const band = v => v>=75 ? 'ok' : v>=55 ? 'warn' : 'bad';
  const metricRow = m =>
    `<div class="metric"><div class="name">${m.label||m.p}</div>
      <div class="bar"><span class="${band(m.value)}" style="width:${m.value}%"></span></div>
      <div class="pct">${fmt(m.value)}</div></div>`;

  async function fetchJson(u){
    const r = await fetch(u, { cache: 'no-store' });
    if (!r.ok) throw new Error(`Fetch ${r.status} for ${u}`);
    const t = await r.text();
    return JSON.parse(t.trim().replace(/^\uFEFF/, ''));
  }

  async function resolveUrl() {
    if (urlParam) return urlParam;
    if (idParam) {
      const r = await fetch(`/api/get-url?id=${encodeURIComponent(idParam)}`);
      const j = await r.json();
      if (!r.ok || !j?.url) throw new Error('Could not resolve report URL from id');
      return j.url;
    }
    throw new Error('Missing report id or url.\nOpen as /report.html?id=<reportId> or /report.html?url=<full-blob-url>');
  }

  function renderReport(data){
    // very small version (keep your pretty UI if you want)
    $('#created')?.textContent = new Date().toLocaleDateString();
    const p = data.power || { score:0, tempo:'—', release_timing:0 };
    // fill any other elements you already have…
  }

  (async () => {
    try {
      const u = await resolveUrl();
      const data = await fetchJson(u);
      renderReport(data);
    } catch (e) {
      console.error(e);
      const err = document.createElement('div');
      err.style.color = 'red';
      err.textContent = `Failed to load report: ${e.message}`;
      document.body.querySelector('main,body').prepend(err);
    }
  })();
</script>

<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Virtual Coach AI — Swing Report</title>
<style>
  :root{--bg:#0c141a;--panel:#12202a;--line:#1f3a4a;--text:#e8f3f7;--muted:#b8d0db}
  html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial}
  .wrap{max-width:920px;margin:0 auto;padding:20px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px 16px;margin:12px 0}
  .muted{color:var(--muted)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .pill{background:#0f1b22;border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-weight:700}
  .btn{display:inline-block;border:1px solid var(--line);background:#0f1b22;color:#fff;text-decoration:none;border-radius:10px;padding:8px 12px;margin-right:6px}
  .btn:hover{background:#122734}
  summary{list-style:none;cursor:pointer}
  details.panel{background:#0f1b22;border:1px solid var(--line);border-radius:12px;margin:8px 0}
  pre{white-space:pre-wrap;word-break:break-word}
</style>
<body>
<div class="wrap">
  <h1>Virtual Coach AI — Swing Report</h1>
  <div class="muted" id="meta">Loading…</div>

  <div class="card" id="summary" hidden>
    <div class="row">
      <span class="pill">Score: <b id="score">—</b></span>
      <span class="pill">Status: <b id="status">—</b></span>
      <span class="pill">Created: <b id="created">—</b></span>
      <span class="pill" id="loadedVia" title="How the report was loaded"></span>
    </div>
    <div style="margin-top:10px">
      <a class="btn" id="btnCopy" href="#">Copy share link</a>
      <a class="btn" id="btnDownload" href="#">Download HTML</a>
    </div>
  </div>

  <div class="card" id="phases" hidden>
    <h3 style="margin:0 0 8px">P1–P9</h3>
    <div id="plist" class="muted">—</div>
  </div>

  <div class="card" id="coach" hidden>
    <h3 style="margin:0 0 8px">Coaching</h3>
    <details class="panel" id="coachPriorityWrap" hidden>
      <summary><b>Top 3 Priority Fixes</b></summary>
      <div id="coachPriority" style="padding:10px"></div>
    </details>
    <details class="panel" id="coachPowerWrap" hidden>
      <summary><b>Top 3 Power Fixes</b></summary>
      <div id="coachPower" style="padding:10px"></div>
    </details>
  </div>

  <div class="card" id="raw" hidden>
    <h3 style="margin:0 0 8px">Raw JSON</h3>
    <pre id="dump"></pre>
  </div>

  <pre id="err" class="card" style="display:none;color:#fff;background:#58151a;border-color:#8a252f"></pre>
</div>

<script>
/* ----------- CONFIG ----------- */
window.BLOB_PUBLIC_BASE =
  window.BLOB_PUBLIC_BASE || "https://yw0bpv5czlbqowjq.public.blob.vercel-storage.com";

/* ----------- helpers ----------- */
const $ = s => document.querySelector(s);
const qp = new URLSearchParams(location.search);
const rid = qp.get('id');
const directUrl = qp.get('url');

const blobFromId = id =>
  `${window.BLOB_PUBLIC_BASE.replace(/\/+$/,'')}/reports/${encodeURIComponent(id)}.json?cb=${Date.now()}`;

function showErr(msg){
  const e = $('#err'); e.style.display='block'; e.textContent = msg;
  $('#meta').textContent = 'Error';
}

async function fetchJson(url){
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error(`Fetch ${res.status} for ${url}`);
  const txt = await res.text();
  return JSON.parse(txt.trim().replace(/^\uFEFF/,''));
}

function shareUrl(){
  const u = new URL(location.href);
  if (directUrl) { u.searchParams.set('url', directUrl); u.searchParams.delete('id'); }
  else if (rid) { u.searchParams.set('id', rid); u.searchParams.delete('url'); }
  return u.toString();
}

const chip = g => (g==='good'?'color:#19c37d':g==='ok'?'color:#f6c453':'color:#ff6b6b');

function render(data){
  $('#summary').hidden = false;
  $('#raw').hidden = false;
  $('#dump').textContent = JSON.stringify(data, null, 2);

  $('#status').textContent  = data.status ?? '—';
  $('#score').textContent   = (data.swingScore ?? data.score ?? '—');
  $('#created').textContent = new Date().toLocaleString();
  $('#meta').textContent    = (directUrl ? 'Loaded via ?url' : 'Loaded via ?id');
  $('#loadedVia').textContent = directUrl ? 'via url' : (rid ? 'via id' : 'via storage');

  // P1–P9
  const phases = Array.isArray(data.phases || data.p1p9) ? (data.phases || data.p1p9) : [];
  if (phases.length){
    $('#phases').hidden = false;
    $('#plist').innerHTML = phases.map((p,i)=> {
      const name  = p.name || p.title || `P${i+1}`;
      const grade = (p.grade || '').toString().toLowerCase();
      const short = p.short || p.note || '';
      return `<div style="margin:6px 0">
        <b>${name}</b>${grade?` — <span style="${chip(grade)}">${grade}</span>`:''}
        ${short?` <span class="muted">• ${short}</span>`:''}
      </div>`;
    }).join('');
  }

  // Coaching
  const pri = data.coaching?.priority_fixes ?? [];
  const pow = data.coaching?.power_fixes ?? [];
  if (pri.length || pow.length){
    $('#coach').hidden = false;
    if (pri.length){
      $('#coachPriorityWrap').hidden = false;
      $('#coachPriority').innerHTML = pri.map(f => {
        const t=f.title||''; const s=f.short||''; const l=f.long||'';
        return `<div style="margin:8px 0">
          <div><b>${t}</b>${s?` <span class="muted">• ${s}</span>`:''}</div>
          ${l?`<div class="muted" style="margin-top:4px">${l}</div>`:''}
        </div>`;
      }).join('');
    }
    if (pow.length){
      $('#coachPowerWrap').hidden = false;
      $('#coachPower').innerHTML = pow.map(f => {
        const t=f.title||''; const s=f.short||''; const l=f.long||'';
        return `<div style="margin:8px 0">
          <div><b>${t}</b>${s?` <span class="muted">• ${s}</span>`:''}</div>
          ${l?`<div class="muted" style="margin-top:4px">${l}</div>`:''}
        </div>`;
      }).join('');
    }
  }

  // actions
  $('#btnCopy').onclick = async (e)=>{
    e.preventDefault();
    const link = shareUrl();
    try{ await navigator.clipboard.writeText(link); alert('Share link copied'); }
    catch{ prompt('Copy link:', link); }
  };

  $('#btnDownload').onclick = (e)=>{
    e.preventDefault();
    const html = document.documentElement.outerHTML;
    const b = new Blob([html], {type:'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(b);
    a.download = 'swing-report.html';
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  };
}

/* ----------- boot ----------- */
(async ()=>{
  try{
    let url = null;
    if (directUrl) url = directUrl;
    else if (rid)   url = blobFromId(rid);
    else {
      const raw = sessionStorage.getItem('vc_report') || localStorage.getItem('vc_last_report');
      if (!raw) throw new Error('Missing ?url or ?id. Use /test-save.html to open.');
      render(JSON.parse(raw.trim().replace(/^\uFEFF/, '')));
      return;
    }
    const data = await fetchJson(url);
    render(data);
  }catch(err){ showErr(err?.message || String(err)); }
})();
</script>
</body>
</html>

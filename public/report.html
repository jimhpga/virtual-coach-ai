<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store, max-age=0, must-revalidate"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Upload • Virtual Coach AI</title>
  <style>
    :root{--bg:#0c141a;--panel:#12202a;--line:#1f3a4a;--text:#e8f3f7;--muted:#b8d0db}
    html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial}
    .wrap{max-width:820px;margin:0 auto;padding:24px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px}
    h1{margin:0 0 12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{border:1px solid var(--line);background:#0f1b22;color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted)}
    pre{white-space:pre-wrap;word-break:break-word;margin:12px 0 0}
    input[type="file"]{accent-color:#19c37d}
    label{display:block;font-weight:700;margin-top:12px}
    input[type="text"],input[type="email"],select{background:#0f1b22;color:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    @media (max-width:760px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <main class="wrap">
    <h1>Upload</h1>

    <section class="card" style="margin-bottom:12px">
      <div class="row" style="gap:12px">
        <input id="file" type="file" accept="video/*" />
        <button id="uploadBtn" class="btn" type="button">Upload & Analyze</button>
        <span class="muted">MP4/MOV recommended</span>
      </div>

      <!-- optional metadata (all optional; kept for future) -->
      <div class="grid" style="margin-top:12px">
        <input id="name"      type="text"  placeholder="Name (optional)" />
        <input id="email"     type="email" placeholder="Email (optional)" />
        <input id="handicap"  type="text"  placeholder="Handicap (optional)" />
        <select id="handed">
          <option value="">Handedness (optional)</option>
          <option>Right</option><option>Left</option>
        </select>
        <select id="eye">
          <option value="">Dominant Eye (optional)</option>
          <option>Right</option><option>Left</option>
        </select>
        <input id="height" type="text" placeholder="Height in inches (48–84)" />
      </div>

      <pre id="log" class="muted">Ready.</pre>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px">How this works</h3>
      <ol class="muted" style="margin:0; padding-left:18px">
        <li>We request a Mux “direct upload” URL.</li>
        <li>Your video is PUT straight to Mux (can take a minute).</li>
        <li>We save a report JSON via <code>/api/save-report</code>.</li>
        <li>We open the viewer at <code>/report.html?url=…</code> (or <code>?id=…</code> fallback).</li>
      </ol>
    </section>
  </main>

  <!-- Inline client (full replacement) -->
  <script>
  (() => {
    const $ = s => document.querySelector(s);
    const fileEl = $("#file");
    const btn = $("#uploadBtn");
    const logEl = $("#log");

    const fields = {
      name:   $("#name"),
      email:  $("#email"),
      hcap:   $("#handicap"),
      handed: $("#handed"),
      eye:    $("#eye"),
      height: $("#height"),
    };

    const log = m => { logEl.textContent += (logEl.textContent ? "\n" : "") + m; logEl.scrollTop = logEl.scrollHeight; };
    const busy = on => { btn.disabled = !!on; fileEl.disabled = !!on; Object.values(fields).forEach(el => el && (el.disabled = !!on)); };

    const readForm = () => ({
      name:   (fields.name?.value || "").trim(),
      email:  (fields.email?.value || "").trim(),
      hcap:   (fields.hcap?.value || "").trim(),
      handed: (fields.handed?.value || "").trim(),
      eye:    (fields.eye?.value || "").trim(),
      height: (fields.height?.value || "").trim(),
    });

    function validateHeight(h){
      if (!h) return ""; // optional now; if you want required, uncomment next line
      // if (!h) return "Height is required.";
      const n = Number(h);
      if (!Number.isFinite(n)) return "Height must be a number.";
      if (n < 48 || n > 84)  return "Height should be between 48 and 84 inches.";
      return "";
    }

    async function jsonOrThrow(res, fallback = "Request failed"){
      let data = null;
      try { data = await res.json(); } catch(_) {}
      if (!res.ok) throw new Error((data && data.error) || `${fallback} (${res.status})`);
      return data || {};
    }

    btn.addEventListener("click", async (e) => {
      e.preventDefault();
      if (window.__uploadRunning) return;

      const file = fileEl.files?.[0];
      if (!file) { log("Pick a video first."); return; }

      const form = readForm();
      const heightErr = validateHeight(form.height);
      if (heightErr) { log("Error: " + heightErr); return; }

      window.__uploadRunning = true;
      busy(true);
      logEl.textContent = "Starting upload…";

      try {
        log("Requesting Mux upload URL…");
        const r1 = await fetch("/api/mux-direct-upload", { method: "POST" });
        const j1 = await jsonOrThrow(r1, "Mux upload URL request failed");
        const up = j1.upload;
        if (!up?.url) throw new Error("Mux upload URL missing");

        log("Uploading to Mux… (this can take a minute)");
        const r2 = await fetch(up.url, { method: "PUT", body: file });
        if (!r2.ok) throw new Error(`Mux upload failed (${r2.status})`);

        log("Saving report JSON…");
        const r3 = await fetch("/api/save-report", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({
            status: "ready",
            swingScore: 80,
            muxPlaybackId: null,  // your backend can resolve later
            muxUploadId: up.id,   // keep this
            p1p9: [],
            faults: [],
            note: `uploaded ${file.name}`,
            meta: form
          })
        });

        // be tolerant of non-JSON to surface server errors
        let rep;
        const ct = (r3.headers.get("content-type") || "").toLowerCase();
        if (ct.includes("application/json")) {
          rep = await r3.json();
        } else {
          const txt = await r3.text();
          throw new Error(`save-report returned non-JSON (${r3.status})\n${txt.slice(0,200)}…`);
        }
        if (!r3.ok) throw new Error(rep?.error || `Report save failed (${r3.status})`);

        log("Opening report view…");
        if (rep.url) {
          location.assign(`/report.html?url=${encodeURIComponent(rep.url)}`);
        } else if (rep.id) {
          location.assign(`/report.html?id=${encodeURIComponent(rep.id)}`);
        } else {
          throw new Error("Report response missing url/id");
        }
      } catch (err) {
        log("Error: " + (err?.message || err));
        busy(false);
        window.__uploadRunning = false;
      }
    });
  })();
  </script>
</body>
</html>

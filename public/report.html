<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Virtual Coach AI — Swing Report</title>
<link rel="stylesheet" href="/styles.css" />
<style>
  :root{
    --pill:#0f1b22; --glass: rgba(255,255,255,.06); --glass2: rgba(255,255,255,.03);
  }
  .wrap{max-width:1140px;margin:0 auto;padding:20px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .pill{background:var(--pill);border:1px solid var(--line);border-radius:999px;padding:6px 12px;font-weight:700}
  .card{background:var(--glass);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 10px 22px rgba(0,0,0,.22)}
  .grid3{display:grid;grid-template-columns:1.2fr 1fr 1fr;gap:14px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .bar{height:10px;background:#0f1b22;border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .bar>i{display:block;height:100%;background:#24c1ff;width:0}
  .muted{color:var(--muted)}
  .h2{margin:18px 0 8px;font-size:22px;font-weight:800}
  .h3{margin:0 0 8px;font-weight:800}
  .small{font-size:12px}
  .btn{border:1px solid var(--line);background:#0f1b22;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  select, textarea{background:var(--glass2);border:1px solid var(--line);color:#fff;border-radius:10px;padding:8px}
  textarea{width:100%;min-height:90px}
  details.p{background:var(--glass2);border:1px solid var(--line);border-radius:12px;padding:10px}
  details.p summary{cursor:pointer;list-style:none;font-weight:700}
  .p-card{border:1px solid var(--line);border-radius:12px;background:var(--glass2);padding:10px}
  .yt{display:inline-block;margin-left:8px}
  .list>li{margin:4px 0}
  .tag{border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px}
  .stackP .p-col{display:block}
  .stackP .p-col .p-card{margin-bottom:10px}
  @media(max-width:1000px){.grid3{grid-template-columns:1fr}}
</style>
</head>
<body>
<header class="site">
  <div class="navwrap">
    <a class="brand" href="/"><img src="/virtualcoach-logo-transparent.png" alt="Virtual Coach AI"><span>Virtual Coach AI</span></a>
    <nav aria-label="Primary">
      <a href="/">Home</a>
      <a href="/upload">Upload</a>
      <a href="/reports">Reports</a>
      <a href="/coming-soon">Coming&nbsp;Soon</a>
      <a href="/pricing">Pricing</a>
      <a href="/faq">FAQ</a>
      <a href="/contact">Contact</a>
      <a href="/about">About</a>
    </nav>
  </div>
</header>

<div class="scrim">
  <main class="wrap">
    <h1 style="margin:0 0 8px">Swing Report — P1–P9</h1>
    <div id="meta" class="row muted"></div>

    <!-- AI PERSONALIZER -->
    <section class="card" style="margin-top:12px">
      <div class="row" style="align-items:flex-end">
        <div>
          <div class="small muted">Golfer level</div>
          <select id="level">
            <option value="beginner">Beginner (plain language)</option>
            <option value="intermediate" selected>Intermediate (balanced)</option>
            <option value="advanced">Advanced (technical)</option>
          </select>
        </div>
        <div style="flex:1;min-width:260px">
          <div class="small muted">What do you want to work on? (multi-select)</div>
          <select id="focus" multiple size="5" style="width:100%">
            <option value="swing_plane">Swing plane</option>
            <option value="hand_path">Hand path</option>
            <option value="clubface_control">Clubface control</option>
            <option value="tempo">Tempo</option>
            <option value="ground_forces">Ground forces</option>
            <option value="wrist_angles">Wrist angles</option>
            <option value="release_timing">Release timing</option>
            <option value="start_line">Start line</option>
            <option value="low_point">Low point</option>
          </select>
        </div>
        <div>
          <button id="btnGen" class="btn">Generate with AI</button>
        </div>
        <div class="muted small" id="aiMsg"></div>
      </div>
    </section>

    <!-- TOP STRIP -->
    <section class="grid3" style="margin-top:14px">
      <div class="card">
        <div class="h3">Coaching Card</div>
        <div class="grid2">
          <div>
            <div class="small muted">Top 3 Priority Fixes</div>
            <ul id="prio" class="list"></ul>
          </div>
          <div>
            <div class="small muted">Top 3 Power Fixes</div>
            <ul id="pfix" class="list"></ul>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="h3">Power Score Summary</div>
        <div class="small muted">Power Score</div>
        <div class="bar"><i id="bScore"></i></div>
        <div id="tScore" class="small"></div>
        <div class="small muted" style="margin-top:6px">Tempo</div>
        <div id="tTempo" class="small">—</div>
        <div class="small muted" style="margin-top:6px">Release Timing</div>
        <div class="bar"><i id="bRel"></i></div>
        <div id="tRel" class="small"></div>
      </div>

      <div class="card">
        <div class="h3">Consistency</div>
        <div class="grid2">
          <div>
            <div class="small muted">Position Consistency</div>
            <div class="row">
              <span id="posScore" class="tag">—</span>
            </div>
            <div id="posNotes" class="small muted" style="margin-top:6px">—</div>
          </div>
          <div>
            <div class="small muted">Swing Consistency</div>
            <div class="row">
              <span id="swingScore" class="tag">—</span>
            </div>
            <div id="swingNotes" class="small muted" style="margin-top:6px">—</div>
          </div>
        </div>
      </div>
    </section>

    <!-- PRACTICE PLAN -->
    <section class="card" style="margin-top:14px">
      <details id="planDetails" open>
        <summary class="h3">Practice Plan (14 days)</summary>
        <ul id="plan" class="list"></ul>
      </details>
    </section>

    <!-- P1–P9 -->
    <section style="margin-top:14px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="h2" style="margin:0">P1–P9</div>
        <div class="row small muted">
          <label><input type="checkbox" id="stackChk"> Stack vertically</label>
        </div>
      </div>
      <div id="pWrap" class="grid2" style="margin-top:8px"></div>
      <div id="pEmpty" class="muted small" style="margin-top:6px"></div>
    </section>

    <!-- SUMMARY -->
    <section class="card" style="margin-top:14px">
      <div class="h3">Swing Summary</div>
      <div id="sumParagraph" class="small" style="margin:8px 0 10px"></div>
      <div class="grid3">
        <div>
          <div class="small muted">What you do well</div>
          <ul id="sumGood" class="list"></ul>
        </div>
        <div>
          <div class="small muted">Needs attention</div>
          <ul id="sumNeed" class="list"></ul>
        </div>
        <div>
          <div class="small muted">Goals</div>
          <ul id="sumGoals" class="list"></ul>
        </div>
      </div>
    </section>

    <!-- NOTE -->
    <section id="noteBox" class="card" style="margin-top:14px;display:none">
      <div class="h3">Note</div>
      <div id="note" class="small muted"></div>
    </section>
  </main>
</div>

<script>
  const $ = s => document.querySelector(s);
  const qp = new URLSearchParams(location.search);
  const rid = qp.get('id');
  const directUrl = qp.get('url');
  const BLOB = "https://yw0bpv5czlbqowjq.public.blob.vercel-storage.com";

  function urlForId(id){
    return BLOB.replace(/\/+$/,'') + "/reports/" + encodeURIComponent(id) + ".json?cb=" + Date.now();
  }

  async function fetchJson(u){
    const r = await fetch(u, { cache: 'no-store' });
    if(!r.ok) throw new Error("Fetch " + r.status);
    const t = await r.text();
    return JSON.parse(t.trim().replace(/^\\uFEFF/, ''));
  }

  function bar(i, pct){ i.style.width = Math.max(0, Math.min(100, +pct||0)) + "%"; }

  function list(el, arr){
    el.innerHTML = "";
    (arr||[]).forEach(s=>{
      const li = document.createElement('li');
      li.textContent = s;
      el.appendChild(li);
    });
    if(!el.children.length) el.innerHTML = '<li class="muted">—</li>';
  }

  function metaPills(data){
    const row = $('#meta'); row.innerHTML = '';
    [
      ['Score', data.swingScore ?? data.power?.score ?? '—'],
      ['Status', data.status ?? 'ready'],
      ['Tempo', data.power?.tempo ?? '—'],
      ['Release', (data.power?.release_timing ?? '—') + (data.power?.release_timing != null ? '%' : '')],
      ['Created', new Date().toLocaleString()]
    ].forEach(([k,v])=>{
      const s = document.createElement('span');
      s.className = 'pill';
      s.textContent = k + ': ' + v;
      row.appendChild(s);
    });
  }

  function renderTop(data){
    // Coaching card
    list($('#prio'), data.topPriorityFixes || data.top_priority_fixes);
    list($('#pfix'), data.topPowerFixes || data.top_power_fixes);

    // Power
    const score = data.power?.score ?? data.swingScore ?? 0;
    bar($('#bScore'), score);
    $('#tScore').textContent = score + '%';

    const rel = data.power?.release_timing ?? 0;
    bar($('#bRel'), rel);
    $('#tRel').textContent = rel + '%';

    $('#tTempo').textContent = data.power?.tempo ?? '—';

    // Consistency
    $('#posScore').textContent = (data.consistency?.position?.score ?? '—') + (data.consistency?.position?.score != null ? '%' : '');
    $('#posNotes').textContent = data.consistency?.position?.notes ?? '—';

    $('#swingScore').textContent = (data.consistency?.swing?.score ?? '—') + (data.consistency?.swing?.score != null ? '%' : '');
    $('#swingNotes').textContent = data.consistency?.swing?.notes ?? '—';
  }

  function youtubeLink(q){ return 'https://www.youtube.com/results?search_query=' + encodeURIComponent(q); }

  function renderP1P9(data){
    const list = Array.isArray(data.p1p9) ? data.p1p9 : [];
    const wrap = $('#pWrap'); wrap.innerHTML=""; $('#pEmpty').textContent = '';
    if(!list.length){ $('#pEmpty').textContent = 'No P1–P9 items in this report.'; return; }

    // two columns by default
    const left = document.createElement('div'); left.className='p-col';
    const right = document.createElement('div'); right.className='p-col';

    list.forEach((p, idx)=>{
      const card = document.createElement('div');
      card.className = 'p-card';
      const h = document.createElement('div');
      h.innerHTML = '<span class="tag">'+(p.id || 'P?')+'</span> <b>'+ (p.name || '') +'</b> <span class="tag" style="margin-left:8px">grade: '+(p.grade || '—')+'</span>';
      card.appendChild(h);

      const s = document.createElement('div');
      s.className='small muted';
      s.style.margin='6px 0';
      s.textContent = p.short || '—';
      card.appendChild(s);

      const det = document.createElement('details');
      det.className='p';
      const sum = document.createElement('summary');
      sum.textContent = 'Details';
      det.appendChild(sum);

      const body = document.createElement('div');
      body.className='small';
      body.style.marginTop='8px';
      body.textContent = p.long || '—';
      det.appendChild(body);

      // watch button under grade
      const row = document.createElement('div'); row.className='row small';
      const a = document.createElement('a');
      a.className='btn';
      a.textContent='Watch';
      a.target='_blank';
      a.href = p.video || youtubeLink((p.name||'golf swing checkpoint'));
      row.appendChild(a);
      det.appendChild(row);

      card.appendChild(det);

      (idx % 2 === 0 ? left : right).appendChild(card);
    });

    wrap.appendChild(left);
    wrap.appendChild(right);
  }

  function renderPlan(data){
    const ul = $('#plan'); ul.innerHTML='';
    (data.practicePlan || data.practice_plan || []).forEach(it=>{
      const li = document.createElement('li');
      li.innerHTML = '<b>Day '+ (it.day ?? '?') + ':</b> ' + (it.title || '') +
        (Array.isArray(it.items) ? ' — ' + it.items.join('; ') : '');
      ul.appendChild(li);
    });
    if(!ul.children.length) ul.innerHTML = '<li class="muted">No plan found.</li>';
  }

  function renderSummary(data){
    list($('#sumGood'), data.swingSummary?.whatYouDoWell);
    list($('#sumNeed'), data.swingSummary?.needsAttention);
    list($('#sumGoals'), data.swingSummary?.goals);
    $('#sumParagraph').textContent = data.swingSummary?.paragraph || '—';
  }

  function showNote(data){
    const t = (data.note || '').trim();
    if(!t){ $('#noteBox').style.display='none'; return; }
    $('#note').textContent = t;
    $('#noteBox').style.display='block';
  }

  function applyStack(on){
    const wrap = $('#pWrap');
    if(on){ wrap.classList.add('stackP'); wrap.classList.remove('grid2'); }
    else { wrap.classList.remove('stackP'); wrap.classList.add('grid2'); }
  }

  function renderAll(d){
    metaPills(d);
    renderTop(d);
    renderPlan(d);
    renderP1P9(d);
    renderSummary(d);
    showNote(d);
  }

  // -------- AI call --------
  async function generateWithAI(base){
    const level = $('#level').value;
    const focus = Array.from($('#focus').selectedOptions).map(o=>o.value);
    $('#aiMsg').textContent = 'Thinking…';
    $('#btnGen').disabled = true;
    try{
      const r = await fetch('/api/generate-report-llm', {
        method:'POST',
        headers:{ 'content-type':'application/json' },
        body: JSON.stringify({ report: base, level, focusAreas: focus })
      });
      const j = await r.json();
      if(!r.ok) throw new Error(j?.error || 'AI error');

      // merge power score for the top meta bar
      j.swingScore = j.power?.score ?? base.swingScore;
      j.status = base.status || 'ready';
      j.note = base.note || j.note;

      renderAll(j);
      // remember last
      try { localStorage.setItem('vc_last_report', JSON.stringify(j)); } catch {}
      $('#aiMsg').textContent = 'Personalized by AI ✓';
    }catch(e){
      $('#aiMsg').textContent = 'Error: ' + (e?.message || e);
    }finally{
      $('#btnGen').disabled = false;
    }
  }

  // boot
  (async ()=>{
    try{
      let data;
      if(directUrl) data = await fetchJson(directUrl);
      else if(rid)  data = await fetchJson(urlForId(rid));
      else {
        const raw = sessionStorage.getItem('vc_report') || localStorage.getItem('vc_last_report');
        if(!raw) throw new Error('Missing ?url or ?id and no cached report.');
        data = JSON.parse(raw);
      }
      // Default level if report carries one
      if(data.meta?.level) $('#level').value = (data.meta.level||'intermediate');

      renderAll(data);

      // UI hooks
      $('#btnGen').onclick = ()=> generateWithAI(data);
      $('#stackChk').onchange = (e)=> applyStack(e.target.checked);
    }catch(e){
      alert(e?.message || e);
    }
  })();
</script>
</body>
</html>

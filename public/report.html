<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Virtual Coach AI — Swing Report</title>
<link rel="stylesheet" href="/styles.css"/>
<style>
  .kpi{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .pill{background:#0f1b22;border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-weight:700}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .metric{display:flex;justify-content:space-between;border:1px solid var(--line);border-radius:8px;padding:8px 10px;margin:4px 0;background:#0f1b22}
  .bar{height:6px;background:#0b1a22;border-radius:6px;margin:6px 0;overflow:hidden}
  .bar>i{display:block;height:6px;background:#38bdf8}
  .pitem{padding:10px;border:1px solid var(--line);border-radius:8px;margin:6px 0;background:#0f1b22}
  details.pitem>summary{cursor:pointer;list-style:none}
  details.pitem>summary::-webkit-details-marker{display:none}
  .list-dot{margin-left:16px}
  .grid2{display:grid;grid-template-columns:1fr 1fr; gap:12px}
  @media (max-width:900px){.grid2{grid-template-columns:1fr}}
</style>
</head>
<body>
<header class="site">
  <div class="navwrap">
    <a class="brand" href="/"><img src="/virtualcoach-logo-transparent.png" alt="Virtual Coach AI"><span>Virtual Coach AI</span></a>
    <nav aria-label="Primary">
      <a href="/">Home</a>
      <a href="/upload">Upload</a>
      <a href="/reports" aria-current="page">Reports</a>
      <a href="/coming-soon">Coming&nbsp;Soon</a>
      <a href="/pricing">Pricing</a>
      <a href="/faq">FAQ</a>
      <a href="/contact">Contact</a>
      <a href="/about">About</a>
    </nav>
  </div>
</header>

<div class="scrim">
  <main class="wrap">
    <h1>Swing Report — P1–P9</h1>

    <!-- Summary / KPIs -->
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="kpi">
          <span class="pill">Score: <b id="score">—</b></span>
          <span class="pill">Status: <b id="status">—</b></span>
          <span class="pill">Tempo: <b id="tempo">—</b></span>
          <span class="pill">Release: <b id="rel">—</b>%</span>
        </div>
        <div class="row">
          <a id="btnDL" class="btn" href="#" download="swing-report.html">Download</a>
          <a id="btnCopy" class="btn" href="#">Copy share link</a>
        </div>
      </div>
      <ul id="ataglance" class="list-dot" style="margin-top:10px"></ul>
    </section>

    <!-- P1–P9 -->
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">P1–P9</h3>
        <span class="pill" id="pcount">Info</span>
      </div>
      <div id="pgrid"></div>
    </section>

    <!-- Coaching card -->
    <section class="card">
      <h3 style="margin:0 0 8px">Coaching Card</h3>
      <div class="grid2">
        <div>
          <b>Top 3 Priority Fixes</b>
          <ul id="prio" class="list-dot"></ul>
        </div>
        <div>
          <b>Top 3 Power Fixes</b>
          <ul id="powerfix" class="list-dot"></ul>
        </div>
      </div>
    </section>

    <!-- Consistency -->
    <section class="card">
      <div class="grid2">
        <div>
          <h3 style="margin:0 0 8px">Position Consistency</h3>
          <div id="pos"></div>
        </div>
        <div>
          <h3 style="margin:0 0 8px">Swing Consistency</h3>
          <div id="swg"></div>
        </div>
      </div>
    </section>

    <!-- Power summary -->
    <section class="card">
      <h3 style="margin:0 0 8px">Power Score Summary</h3>
      <div>Power Score</div>
      <div class="bar"><i id="pscore" style="width:0%"></i></div>
      <div class="row" style="gap:20px">
        <div>Tempo <b id="ptempo">—</b></div>
        <div>Release Timing <b id="prel">—</b>%</div>
      </div>
    </section>

    <!-- Practice plan -->
    <section class="card">
      <h3 style="margin:0 0 8px">Practice Plan</h3>
      <ol id="plan" style="margin-left:18px"></ol>
    </section>

    <!-- Raw JSON -->
    <section class="card">
      <h3 style="margin:0 0 8px">Raw JSON</h3>
      <pre id="dump" style="white-space:pre-wrap"></pre>
    </section>
  </main>
</div>

<script>
const $ = s => document.querySelector(s);
const qp = new URLSearchParams(location.search);
const rid = qp.get('id');
const directUrl = qp.get('url');
const blobBase = (window.BLOB_PUBLIC_BASE || "https://yw0bpv5czlbqowjq.public.blob.vercel-storage.com").replace(/\/+$/,'');

function shareUrl(){
  const u = new URL(location.href);
  if (directUrl) { u.searchParams.set('url', directUrl); u.searchParams.delete('id'); }
  else if (rid)  { u.searchParams.set('id', rid); u.searchParams.delete('url'); }
  return u.toString();
}
function blobFromId(id){
  return `${blobBase}/reports/${encodeURIComponent(id)}.json?cb=${Date.now()}`;
}
async function fetchJson(url){
  const r = await fetch(url, { cache: 'no-store' });
  if (!r.ok) throw new Error(`Fetch ${r.status} for ${url}`);
  const t = await r.text();
  return JSON.parse(t.trim().replace(/^\uFEFF/, ''));
}
function el(tag, attrs={}, html){
  const n = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v]) => n.setAttribute(k,v));
  if (html) n.innerHTML = html;
  return n;
}

function render(data){
  // KPIs
  $('#status').textContent = data.status || '—';
  $('#score').textContent  = data.power?.score ?? data.swingScore ?? '—';
  $('#tempo').textContent  = data.power?.tempo ?? '—';
  $('#rel').textContent    = data.power?.release_timing ?? '—';
  $('#ptempo').textContent = data.power?.tempo ?? '—';
  $('#prel').textContent   = data.power?.release_timing ?? '—';
  $('#pscore').style.width = ((data.power?.score ?? data.swingScore ?? 0)|0) + '%';

  // at a glance
  const ag = data.atAGlance || [];
  const ul = $('#ataglance'); ul.innerHTML='';
  ag.forEach(s => ul.appendChild(el('li',{},s)));

  // P1–P9
  const pgrid = $('#pgrid'); pgrid.innerHTML='';
  const phases = Array.isArray(data.p1p9) ? data.p1p9 : [];
  $('#pcount').textContent = `${phases.length} items`;
  phases.forEach(p => {
    const d = el('details', {class:'pitem', open:''});
    const s = el('summary', {}, `<b>${p.id} — ${p.name}</b> <span class="muted">• ${p.grade}</span><div class="muted">${p.short}</div>`);
    d.appendChild(s);
    d.appendChild(el('div', {style:'margin-top:6px'}, p.long || p.short || ''));
    pgrid.appendChild(d);
  });

  // top 3s
  const prio = $('#prio'); prio.innerHTML='';
  (data.priorityFixes || []).slice(0,3).forEach(t => prio.appendChild(el('li',{},t)));
  const pfix = $('#powerfix'); pfix.innerHTML='';
  (data.powerFixes || []).slice(0,3).forEach(t => pfix.appendChild(el('li',{},t)));

  // consistency
  const pos = $('#pos'); pos.innerHTML='';
  (data.positionConsistency || []).forEach(m => {
    const div = el('div',{class:'metric'}, `<div>${m.name}</div><div><b>${m.score}%</b></div>`);
    pos.appendChild(div);
  });
  const swg = $('#swg'); swg.innerHTML='';
  (data.swingConsistency || []).forEach(m => {
    const div = el('div',{class:'metric'}, `<div>${m.name}</div><div><b>${m.score}%</b></div>`);
    swg.appendChild(div);
  });

  // plan
  const plan = $('#plan'); plan.innerHTML='';
  (data.practice_plan || []).forEach(day => {
    const li = el('li',{}, `<b>Day ${day.day} — ${day.title}</b>`);
    const sub = el('ul',{class:'list-dot'});
    (day.items || []).forEach(i => sub.appendChild(el('li',{},i)));
    li.appendChild(sub); plan.appendChild(li);
  });

  // raw
  $('#dump').textContent = JSON.stringify(data, null, 2);

  // actions
  $('#btnCopy').onclick = async (e)=>{ e.preventDefault(); try{ await navigator.clipboard.writeText(shareUrl()); alert('Share link copied'); }catch{ prompt('Copy link:', shareUrl()); } };
  $('#btnDL').onclick   = (e)=>{ e.preventDefault(); const html = document.documentElement.outerHTML; const b = new Blob([html], {type:'text/html'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download='swing-report.html'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000); };
}

(async()=>{
  try{
    let url=null;
    if (directUrl) url = directUrl;
    else if (rid)  url = blobFromId(rid);
    else {
      const raw = sessionStorage.getItem('vc_report') || localStorage.getItem('vc_last_report');
      if (!raw) throw new Error('Missing ?url or ?id');
      render(JSON.parse(raw.trim().replace(/^\uFEFF/,'') ));
      return;
    }
    const data = await fetchJson(url);
    render(data);
  }catch(err){
    alert(err?.message || String(err));
  }
})();
</script>
</body>
</html>

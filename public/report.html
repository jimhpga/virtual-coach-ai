<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Swing Report | Virtual Coach AI</title>
  <link rel="icon" href="/favicon.ico"/>
  <style>
    :root{
      --bg:#05180f;
      --card:rgba(0,0,0,.45);
      --stroke:rgba(255,255,255,.12);
      --text:#f3f6f4; --muted:#cbd5ce;
      --accent:#1f6f3e; --accent-2:#2b8c53; --warn:#b08900;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); background:var(--bg);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background-image:
        radial-gradient(1200px 600px at 10% -20%, rgba(255,255,255,.05), transparent 60%),
        radial-gradient(1200px 600px at 110% -20%, rgba(255,255,255,.05), transparent 60%);
    }
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{
      background:var(--card); border:1px solid var(--stroke); border-radius:14px;
      box-shadow:0 12px 32px rgba(0,0,0,.35); backdrop-filter:blur(4px);
      padding:16px 18px; margin-bottom:12px;
    }
    .title{display:flex;justify-content:space-between;gap:12px;align-items:baseline;margin:0 0 8px}
    h1{font-size:20px;margin:0}
    .muted{color:var(--muted)}
    select,input[type="text"],button{
      border:1px solid rgba(255,255,255,.18); border-radius:10px; padding:8px 10px;
      color:var(--text); background:rgba(255,255,255,.06); outline:none;
    }
    button.btn{background:var(--accent);color:#fff;cursor:pointer}
    button.btn:hover{filter:brightness(1.05)}
    button.ghost{background:transparent}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media (max-width:920px){ .grid{grid-template-columns:1fr} }
    .section h3{margin:0 0 6px;font-size:16px}
    .badge{
      display:inline-flex;align-items:center;gap:6px;border:1px solid var(--stroke);
      border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;background:rgba(255,255,255,.06)
    }
    .progress{height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2))}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .pending{padding:12px;border:1px dashed var(--stroke);border-radius:12px}
    .pill{border:1px solid var(--stroke);border-radius:999px;padding:6px 10px}
  </style>
</head>
<body>
  <div class="wrap">
<<<<<<< Updated upstream
    <div class="title" role="banner">
      <h1>Virtual Coach AI &mdash; Swing Report</h1>
=======
    <div class="title">
      <h1>Virtual Coach AI ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Swing Report</h1>
>>>>>>> Stashed changes
      <div class="row">
        <a class="pill" href="/upload.html">Upload another</a>
        <a class="pill" id="share" href="#">Copy share link</a>
      </div>
    </div>

    <div id="meta" class="muted" style="margin-bottom:10px;"></div>

    <div class="card" aria-label="Controls">
      <div class="row" style="gap:12px;align-items:center;">
        <div>
          <label class="muted" for="teacher">Teacher voice</label><br/>
          <select id="teacher">
            <option value="nice">Nice &amp; encouraging</option>
            <option value="oldschool">Old-school coach</option>
            <option value="supportive">Calm &amp; supportive</option>
          </select>
        </div>
        <div>
          <label class="muted" for="baseline">Baseline compare</label><br/>
          <select id="baseline"></select>
        </div>
        <div class="row">
          <button id="setBaseline" class="btn" type="button">Set current as baseline</button>
          <button id="clearBaseline" class="ghost" type="button">Clear baseline</button>
        </div>
      </div>
    </div>

    <div id="pending" class="card pending" style="display:none"></div>

    <div id="report" style="display:none">
      <div class="grid">
        <div class="card section" id="summary">
          <h3>Power Score &amp; Consistency</h3>
          <div class="row" style="gap:20px">
            <div style="min-width:220px">
              <div class="muted small">Power Score</div>
              <div class="progress" title="Power Score">
                <div class="bar" id="pwrBar" style="width:0%"></div>
              </div>
<<<<<<< Updated upstream
              <div class="mono" id="pwrLbl">&mdash;</div>
=======
              <div class="mono" id="pwrLbl">ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â</div>
>>>>>>> Stashed changes
            </div>
            <div style="min-width:220px">
              <div class="muted small">Consistency</div>
              <div class="progress" title="Consistency">
                <div class="bar" id="consBar" style="width:0%"></div>
              </div>
<<<<<<< Updated upstream
              <div class="mono" id="consLbl">&mdash;</div>
=======
              <div class="mono" id="consLbl">ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â</div>
>>>>>>> Stashed changes
            </div>
          </div>
          <div id="deltas" style="margin-top:10px"></div>
        </div>

        <div class="card section" id="top3">
          <h3>Top 3 Fundamentals</h3>
          <ol id="funds"></ol>
        </div>

        <div class="card section" id="errors">
          <h3>Top 3 Power Errors</h3>
          <ol id="errs"></ol>
        </div>

        <div class="card section" id="quickfix">
          <h3>Top 3 Quick Fixes</h3>
          <ol id="fixes"></ol>
        </div>

        <div class="card section" id="expect">
          <h3>What to Expect After a Change</h3>
          <ul id="exp"></ul>
          <div class="muted small">These short-term outcomes are normal as your body adopts new patterns.</div>
        </div>

        <div class="card section" id="drills">
          <h3>Drills</h3>
          <ul id="drillList"></ul>
        </div>

        <div class="card section" id="badges">
          <h3>Badges</h3>
          <div id="badgeRow"></div>
        </div>

        <div class="card section" id="coach">
          <h3>Your Coach Says</h3>
          <div id="coachCopy"></div>
        </div>
      </div>
    </div>
  </div>

<<<<<<< Updated upstream
  <!-- All logic in external script to avoid encoding issues in inline strings -->
  =======
  <!-- All logic in external script to avoid inline multi-line strings -->
  >>>>>>> Stashed changes
<script><<<<<<< Updated upstream
// public/report.client.js
(function () {
  const $ = (s) => document.querySelector(s);
  const byId = (id) => document.getElementById(id);
  const qs = () => Object.fromEntries(new URLSearchParams(location.search).entries());

  async function getJSON(url) {
    const r = await fetch(url, { headers: { accept: "application/json" }, cache: "no-store" });
    const t = await r.text();
    try { return JSON.parse(t); } catch { throw new Error(`Bad JSON: ${t}`); }
  }

  function setProgress(barId, lblId, val) {
    const n = Math.max(0, Math.min(100, Number(val) || 0));
    const bar = byId(barId), lbl = byId(lblId);
    if (bar) bar.style.width = n + "%";
    if (lbl) lbl.textContent = `${n} / 100`;
  }

  function setList(id, arr) {
    const el = byId(id); if (!el) return;
    el.innerHTML = "";
    (arr || []).forEach((x) => {
      const li = document.createElement("li");
      li.textContent = String(x);
      el.appendChild(li);
    });
  }
  const setUl = setList;

  function setBadges(id, badges) {
    const row = byId(id); if (!row) return;
    row.innerHTML = "";
    (badges || []).forEach((b) => {
      const span = document.createElement("span");
      span.className = "badge";
      span.textContent = (b.title || b.label || b.id || b.code || "").toString().replace(/[-_]/g, " ");
      row.appendChild(span);
    });
  }

  // --------- Shape A (legacy) ----------
  function renderShapeA(d) {
    const s = d.summary || {};
    setProgress("pwrBar", "pwrLbl", s.powerScore);
    setProgress("consBar", "consLbl", s.consistency);
    setList("funds", d.fundamentals);
    setList("errs", d.errors);
    setList("fixes", d.quickFixes);
    setUl("exp", d.expectations);
    setUl("drillList", d.drills);
    setBadges("badgeRow", d.badges);
    byId("coachCopy").textContent = d.coachCopy || "";
    const deltas = d.deltas || {};
    byId("deltas").innerHTML =
      (deltas.powerScore || deltas.consistency)
        ? `<span class="mono">Î” Power: ${deltas.powerScore ?? 0} â€¢ Î” Consistency: ${deltas.consistency ?? 0}</span>`
        : "";
  }

  // --------- Shape B (wrapped report) ----------
  function renderShapeB(r) {
    const meta = r.meta || {};
    const sections = r.sections || {};
    const pwr = r.summary?.powerScore ?? r.metrics?.powerScore ?? 0;
    const cons = r.summary?.consistency ?? r.metrics?.consistency ?? 0;

    setProgress("pwrBar", "pwrLbl", pwr);
    setProgress("consBar", "consLbl", cons);
    setList("funds", sections.fundamentalsTop3 || []);
    setList("errs", sections.powerErrorsTop3 || []);
    setList("fixes", sections.quickFixesTop3 || []);
    setUl("exp", r.expectations || []);
    setUl("drillList", sections.drills || r.drills || []);
    setBadges("badgeRow", r.badges || []);
    byId("coachCopy").textContent = r.teacherVoice?.sample || r.coachCopy || "";

    const bits = [];
    if (meta.date) bits.push(`Date: ${meta.date}`);
    if (meta.mode) bits.push(meta.mode);
    if (meta.key) bits.push(`<span class="mono">${meta.key}</span>`);
    byId("meta").innerHTML = bits.join(" â€¢ ");
  }

  // --------- Shape VC (your current API) ----------
  function renderShapeVC(r) {
    // meta/header
    const when = r.ts ? new Date(r.ts) : new Date();
    const parts = [
      when.toLocaleDateString(),
      r.mode ? `Mode: ${title(r.mode)}` : "",
      r.sourceKey ? `<span class="mono">${r.sourceKey}</span>` : ""
    ].filter(Boolean);
    byId("meta").innerHTML = parts.join(" â€¢ ");

    // scores
    const pwr = r.swingScore ?? 0;
    const cons = Math.round((r.swingScore ?? 0) * 0.9); // simple proxy until you add a real field
    setProgress("pwrBar", "pwrLbl", pwr);
    setProgress("consBar", "consLbl", cons);

    // p-checkpoints â†’ fundamentals list
    const funds = (r.p_checkpoints || [])
      .slice(0, 3)
      .map(x => `P${x.p} â€” ${x.notes || x.label || ""}`);
    setList("funds", funds);

    // faults â†’ errors list & badges
    const errs = (r.faults || []).map(f => `${nice(f.code)}${f.severity ? ` (${f.severity})` : ""}`);
    setList("errs", errs.slice(0, 3));
    setBadges("badgeRow", r.faults);

    // friendly placeholders until you return these arrays
    setList("fixes", [
      "Add vertical force earlier",
      "Keep trail wrist bent through P6",
      "Match face closer to path at P7"
    ]);
    setUl("exp", [
      "Ball flight may start lower for a few sessions",
      "Tempo can feel slower as mechanics improve",
      "Contact consistency improves after 50â€“100 reps"
    ]);
    setUl("drillList", [
      "Step-Through Drill",
      "Pump to P6 Drill",
      "Alignment Stick Side-Bend"
    ]);

    byId("coachCopy").textContent =
      "Great foundation. Build verticals sooner and keep side-bend into P6. Expect straighter starts as face matches path.";
  }

  function showPending(msg) {
    const p = byId("pending");
    if (!p) return;
    p.style.display = "";
    p.innerHTML = `<div class="mono">${msg}</div>`;
  }

  function render(data) {
    if (data?.report) renderShapeB(data.report);
    else if ("swingScore" in data || "p_checkpoints" in data) renderShapeVC(data);
    else renderShapeA(data);

    const pending = byId("pending"), report = byId("report");
    if (pending) pending.style.display = "none";
    if (report) report.style.display = "";
  }

  async function init() {
    const params = qs();
    // Your flow uses uploads/<date>/demo.mov; keep that default to match S3 keys you write
    const key = params.key || "uploads/demo.mov";
    const demo = params.demo;

    const share = $("#share");
    if (share) {
      share.addEventListener("click", (e) => {
        e.preventDefault();
        navigator.clipboard?.writeText(location.href);
        share.textContent = "Copied!";
        setTimeout(() => (share.textContent = "Copy share link"), 1200);
      });
    }

    showPending("Loading reportâ€¦");

    const url = new URL("/api/report", location.origin);
    url.searchParams.set("key", key);
    if (demo) url.searchParams.set("demo", demo);

    const start = Date.now();
    while (true) {
      try {
        const data = await getJSON(url.toString());
        if (data?.ok) { render(data); return; }
        if (data?.error === "NOT_READY") showPending("Analyzing your swingâ€¦ (auto-refreshing)");
        else showPending("Waiting on analysisâ€¦");
      } catch (e) {
        console.warn(e);
        showPending("Problem loading the report.");
      }
      if (Date.now() - start > 60000) { showPending("Still processing â€” check back soon."); return; }
      await new Promise((r) => setTimeout(r, 5000));
    }
  }

  document.addEventListener("DOMContentLoaded", init);

  function title(s){ return (s||"").replace(/-/g," ").replace(/\b\w/g,m=>m.toUpperCase()); }
  function nice(s){ return (s||"").replace(/[-_]/g," ").replace(/\b\w/g,m=>m.toUpperCase()); }
})();
=======
ï»¿<PASTE THE NEW JS FROM MY LAST MESSAGE HERE>
>>>>>>> Stashed changes

// ship 2025-10-13T12:29:25

// ship 2025-10-13T12:30:22
</script>
</body>
</html>



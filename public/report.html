<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store, max-age=0, must-revalidate" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Virtual Coach AI ‚Äî Report</title>
  <style>
    :root{
      --bg: #071c10; --ink:#ecf3f7; --muted:#cfe0e6; --border:rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    body{margin:0;background:#071c10;color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;}
    .wrap{width:min(1100px,94%);margin:18px auto}
    .card{background:rgba(10,18,24,.35);border:1px solid var(--border);border-radius:14px;padding:16px}
    .vcai-toolbar{
      position: sticky; top: 0; z-index: 10;
      display:flex; gap:.5rem; align-items:center; padding:.6rem .75rem;
      background: rgba(0,0,0,.55); backdrop-filter: blur(6px);
      border-bottom:1px solid var(--border);
      color:#eaf3ee; font:14px/1.4 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;
    }
    .btn{
      border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.08);
      color:#fff; padding:.45rem .6rem; border-radius:10px; cursor:pointer;
    }
    .btn:hover{ filter:brightness(1.05); }
    .vcai-muted{ color:#cbd5ce; }
    .vcai-expect{
      margin:12px 0; padding:.9rem; border-radius:12px;
      border:1px solid var(--border); background:rgba(0,0,0,.35);
      white-space:pre-wrap;
    }
    .kv{display:grid;grid-template-columns: 160px 1fr; gap:6px 14px; margin-top:8px;}
    .kv .k{color:#cbd5ce}
    .kv .v{color:#f2f7f4;overflow-wrap:anywhere}
    .hint{font-size:12px;color:#cbd5ce;margin-top:6px}
  </style>
</head>
<body>
  <div class="vcai-toolbar" id="vcai-baseline-toolbar">
    <button class="btn" id="vcai-set-baseline">Set as Baseline</button>
    <button class="btn" id="vcai-compare" disabled>Compare to Baseline</button>
    <button class="btn" id="vcai-clear" disabled>Clear Baseline</button>
    <span class="vcai-muted" id="vcai-base-info">(no baseline yet)</span>
  </div>

  <main class="wrap">
    <section class="card">
      <h3>Report</h3>
      <div class="kv">
        <div class="k">Key</div><div class="v" id="kv-key">‚Äî</div>
        <div class="k">Compare</div><div class="v" id="kv-compare">‚Äî</div>
        <div class="k">Teacher voice</div><div class="v" id="kv-coach">‚Äî</div>
        <div class="k">Height (in)</div><div class="v" id="kv-height">‚Äî</div>
        <div class="k">Name</div><div class="v" id="kv-name">‚Äî</div>
        <div class="k">Email</div><div class="v" id="kv-email">‚Äî</div>
        <div class="k">Handed</div><div class="v" id="kv-hand">‚Äî</div>
        <div class="k">Eye</div><div class="v" id="kv-eye">‚Äî</div>
        <div class="k">Handicap</div><div class="v" id="kv-hcp">‚Äî</div>
      </div>

      <div class="vcai-expect" id="vcai-expect" hidden></div>
      <div class="hint">Tip: ‚ÄúCompare to Baseline‚Äù will reload this page with <code>?compare=&lt;baselineKey&gt;</code>. Use a side-by-side viewer if you have one; otherwise open your baseline in a new tab for A/B review.</div>
    </section>
  </main>

  <script>
  (function(){
    const qs = new URLSearchParams(location.search);
    const current = {
      key: qs.get("key") || "",
      coach: qs.get("coach") || "supportive",
      height: qs.get("h") || "",
      name: qs.get("name") || "",
      email: qs.get("email") || "",
      hand: qs.get("hand") || "Right",
      eye: qs.get("eye") || "Unknown",
      hcp: qs.get("hcp") || "",
      baselineFlag: qs.get("baseline") === "1",
      compare: qs.get("compare") || ""
    };

    // Populate KV
    function set(id, val){ const el = document.getElementById(id); if (el) el.textContent = val || "‚Äî"; }
    set("kv-key", current.key);
    set("kv-compare", current.compare || "‚Äî");
    set("kv-coach", current.coach);
    set("kv-height", current.height);
    set("kv-name", current.name);
    set("kv-email", current.email);
    set("kv-hand", current.hand);
    set("kv-eye", current.eye);
    set("kv-hcp", current.hcp);

    // Baseline storage in this browser
    const LSKEY = "vcai.baseline";
    function getBaseline(){
      try { return JSON.parse(localStorage.getItem(LSKEY) || "null"); } catch(_){ return null; }
    }
    function setBaseline(obj){ localStorage.setItem(LSKEY, JSON.stringify(obj)); }
    function clearBaseline(){ localStorage.removeItem(LSKEY); }

    const setBtn = document.getElementById("vcai-set-baseline");
    const cmpBtn = document.getElementById("vcai-compare");
    const clrBtn = document.getElementById("vcai-clear");
    const infoEl = document.getElementById("vcai-base-info");
    const expectEl = document.getElementById("vcai-expect");

    function refreshUI(){
      const base = getBaseline();
      if (base && base.key){
        cmpBtn.disabled = false;
        clrBtn.disabled = false;
        infoEl.textContent = `Baseline: ${base.label || base.key}`;
      } else {
        cmpBtn.disabled = true;
        clrBtn.disabled = true;
        infoEl.textContent = "(no baseline yet)";
      }
    }

    // Auto-set when arriving with ?baseline=1
    if (current.key && current.baselineFlag) {
      const label = current.name ? `${current.name} ‚Ä¢ ${current.key}` : current.key;
      setBaseline({ key: current.key, label, meta: current });
    }

    setBtn.addEventListener("click", () => {
      if (!current.key) return alert("No report key in URL.");
      const label = current.name ? `${current.name} ‚Ä¢ ${current.key}` : current.key;
      setBaseline({ key: current.key, label, meta: current });
      refreshUI();
      alert("Baseline saved in this browser.");
    });

    clrBtn.addEventListener("click", () => {
      clearBaseline();
      refreshUI();
    });

    cmpBtn.addEventListener("click", () => {
      const base = getBaseline();
      if (!base || !base.key) return;
      const next = new URLSearchParams(location.search);
      next.set("compare", base.key);
      location.href = `${location.pathname}?${next.toString()}`;
    });

    // ‚ÄúWhat to expect‚Äù card
    function whatToExpect(coach, hand, eye){
      const lines = [];
      lines.push("After a swing change, expect a short adjustment period‚Äîthis is normal.");
      lines.push("‚Ä¢ More arm rotation ‚Üí tends to pull / start left (RH golfer).");
      lines.push("‚Ä¢ Faster body rotation ‚Üí shallower AoA ‚Üí more thin or ground balls early.");
      lines.push("‚Ä¢ New release pattern ‚Üí face control can wobble for a few sessions.");

      let plan = "";
      switch (coach) {
        case "direct":
          plan = "Plan: 25 purposeful reps ‚Äî 10 slow-motion, 10 pause at P5, 5 at game speed. Judge only start line & strike; ignore distance.";
          break;
        case "grumpy":
          plan = "Plan: 3√ó10 with checkpoints. Film rep #1 & #10 each set. If strike degrades, slow down and reset feels.";
          break;
        case "tech":
          plan = "Plan: Track start-line dispersion (¬±¬∞) & low-point ahead of ball. If low-point trails, add 5 rehearsals with lead-side pressure at P6.";
          break;
        default:
          plan = "Plan: Be kind to yourself. Rehearse the new feel, then 3√ó8 balls focusing on clean contact and consistent start line.";
      }
      lines.push("");
      lines.push(plan);
      return lines.join("\n");
    }

    const expectTxt = whatToExpect(current.coach, current.hand, current.eye);
    if (expectTxt) {
      expectEl.hidden = false;
      expectEl.textContent = expectTxt;
    }

    refreshUI();
  })();
  </script>
</body>
</html>
<!-- pending badge -->
<span id="pending-note" style="display:none;margin-left:8px;padding:2px 8px;border-radius:12px;background:#645; color:#fff; font-size:.85rem;">
  LoadingÖ analysis pending
</span>

<!-- value placeholders (put these where the cards live) -->
<div id="sec-pos" style="display:none"></div>
<div id="sec-swing" style="display:none"></div>
<div id="sec-power" style="display:none"></div>
<ul id="list-fundamentals"></ul>
<ul id="list-power-errors"></ul>
<ul id="list-quick-fixes"></ul>
<ul id="list-faults"></ul>
<ul id="list-drills"></ul>
<ul id="list-expectations"></ul>
<div id="baseline-cta" style="display:none;margin-top:6px;">
  <em>Tip:</em> Set a baseline swing to compare future rounds.
</div>
<script>
(function () {
  const $ = s => document.querySelector(s);
  const ui = {
    badgeSwings: $('#badge-swings'),
    pending: $('#pending-note')
  };
  const ids = {
    pos: '#sec-pos', swing: '#sec-swing', power: '#sec-power',
    fundamentals: '#list-fundamentals', powerErrors: '#list-power-errors',
    quickFixes: '#list-quick-fixes', faults: '#list-faults',
    drills: '#list-drills', expectations: '#list-expectations', baselineCta: '#baseline-cta'
  };

  function show(el, yes = true) {
    const node = typeof el === 'string' ? $(el) : el;
    if (!node) return;
    node.style.display = yes ? '' : 'none';
  }
  function text(el, t) {
    const node = typeof el === 'string' ? $(el) : el;
    if (!node) return;
    node.textContent = t;
    show(node, true);
  }
  function fillList(sel, arr = []) {
    const node = $(sel);
    if (!node) return;
    node.innerHTML = arr.map(i => `<li>${i}</li>`).join('');
  }

  const params = new URLSearchParams(location.search);
  const key = params.get('key');
  const demo = params.get('demo');

  async function fetchReport() {
    const url = demo === '1' ? '/api/report?demo=1'
                             : `/api/report?key=${encodeURIComponent(key)}`;
    const res = await fetch(url, { cache: 'no-store' });
    if (res.status === 404) return null;
    if (!res.ok) throw new Error(`Report API ${res.status}`);
    return await res.json();
  }

  function render(r) {
    if (ui.pending) ui.pending.style.display = 'none';
    if (ui.badgeSwings && r?.meta?.swings) ui.badgeSwings.textContent = `Swings: ${r.meta.swings}`;

    text(ids.pos, `${r?.scores?.positionConsistency ?? '--'} / 100`);
    text(ids.swing, `${r?.scores?.swingConsistency ?? '--'} / 100`);
    text(ids.power, `${r?.scores?.powerScore ?? '--'} / 100`);

    fillList(ids.fundamentals, r.fundamentals);
    fillList(ids.powerErrors, r.powerErrors);
    fillList(ids.quickFixes, r.quickFixes);
    fillList(ids.faults, r.faults);
    fillList(ids.drills, r.drills);
    fillList(ids.expectations, r.expectations);

    show(ids.baselineCta, !(r?.baseline?.hasBaseline));
  }

  async function init() {
    if (!key && demo !== '1') {
      alert('Missing ?key=Ö in the URL');
      return;
    }
    if (ui.pending) ui.pending.style.display = 'inline-block';

    const start = Date.now();
    while (true) {
      try {
        const data = await fetchReport();
        if (data) { render(data); return; }
      } catch (e) {
        console.warn(e);
        if (ui.pending) ui.pending.style.display = 'none';
        alert('Problem loading the report.');
        return;
      }
      if (Date.now() - start > 60000) {
        if (ui.pending) ui.pending.style.display = 'none';
        alert('Analysis still processing. Check back soon.');
        return;
      }
      await new Promise(r => setTimeout(r, 5000));
    }
  }
  init();
})();
</script>

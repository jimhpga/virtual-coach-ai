<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Virtual Coach AI — Swing Report</title>
<link rel="stylesheet" href="/styles.css" />
<style>
  :root{ --card-bg: rgba(255,255,255,.035); }
  .wrap { max-width: 1100px; margin: 0 auto; padding: 20px; }
  .pill { background:#0f1b22;border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-weight:700 }
  .meta-row { display:flex; flex-wrap:wrap; gap:8px; align-items:center }
  .card { background:var(--card-bg); border:1px solid var(--line); border-radius:14px; padding:12px; box-shadow:0 6px 14px rgba(0,0,0,.25); }
  .card h3 { margin: 0 0 10px; }
  .muted { color: var(--muted); }
  .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
  .grid3 { display:grid; grid-template-columns: repeat(3, 1fr); gap:14px; }
  .bar { height:8px; border-radius:999px; background:#0f1b22; border:1px solid var(--line); overflow:hidden; }
  .bar > i { display:block; height:100%; width:0%; background:var(--accent, #4ad0ff); transition: width .4s ease; }
  .pill-tiny { font-size: 12px; padding: 3px 8px; border-radius: 999px; border:1px solid var(--line); background:#0f1b22 }
  .section-title { display:flex; align-items:center; justify-content:space-between; margin:0 0 8px; }

  /* ---------- P1–P9 cards ---------- */
  .pcol { display:grid; grid-template-columns: 1fr; gap:14px; } /* vertical stack */
  .p-card { background:var(--card-bg); border:1px solid var(--line); border-radius:14px; padding:12px; box-shadow:0 6px 14px rgba(0,0,0,.25); }
  .p-card h4 { margin:0 0 6px; font-size:16px }
  .p-card .short { color:var(--muted); margin-bottom:8px }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  .btn-sm { border:1px solid var(--line); padding:6px 10px; border-radius:8px; background:#0f1b22; color:#fff; text-decoration:none; cursor:pointer }
  .btn-sm:hover { background:#122734 }

  details.p-long { margin-top:6px }
  details.p-long summary { cursor:pointer; list-style:none; display:flex; align-items:center; gap:6px; }
  details.p-long summary::-webkit-details-marker{ display:none }
  .caret { display:inline-block; transform: rotate(0deg); transition: transform .2s ease; }
  details[open].p-long .caret { transform: rotate(90deg); }

  .accordion { border:1px solid var(--line); border-radius:14px; overflow:hidden }
  .ac-head { background:var(--card-bg); padding:10px 12px; display:flex; align-items:center; justify-content:space-between; cursor:pointer }
  .ac-body { padding:12px; display:none }
  .ac-open .ac-body { display:block }
  .ac-open .caret { transform: rotate(90deg); }

  /* color coding helpers (green/yellow/red/gray) */
  .ok      { box-shadow: 0 0 0 1px #224a2b inset; }
  .good    { box-shadow: 0 0 0 1px #29693a inset; }
  .warn    { box-shadow: 0 0 0 1px #6d5e2a inset; }
  .bad     { box-shadow: 0 0 0 1px #6b2a2a inset; }
  .neutral { box-shadow: 0 0 0 1px var(--line) inset; }

  @media (max-width: 900px) {
    .grid3 { grid-template-columns: 1fr; }
    .grid2 { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<header class="site">
  <div class="navwrap">
    <a class="brand" href="/"><img src="/virtualcoach-logo-transparent.png" alt="Virtual Coach AI"><span>Virtual Coach AI</span></a>
    <nav aria-label="Primary">
      <a href="/">Home</a>
      <a href="/upload">Upload</a>
      <a href="/reports">Reports</a>
      <a href="/coming-soon">Coming&nbsp;Soon</a>
      <a href="/pricing">Pricing</a>
      <a href="/faq">FAQ</a>
      <a href="/contact">Contact</a>
      <a href="/about">About</a>
    </nav>
  </div>
</header>

<div class="scrim">
  <main class="wrap" id="app">
    <h1 style="margin-bottom:6px">Swing Report — P1–P9</h1>
    <div class="meta-row muted" id="metaRow"></div>

    <!-- SUMMARY STRIP -->
    <section class="grid3" style="margin-top:14px">
      <div class="card">
        <div class="section-title"><h3>Coaching Card</h3></div>
        <div class="grid2">
          <div>
            <div class="muted" style="font-weight:700; margin-bottom:6px">Top 3 Priority Fixes</div>
            <div id="topPriority"></div>
          </div>
          <div>
            <div class="muted" style="font-weight:700; margin-bottom:6px">Top 3 Power Fixes</div>
            <div id="topPower"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="section-title"><h3>Power Score Summary</h3></div>
        <div class="grid2">
          <div>
            <div class="muted">Power Score</div>
            <div class="bar"><i id="barScore"></i></div>
            <div class="muted" id="txtScore" style="margin-top:4px">—</div>
          </div>
          <div>
            <div class="muted">Release Timing</div>
            <div class="bar"><i id="barRelease"></i></div>
            <div class="muted" id="txtRelease" style="margin-top:4px">—</div>
          </div>
        </div>
        <div style="margin-top:8px">
          <span class="muted">Tempo</span>
          <div class="muted" id="txtTempo">—</div>
        </div>
      </div>

      <div class="card">
        <div class="section-title"><h3>Consistency</h3></div>
        <div class="grid2">
          <div>
            <div class="muted" style="font-weight:700; margin-bottom:6px">Position Consistency</div>
            <div id="posConsistency" class="muted">—</div>
          </div>
          <div>
            <div class="muted" style="font-weight:700; margin-bottom:6px">Swing Consistency</div>
            <div id="swingConsistency" class="muted">—</div>
          </div>
        </div>
      </div>
    </section>

    <!-- PRACTICE PLAN -->
    <section style="margin-top:14px">
      <div class="accordion" id="planAcc">
        <div class="ac-head" role="button" tabindex="0">
          <div style="display:flex; gap:10px; align-items:center">
            <span class="caret">▶</span>
            <h3 style="margin:0">Practice Plan (14 days)</h3>
          </div>
          <span class="pill-tiny" id="planCount">0 items</span>
        </div>
        <div class="ac-body">
          <div id="planList"></div>
        </div>
      </div>
    </section>

    <!-- P1–P9 -->
    <section style="margin-top:14px">
      <h2 style="margin:0 0 8px">P1–P9</h2>
      <div class="pcol" id="pGrid"></div>
      <div class="muted" id="pGridEmpty" style="margin-top:8px"></div>
    </section>

    <!-- Note -->
    <section id="noteBox" class="card" style="margin-top:14px; display:none">
      <h3 style="margin:0 0 8px">Note</h3>
      <div id="noteTxt" class="muted"></div>
    </section>
  </main>
</div>

<script>
/* ----------- CONFIG ----------- */
const BLOB_PUBLIC_BASE =
  (window.BLOB_PUBLIC_BASE || "https://yw0bpv5czlbqowjq.public.blob.vercel-storage.com").replace(/\/+$/,'');

/* ----------- helpers ----------- */
const $ = s => document.querySelector(s);
const qp = new URLSearchParams(location.search);
const rid = qp.get('id');
const directUrl = qp.get('url');

const blobFromId = id => `${BLOB_PUBLIC_BASE}/reports/${encodeURIComponent(id)}.json?cb=${Date.now()}`;

function pct(n){ n = Number(n); return Number.isFinite(n) ? Math.max(0,Math.min(100,n)) : 0; }
async function fetchJson(url){
  const res = await fetch(url,{cache:'no-store'});
  if(!res.ok) throw new Error(`Fetch ${res.status} for ${url}`);
  const txt = await res.text();
  return JSON.parse(txt.trim().replace(/^\uFEFF/, ''));
}
function li(text){ const d=document.createElement('div'); d.textContent = '• ' + text; return d; }
const youTube = name => `https://www.youtube.com/results?search_query=${encodeURIComponent(name + ' golf checkpoint')}`;

/* ----------- “enrichment” for longer P1–P9 text ----------- */
/* If a report doesn’t include a long explanation, we build one
   from the phase id/name + short text and add actionable cues. */
function enrichLong(id, name, short){
  const add = (lines) => lines.filter(Boolean).join(' ');
  switch((id||'').toUpperCase()){
    case 'P1': return add([
      short,
      'Checklist: athletic posture; weight centered; neutral grip; eyes over ball; relaxed forearms.',
      'Goal: stable base with light pressure under arches of both feet; 55/45 pressure lead/trail.'
    ]);
    case 'P2': return add([
      short,
      'Keys: one-piece takeaway to thigh-high; clubface square; wrists soft.',
      'Drill: alignment stick across hips—turn to move stick, not hands.'
    ]);
    case 'P3': return add([
      short,
      'Cue: lead arm parallel; trail elbow stays below lead arm; width maintained.',
      'Drill: “stretch the towel”—feel diameter of the circle increase.'
    ]);
    case 'P4': return add([
      short,
      'Checkpoint: hands over trail shoulder; lead wrist flat/bowed; face not flared open.',
      'Drill: pause at the top for 1s, then swing—groove structure.'
    ]);
    case 'P5': return add([
      short,
      'Move: shallow shaft; hands moving down while club head “hangs”; chest still turning.',
      'Drill: slow-motion pumps to P5 then stop—repeat 5x and hit.'
    ]);
    case 'P6': return add([
      short,
      'Checkpoint: club parallel to ground; handle ahead of club head; hips open ~30–45°.',
      'Drill: gate 4–5 inches ahead of ball; brush inside-to-square.'
    ]);
    case 'P7': return add([
      short,
      'Impact intent: forward shaft lean; lowest point ahead; face square with stable handle.',
      'Drill: impact line—paint a line ahead; brush it each time.'
    ]);
    case 'P8': return add([
      short,
      'Post-impact: arms extend, chest rotates; face passive; trail foot banking (not spinning).',
      'Drill: hold finish 2s—match chest and trail shoe laces to target.'
    ]);
    case 'P9': return add([
      short,
      'Finish: balanced and tall; belt buckle to target; pressure predominantly on lead side.',
      'Drill: “pose” finish for 3s after every ball in practice.'
    ]);
    default: return add([short,'Details: maintain structure and tempo; film from face-on & DTL to verify.']);
  }
}
function gradeClass(grade=''){
  const g = String(grade).toLowerCase();
  if (/(great|excellent|good|ok)/.test(g)) return g.includes('good') ? 'good' : (g.includes('ok') ? 'ok' : 'good');
  if (/(warn|needs|help|work)/.test(g)) return 'warn';
  if (/(bad|poor|fix|broken|critical)/.test(g)) return 'bad';
  return 'neutral';
}

/* ----------- UI fill ----------- */
function fillMeta(data){
  const row = $('#metaRow'); row.innerHTML='';
  const pills = [
    ['Score', (data.swingScore ?? data.score ?? '—')],
    ['Status', (data.status ?? '—')],
    ['Tempo', (data.power?.tempo ?? '—')],
    ['Release', (data.power?.release_timing != null ? (data.power.release_timing + '%') : '—')],
  ];
  for (const [k,v] of pills){
    const s = document.createElement('span'); s.className='pill'; s.textContent = `${k}: ${v}`; row.appendChild(s);
  }
  const created = document.createElement('span'); created.className='muted'; created.style.marginLeft='8px';
  created.textContent = `Created: ${new Date().toLocaleString()}`; row.appendChild(created);
}
function setBars(data){
  const score = pct(data.power?.score ?? data.swingScore);
  $('#barScore').style.width = score + '%'; $('#txtScore').textContent = `${score || 0}%`;
  const rel = pct(data.power?.release_timing); $('#barRelease').style.width = rel + '%'; $('#txtRelease').textContent = `${rel || 0}%`;
  $('#txtTempo').textContent = data.power?.tempo ?? '—';
}
function setConsistency(data){
  $('#posConsistency').textContent   = data.positionConsistency?.notes ?? data.position_consistency?.notes ?? '—';
  $('#swingConsistency').textContent = data.swingConsistency?.notes    ?? data.swing_consistency?.notes    ?? '—';
}
function setCoachingCard(data){
  const pri = (data.topPriorityFixes || data.top_priority_fixes || []).slice(0,3);
  const pow = (data.topPowerFixes    || data.top_power_fixes    || []).slice(0,3);
  const priBox = $('#topPriority'); const powBox = $('#topPower'); priBox.innerHTML=''; powBox.innerHTML='';
  if (!pri.length) priBox.appendChild(li('—')); else pri.forEach(x=>priBox.appendChild(li(String(x))));
  if (!pow.length) powBox.appendChild(li('—')); else pow.forEach(x=>powBox.appendChild(li(String(x))));
}

function renderPGrid(data){
  const list = Array.isArray(data.p1p9 || data.phases) ? (data.p1p9 || data.phases) : [];
  const grid = $('#pGrid'); grid.innerHTML = ''; const empty = $('#pGridEmpty'); empty.textContent='';
  if (!list.length){ empty.textContent='No P1–P9 items in this report.'; return; }

  list.forEach((p,i)=>{
    const id    = p.id || `P${i+1}`;
    const name  = p.name || p.title || id;
    const grade = p.grade || '';
    const short = p.short || p.note || '—';
    const long  = p.long  || p.details || enrichLong(id, name, short);
    const video = p.video || youTube(name);

    const card = document.createElement('div');
    card.className = `p-card ${gradeClass(grade)}`;

    const head = document.createElement('div');
    head.style.display = 'flex'; head.style.alignItems = 'center'; head.style.justifyContent = 'space-between'; head.style.gap='8px';

    const h4 = document.createElement('h4'); h4.textContent = `${id}. ${name}`; head.appendChild(h4);

    const g = document.createElement('span'); g.className='pill-tiny'; g.textContent = grade ? `grade: ${grade}` : 'grade: —';
    head.appendChild(g);
    card.appendChild(head);

    const s = document.createElement('div'); s.className='short'; s.textContent = short; card.appendChild(s);

    const row = document.createElement('div'); row.className='row';
    const aWatch = document.createElement('a'); aWatch.className='btn-sm'; aWatch.target='_blank'; aWatch.href=video; aWatch.textContent='Watch';
    row.appendChild(aWatch); card.appendChild(row);

    const det = document.createElement('details'); det.className='p-long';
    const sum = document.createElement('summary'); const caret = document.createElement('span'); caret.className='caret'; caret.textContent='▶';
    sum.appendChild(caret); sum.append(' Details'); det.appendChild(sum);
    const body = document.createElement('div'); body.style.marginTop='8px'; body.textContent = long; det.appendChild(body);
    card.appendChild(det);

    grid.appendChild(card);
  });
}

function setPracticePlan(data){
  const list = data.practicePlan || data.practice_plan || [];
  const root = $('#planAcc'); const count = $('#planCount'); const out  = $('#planList'); out.innerHTML='';
  count.textContent = `${list.length} items`;
  if(!list.length) { out.innerHTML = '<div class="muted">No plan found.</div>'; }
  else {
    const ul = document.createElement('ul');
    list.forEach(it=>{
      const li = document.createElement('li');
      const d = it.day!=null ? `Day ${it.day}: ` : '';
      const title = it.title || it.name || '';
      const items = Array.isArray(it.items)? ` — ${it.items.join('; ')}` : '';
      li.textContent = `${d}${title}${items}`; ul.appendChild(li);
    });
    out.appendChild(ul);
  }
  const head = root.querySelector('.ac-head');
  head.onclick = () => root.classList.toggle('ac-open');
  head.onkeydown = (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); root.classList.toggle('ac-open'); }};
}
function setNote(data){
  const n = (data.note || '').trim(); if(!n){ $('#noteBox').style.display='none'; return; }
  $('#noteTxt').textContent = n; $('#noteBox').style.display='';
}

function renderAll(data){
  fillMeta(data); setBars(data); setConsistency(data); setCoachingCard(data);
  renderPGrid(data); setPracticePlan(data); setNote(data);
}

/* ----------- boot ----------- */
(async ()=>{
  try{
    let url = directUrl ? directUrl : (rid ? blobFromId(rid) : null);
    if(!url){
      const raw = sessionStorage.getItem('vc_report') || localStorage.getItem('vc_last_report');
      if(!raw) throw new Error('Missing ?url or ?id. Use upload flow or reports page.');
      renderAll(JSON.parse(raw.trim().replace(/^\uFEFF/,'')));
      return;
    }
    const data = await fetchJson(url);
    renderAll(data);
  }catch(err){
    alert(err?.message || String(err));
  }
})();
</script>
</body>
</html>

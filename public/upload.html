<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Upload • Virtual Coach AI</title>
<link rel="stylesheet" href="/styles.css" />
<body>
  <header class="site">
    <div class="navwrap">
      <a class="brand" href="/"><img src="/virtualcoach-logo-transparent.png" alt="Virtual Coach AI"><span>Virtual Coach AI</span></a>
      <nav aria-label="Primary">
        <a href="/">Home</a>
        <a href="/upload" aria-current="page">Upload</a>
        <a href="/reports">Reports</a>
        <a href="/coming-soon">Coming&nbsp;Soon</a>
        <a href="/pricing">Pricing</a>
        <a href="/faq">FAQ</a>
        <a href="/contact">Contact</a>
        <a href="/about">About</a>
      </nav>
    </div>
  </header>

  <div class="scrim">
    <main class="wrap">
      <h1>Upload Your Swing</h1>

      <section class="card">
        <div class="grid2" style="align-items:flex-end">
          <div>
            <label class="field"><span>Name (optional)</span><input id="name" placeholder="Your name" /></label>
            <label class="field"><span>Email (optional)</span><input id="email" type="email" placeholder="you@example.com" /></label>
            <label class="field"><span>Handicap (optional)</span><input id="handicap" placeholder="e.g. 10" /></label>
            <label class="field"><span>Hand (optional)</span>
              <select id="handed"><option value="">—</option><option>right</option><option>left</option></select>
            </label>
            <label class="field"><span>Eye dominance (optional)</span>
              <select id="eye"><option value="">—</option><option>right</option><option>left</option></select>
            </label>
            <label class="field"><span>Height in inches *</span><input id="height" inputmode="numeric" placeholder="e.g. 70" /></label>
          </div>

          <div>
            <label class="field">
              <span>Video *</span>
              <input id="file" type="file" accept="video/*" />
            </label>
            <button id="uploadBtn" class="btn primary" type="button" style="margin-top:10px">Upload & Analyze</button>
          </div>
        </div>

        <pre id="log" class="muted" style="margin-top:12px;white-space:pre-wrap"></pre>
      </section>
    </main>
  </div>

  <style>
    .field{display:block;margin:6px 0}
    .field>span{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
    input,select{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.06);color:#fff}
  </style>

  <script>
  (function(){
    const $ = s => document.querySelector(s);
    const el = {
      name: $("#name"), email: $("#email"), hcap: $("#handicap"),
      handed: $("#handed"), eye: $("#eye"), height: $("#height"),
      file: $("#file"), btn: $("#uploadBtn"), log: $("#log")
    };
    const log = m => { el.log.textContent += (el.log.textContent ? "\n" : "") + m; el.log.scrollTop = el.log.scrollHeight; };
    const showErr = (e) => {
      const msg = (typeof e === "string") ? e : (e?.message || JSON.stringify(e));
      log("Error: " + msg);
    };
    const busy = on => {
      el.btn.disabled = on; el.file.disabled = on;
      [el.name, el.email, el.hcap, el.handed, el.eye, el.height].forEach(x=>x.disabled = on);
    };
    const readForm = () => ({
      name: (el.name.value||"").trim(),
      email: (el.email.value||"").trim(),
      hcap: (el.hcap.value||"").trim(),
      handed: (el.handed.value||"").trim(),
      eye: (el.eye.value||"").trim(),
      height: (el.height.value||"").trim(),
    });
    const validateHeight = h => {
      if (!h) return "Height is required.";
      const n = Number(h); if (!Number.isFinite(n)) return "Height must be a number.";
      if (n < 48 || n > 84) return "Height should be between 48 and 84 inches.";
      return "";
    };

    el.btn.addEventListener("click", async (e) => {
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();

      const file = el.file.files?.[0];
      if (!file) return log("Pick a video first.");

      const meta = readForm();
      const err = validateHeight(meta.height);
      if (err) return showErr(err);

      busy(true);
      try {
        log("Requesting Mux upload URL…");
        const r1 = await fetch("/api/mux-direct-upload", { method: "POST" });
        let j1; try { j1 = await r1.json(); } catch{}
        if (!r1.ok || !j1?.upload?.url) {
          throw new Error(`mux-direct-upload failed (${r1.status}): ${JSON.stringify(j1)}`);
        }

        log("Uploading to Mux (this can take a minute)...");
        const r2 = await fetch(j1.upload.url, { method: "PUT", body: file });
        if (!r2.ok) {
          const t = await r2.text();
          throw new Error(`Mux upload failed (${r2.status}): ${t.slice(0,180)}`);
        }

        log("Saving report JSON…");
        const r3 = await fetch("/api/save-report", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({
            status: "ready",
            swingScore: 80,
            muxPlaybackId: null,
            muxUploadId: j1.upload.id,
            p1p9: [],
            faults: [],
            note: `uploaded ${file.name}`,
            meta
          })
        });

        const ct = (r3.headers.get("content-type") || "").toLowerCase();
        const rep = ct.includes("json") ? await r3.json() : { errorText: await r3.text() };
        if (!r3.ok || (!rep?.url && !rep?.id)) {
          throw new Error(`save-report failed (${r3.status}): ${JSON.stringify(rep).slice(0,200)}`);
        }

        log("Opening report…");
        if (rep.url) location.assign(`/report.html?url=${encodeURIComponent(rep.url)}`);
        else         location.assign(`/report.html?id=${encodeURIComponent(rep.id)}`);
      } catch (e) {
        showErr(e);
        busy(false);
      }
    });
  })();
  </script>
</body>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Upload • Virtual Coach AI</title>
<link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <!-- Header -->
  <header class="site">
    <div class="navwrap">
      <a class="brand" href="/"><img src="/virtualcoach-logo-transparent.png" alt="Virtual Coach AI"><span>Virtual Coach AI</span></a>
      <nav aria-label="Primary">
        <a href="/">Home</a>
        <a href="/upload" aria-current="page">Upload</a>
        <a href="/reports">Reports</a>
        <a href="/coming-soon">Coming&nbsp;Soon</a>
        <a href="/pricing">Pricing</a>
        <a href="/faq">FAQ</a>
        <a href="/contact">Contact</a>
        <a href="/about">About</a>
      </nav>
    </div>
  </header>

  <div class="scrim">
    <main class="wrap">
      <h1>Upload a swing</h1>
      <section class="card">
        <label class="sub" for="file">Video file</label><br/>
        <input id="file" type="file" accept="video/*" />
        <div style="margin-top:10px">
          <button id="uploadBtn" class="btn primary" type="button">Upload & Analyze</button>
        </div>
        <pre id="log" class="sub" style="margin-top:10px;white-space:pre-wrap"></pre>
      </section>
    </main>
  </div>

  <!-- Inline client (Mux flow) -->
  <script>
  (function () {
    const $ = s => document.querySelector(s);
    const file = $("#file");
    const btn  = $("#uploadBtn");
    const logEl = $("#log");
    const log = m => { logEl.textContent += (logEl.textContent ? "\\n" : "") + m; };

    btn.addEventListener("click", async (e) => {
      e.preventDefault();
      const f = file.files?.[0];
      if (!f) return log("Pick a video first.");

      try {
        log("Requesting Mux upload URL…");
        const r1 = await fetch("/api/mux-direct-upload", { method: "POST" });
        const j1 = await r1.json().catch(() => ({}));
        const up = j1?.upload;
        if (!r1.ok || !up?.url) throw new Error(`Mux upload URL missing (${r1.status})`);

        log("Uploading to Mux…");
        const r2 = await fetch(up.url, { method: "PUT", body: f });
        if (!r2.ok) throw new Error(`Mux upload failed (${r2.status})`);

        log("Saving report JSON…");
        const r3 = await fetch("/api/save-report", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({
            status: "ready", swingScore: 80,
            muxPlaybackId: null, muxUploadId: up.id,
            p1p9: [], faults: [], note: `uploaded ${f.name}`
          })
        });

        let rep;
        const ct = (r3.headers.get("content-type") || "").toLowerCase();
        if (ct.includes("application/json")) rep = await r3.json();
        else throw new Error(`save-report returned non-JSON (${r3.status})`);

        if (!r3.ok || (!rep?.id && !rep?.url)) throw new Error(`Report save failed (${r3.status})`);

        if (rep.url) location.assign(`/report.html?url=${encodeURIComponent(rep.url)}`);
        else         location.assign(`/report.html?id=${encodeURIComponent(rep.id)}`);
      } catch (err) {
        log("Error: " + (err?.message || err));
      }
    });
  })();
  </script>
</body>
</html>

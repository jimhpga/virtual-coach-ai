<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Upload • Virtual Coach AI</title>
<link rel="stylesheet" href="/styles.css" />
<body>
  <!-- Header -->
  <header class="site">
    <div class="navwrap">
      <a class="brand" href="/"><img src="/virtualcoach-logo-transparent.png" alt="Virtual Coach AI"><span>Virtual Coach AI</span></a>
      <nav aria-label="Primary">
        <a href="/">Home</a>
        <a href="/upload" aria-current="page">Upload</a>
        <a href="/reports">Reports</a>
        <a href="/coming-soon">Coming&nbsp;Soon</a>
        <a href="/pricing">Pricing</a>
        <a href="/faq">FAQ</a>
        <a href="/contact">Contact</a>
        <a href="/about">About</a>
      </nav>
    </div>
  </header>

  <div class="scrim">
    <main class="wrap">
      <h1>Upload Your Swing</h1>

      <section class="card">
        <div class="grid2" style="align-items:flex-end">
          <div>
            <label class="field"><span>Name (optional)</span><input id="name" placeholder="Your name" /></label>
            <label class="field"><span>Email (optional)</span><input id="email" type="email" placeholder="you@example.com" /></label>
            <label class="field"><span>Handicap (optional)</span><input id="handicap" placeholder="e.g. 10" /></label>
            <label class="field"><span>Hand (optional)</span>
              <select id="handed"><option value="">—</option><option>right</option><option>left</option></select>
            </label>
            <label class="field"><span>Eye dominance (optional)</span>
              <select id="eye"><option value="">—</option><option>right</option><option>left</option></select>
            </label>
            <label class="field"><span>Height in inches *</span><input id="height" inputmode="numeric" placeholder="e.g. 70" /></label>
          </div>

          <div>
            <label class="field">
              <span>Video *</span>
              <input id="file" type="file" accept="video/*" />
            </label>
            <button id="uploadBtn" class="btn primary" type="button" style="margin-top:10px">Upload & Analyze</button>
          </div>
        </div>

        <pre id="log" class="muted" style="margin-top:12px;white-space:pre-wrap"></pre>
      </section>
    </main>
  </div>

  <style>
    .field{display:block;margin:6px 0}
    .field>span{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
    input,select{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.06);color:#fff}
  </style>

  <script>
  // Full flow: Mux upload -> LLM personalize -> Save to Blob -> Open viewer
  (function(){
    const $ = s => document.querySelector(s);
    const el = {
      name: $("#name"), email: $("#email"), hcap: $("#handicap"),
      handed: $("#handed"), eye: $("#eye"), height: $("#height"),
      file: $("#file"), btn: $("#uploadBtn"), log: $("#log")
    };
    const log = m => { el.log.textContent += (el.log.textContent ? "\n" : "") + m; el.log.scrollTop = el.log.scrollHeight; };
    const busy = on => {
      el.btn.disabled = on; el.file.disabled = on;
      [el.name, el.email, el.hcap, el.handed, el.eye, el.height].forEach(x=>x.disabled = on);
    };
    const readForm = () => ({
      name: (el.name.value||"").trim(),
      email: (el.email.value||"").trim(),
      hcap: (el.hcap.value||"").trim(),
      handed: (el.handed.value||"").trim(),
      eye: (el.eye.value||"").trim(),
      height: (el.height.value||"").trim(),
    });
    const validateHeight = h => {
      if (!h) return "Height is required.";
      const n = Number(h); if (!Number.isFinite(n)) return "Height must be a number.";
      if (n < 48 || n > 84) return "Height should be between 48 and 84 inches.";
      return "";
    };

    el.btn.addEventListener("click", async (e) => {
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();

      const file = el.file.files?.[0];
      if (!file) return log("Pick a video first.");

      const meta = readForm();
      const err = validateHeight(meta.height);
      if (err) return log("Error: " + err);

      busy(true);
      try {
        // 1) Mint Mux direct-upload URL
        log("Requesting Mux upload URL…");
        const r1 = await fetch("/api/mux-direct-upload", { method: "POST" });
        const j1 = await r1.json().catch(() => ({}));
        if (!r1.ok || !j1?.upload?.url) {
          throw new Error("mux-direct-upload failed (" + r1.status + "): " + (j1?.error || JSON.stringify(j1)));
        }

        // 2) Upload the file to Mux
        log("Uploading to Mux (this can take a minute)...");
        const r2 = await fetch(j1.upload.url, { method: "PUT", body: file });
        if (!r2.ok) throw new Error("Mux upload failed (" + r2.status + ")");

        // 3) Ask the LLM for personalized content
        log("Personalizing report with pro patterns…");
        let gen = null;
        try {
          const rGen = await fetch("/api/generate-report-llm", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify({
              meta,
              filename: file.name,
              observations: {
                // place for future auto-detected notes
              }
            })
          });
          gen = await rGen.json();
          if (!rGen.ok) throw new Error(gen?.error || "generate-report-llm failed");
        } catch (e) {
          log("Warn: personalization failed, using defaults. " + (e?.message || e));
          gen = null;
        }

        // 4) Save final report JSON to Blob
        log("Saving report JSON…");
        const r3 = await fetch("/api/save-report", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({
            status: "ready",
            swingScore: (gen?.power?.score ?? 80),
            muxPlaybackId: null,
            muxUploadId: j1.upload.id,       // resolved later by a poller if you add one
            // --- personalized sections ---
            p1p9: gen?.p1p9 ?? [],
            faults: [],                       // keep if you use a faults table elsewhere
            note: `uploaded ${file.name}`,
            power: gen?.power ?? { score: 74, tempo: "3:1", release_timing: 68 },
            positionConsistency: gen?.position_consistency ?? { notes: "—" },
            swingConsistency: gen?.swing_consistency ?? { notes: "—" },
            topPriorityFixes: gen?.top_priority_fixes ?? [],
            topPowerFixes: gen?.top_power_fixes ?? [],
            practicePlan: gen?.practice_plan ?? [],
            meta
          })
        });

        // tolerant response handling
        let rep, ct = (r3.headers.get("content-type") || "").toLowerCase();
        if (ct.includes("application/json")) rep = await r3.json(); else {
          const txt = await r3.text(); throw new Error("save-report returned non-JSON ("+r3.status+"): " + txt.slice(0,200));
        }
        if (!r3.ok || (!rep?.url && !rep?.id)) throw new Error("Report save failed (" + r3.status + ")");

        // 5) Open the viewer — prefer ?url= for 100% load
        log("Opening report…");
        if (rep.url) {
          location.assign(`/report.html?url=${encodeURIComponent(rep.url)}`);
        } else {
          location.assign(`/report.html?id=${encodeURIComponent(rep.id)}`);
        }
      } catch (e) {
        log("Error: " + (e?.message || e));
        busy(false);
      }
    });
  })();
  </script>
</body>

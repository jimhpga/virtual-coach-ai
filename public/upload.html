<!doctype html>
<meta charset="utf-8" />
<title>S3 Upload Test</title>
<style>
  body { font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 24px; max-width: 720px; margin: auto; }
  h1 { margin: 0 0 12px; }
  .row { margin: 12px 0; }
  #log { white-space: pre-wrap; background:#111; color:#eee; padding:12px; border-radius:8px; min-height: 100px; }
  input[type=file] { display:block; }
  button { padding: 8px 12px; }
</style>
<h1>S3 Upload Test</h1>

<div class="row">
  <input id="file" type="file" accept="video/*,.mov,.mp4,.m4v,.mpg,.mpeg,.mp4" />
</div>
<div class="row">
  <button id="go" type="button">Upload</button>
</div>

<pre id="log"></pre>

<script>
const log = (...a) => {
  const el = document.getElementById('log');
  el.textContent += a.join(' ') + "\n";
  console.log(...a);
};

function qs(obj){ return new URLSearchParams(obj).toString(); }

async function run() {
  const input = document.getElementById('file');
  const f = input.files?.[0];
  if (!f) { log("Pick a file first."); return; }

  try {
    log("Starting?");

    const contentType = f.type || 'application/octet-stream';
    log("Requesting signed URL?");
    const pre = await fetch(`/api/s3-presign?${qs({ filename: f.name, contentType })}`, {
      headers: { 'Cache-Control': 'no-cache' }
    }).then(r => {
      if (!r.ok) throw new Error("presign failed " + r.status);
      return r.json();
    });

    log("Uploading to S3?");
    const putRes = await fetch(pre.url, { method: 'PUT', headers: { 'Content-Type': contentType }, body: f });
    if (!putRes.ok) throw new Error(`S3 PUT failed ${putRes.status}`);

    const publicUrl = `https://${pre.bucket}.s3.${pre.region}.amazonaws.com/${pre.key}`;
    log("Upload complete:");
    log(publicUrl);
  } catch (e) {
    log("ERROR:", e?.message || e);
  }
}

document.getElementById('go').addEventListener('click', run);
</script>
<!doctype html>
<meta charset="utf-8" />
<title>Upload • Virtual Coach AI</title>
<body style="font-family:system-ui;margin:2rem;max-width:820px">
  <h1>Upload Your Swing</h1>

  <!-- Minimal form (no required height field) -->
  <form id="upload-form">
    <input id="file" type="file" accept="video/*" />
    <!-- Make this a plain button so the form doesn't submit/reload -->
    <button id="uploadBtn" type="button">Upload & Analyze</button>
  </form>

  <pre id="log" style="margin-top:1rem;color:#555;white-space:pre-wrap"></pre>

  <script>
  // [upload mux INLINE v3] — Mux flow only, blocks legacy S3 handler, no height requirement
  (function () {
    console.log("[upload mux INLINE v3] client JS loaded");

    const $ = (s) => document.querySelector(s);
    const fileInput = $("#fileInput") || $("#file");
    const fileLabel = $("#fileLabel");
    const btn = $("#uploadBtn") || $("#submit") || document.querySelector('button[type="submit"]') || document.querySelector('button');
    const logEl = $("#log") || (() => { const d=document.createElement('pre'); d.id='log'; d.style="margin-top:1rem;color:#9aa"; document.body.appendChild(d); return d; })();

    const log  = (m) => { logEl.textContent += (logEl.textContent ? "\n" : "") + m; logEl.scrollTop = logEl.scrollHeight; };
    const busy = (on) => { if (btn) btn.disabled = on; if (fileInput) fileInput.disabled = on; };

    fileInput?.addEventListener("change", (e) => {
      const f = e.target.files?.[0];
      if (fileLabel) fileLabel.textContent = f ? `${f.name}` : "(no file)";
      if (f) log("Selected: " + f.name);
    });

    btn?.addEventListener("click", async (e) => {
      // Block any legacy handlers (old S3 script)
      e?.preventDefault?.();
      e?.stopPropagation?.();
      e?.stopImmediatePropagation?.();

      if (window.__uploadRunning) return;
      window.__uploadRunning = true;

      const file = fileInput?.files?.[0];
      if (!file) { log("Pick a video first."); window.__uploadRunning = false; return; }

      busy(true);
      try {
        log("Requesting Mux upload URL…");
        const r1 = await fetch("/api/mux-direct-upload", { method: "POST" });
        const j1 = await r1.json().catch(() => ({}));
        const upload = j1?.upload;
        if (!r1.ok || !upload?.url) throw new Error("Mux upload URL missing");

        log("Uploading to Mux (this can take a minute)...");
        const put = await fetch(upload.url, { method: "PUT", body: file });
        if (!put.ok) throw new Error(`Mux upload failed (${put.status})`);

        log("Saving report JSON…");
        const r2 = await fetch("/api/save-report", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({
            status: "ready",
            swingScore: 80,
            muxPlaybackId: null,   // resolved later by /api/resolve-mux
            muxUploadId: upload.id,
            p1p9: [],
            faults: [],
            note: `uploaded ${file.name}`
          })
        });
        const rep = await r2.json().catch(() => ({}));
        if (!r2.ok || !rep?.id) throw new Error("Report save failed");

        log("Opening report view…");
        location.assign(`/report?id=${encodeURIComponent(rep.id)}`);
      } catch (err) {
        log("Error: " + (err?.message || err));
        busy(false);
        window.__uploadRunning = false;
      }
    });
  })();
  </script>
</body>

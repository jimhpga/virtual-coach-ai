<!doctype html>
<meta charset="utf-8" />
<title>Upload</title>
<style>
  body { font: 16px/1.4 system-ui, sans-serif; max-width: 720px; margin: 40px auto; }
  #status { margin-top: 12px; white-space: pre-wrap; }
</style>
<h1>S3 Upload Test</h1>
<input id="file" type="file" />
<div id="status">Idle</div>

<script>
const API_BASE = ''; // if custom domain acts up, temporarily set to your Vercel URL.

async function runUploadFlow(file) {
  if (!file) throw new Error('No file selected');
  const qs = new URLSearchParams({
    filename: file.name,
    contentType: file.type || 'application/octet-stream'
  });

  const p = await fetch(`${API_BASE}/api/s3-presign?${qs}`);
  if (!p.ok) throw new Error(`presign failed ${p.status} ${await p.text()}`);
  const pre = await p.json();

  const put = await fetch(pre.url, {
    method: 'PUT',
    headers: { 'Content-Type': file.type || 'application/octet-stream' },
    body: file
  });
  if (!put.ok) throw new Error(`S3 PUT failed ${put.status} ${await put.text()}`);

  const publicUrl = `https://${pre.bucket}.s3.${pre.region}.amazonaws.com/${pre.key}`;
  return publicUrl;
}

document.querySelector('#file').addEventListener('change', async (e) => {
  const el = document.querySelector('#status');
  el.textContent = 'Starting…';
  try {
    const url = await runUploadFlow(e.target.files[0]);
    el.textContent = 'Upload complete:\n' + url;
  } catch (err) {
    el.textContent = 'Upload failed:\n' + (err?.message || err);
    console.error(err);
  }
});
</script>
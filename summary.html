<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Virtual Coach AI ‚Äî Swing Report</title>
<meta name="robots" content="noindex, nofollow" />
<style>
  :root{
    --fg:#f5f5f5; --bg:#0a0a0a; --line:rgba(255,255,255,0.16);
    --muted:rgba(255,255,255,0.75);
    --good:#16a34a; --warn:#eab308; --bad:#ef4444; --accent:#1F6F1F;
  }
  html,body{
    margin:0; color:var(--fg); background: var(--bg) url("homepage-background.png") center/cover no-repeat fixed;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    filter: brightness(1.06) contrast(1.02); min-height:100%;
  }
  .wrap{ max-width:1000px; margin:0 auto; padding:32px 16px; text-shadow:0 1px 2px rgba(0,0,0,.25);}
  h1{ margin:0 0 6px; font-size:28px;}
  .muted{ color:var(--muted); }

  .cta{ display:inline-block; padding:10px 14px; border-radius:10px; background:var(--accent); color:#fff;
        text-decoration:none; font-weight:700; border:1px solid var(--line); cursor:pointer; }
  .cta:hover{ opacity:.92; }
  #exportBar{ margin:14px 0 18px; display:flex; flex-wrap:wrap; gap:8px; }

  details{ border:1px solid var(--line); border-radius:12px; background:rgba(0,0,0,.25); padding:14px 16px; margin:10px 0;}
  summary{ cursor:pointer; font-weight:700; display:flex; justify-content:space-between; align-items:center; }

  .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;}
  .chip{ border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:13px; }

  .pill{ padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line);}
  .pill.g{ background:rgba(22,163,74,.2); border-color:var(--good);}
  .pill.y{ background:rgba(234,179,8,.2); border-color:var(--warn);}
  .pill.r{ background:rgba(239,68,68,.2); border-color:var(--bad);}

  .table-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; margin:0 -8px; padding:0 8px;}
  table{ width:100%; border-collapse:collapse; table-layout:fixed; min-width:520px;}
  th,td{ padding:10px; border-bottom:1px solid var(--line); text-align:left; vertical-align:top;}

  /* Frames grid (hidden until toggled) */
  #framesBlock{ display:none; }
  .frames{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:10px; }
  @media (max-width:640px){ .frames{ grid-template-columns:repeat(2,1fr);} }
  .frame{ border:1px solid var(--line); border-radius:10px; background:rgba(0,0,0,.25); overflow:hidden; font-size:13px; color:var(--muted); }
  .frame img{ width:100%; aspect-ratio:16/9; object-fit:cover; display:block; }
  .frame figcaption{ padding:6px 8px; }

  @media print{
    body{ filter:none !important; background:#fff !important; color:#000 !important;}
    #exportBar, #toggleFramesBtn{ display:none !important;}
    details{ background:#fff; border:1px solid #ddd;}
    .pill.g{ background:#d9f2e4; border-color:#16a34a; color:#0a5a2e;}
    .pill.y{ background:#fff2c2; border-color:#eab308; color:#6b5700;}
    .pill.r{ background:#ffd9d9; border-color:#ef4444; color:#7a1b1b;}
  }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Swing Reports</h1>
    <div class="muted">ID: <span id="rid">‚Äî</span></div>

    <!-- Export / Share -->
    <div id="exportBar">
      <button class="cta" id="btnEmail" type="button">‚úâÔ∏è Email</button>
      <button class="cta" id="btnSMS"   type="button">üí¨ Text</button>
      <button class="cta" id="btnPrint" type="button">üñ®Ô∏è Download / Print PDF</button>
      <button class="cta" id="btnCopy"  type="button">üìã Copy</button>
      <button class="cta" id="btnShare" type="button">üîó Share Link</button>
      <button class="cta" id="toggleFramesBtn" type="button">üñº Show P1‚ÄìP9 Images</button>
    </div>

    <details open>
      <summary>Tempo</summary>
      <div class="chips" id="chips"></div>
      <p class="muted" style="margin-top:8px">
        Target ~<b>3:1</b> backswing:downswing with a micro-pause (&lt;0.08s) at the top.
      </p>
    </details>

    <details open>
      <summary>P1‚ÄìP9 Assessment</summary>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Checkpoint</th><th>Status</th></tr></thead>
          <tbody id="pRows"></tbody>
        </table>
      </div>

      <!-- Hidden frames block (toggle) -->
      <div id="framesBlock">
        <div class="frames" id="thumbs"></div>
      </div>
    </details>

    <details open>
      <summary>Top 3 Things to Work On</summary>
      <ol id="top3work"></ol>
    </details>

    <details>
      <summary>Top 3 Power Things</summary>
      <ol id="top3power"></ol>
    </details>

    <p><a class="cta" href="/">‚¨Ö Back to Home</a></p>
  </div>

<script>
(function(){
  // Read ID
  const id = new URLSearchParams(location.search).get('id') || 'local-demo';
  document.getElementById('rid').textContent = id;

  // Safe load report/frames
  let report = null, framesAll = [];
  try { report = JSON.parse(sessionStorage.getItem('vc_report_' + id) || 'null'); } catch(_) {}
  try { framesAll = JSON.parse(sessionStorage.getItem('vc_frames_' + id) || '[]'); } catch(_) {}

  if (!report) {
    alert('No saved report found. Please upload a swing from the Home page.');
    location.href = '/';
    return;
  }

  // Tempo
  const t = report.tempo || {};
  document.getElementById('chips').innerHTML = `
    <span class="chip">Backswing: ${t.backswing ?? '-' }s</span>
    <span class="chip">Pause: ${t.pause ?? '-' }s</span>
    <span class="chip">Downswing: ${t.downswing ?? '-' }s</span>
    <span class="chip">Ratio: ${t.ratio ?? '-' }:1</span>
  `;

  // P1‚ÄìP9 flags
  const map = { g:'Good', y:'Okay', r:'Needs Work' };
  const rows = document.getElementById('pRows');
  rows.innerHTML = '';
  (report.pFlags || []).slice(0,9).forEach((f,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>P${i+1}</td><td><span class="pill ${f||'y'}">${map[f]||'Okay'}</span></td>`;
    rows.appendChild(tr);
  });

  // Top 3 lists
  document.getElementById('top3work').innerHTML  = (report.top3WorkOn||[]).map(x=>`<li><b>${x}</b></li>`).join('');
  document.getElementById('top3power').innerHTML = (report.top3Power||[]).map(x=>`<li><b>${x}</b></li>`).join('');

  // Toggle P1‚ÄìP9 images
  const toggleBtn = document.getElementById('toggleFramesBtn');
  const framesBlock = document.getElementById('framesBlock');
  const thumbs = document.getElementById('thumbs');
  let framesVisible = false;

  toggleBtn.addEventListener('click', ()=>{
    framesVisible = !framesVisible;
    if (framesVisible) {
      toggleBtn.textContent = 'üñº Hide P1‚ÄìP9 Images';
      // render if empty
      if (!thumbs.innerHTML.trim()) {
        thumbs.innerHTML = (framesAll||[]).slice(0,9).map((src,i)=>`
          <figure class="frame">
            <img src="${src || `p${i+1}.jpg`}" alt="P${i+1}">
            <figcaption>P${i+1}</figcaption>
          </figure>
        `).join('');
      }
      framesBlock.style.display = 'block';
    } else {
      toggleBtn.textContent = 'üñº Show P1‚ÄìP9 Images';
      framesBlock.style.display = 'none';
    }
  });

  // ==== Export / Share wiring ====
  function buildSummaryText(report, id) {
    const tempo = report?.tempo || {};
    const flags = (report?.pFlags || []).slice(0,9);
    const map = { g:'Good', y:'Okay', r:'Needs Work' };
    const pText = flags.map((f,i)=>`P${i+1}:${map[f]||'-'}`).join('  ');
    const w3 = (report?.top3WorkOn||[]).map((x,i)=>`${i+1}. ${x}`).join('\n');
    const p3 = (report?.top3Power||[]).map((x,i)=>`${i+1}. ${x}`).join('\n');

    return [
      `Virtual Coach AI ‚Äî Swing Report ${id}`,
      `Tempo: BS ${tempo.backswing||'-'}s  Pause ${tempo.pause||'-'}s  DS ${tempo.downswing||'-'}s  Ratio ${tempo.ratio||'-'}:1`,
      `Checkpoints: ${pText}`,
      ``,
      `Top 3 Things to Work On:`,
      w3 || '-',
      ``,
      `Top 3 Power Things:`,
      p3 || '-',
      ``,
      `‚Äî Generated with Virtual Coach AI`
    ].join('\n');
  }
  function mailtoEncode(s){ return encodeURIComponent(s).replace(/%0A/g,'%0D%0A'); }

  const text = buildSummaryText(report, id);

  // Email
  document.getElementById('btnEmail').onclick = () => {
    const subject = mailtoEncode(`Virtual Coach AI ‚Äî Swing Report ${id}`);
    const body    = mailtoEncode(text);
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
  };
  // SMS
  document.getElementById('btnSMS').onclick = () => {
    const body = encodeURIComponent(text);
    const url = /iPhone|iPad|iPod/i.test(navigator.userAgent) ? `sms:&body=${body}` : `sms:?body=${body}`;
    window.location.href = url;
  };
  // Print / PDF
  document.getElementById('btnPrint').onclick = () => window.print();
  // Copy
  document.getElementById('btnCopy').onclick = async () => {
    try { await navigator.clipboard.writeText(text); alert('Report copied.'); }
    catch { prompt('Copy report text:', text); }
  };
  // Share Link (uses /api/save with Upstash creds)
  document.getElementById('btnShare').onclick = async () => {
    try {
      const r = await fetch('/api/save', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ report, frames: (framesAll||[]).slice(0,3) })
      });
      const j = await r.json();
      if (!r.ok || !j?.ok) throw new Error(j?.error || 'Save failed');
      await navigator.clipboard.writeText(j.url);
      alert('Share link copied:\n' + j.url);
    } catch (e) {
      alert('Error creating share link: ' + (e.message||e));
    }
  };
})();
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Virtual Coach AI — Swing Summary</title>
  <link rel="stylesheet" href="style.css?v=11"/>
  <style>
    .tile { background: var(--card); border:1px solid var(--border); border-radius:14px; margin:10px 0; overflow:hidden; }
    .tile > button { width:100%; text-align:left; display:flex; justify-content:space-between; align-items:center;
      padding:14px 16px; background:transparent; border:none; color:var(--text); cursor:pointer; font-size:1.05rem; }
    .tile > button:hover { background: rgba(255,255,255,.06); }
    .tile-body { display:none; padding:14px 16px; border-top:1px solid var(--border); }
    .list { margin:0; padding-left:18px; }
    .bar { height:10px; background: rgba(255,255,255,.1); border-radius:10px; overflow:hidden; }
    .bar > span { display:block; height:100%; background: var(--accent); width:0%; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; }

    /* P1–P9 stacked (with More toggle) */
    .pstack { width:100%; border-collapse:collapse; }
    .pstack th, .pstack td { border:1px solid var(--border); padding:10px; vertical-align:top; }
    .pstack thead { background: rgba(255,255,255,.06); }
    .pname { width:110px; white-space:nowrap; }
    .badge { display:inline-block; padding:3px 8px; border-radius:999px; font-size:.9rem; border:1px solid var(--border); }
    .good  { background: rgba(0,200,0,.15);  color:#9ff39f; }
    .okay  { background: rgba(255,200,0,.15);color:#ffe28a; }
    .need  { background: rgba(255,0,0,.15);  color:#ffb3b3; }
    .desc { opacity:.95; }
    .more { margin-top:8px; }
    .more button { padding:6px 10px; border:1px solid var(--border); background: rgba(255,255,255,.08); color:var(--text); border-radius:8px; cursor:pointer; }
    .long { display:none; margin-top:8px; line-height:1.4; }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="header">
      <img class="logo" src="virtualcoach-logo.png" onerror="this.src='virtualcoach-logo-transparent.png'" alt="Virtual Coach AI"/>
      <div>
        <h1 class="brand">Virtual Coach AI</h1>
        <p class="sub">Swing Summary</p>
      </div>
    </header>

    <div id="notice" class="notice"></div>

    <!-- Top bar: ID + Actions -->
    <section class="card" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <div id="reportId">ID: —</div>
      <div class="actions">
        <button id="exportJsonBtn" title="Download JSON">Export JSON</button>
        <button id="printBtn" title="Print or Save as PDF">Print / PDF</button>
      </div>
    </section>

    <!-- Summary -->
    <section class="tile">
      <button data-acc="summary"><span>Swing Summary</span><span>▾</span></button>
      <div class="tile-body" id="tile-summary">
        <div class="grid two">
          <div class="card">
            <h3 class="section-title">Profile</h3>
            <div id="profile">—</div>
          </div>
          <div class="card">
            <h3 class="section-title">Tempo</h3>
            <div id="tempo">—</div>
          </div>
        </div>
        <div class="card" style="margin-top:10px;">
          <h3 class="section-title">Totals</h3>
          <div id="totals">—</div>
        </div>
      </div>
    </section>

    <!-- P1–P9 vertically stacked (Condition | Rating | Description + More) -->
    <section class="tile">
      <button data-acc="pstack"><span>P1–P9 Details</span><span>▾</span></button>
      <div class="tile-body" id="tile-pstack">
        <table class="pstack" id="pTable">
          <thead>
            <tr>
              <th class="pname">Condition</th>
              <th>Rating</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody><!-- rows go here --></tbody>
        </table>
      </div>
    </section>

    <!-- (Other tiles kept as-is) -->
    <section class="tile">
      <button data-acc="improve"><span>3 Things to Improve</span><span>▾</span></button>
      <div class="tile-body">
        <ol class="list" id="tips3"></ol>
      </div>
    </section>

    <section class="tile">
      <button data-acc="power"><span>Power Assessment</span><span>▾</span></button>
      <div class="tile-body" id="tile-power">
        <div style="margin-bottom:8px;">Overall Power: <b id="powerScore">—</b></div>
        <div class="bar"><span id="powerBar"></span></div>
        <ul class="list" id="powerNotes" style="margin-top:10px;"></ul>
      </div>
    </section>

    <section class="tile">
      <button data-acc="power-tips"><span>3 Power Things to Improve</span><span>▾</span></button>
      <div class="tile-body">
        <ol class="list" id="powerTips3"></ol>
      </div>
    </section>

    <section class="tile">
      <button data-acc="lessons"><span>14-Day Lesson Plan</span><span>▾</span></button>
      <div class="tile-body">
        <ol class="list" id="lessons14"></ol>
      </div>
    </section>
  </div>

  <script>
  // accordion
  (function(){
    document.querySelectorAll('.tile > button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const body = btn.parentElement.querySelector('.tile-body');
        const open = body.style.display === 'block';
        body.style.display = open ? 'none' : 'block';
        btn.lastElementChild.textContent = open ? '▾' : '▴';
      });
    });
  })();
  </script>

  <script>
  (function(){
    const $ = (s)=>document.querySelector(s);
    const notice = $('#notice');
    const setNotice=(m,t='info')=>{ if(!notice) return; notice.textContent=m||''; notice.style.display=m?'block':'none'; notice.setAttribute('data-type',t); };
    const setText=(sel,val)=>{ const el=$(sel); if(el) el.textContent=(val??'—'); };

    // ID (fallback demo)
    const params = new URLSearchParams(location.search);
    const id = params.get('id') || '1754322283691';
    $('#reportId').textContent = 'ID: ' + id;

    // Export / Print
    let lastData = null;
    $('#exportJsonBtn').onclick = () => {
      if (!lastData) return setNotice('Nothing to export yet.', 'error');
      const blob = new Blob([JSON.stringify(lastData, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `swing-summary-${id}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    };
    $('#printBtn').onclick = () => window.print();

    // Fetch
    (async()=>{
      try{
        const r = await fetch('/api/get?id='+encodeURIComponent(id), { cache:'no-store' });
        let data; try { data = await r.json(); } catch { setNotice('Server returned non-JSON.','error'); return; }
        if (!r.ok) { setNotice(data?.error || ('Failed to load report ('+r.status+')'),'error'); return; }
        if (!data) { setNotice('Empty report payload.','error'); return; }
        lastData = data;

        setText('#profile', data.profile || '—');
        setText('#tempo', data.tempo || '—');
        setText('#totals', data.totals ? JSON.stringify(data.totals) : '—');

        // Build P1–P9 rows with short+long + status badge
        const tbody = document.querySelector('#pTable tbody');
        tbody.innerHTML = '';
        const order = ['P1','P2','P3','P4','P5','P6','P7','P8','P9'];
        order.forEach(k=>{
          const it = data.pstack?.[k] || {};
          const tr = document.createElement('tr');

          const tdCond = document.createElement('td');
          tdCond.className = 'pname';
          tdCond.innerHTML = `<div><b>${k}</b></div><div>${it.condition ?? '—'}</div>`;

          const tdRating = document.createElement('td');
          const status = it.status || 'okay';
          const badgeClass = status === 'good' ? 'good' : (status === 'need' ? 'need' : 'okay');
          tdRating.innerHTML = `<span class="badge ${badgeClass}">${(it.rating ?? '—')} · ${status.toUpperCase()}</span>`;

          const tdDesc = document.createElement('td');
          tdDesc.className = 'desc';
          const short = it.short ?? it.description ?? '—';
          const long  = it.long  ?? '';
          const idBtn = `more_${k}`;

          tdDesc.innerHTML = `
            <div>${short}</div>
            ${long ? `
              <div class="more">
                <button type="button" id="${idBtn}" aria-expanded="false" aria-controls="${idBtn}_long">More</button>
                <div class="long" id="${idBtn}_long">${long}</div>
              </div>
            ` : '' }
          `;

          tr.appendChild(tdCond);
          tr.appendChild(tdRating);
          tr.appendChild(tdDesc);
          tbody.appendChild(tr);

          // wire the toggle (if present)
          if (long) {
            setTimeout(()=>{
              const btn = document.getElementById(idBtn);
              const panel = document.getElementById(`${idBtn}_long`);
              if (btn && panel) {
                btn.addEventListener('click', ()=>{
                  const open = panel.style.display === 'block';
                  panel.style.display = open ? 'none' : 'block';
                  btn.setAttribute('aria-expanded', (!open).toString());
                  btn.textContent = open ? 'More' : 'Less';
                });
              }
            }, 0);
          }
        });

        // Other tiles (unchanged)
        const tips3 = document.getElementById('tips3'); tips3.innerHTML='';
        (data.tips3 || []).slice(0,3).forEach(t=>{ const li=document.createElement('li'); li.textContent=t; tips3.appendChild(li); });
        if (!tips3.children.length) tips3.innerHTML = '<li>—</li>';

        const power = data.power || { score: 0, notes: [] };
        setText('#powerScore', (power.score ?? 0) + '/100');
        const bar = document.getElementById('powerBar'); bar.style.width = Math.max(0, Math.min(100, power.score || 0)) + '%';
        const pNotes = document.getElementById('powerNotes'); pNotes.innerHTML='';
        (power.notes || []).forEach(n=>{ const li=document.createElement('li'); li.textContent=n; pNotes.appendChild(li); });
        if (!pNotes.children.length) pNotes.innerHTML = '<li>—</li>';

        const powerTips3 = document.getElementById('powerTips3'); powerTips3.innerHTML='';
        (data.powerTips3 || []).slice(0,3).forEach(t=>{ const li=document.createElement('li'); li.textContent=t; powerTips3.appendChild(li); });
        if (!powerTips3.children.length) powerTips3.innerHTML = '<li>—</li>';

        const lessons = document.getElementById('lessons14'); lessons.innerHTML='';
        (data.lessons14 || []).slice(0,14).forEach((d,i)=>{
          const li=document.createElement('li'); li.innerHTML = `<b>Day ${i+1}:</b> ${d}`; lessons.appendChild(li);
        });
        if (!lessons.children.length) lessons.innerHTML = '<li>—</li>';

        // Open Summary + P1–P9 by default
        document.querySelector('#tile-summary').style.display = 'block';
        document.querySelector('#tile-pstack').style.display = 'block';
      } catch(e){
        setNotice('Error loading report: '+(e?.message||e),'error');
      }
    })();
  })();
  </script>
</body>
</html>

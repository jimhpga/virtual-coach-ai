<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Virtual Coach AI ‚Äî Swing Report</title>
  <style>
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: #0a0a0a url("homepage-background.png") center/cover no-repeat fixed;
      color: #f5f5f5;
      filter: brightness(1.06) contrast(1.02);
      min-height: 100vh;
    }
    .wrap { max-width: 1000px; margin: 0 auto; padding: 32px 16px; text-shadow: 0 1px 2px rgba(0,0,0,.25); }
    h1 { margin: 0 0 6px; font-size: 28px; }
    .muted { color: rgba(255,255,255,.75); }
    details { border: 1px solid rgba(255,255,255,.16); border-radius: 12px; background: rgba(0,0,0,.25); padding: 14px 16px; margin: 10px 0; }
    summary { cursor: pointer; font-weight: 700; display: flex; justify-content: space-between; }
    .chips { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .chip { border: 1px solid rgba(255,255,255,.16); border-radius: 999px; padding: 6px 10px; font-size: 13px; }
    .pill { padding: 3px 8px; border-radius: 999px; font-size: 12px; border: 1px solid rgba(255,255,255,.16);}
    .pill.g { background: rgba(22,163,74,0.2); border-color: #16a34a; }
    .pill.y { background: rgba(234,179,8,0.2); border-color: #eab308; }
    .pill.r { background: rgba(239,68,68,0.2); border-color: #ef4444; }
    .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; margin: 0 -8px; padding: 0 8px; }
    table { width: 100%; border-collapse: collapse; table-layout: fixed; min-width: 720px; }
    th, td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,.16); text-align: left; vertical-align: top; }
    .frames { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
    @media (max-width: 640px) { .frames { grid-template-columns: repeat(2, 1fr); } }
    .frame { border: 1px solid rgba(255,255,255,.16); border-radius: 10px; background: rgba(0,0,0,.25); overflow: hidden; font-size: 13px; color: rgba(255,255,255,.75);}
    .frame img { width: 100%; aspect-ratio: 16/9; object-fit: cover; display: block; }
    .frame figcaption { padding: 6px 8px; }
    .cta { display: inline-block; padding: 10px 14px; border-radius: 10px; background: #1F6F1F; color: #fff; text-decoration: none; font-weight: 700; border: 1px solid rgba(255,255,255,.16); cursor: pointer; }
    .cta:hover { opacity: .92; }
    #exportBar { margin: 14px 0 18px; display: flex; flex-wrap: wrap; gap: 8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Swing Reports</h1>
    <div class="muted">ID: <span id="rid">‚Äî</span></div>

    <div id="exportBar">
      <button class="cta" id="btnEmail" type="button">‚úâÔ∏è Email</button>
      <button class="cta" id="btnSMS" type="button">üí¨ Text</button>
      <button class="cta" id="btnPrint" type="button">üñ®Ô∏è Download / Print PDF</button>
      <button class="cta" id="btnCopy" type="button">üìã Copy</button>
      <button class="cta" id="btnShare" type="button">üîó Share Link</button>
    </div>

    <details open>
      <summary>Tempo</summary>
      <div class="chips" id="chips"></div>
    </details>

    <details open>
      <summary>P1‚ÄìP9 Assessment</summary>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Checkpoint</th><th>Status</th></tr></thead>
          <tbody id="pRows"></tbody>
        </table>
      </div>
      <div class="frames" id="thumbs"></div>
    </details>

    <details open>
      <summary>Top 3 Things to Work On</summary>
      <ol id="top3work"></ol>
    </details>

    <details>
      <summary>Top 3 Power Things</summary>
      <ol id="top3power"></ol>
    </details>

    <p><a class="cta" href="/">‚¨Ö Back to Home</a></p>
  </div>

  <script>
    const id = new URLSearchParams(location.search).get('id') || 'local-demo';
    document.getElementById('rid').textContent = id;

    let report = null, framesAll = [];
    try { report = JSON.parse(sessionStorage.getItem('vc_report_' + id) || 'null'); } catch(_) {}
    try { framesAll = JSON.parse(sessionStorage.getItem('vc_frames_' + id) || '[]'); } catch(_) {}

    // Fill Tempo
    const t = report?.tempo || {};
    document.getElementById('chips').innerHTML = `
      <span class="chip">Backswing: ${t.backswing ?? '-' }s</span>
      <span class="chip">Pause: ${t.pause ?? '-' }s</span>
      <span class="chip">Downswing: ${t.downswing ?? '-' }s</span>
      <span class="chip">Ratio: ${t.ratio ?? '-' }:1</span>
    `;

    // Fill P1‚ÄìP9
    const map = { g:'Good', y:'Okay', r:'Needs Work' };
    const rows = document.getElementById('pRows');
    (report?.pFlags || []).slice(0,9).forEach((f,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>P${i+1}</td><td><span class="pill ${f||'y'}">${map[f]||'Okay'}</span></td>`;
      rows.appendChild(tr);
    });

    // Fill Top 3s
    document.getElementById('top3work').innerHTML  = (report?.top3WorkOn||[]).map(x=>`<li><b>${x}</b></li>`).join('');
    document.getElementById('top3power').innerHTML = (report?.top3Power||[]).map(x=>`<li><b>${x}</b></li>`).join('');

    // Fill Thumbs
    document.getElementById('thumbs').innerHTML = (framesAll||[]).slice(0,9).map((src,i)=>`
      <figure class="frame"><img src="${src}" alt="Frame ${i+1}"><figcaption>Frame ${i+1}</figcaption></figure>
    `).join('');

    // Email
    document.getElementById('btnEmail').onclick = () => {
      const body = encodeURIComponent(JSON.stringify(report, null, 2));
      window.location.href = `mailto:?subject=Virtual Coach AI Report ${id}&body=${body}`;
    };
    // SMS
    document.getElementById('btnSMS').onclick = () => {
      const body = encodeURIComponent(JSON.stringify(report, null, 2));
      window.location.href = /iPhone|iPad|iPod/i.test(navigator.userAgent) ? `sms:&body=${body}` : `sms:?body=${body}`;
    };
    // Print
    document.getElementById('btnPrint').onclick = () => window.print();
    // Copy
    document.getElementById('btnCopy').onclick = async () => {
      try { await navigator.clipboard.writeText(JSON.stringify(report, null, 2)); alert('Report copied.'); }
      catch { prompt('Copy report:', JSON.stringify(report, null, 2)); }
    };
    // Share Link
    document.getElementById('btnShare').onclick = async () => {
      try {
        const r = await fetch('/api/save', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ report, frames: framesAll.slice(0,3) })
        });
        const j = await r.json();
        if (!r.ok || !j?.ok) throw new Error(j?.error || 'Save failed');
        await navigator.clipboard.writeText(j.url);
        alert('Share link copied:\n' + j.url);
      } catch (e) {
        alert('Error creating share link: ' + e.message);
      }
    };
  </script>
</body>
</html>

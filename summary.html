<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Virtual Coach AI — Swing Summary</title>
  <!-- cache-bust to ensure latest styles load -->
  <link rel="stylesheet" href="style.css?v=6"/>
</head>
<body>
  <div class="wrap">
    <header class="header">
      <img class="logo" src="virtualcoach-logo.png" alt="Virtual Coach AI"/>
      <div>
        <h1 class="brand">Virtual Coach AI</h1>
        <p class="sub">Swing Summary</p>
      </div>
    </header>

    <div id="notice" class="notice"></div>
    <div class="card" id="report-id">ID: —</div>

    <section class="grid two">
      <div class="card">
        <h3 class="section-title">Profile</h3>
        <div id="profile">—</div>
      </div>
      <div class="card">
        <h3 class="section-title">Tempo</h3>
        <div id="tempo">—</div>
      </div>
    </section>

    <section class="card">
      <h3 class="section-title">Totals</h3>
      <div id="totals">—</div>
    </section>

    <section class="card">
      <h3 class="section-title">P1–P9 Metrics</h3>
      <table id="p-table">
        <thead><tr><th>Position</th><th>Value</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

  <script>
    // --- ID fallback so the page never shows blanks ---
    (function ensureId() {
      const params = new URLSearchParams(location.search);
      if (!params.get('id')) {
        const demo = '1754322283691';
        location.replace(`${location.pathname}?id=${demo}`);
      }
    })();
  </script>

  <script>
  (function(){
    const $ = (s)=>document.querySelector(s);
    const notice = $('#notice');
    const setNotice=(m,t='info')=>{
      if(!notice) return;
      notice.textContent=m||'';
      notice.style.display=m?'block':'none';
      notice.setAttribute('data-type',t);
    };
    const setText=(sel,val)=>{ const el=$(sel); if(el) el.textContent=(val??'—'); };

    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    setText('#report-id','ID: '+(id||'—'));

    // Fetch and render
    (async()=>{
      try{
        const url = '/api/get?id='+encodeURIComponent(id);
        const r = await fetch(url, { cache:'no-store' });
        let data;
        try { data = await r.json(); } catch {
          setNotice('Server returned non-JSON. Check Functions Logs.', 'error'); return;
        }

        if (!r.ok) { setNotice(data?.error || ('Failed to load report ('+r.status+')'), 'error'); return; }
        if (!data || typeof data!=='object') { setNotice('Empty report payload.', 'error'); return; }

        setText('#profile', data.profile || '—');
        setText('#tempo',   data.tempo   || '—');
        setText('#totals',  data.totals ? JSON.stringify(data.totals) : '—');

        const tbody = document.querySelector('#p-table tbody');
        const keys = ['P1','P2','P3','P4','P5','P6','P7','P8','P9'];
        if (tbody){
          tbody.innerHTML='';
          keys.forEach(k=>{
            const tr=document.createElement('tr');
            const tdK=document.createElement('td'); tdK.textContent=k;
            const tdV=document.createElement('td'); tdV.textContent=(data.metrics?.[k] ?? '—');
            tr.appendChild(tdK); tr.appendChild(tdV);
            tbody.appendChild(tr);
          });
        }

        setNotice('Summary loaded.');
      } catch(e){
        setNotice('Error loading report: '+(e?.message||e), 'error');
      }
    })();
  })();
  </script>
</body>
</html>


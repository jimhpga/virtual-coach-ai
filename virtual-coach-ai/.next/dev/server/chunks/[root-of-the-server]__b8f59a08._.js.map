{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///C:/Sites/virtual-coach-ai/virtual-coach-ai/src/app/api/swing-report/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport type { SwingReport } from \"@/types/swingReport\";\r\nimport os from \"os\";\r\nimport path from \"path\";\r\nimport { promises as fs } from \"fs\";\r\nimport { spawn } from \"child_process\";\r\n\r\nexport const runtime = \"nodejs\";\r\n// If you ever deploy to Vercel, this gives the route more time\r\nexport const maxDuration = 60;\r\n\r\ntype Severity = \"low\" | \"medium\" | \"high\";\r\n\r\n/**\r\n * Try to parse JSON, and do a light repair pass if the model\r\n * sneaks in trailing commas or smart quotes.\r\n */\r\nfunction safeParseJSON<T>(str: string): T {\r\n  try {\r\n    return JSON.parse(str) as T;\r\n  } catch {\r\n    const repaired = str\r\n      .replace(/,\\s*}/g, \"}\")\r\n      .replace(/,\\s*]/g, \"]\")\r\n      .replace(/“|”/g, '\"')\r\n      .replace(/‘|’/g, \"'\");\r\n    return JSON.parse(repaired) as T;\r\n  }\r\n}\r\n\r\n/**\r\n * Run ffmpeg to pull a few JPEG frames from the uploaded video,\r\n * return them as data: URLs for OpenAI vision.\r\n */\r\nasync function extractFrames(\r\n  videoPath: string,\r\n  frameCount = 4\r\n): Promise<string[]> {\r\n  const tmpDir = await fs.mkdtemp(path.join(os.tmpdir(), \"vca-frames-\"));\r\n  const outputPattern = path.join(tmpDir, \"frame-%02d.jpg\");\r\n\r\n  await new Promise<void>((resolve, reject) => {\r\n    // 1 frame per second, first N frames\r\n    const args = [\r\n      \"-hide_banner\",\r\n      \"-loglevel\",\r\n      \"error\",\r\n      \"-i\",\r\n      videoPath,\r\n      \"-vf\",\r\n      \"fps=1\",\r\n      \"-vframes\",\r\n      String(frameCount),\r\n      outputPattern,\r\n    ];\r\n\r\n    const child = spawn(\"ffmpeg\", args);\r\n\r\n    child.on(\"error\", (err) => {\r\n      console.error(\"ffmpeg spawn error:\", err);\r\n      reject(err);\r\n    });\r\n\r\n    child.on(\"close\", (code) => {\r\n      if (code === 0) resolve();\r\n      else reject(new Error(`ffmpeg exited with code ${code}`));\r\n    });\r\n  });\r\n\r\n  const files = (await fs.readdir(tmpDir)).filter((f) =>\r\n    f.toLowerCase().endsWith(\".jpg\")\r\n  );\r\n  files.sort();\r\n\r\n  const frames: string[] = [];\r\n  for (const file of files) {\r\n    const full = path.join(tmpDir, file);\r\n    const buf = await fs.readFile(full);\r\n    frames.push(`data:image/jpeg;base64,${buf.toString(\"base64\")}`);\r\n  }\r\n\r\n  // Clean up temp dir\r\n  await fs.rm(tmpDir, { recursive: true, force: true });\r\n\r\n  return frames;\r\n}\r\n\r\n/**\r\n * System prompt: who VCA is + JSON contract for SwingReport.\r\n */\r\nfunction buildSystemPrompt(): string {\r\n  return [\r\n    \"You are VCA Virtual Coach, a tour-level golf coach AI.\",\r\n    \"You blend Jim Hartnett’s 'Golf for the Other 80%' priority stack and simple language,\",\r\n    \"Jim McLean’s P-system / corridors of success and fault-tree testing,\",\r\n    \"Butch Harmon’s ball-flight laws and 'don’t wreck what works' philosophy,\",\r\n    \"Dr. Kwon’s ground-force / sequencing concepts,\",\r\n    \"and a light layer of Dave Tutelman’s golf-physics perspective.\",\r\n    \"\",\r\n    \"You coach for scoring, not pretty positions. You favour a short list of big priorities over a long list of random tips.\",\r\n    \"Adjust tone and dosage for rec 20+, mid caps, single digits, plus players, and tour patterns.\",\r\n    \"\",\r\n    \"You are analysing golf swing video frames (face-on or down-the-line).\",\r\n    \"Use the images to infer: dominant miss pattern, key positions, main leaks, and practical drills.\",\r\n    \"\",\r\n    \"You must output ONLY valid JSON matching this TypeScript interface:\",\r\n    \"\",\r\n    `{\r\n  \"createdAt\": \"string\",\r\n  \"overallScore\": number,         // 0–100\r\n  \"powerScore\": number,           // 0–100\r\n  \"efficiencyScore\": number,      // 0–100\r\n  \"consistencyScore\": number,     // 0–100\r\n  \"dominantMiss\": \"string\",       // e.g. \"push-slice\", \"pull-hook\", \"thin\", etc.\r\n  \"summary\": \"string\",            // 2–4 sentences in plain English\r\n  \"issues\": [\r\n    {\r\n      \"id\": \"string\",\r\n      \"title\": \"string\",\r\n      \"position\":\r\n        \"setup\" |\r\n        \"takeaway\" |\r\n        \"backswing\" |\r\n        \"top\" |\r\n        \"transition\" |\r\n        \"downswing\" |\r\n        \"impact\" |\r\n        \"finish\",\r\n      \"severity\": \"low\" | \"medium\" | \"high\",\r\n      \"description\": \"string\",\r\n      \"drills\": [\"string\"]\r\n    }\r\n  ],\r\n  \"practicePlanSummary\": \"string\" // 3–6 sentences describing the 14-day focus\r\n}`,\r\n    \"\",\r\n    \"Rules:\",\r\n    \"- Scores must be integers 0–100.\",\r\n    \"- 3–5 issues total. At least one high severity, at least one medium.\",\r\n    \"- Make every drill something a normal range golfer can actually do.\",\r\n    \"- Use simple, direct language, not biomech jargon.\",\r\n    \"- DO NOT include any commentary outside the JSON object.\",\r\n  ].join(\" \");\r\n}\r\n\r\n/**\r\n * Build the user content for OpenAI, using frames if we have them.\r\n */\r\nfunction buildUserContent(frames: string[] | null) {\r\n  const baseText =\r\n    frames && frames.length > 0\r\n      ? [\r\n          \"You are analysing a real golfer’s swing using the attached video frames.\",\r\n          \"Infer the dominant miss pattern, where the motion breaks down, and what is already working.\",\r\n          \"Then produce the SwingReport JSON described in the system prompt.\",\r\n          \"Assume a stock mid-iron or driver unless the frames clearly show otherwise.\",\r\n        ].join(\" \")\r\n      : [\r\n          \"No frames were available. Pretend you are analysing a typical 15-handicap slicer with a push-slice driver miss.\",\r\n          \"Create a realistic SwingReport JSON for that player based on your coaching knowledge.\",\r\n        ].join(\" \");\r\n\r\n  const content: any[] = [{ type: \"text\", text: baseText }];\r\n\r\n  if (frames && frames.length > 0) {\r\n    for (const url of frames) {\r\n      content.push({\r\n        type: \"image_url\",\r\n        image_url: { url },\r\n      });\r\n    }\r\n  }\r\n\r\n  return content;\r\n}\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const apiKey = process.env.OPENAI_API_KEY;\r\n    if (!apiKey) {\r\n      return NextResponse.json(\r\n        { error: \"OPENAI_API_KEY is not set on the server.\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    const contentType = req.headers.get(\"content-type\") || \"\";\r\n    let frames: string[] | null = null;\r\n\r\n    // If this is a real upload (multipart/form-data), extract frames via ffmpeg\r\n    if (contentType.startsWith(\"multipart/form-data\")) {\r\n      const formData = await req.formData();\r\n      const file = formData.get(\"video\") as File | null;\r\n\r\n      if (file && typeof file === \"object\" && \"arrayBuffer\" in file) {\r\n        const arrayBuffer = await file.arrayBuffer();\r\n        const buffer = Buffer.from(arrayBuffer);\r\n        const tmpVideoPath = path.join(\r\n          os.tmpdir(),\r\n          `vca-swing-${Date.now()}.mp4`\r\n        );\r\n        await fs.writeFile(tmpVideoPath, buffer);\r\n\r\n        try {\r\n          frames = await extractFrames(tmpVideoPath, 4);\r\n        } catch (err) {\r\n          console.error(\"Failed to extract frames with ffmpeg:\", err);\r\n        } finally {\r\n          await fs.rm(tmpVideoPath, { force: true });\r\n        }\r\n      }\r\n    } else {\r\n      // Non-multipart (your \"See sample report\" button) → no frames, just sample\r\n      frames = null;\r\n    }\r\n\r\n    const systemPrompt = buildSystemPrompt();\r\n    const userContent = buildUserContent(frames);\r\n\r\n    const openaiRes = await fetch(\r\n      \"https://api.openai.com/v1/chat/completions\",\r\n      {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          Authorization: `Bearer ${apiKey}`,\r\n        },\r\n        body: JSON.stringify({\r\n          // Use a multimodal-capable model\r\n          model: \"gpt-4.1-mini\",\r\n          response_format: { type: \"json_object\" },\r\n          messages: [\r\n            {\r\n              role: \"system\",\r\n              content: systemPrompt,\r\n            },\r\n            {\r\n              role: \"user\",\r\n              content: userContent,\r\n            },\r\n          ],\r\n        }),\r\n      }\r\n    );\r\n\r\n    if (!openaiRes.ok) {\r\n      const text = await openaiRes.text();\r\n      console.error(\"OpenAI API error:\", openaiRes.status, text);\r\n      return NextResponse.json(\r\n        { error: \"OpenAI API error.\", detail: text },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    const openaiJson = (await openaiRes.json()) as any;\r\n    const content: string | undefined =\r\n      openaiJson?.choices?.[0]?.message?.content;\r\n\r\n    if (!content) {\r\n      console.error(\"No content in OpenAI response:\", openaiJson);\r\n      return NextResponse.json(\r\n        { error: \"No content returned from AI.\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    let parsed: SwingReport;\r\n    try {\r\n      parsed = safeParseJSON<SwingReport>(content);\r\n    } catch (err) {\r\n      console.error(\"Failed to parse AI JSON for swing report:\", err, content);\r\n      return NextResponse.json(\r\n        { error: \"AI returned invalid JSON.\", raw: content },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // Normalize / guard a few fields\r\n    parsed.createdAt = parsed.createdAt || new Date().toISOString();\r\n\r\n    // Make sure scores are in 0–100 range\r\n    parsed.overallScore = clampScore(parsed.overallScore);\r\n    parsed.powerScore = clampScore(parsed.powerScore);\r\n    parsed.efficiencyScore = clampScore(parsed.efficiencyScore);\r\n    parsed.consistencyScore = clampScore(parsed.consistencyScore);\r\n\r\n    // Basic sanity check on issues\r\n    if (!Array.isArray(parsed.issues) || parsed.issues.length === 0) {\r\n      return NextResponse.json(\r\n        { error: \"AI returned a report with no issues.\", raw: parsed },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    return NextResponse.json(parsed, { status: 200 });\r\n  } catch (err) {\r\n    console.error(\"Error in /api/swing-report:\", err);\r\n    return NextResponse.json(\r\n      { error: \"Internal server error.\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\nfunction clampScore(value: number | undefined): number {\r\n  if (typeof value !== \"number\" || Number.isNaN(value)) return 0;\r\n  return Math.max(0, Math.min(100, Math.round(value)));\r\n}\r\n"],"names":[],"mappings":"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"}}]
}
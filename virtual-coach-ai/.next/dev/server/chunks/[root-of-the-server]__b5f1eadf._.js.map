{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///C:/Sites/virtual-coach-ai/virtual-coach-ai/src/app/api/swing-report/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { tmpdir } from \"os\";\r\nimport { randomBytes } from \"crypto\";\r\nimport { promises as fs } from \"fs\";\r\nimport { execFile } from \"child_process\";\r\nimport { promisify } from \"util\";\r\n\r\nexport const runtime = \"nodejs\";\r\nexport const dynamic = \"force-dynamic\";\r\n\r\nconst execFileAsync = promisify(execFile);\r\n\r\ntype Severity = \"low\" | \"medium\" | \"high\";\r\n\r\ntype SwingIssue = {\r\n  id: string;\r\n  title: string;\r\n  severity: Severity;\r\n  position: string;\r\n  description: string;\r\n  drills: string[];\r\n};\r\n\r\ntype SwingReport = {\r\n  id: string;\r\n  createdAt: string;\r\n  overallScore: number;\r\n  powerScore: number;\r\n  efficiencyScore: number;\r\n  consistencyScore: number;\r\n  dominantMiss: string;\r\n  summary: string;\r\n  issues: SwingIssue[];\r\n  practicePlanSummary: string;\r\n};\r\n\r\n/**\r\n * If the client calls POST with no video (our \"sample\" button),\r\n * just return a hard-coded sample report so the UI always works.\r\n */\r\nfunction buildSampleReport(): SwingReport {\r\n  const now = new Date().toISOString();\r\n\r\n  return {\r\n    id: \"sample-swing\",\r\n    createdAt: now,\r\n    overallScore: 78,\r\n    powerScore: 80,\r\n    efficiencyScore: 77,\r\n    consistencyScore: 76,\r\n    dominantMiss: \"push_fade\",\r\n    summary:\r\n      \"Sample swing: solid structure with a slight push-fade bias. Face is a touch open to path with a little early extension in the downswing. Contact is generally centered with good speed potential.\",\r\n    issues: [\r\n      {\r\n        id: \"clubface_top\",\r\n        title: \"Open clubface at the top\",\r\n        severity: \"high\",\r\n        position: \"top_of_backswing\",\r\n        description:\r\n          \"Lead wrist gets a bit extended and the face sits open relative to your lead forearm. That pushes the pattern toward a hold-off fade and makes start lines leak right.\",\r\n        drills: [\r\n          \"Lead wrist wall drill: rehearse backswing with knuckles brushing an imaginary wall behind you.\",\r\n          \"Trail hand cover drill: feel your trail palm more on top of the handle at the top.\",\r\n        ],\r\n      },\r\n      {\r\n        id: \"downswing_path\",\r\n        title: \"Outside-in downswing path\",\r\n        severity: \"medium\",\r\n        position: \"downswing\",\r\n        description:\r\n          \"Arms and hands work out in front of your chest early in transition, steepening the shaft and sending the path across the ball.\",\r\n        drills: [\r\n          \"Headcover-behind-ball drill: place a headcover just outside the ball and swing without clipping it.\",\r\n          \"Trail arm-under drill: feel your trail elbow stay closer to your side in transition.\",\r\n        ],\r\n      },\r\n      {\r\n        id: \"early_extension\",\r\n        title: \"Early extension under pressure\",\r\n        severity: \"medium\",\r\n        position: \"impact\",\r\n        description:\r\n          \"Hips push toward the ball as you approach impact, changing spine angle and making low-point and face control tougher.\",\r\n        drills: [\r\n          \"Butt-on-wall drill: address a ball with your backside lightly touching a wall, then rehearse swings without losing contact.\",\r\n          \"Step-through rotations: hit half shots while stepping through with your trail foot to keep rotation going.\",\r\n        ],\r\n      },\r\n    ],\r\n    practicePlanSummary:\r\n      \"Days 1–4: Rebuild clubface control at the top with slow reps in front of a mirror. Days 5–10: Blend shallower transition reps with simple path drills and low-pressure range sessions. Days 11–14: Take the pattern to the course using one pre-shot key: clubface feel at the top and fully rotated finish.\",\r\n  };\r\n}\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const apiKey = process.env.OPENAI_API_KEY;\r\n    if (!apiKey) {\r\n      return NextResponse.json(\r\n        { error: \"OPENAI_API_KEY is not set on the server.\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // If this is a JSON POST with no file (our sample button), just return the sample.\r\n    const contentType = req.headers.get(\"content-type\") || \"\";\r\n    const isJson = contentType.startsWith(\"application/json\");\r\n    if (isJson) {\r\n      const sample = buildSampleReport();\r\n      return NextResponse.json(sample, { status: 200 });\r\n    }\r\n\r\n    // Otherwise, expect multipart/form-data with a \"video\" file.\r\n    const formData = await req.formData();\r\n    const videoFile = formData.get(\"video\") as File | null;\r\n\r\n    if (!videoFile) {\r\n      // No file – behave like the sample path rather than blowing up.\r\n      const sample = buildSampleReport();\r\n      return NextResponse.json(sample, { status: 200 });\r\n    }\r\n\r\n    // ---- 1) Save uploaded video to a temp file ----\r\n    const arrayBuffer = await videoFile.arrayBuffer();\r\n    const buffer = Buffer.from(arrayBuffer);\r\n\r\n    const tmpBase =\r\n      tmpdir() + `/swing-${Date.now()}-${randomBytes(4).toString(\"hex\")}`;\r\n    const inputPath = `${tmpBase}.mp4`;\r\n\r\n    await fs.writeFile(inputPath, buffer);\r\n\r\n    // ---- 2) Extract a handful of frames with ffmpeg ----\r\n    const framePattern = `${tmpBase}-%02d.jpg`;\r\n\r\n    await execFileAsync(\"ffmpeg\", [\r\n      \"-y\",\r\n      \"-i\",\r\n      inputPath,\r\n      \"-vf\",\r\n      \"fps=4\", // roughly 4 frames per second\r\n      \"-vframes\",\r\n      \"4\", // cap at 4 frames\r\n      framePattern,\r\n    ]);\r\n\r\n    const frameDataUrls: string[] = [];\r\n\r\n    for (let i = 1; i <= 4; i++) {\r\n      const framePath = `${tmpBase}-${String(i).padStart(2, \"0\")}.jpg`;\r\n      try {\r\n        const img = await fs.readFile(framePath);\r\n        const b64 = img.toString(\"base64\");\r\n        frameDataUrls.push(`data:image/jpeg;base64,${b64}`);\r\n      } catch {\r\n        // ignore missing frames\r\n      }\r\n    }\r\n\r\n    // fire-and-forget cleanup\r\n    (async () => {\r\n      try {\r\n        await fs.unlink(inputPath).catch(() => {});\r\n        for (let i = 1; i <= 4; i++) {\r\n          const framePath = `${tmpBase}-${String(i).padStart(2, \"0\")}.jpg`;\r\n          await fs.unlink(framePath).catch(() => {});\r\n        }\r\n      } catch {\r\n        // best-effort cleanup only\r\n      }\r\n    })();\r\n\r\n    if (frameDataUrls.length === 0) {\r\n      return NextResponse.json(\r\n        { error: \"Failed to extract frames from video.\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // ---- 3) Call OpenAI vision (gpt-4o-mini) ----\r\n    const systemPrompt =\r\n      [\r\n        \"You are VCA Virtual Coach, a tour-level golf coach AI.\",\r\n        \"You analyze golf swing images (P1–P9 style checkpoints) and return a concise but detailed SwingReport in JSON.\",\r\n        \"Your coaching DNA: Hartnett 'Golf for the Other 80%', McLean P-system, Butch Harmon ball-flight laws,\",\r\n        \"Dr. Kwon ground-force/sequencing, and light Dave Tutelman ball-flight/physics.\",\r\n        \"\",\r\n        \"JSON schema (SwingReport):\",\r\n        \"{\",\r\n        '  \"id\": string,',\r\n        '  \"createdAt\": string (ISO date),',\r\n        '  \"overallScore\": number (0–100),',\r\n        '  \"powerScore\": number (0–100),',\r\n        '  \"efficiencyScore\": number (0–100),',\r\n        '  \"consistencyScore\": number (0–100),',\r\n        '  \"dominantMiss\": string (e.g., \"slice\", \"push_fade\", \"hook\", \"pull\", etc.),',\r\n        '  \"summary\": string,',\r\n        '  \"issues\": [',\r\n        \"    {\",\r\n        '      \"id\": string,',\r\n        '      \"title\": string,',\r\n        '      \"severity\": \"low\" | \"medium\" | \"high\",',\r\n        '      \"position\": string,  // e.g. \"setup\", \"top_of_backswing\", \"downswing\", \"impact\", \"finish\"',\r\n        '      \"description\": string,',\r\n        '      \"drills\": string[]',\r\n        \"    }\",\r\n        \"  ],\",\r\n        '  \"practicePlanSummary\": string',\r\n        \"}\",\r\n        \"\",\r\n        \"Constraints:\",\r\n        \"- Use clear, simple, tour-tested language.\",\r\n        \"- Focus on 2–4 key issues and specific drills, not 15 random tips.\",\r\n        \"- Always respond with ONLY a JSON object matching SwingReport. No backticks, no extra text.\",\r\n      ].join(\" \");\r\n\r\n    const userTextPrompt =\r\n      \"These are frames from a golfer's swing. Identify the main swing pattern, key issues, and high-impact drills. \" +\r\n      \"Assume a reasonably skilled player unless the motion looks very beginner-ish. Return a SwingReport JSON object only.\";\r\n\r\n    const messages = [\r\n      {\r\n        role: \"system\",\r\n        content: systemPrompt,\r\n      },\r\n      {\r\n        role: \"user\",\r\n        content: [\r\n          { type: \"text\", text: userTextPrompt },\r\n          ...frameDataUrls.map((url) => ({\r\n            type: \"image_url\" as const,\r\n            image_url: { url },\r\n          })),\r\n        ],\r\n      },\r\n    ];\r\n\r\n    const openaiRes = await fetch(\"https://api.openai.com/v1/chat/completions\", {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        Authorization: `Bearer ${apiKey}`,\r\n      },\r\n      body: JSON.stringify({\r\n        model: \"gpt-4o-mini\",\r\n        response_format: { type: \"json_object\" },\r\n        messages,\r\n      }),\r\n    });\r\n\r\n    const rawText = await openaiRes.text();\r\n\r\n    if (!openaiRes.ok) {\r\n      console.error(\"OpenAI /chat/completions error:\", openaiRes.status, rawText);\r\n      return NextResponse.json(\r\n        { error: \"OpenAI API error.\", detail: rawText },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    let aiJson: any;\r\n    try {\r\n      aiJson = JSON.parse(rawText);\r\n    } catch (err) {\r\n      console.error(\"Failed to parse OpenAI outer JSON:\", err, rawText);\r\n      return NextResponse.json(\r\n        { error: \"Failed to parse OpenAI response (outer JSON).\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    const content = aiJson?.choices?.[0]?.message?.content;\r\n    if (!content) {\r\n      console.error(\"No content in OpenAI response:\", aiJson);\r\n      return NextResponse.json(\r\n        { error: \"No content returned from OpenAI.\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // When response_format: json_object is used, content is usually a JSON string.\r\n    let report: SwingReport;\r\n    try {\r\n      report =\r\n        typeof content === \"string\"\r\n          ? (JSON.parse(content) as SwingReport)\r\n          : (content as SwingReport);\r\n    } catch (err) {\r\n      console.error(\"Failed to parse SwingReport JSON:\", err, content);\r\n      return NextResponse.json(\r\n        { error: \"OpenAI returned invalid SwingReport JSON.\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    if (!report.id) report.id = `swing-${Date.now()}`;\r\n    if (!report.createdAt) report.createdAt = new Date().toISOString();\r\n\r\n    return NextResponse.json(report, { status: 200 });\r\n  } catch (err: any) {\r\n    console.error(\"Error in /api/swing-report:\", err);\r\n    return NextResponse.json(\r\n      { error: \"Internal server error.\", detail: String(err?.message || err) },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}
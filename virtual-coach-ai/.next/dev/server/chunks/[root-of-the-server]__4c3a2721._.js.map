{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///C:/Sites/virtual-coach-ai/virtual-coach-ai/src/app/api/swing-report/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { spawn } from \"child_process\";\r\nimport { promises as fs } from \"fs\";\r\nimport path from \"path\";\r\nimport { tmpdir } from \"os\";\r\nimport type { SwingReport } from \"@/types/swingReport\";\r\n\r\nexport const runtime = \"nodejs\";\r\n\r\ntype Severity = \"low\" | \"medium\" | \"high\";\r\n\r\nfunction safeParseJSON(str: string) {\r\n  try {\r\n    return JSON.parse(str);\r\n  } catch {\r\n    const repaired = str\r\n      .replace(/,\\s*}/g, \"}\")\r\n      .replace(/,\\s*]/g, \"]\")\r\n      .replace(/“|”/g, '\"')\r\n      .replace(/‘|’/g, \"'\");\r\n    return JSON.parse(repaired);\r\n  }\r\n}\r\n\r\nfunction runFfmpeg(args: string[]): Promise<void> {\r\n  return new Promise((resolve, reject) => {\r\n    const proc = spawn(\"ffmpeg\", args);\r\n\r\n    let stderr = \"\";\r\n    proc.stderr.on(\"data\", (d) => {\r\n      stderr += d.toString();\r\n    });\r\n\r\n    proc.on(\"error\", (err) => {\r\n      reject(err);\r\n    });\r\n\r\n    proc.on(\"close\", (code) => {\r\n      if (code !== 0) {\r\n        reject(new Error(`ffmpeg exited with code ${code}: ${stderr}`));\r\n      } else {\r\n        resolve();\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\nasync function extractFrames(videoPath: string, maxFrames = 4): Promise<string[]> {\r\n  const outDir = await fs.mkdtemp(path.join(tmpdir(), \"vca-frames-\"));\r\n  const pattern = path.join(outDir, \"frame-%02d.png\");\r\n\r\n  // 1 frame per second, up to maxFrames frames.\r\n  await runFfmpeg([\r\n    \"-y\",\r\n    \"-i\",\r\n    videoPath,\r\n    \"-vf\",\r\n    \"fps=1\",\r\n    \"-vframes\",\r\n    String(maxFrames),\r\n    pattern,\r\n  ]);\r\n\r\n  const files = (await fs.readdir(outDir))\r\n    .filter((f) => f.endsWith(\".png\"))\r\n    .sort();\r\n\r\n  const dataUrls: string[] = [];\r\n  for (const file of files) {\r\n    const full = path.join(outDir, file);\r\n    const buf = await fs.readFile(full);\r\n    const b64 = buf.toString(\"base64\");\r\n    dataUrls.push(`data:image/png;base64,${b64}`);\r\n  }\r\n\r\n  return dataUrls;\r\n}\r\n\r\n// Simple fallback sample report if there is no video in the request\r\nfunction buildSampleReport(): SwingReport {\r\n  const now = new Date().toISOString();\r\n  return {\r\n    createdAt: now,\r\n    overallScore: 75,\r\n    powerScore: 78,\r\n    efficiencyScore: 72,\r\n    consistencyScore: 74,\r\n    dominantMiss: \"push_fade\",\r\n    summary:\r\n      \"Sample swing: solid overall motion with a slight push-fade bias. Face and path are slightly mismatched, and low point control can tighten up.\",\r\n    issues: [\r\n      {\r\n        id: \"setup_alignment\",\r\n        title: \"Alignment and ball position\",\r\n        severity: \"medium\",\r\n        position: \"P1_setup\",\r\n        description:\r\n          \"Shoulders and feet are aimed a bit right of target, encouraging a push-fade pattern and inconsistent start lines.\",\r\n        drills: [\r\n          \"Stick drill: alignment stick on target line, second stick across toes.\",\r\n          \"3-ball gate drill to calibrate start line and curvature window.\",\r\n        ],\r\n      },\r\n      {\r\n        id: \"downswing_sequence\",\r\n        title: \"Downswing sequence\",\r\n        severity: \"high\",\r\n        position: \"P5_P6\",\r\n        description:\r\n          \"Upper body races the lower body from the top, making the shaft steep and forcing late face rotation.\",\r\n        drills: [\r\n          \"Pump-from-the-top drill: 3 small rehearsals then one full swing.\",\r\n          \"Step-change-of-direction drill to feel pressure shifting left before the arms fire.\",\r\n        ],\r\n      },\r\n    ],\r\n    practicePlanSummary:\r\n      \"Days 1–4: neutralize setup and aim using stick work. Days 5–10: rehearse transition sequence with pump drills and step-change moves. Days 11–14: on-course practice with one alignment key and one transition key only.\",\r\n  };\r\n}\r\n\r\nexport async function POST(req: NextRequest) {\r\n  const apiKey = process.env.OPENAI_API_KEY;\r\n\r\n  if (!apiKey) {\r\n    console.error(\"[swing-report] Missing OPENAI_API_KEY\");\r\n    return NextResponse.json(\r\n      { error: \"Server misconfigured: OPENAI_API_KEY is not set.\" },\r\n      { status: 500 },\r\n    );\r\n  }\r\n\r\n  try {\r\n    const contentType = req.headers.get(\"content-type\") || \"\";\r\n\r\n    // Two modes:\r\n    // 1) Multipart form with \"video\" -> real analysis\r\n    // 2) No body or non-multipart -> return sample report\r\n    if (!contentType.toLowerCase().startsWith(\"multipart/form-data\")) {\r\n      const sample = buildSampleReport();\r\n      return NextResponse.json(sample, { status: 200 });\r\n    }\r\n\r\n    const formData = await req.formData();\r\n    const file = formData.get(\"video\") as File | null;\r\n\r\n    if (!file) {\r\n      const sample = buildSampleReport();\r\n      return NextResponse.json(sample, { status: 200 });\r\n    }\r\n\r\n    // Write uploaded video to a temp file\r\n    const arrayBuffer = await file.arrayBuffer();\r\n    const buffer = Buffer.from(arrayBuffer);\r\n    const tempVideoPath = path.join(\r\n      tmpdir(),\r\n      `vca-swing-${Date.now()}-${file.name.replace(/[^\\w.-]/g, \"_\")}`,\r\n    );\r\n    await fs.writeFile(tempVideoPath, buffer);\r\n\r\n    // Grab a few frames using ffmpeg\r\n    const frameDataUrls = await extractFrames(tempVideoPath, 4);\r\n\r\n    if (frameDataUrls.length === 0) {\r\n      throw new Error(\"ffmpeg did not produce any frames.\");\r\n    }\r\n\r\n    // Build OpenAI vision request\r\n    const imageParts = frameDataUrls.map((url) => ({\r\n      type: \"image_url\" as const,\r\n      image_url: { url },\r\n    }));\r\n\r\n    const systemPrompt =\r\n      [\r\n        \"You are VCA Virtual Coach, a tour-level golf coach AI.\",\r\n        \"You analyze golf swing images (P1–P9 checkpoints) using Jim Hartnett style priorities,\",\r\n        \"Jim McLean’s P-system, Butch Harmon ball-flight logic, Dr. Kwon ground-force concepts,\",\r\n        \"and a light Dave Tutelman physics influence.\",\r\n        \"You coach for scoring, not pretty positions.\",\r\n        \"Return ONLY JSON that matches the SwingReport TypeScript interface:\",\r\n        \"{\",\r\n        '  \"createdAt\": \"string ISO\",',\r\n        '  \"overallScore\": number,',\r\n        '  \"powerScore\": number,',\r\n        '  \"efficiencyScore\": number,',\r\n        '  \"consistencyScore\": number,',\r\n        '  \"dominantMiss\": \"push\" | \"pull\" | \"slice\" | \"hook\" | \"push_slice\" | \"pull_hook\" | string,',\r\n        '  \"summary\": \"string\",',\r\n        '  \"issues\": [',\r\n        \"    {\",\r\n        '      \"id\": \"string\",',\r\n        '      \"title\": \"string\",',\r\n        '      \"severity\": \"low\" | \"medium\" | \"high\",',\r\n        '      \"position\": \"P1_setup\" | \"P2_takeaway\" | \"P3_early_set\" | \"P4_top\" | \"P5_transition\" | \"P6_delivery\" | \"P7_impact\" | \"P8_early_release\" | \"P9_finish\" | string,',\r\n        '      \"description\": \"string\",',\r\n        '      \"drills\": [\"string\"]',\r\n        \"    }\",\r\n        \"  ],\",\r\n        '  \"practicePlanSummary\": \"string\"',\r\n        \"}\",\r\n        \"Scores must be 0–100. Use clear, practical language.\",\r\n      ].join(\" \");\r\n\r\n    const userText =\r\n      \"These frames are from a single golf swing. \" +\r\n      \"Infer dominant miss pattern and key swing issues from setup through finish. \" +\r\n      \"Focus on 2–4 main issues, each tied to a position (P1–P9) and include simple drills. \" +\r\n      \"Return JSON only.\";\r\n\r\n    const openaiRes = await fetch(\"https://api.openai.com/v1/chat/completions\", {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        Authorization: `Bearer ${apiKey}`,\r\n      },\r\n      body: JSON.stringify({\r\n        model: \"gpt-4.1\",\r\n        response_format: { type: \"json_object\" },\r\n        messages: [\r\n          { role: \"system\", content: systemPrompt },\r\n          {\r\n            role: \"user\",\r\n            content: [\r\n              { type: \"text\", text: userText },\r\n              ...imageParts,\r\n            ],\r\n          },\r\n        ],\r\n      }),\r\n    });\r\n\r\n    if (!openaiRes.ok) {\r\n      const detail = await openaiRes.text().catch(() => \"\");\r\n      console.error(\"[swing-report] OpenAI API error:\", openaiRes.status, detail);\r\n      return NextResponse.json(\r\n        {\r\n          error: \"OpenAI API error.\",\r\n          detail: detail || `Status ${openaiRes.status}`,\r\n        },\r\n        { status: 500 },\r\n      );\r\n    }\r\n\r\n    const openaiJson = (await openaiRes.json()) as any;\r\n    const content: string | undefined =\r\n      openaiJson?.choices?.[0]?.message?.content;\r\n\r\n    if (!content) {\r\n      console.error(\"[swing-report] No content in OpenAI response:\", openaiJson);\r\n      return NextResponse.json(\r\n        { error: \"No content returned from AI.\" },\r\n        { status: 500 },\r\n      );\r\n    }\r\n\r\n    let parsed: SwingReport;\r\n    try {\r\n      parsed = safeParseJSON(content) as SwingReport;\r\n    } catch (err) {\r\n      console.error(\"[swing-report] Failed to parse AI JSON:\", err, content);\r\n      return NextResponse.json(\r\n        { error: \"AI returned invalid JSON.\", raw: content },\r\n        { status: 500 },\r\n      );\r\n    }\r\n\r\n    // Normalize a few fields\r\n    if (!parsed.createdAt) parsed.createdAt = new Date().toISOString();\r\n    if (typeof parsed.overallScore !== \"number\") parsed.overallScore = 70;\r\n    if (typeof parsed.powerScore !== \"number\") parsed.powerScore = 70;\r\n    if (typeof parsed.efficiencyScore !== \"number\") parsed.efficiencyScore = 70;\r\n    if (typeof parsed.consistencyScore !== \"number\") parsed.consistencyScore = 70;\r\n\r\n    return NextResponse.json(parsed, { status: 200 });\r\n  } catch (err: any) {\r\n    console.error(\"[swing-report] Internal error:\", err);\r\n    return NextResponse.json(\r\n      { error: err?.message || \"Internal server error.\" },\r\n      { status: 500 },\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}
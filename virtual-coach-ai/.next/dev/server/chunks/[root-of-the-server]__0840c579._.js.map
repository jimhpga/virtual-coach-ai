{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 88, "column": 0}, "map": {"version":3,"sources":["file:///C:/Sites/virtual-coach-ai/virtual-coach-ai/src/app/api/swing-report/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport ffmpeg from \"fluent-ffmpeg\";\r\nimport ffmpegPath from \"ffmpeg-static\";\r\nimport fs from \"fs\";\r\nimport os from \"os\";\r\nimport path from \"path\";\r\n\r\nexport const runtime = \"nodejs\";\r\n\r\n// Tell fluent-ffmpeg where ffmpeg lives\r\nif (ffmpegPath) {\r\n  ffmpeg.setFfmpegPath(ffmpegPath);\r\n}\r\n\r\n// ---- Types that match src/types/swingReport.ts (keep in sync) ----\r\ntype SwingIssue = {\r\n  id: string;\r\n  title: string;\r\n  position:\r\n    | \"setup\"\r\n    | \"takeaway\"\r\n    | \"backswing\"\r\n    | \"top\"\r\n    | \"downswing\"\r\n    | \"impact\"\r\n    | \"release\"\r\n    | \"finish\";\r\n  severity: \"low\" | \"medium\" | \"high\";\r\n  description: string;\r\n  drills: string[];\r\n};\r\n\r\ntype SwingReport = {\r\n  createdAt: string;\r\n  overallScore: number;\r\n  powerScore: number;\r\n  efficiencyScore: number;\r\n  consistencyScore: number;\r\n  dominantMiss: string;\r\n  summary: string;\r\n  issues: SwingIssue[];\r\n  practicePlanSummary: string;\r\n};\r\n\r\n// Simple JSON repair just in case the AI returns commas/trailing stuff\r\nfunction safeParseJSON(str: string) {\r\n  try {\r\n    return JSON.parse(str);\r\n  } catch {\r\n    const repaired = str\r\n      .replace(/,\\s*}/g, \"}\")\r\n      .replace(/,\\s*]/g, \"]\")\r\n      .replace(/“|”/g, '\"')\r\n      .replace(/‘|’/g, \"'\");\r\n    return JSON.parse(repaired);\r\n  }\r\n}\r\n\r\n// Extract a few JPEG frames from a temp video file and return base64 strings\r\nasync function extractFrames(videoPath: string): Promise<string[]> {\r\n  return new Promise((resolve, reject) => {\r\n    const tmpDir = fs.mkdtempSync(path.join(os.tmpdir(), \"swing-frames-\"));\r\n    const timestamps = [\"10%\", \"50%\", \"90%\"]; // early / mid / late\r\n    const framePaths: string[] = [];\r\n\r\n    ffmpeg(videoPath)\r\n      .on(\"end\", () => {\r\n        try {\r\n          const framesBase64 = framePaths.map((fp) => {\r\n            const buf = fs.readFileSync(fp);\r\n            const b64 = buf.toString(\"base64\");\r\n            fs.unlinkSync(fp);\r\n            return `data:image/jpeg;base64,${b64}`;\r\n          });\r\n          fs.rmSync(tmpDir, { recursive: true, force: true });\r\n          resolve(framesBase64);\r\n        } catch (err) {\r\n          reject(err);\r\n        }\r\n      })\r\n      .on(\"error\", (err) => {\r\n        reject(err);\r\n      })\r\n      .screenshots({\r\n        timestamps,\r\n        filename: \"frame-%i.jpg\",\r\n        folder: tmpDir,\r\n        size: \"720x? \",\r\n      });\r\n\r\n    // We don't get file names until ffmpeg runs, so we glob by pattern\r\n    // after it finishes in the 'end' handler above.\r\n    fs.readdir(tmpDir, (err, files) => {\r\n      if (!err && files) {\r\n        files\r\n          .filter((f) => f.startsWith(\"frame-\") && f.endsWith(\".jpg\"))\r\n          .forEach((f) => framePaths.push(path.join(tmpDir, f)));\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\n// ------ MAIN HANDLER ------\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const apiKey = process.env.OPENAI_API_KEY;\r\n    if (!apiKey) {\r\n      return NextResponse.json(\r\n        { error: \"OPENAI_API_KEY is not set on the server.\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // Try to read FormData (video upload). If none is present,\r\n    // fall back to a static sample report so the button still works.\r\n    let file: File | null = null;\r\n    try {\r\n      const formData = await req.formData();\r\n      const maybeFile = formData.get(\"video\");\r\n      if (maybeFile instanceof File) {\r\n        file = maybeFile;\r\n      }\r\n    } catch {\r\n      // not multipart / no file – we'll handle below\r\n    }\r\n\r\n    // No video provided: return a sample report (so \"See sample report\" still works)\r\n    if (!file) {\r\n      const sample: SwingReport = {\r\n        createdAt: new Date().toISOString(),\r\n        overallScore: 78,\r\n        powerScore: 80,\r\n        efficiencyScore: 76,\r\n        consistencyScore: 75,\r\n        dominantMiss: \"push_fade\",\r\n        summary:\r\n          \"Sample report: solid motion with slight push-fade pattern. Good athletic pivot with a few cleanup items around setup, takeaway, and delivery.\",\r\n        issues: [\r\n          {\r\n            id: \"setup_alignment\",\r\n            title: \"Setup alignment a touch open\",\r\n            position: \"setup\",\r\n            severity: \"medium\",\r\n            description:\r\n              \"Feet and shoulders sit a hair open to the target, which tends to send your baseline start line right of where you think you’re aimed.\",\r\n            drills: [\r\n              \"Alignment stick routine: one stick on target line, one across toes for 10 balls per session.\",\r\n              \"Ball position checkpoint: mark mid-iron and driver ball positions on the mat.\",\r\n            ],\r\n          },\r\n          {\r\n            id: \"club_steep_down\",\r\n            title: \"Slightly steep delivery with face open\",\r\n            position: \"downswing\",\r\n            severity: \"high\",\r\n            description:\r\n              \"Club drifts a bit steep into the ball with the face slightly open, which produces the push-fade when tempo gets quick.\",\r\n            drills: [\r\n              \"Lead wrist flex drill: three-quarter swings focusing on flatter lead wrist at shaft-parallel in the downswing.\",\r\n              \"Pump drill from P5–P6 feeling more depth and side-bend before releasing the club.\",\r\n            ],\r\n          },\r\n        ],\r\n        practicePlanSummary:\r\n          \"Days 1–4: rebuild alignment and ball position. Days 5–10: mix takeaway shallowing and lead-wrist drills in slow reps. Days 11–14: take it to the course with one clear key – setup, then shallower delivery.\",\r\n      };\r\n\r\n      return NextResponse.json(sample, { status: 200 });\r\n    }\r\n\r\n    // We have a real video file – save it temporarily\r\n    const bytes = Buffer.from(await file.arrayBuffer());\r\n    const tmpVideoPath = path.join(\r\n      os.tmpdir(),\r\n      `swing-upload-${Date.now()}.mp4`\r\n    );\r\n    fs.writeFileSync(tmpVideoPath, bytes);\r\n\r\n    // Extract 2–3 frames as base64 images\r\n    const frameDataUrls = await extractFrames(tmpVideoPath).catch((err) => {\r\n      console.error(\"Frame extraction failed:\", err);\r\n      return [] as string[];\r\n    });\r\n\r\n    // Clean up video file\r\n    try {\r\n      fs.unlinkSync(tmpVideoPath);\r\n    } catch {\r\n      // ignore\r\n    }\r\n\r\n    // Build an OpenAI vision prompt using the extracted frames\r\n    const systemPrompt =\r\n      [\r\n        \"You are VCA Virtual Coach, a tour-level golf coach AI.\",\r\n        \"Your coaching DNA blends Jim Hartnett’s 'Golf for the Other 80%' priority stack and simple scoring language,\",\r\n        \"Jim McLean’s P-system / Eight Step Swing / corridors of success and fault-tree testing,\",\r\n        \"Butch Harmon’s ball-flight laws and 'don’t wreck what works' philosophy,\",\r\n        \"Dr. Kwon’s ground-force and sequencing concepts,\",\r\n        \"and a light layer of Dave Tutelman’s golf-physics perspective.\",\r\n        \"You coach for scoring, not pretty positions. Fewer, bigger priorities.\",\r\n        \"From a few swing frames, infer the player’s dominant miss, key motion patterns, and produce a concise SwingReport JSON.\",\r\n      ].join(\" \");\r\n\r\n    const userText =\r\n      \"You are looking at a single golf swing. Analyze setup, backswing, top, downswing, impact, and finish. \" +\r\n      \"Infer the most likely miss pattern (slice, hook, push, pull, etc.) and the biggest 2–4 motion issues that affect ball flight and contact. \" +\r\n      \"Give very practical drills. Return ONLY valid JSON matching the SwingReport type I describe.\";\r\n\r\n    // Build the vision message: text + images (frames)\r\n    const content: any[] = [{ type: \"text\", text: userText }];\r\n\r\n    for (const url of frameDataUrls) {\r\n      content.push({\r\n        type: \"image_url\",\r\n        image_url: { url, detail: \"low\" },\r\n      });\r\n    }\r\n\r\n    const openaiRes = await fetch(\"https://api.openai.com/v1/chat/completions\", {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        Authorization: `Bearer ${apiKey}`,\r\n      },\r\n      body: JSON.stringify({\r\n        model: \"gpt-4.1\",\r\n        response_format: { type: \"json_object\" },\r\n        messages: [\r\n          { role: \"system\", content: systemPrompt },\r\n          {\r\n            role: \"user\",\r\n            content,\r\n          },\r\n          {\r\n            role: \"user\",\r\n            content:\r\n              \"The JSON shape you must return is: \" +\r\n              JSON.stringify(\r\n                {\r\n                  createdAt: \"string\",\r\n                  overallScore: 0,\r\n                  powerScore: 0,\r\n                  efficiencyScore: 0,\r\n                  consistencyScore: 0,\r\n                  dominantMiss: \"string\",\r\n                  summary: \"string\",\r\n                  issues: [\r\n                    {\r\n                      id: \"string\",\r\n                      title: \"string\",\r\n                      position: \"setup | takeaway | backswing | top | downswing | impact | release | finish\",\r\n                      severity: \"low | medium | high\",\r\n                      description: \"string\",\r\n                      drills: [\"string\"],\r\n                    },\r\n                  ],\r\n                  practicePlanSummary: \"string\",\r\n                },\r\n                null,\r\n                0\r\n              ),\r\n          },\r\n        ],\r\n      }),\r\n    });\r\n\r\n    if (!openaiRes.ok) {\r\n      const text = await openaiRes.text();\r\n      console.error(\"OpenAI API error:\", openaiRes.status, text);\r\n      return NextResponse.json(\r\n        { error: \"OpenAI API error.\", detail: text },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    const openaiJson = (await openaiRes.json()) as any;\r\n    const contentStr: string | undefined =\r\n      openaiJson?.choices?.[0]?.message?.content;\r\n\r\n    if (!contentStr) {\r\n      console.error(\"No content in OpenAI response:\", openaiJson);\r\n      return NextResponse.json(\r\n        { error: \"No content returned from AI.\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    let parsed: SwingReport;\r\n    try {\r\n      parsed = safeParseJSON(contentStr) as SwingReport;\r\n    } catch (err) {\r\n      console.error(\"Failed to parse AI JSON:\", err, contentStr);\r\n      return NextResponse.json(\r\n        { error: \"AI returned invalid JSON.\", raw: contentStr },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // Normalize createdAt if missing\r\n    if (!parsed.createdAt) {\r\n      parsed.createdAt = new Date().toISOString();\r\n    }\r\n\r\n    return NextResponse.json(parsed, { status: 200 });\r\n  } catch (err) {\r\n    console.error(\"Error in /api/swing-report:\", err);\r\n    return NextResponse.json(\r\n      { error: \"Internal server error.\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}
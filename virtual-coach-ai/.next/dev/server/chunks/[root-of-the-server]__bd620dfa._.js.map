{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///C:/Sites/virtual-coach-ai/virtual-coach-ai/src/app/api/swing-report/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport type { SwingReport } from \"@/types/swingReport\";\r\nimport { execFile } from \"child_process\";\r\nimport { promisify } from \"util\";\r\nimport fs from \"fs/promises\";\r\nimport path from \"path\";\r\n\r\nexport const runtime = \"nodejs\";\r\n\r\nconst execFileAsync = promisify(execFile);\r\n\r\nfunction safeParseJSON(str: string) {\r\n  try {\r\n    return JSON.parse(str);\r\n  } catch {\r\n    const repaired = str\r\n      .replace(/,\\s*}/g, \"}\")\r\n      .replace(/,\\s*]/g, \"]\")\r\n      .replace(/“|”/g, '\"')\r\n      .replace(/‘|’/g, \"'\");\r\n    return JSON.parse(repaired);\r\n  }\r\n}\r\n\r\n// --- SAMPLE REPORT FALLBACK (for \"See sample report\" button) ---\r\nconst SAMPLE_REPORT: SwingReport = {\r\n  createdAt: new Date().toISOString(),\r\n  overallScore: 76,\r\n  powerScore: 80,\r\n  efficiencyScore: 70,\r\n  consistencyScore: 72,\r\n  dominantMiss: \"push_fade\",\r\n  summary:\r\n    \"Sample report: solid motion with enough speed, but face and path slightly mismatched, giving you a gentle push–fade. Clean up setup, takeaway depth, and delivery so you can tighten start lines and control curve without losing your natural move.\",\r\n  issues: [\r\n    {\r\n      id: \"open_face_top\",\r\n      title: \"Open clubface at the top\",\r\n      severity: \"high\",\r\n      position: \"top\",\r\n      description:\r\n        \"At the top, the clubface is considerably more open than your lead forearm, making it difficult to square at impact and causing a rightward start line and curve.\",\r\n      drills: [\r\n        \"Lead wrist bow drill: At the top, rehearse flattening or slightly bowing the lead wrist to match clubface to forearm.\",\r\n        \"Stick-on-forearm drill: Place a stick along your lead arm and match clubface angle to the stick at the top.\",\r\n      ],\r\n    },\r\n    {\r\n      id: \"steep_down\",\r\n      title: \"Steep downswing with little face control\",\r\n      severity: \"high\",\r\n      position: \"downswing\",\r\n      description:\r\n        \"Club shaft gets too steep on the way down, and the face hangs open. That mix sends the ball starting right with a soft fade and occasional wipe–slice.\",\r\n      drills: [\r\n        \"Wall or chair depth drill: rehearse takeaway so the handle works in while the clubhead stays in front.\",\r\n        \"Lead wrist tilt drill: three-quarter swings focusing on modest forward shaft lean with a quieter handle exit.\",\r\n      ],\r\n    },\r\n    {\r\n      id: \"strike_high\",\r\n      title: \"Strike pattern too high on the face\",\r\n      severity: \"medium\",\r\n      position: \"impact\",\r\n      description:\r\n        \"Contact tends to live slightly high on the clubface, costing ball speed and flattening launch. Combined with the open face it robs you of distance even when the ball finishes in play.\",\r\n      drills: [\r\n        \"Impact tape or dry-erase dot on the face for 10–15 balls, aiming to stack strikes around the center.\",\r\n        \"Tee-height ladder drill: Alternate low/normal tee heights to train centered contact.\",\r\n      ],\r\n    },\r\n    {\r\n      id: \"finish_balance\",\r\n      title: \"Finish balance under pressure\",\r\n      severity: \"low\",\r\n      position: \"finish\",\r\n      description:\r\n        \"On routine swings your finish is solid, but under pressure you tend to stand up early and lose your posted left side. That’s more of a scoring tendency issue than a mechanics disaster.\",\r\n      drills: [\r\n        \"3-second hold drill: every shot in practice, freeze your finish until the ball lands.\",\r\n        \"Pressure ladder: hit 3-ball sets with small targets and hold your finish on every swing.\",\r\n      ],\r\n    },\r\n  ],\r\n  practicePlanSummary:\r\n    \"Sample 14-day plan: first four days on setup and face control with slow, feedback-rich reps. Days 5–10 blend shallow-and-square delivery with strike work. Days 11–14 take it to the course with one setup key and one delivery key, aiming at windows, not perfect mechanics.\",\r\n};\r\n\r\n// Build the vision prompt for the AI\r\nfunction buildVisionPrompt() {\r\n  return `\r\nYou are VCA Virtual Coach, a tour-level golf coach AI.\r\n\r\nYou are analyzing a golf swing from 4–6 still frames taken from a face-on or down-the-line video.\r\nBlend the influence of:\r\n- Jim Hartnett (\"Golf for the Other 80%\"): simple, priority-based, scoring-focused coaching.\r\n- Jim McLean: P-system checkpoints, corridors of success, fault-tree thinking.\r\n- Butch Harmon: ball-flight laws and \"don’t wreck what already works\".\r\n- Dr. Kwon: ground-force and sequencing.\r\n- Dave Tutelman: light golf-physics influence (spin loft, face/path, gear effect, strike).\r\n\r\nThe goal:\r\n- Identify the main ball-flight tendencies and delivery pattern.\r\n- Find a short list of 2–3 high-leverage priorities.\r\n- Suggest simple, realistic drills a normal golfer can actually do.\r\n\r\nReturn ONLY valid JSON matching this TypeScript interface:\r\n\r\ninterface SwingReport {\r\n  createdAt: string;\r\n  overallScore: number;\r\n  powerScore: number;\r\n  efficiencyScore: number;\r\n  consistencyScore: number;\r\n  dominantMiss: string;\r\n  summary: string;\r\n  issues: {\r\n    id: string;\r\n    title: string;\r\n    severity: \"low\" | \"medium\" | \"high\";\r\n    position:\r\n      | \"setup\"\r\n      | \"backswing\"\r\n      | \"top\"\r\n      | \"transition\"\r\n      | \"downswing\"\r\n      | \"impact\"\r\n      | \"finish\";\r\n    description: string;\r\n    drills: string[];\r\n  }[];\r\n  practicePlanSummary: string;\r\n}\r\n\r\nGuidelines:\r\n- Scores must be between 0 and 100.\r\n- Use 3–5 issues, each with 2–4 concise drills.\r\n- dominantMiss should be a short label like \"push_slice\", \"pull_hook\", \"thin\", \"fat\", etc.\r\n- Use plain, tour-style but clear language.\r\n- Return JSON only, no backticks or commentary.\r\n`.trim();\r\n}\r\n\r\n// Read frames produced by ffmpeg and return an array of base64 strings\r\nasync function extractFramesToBase64(inputPath: string): Promise<string[]> {\r\n  const tmpDir = path.dirname(inputPath);\r\n  const framePattern = path.join(tmpDir, \"frame-%02d.jpg\");\r\n\r\n  // Grab up to 4 frames spread over the clip\r\n  await execFileAsync(\"ffmpeg\", [\r\n    \"-y\",\r\n    \"-i\",\r\n    inputPath,\r\n    \"-vf\",\r\n    \"fps=4,scale=640:-1\",\r\n    \"-vframes\",\r\n    \"4\",\r\n    framePattern,\r\n  ]);\r\n\r\n  const frames: string[] = [];\r\n  for (let i = 1; i <= 4; i++) {\r\n    const framePath = path.join(tmpDir, `frame-0${i}.jpg`);\r\n    try {\r\n      const buf = await fs.readFile(framePath);\r\n      frames.push(buf.toString(\"base64\"));\r\n    } catch {\r\n      // If fewer frames exist, just stop.\r\n      break;\r\n    }\r\n  }\r\n  return frames;\r\n}\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const apiKey = process.env.OPENAI_API_KEY;\r\n    if (!apiKey) {\r\n      console.error(\"OPENAI_API_KEY is not set on the server.\");\r\n      return NextResponse.json(\r\n        { error: \"Server misconfiguration: missing OpenAI API key.\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    const contentType = req.headers.get(\"content-type\") || \"\";\r\n\r\n    // If this is NOT multipart/form-data, treat it as \"see sample report\"\r\n    if (!contentType.includes(\"multipart/form-data\")) {\r\n      const sample = { ...SAMPLE_REPORT, createdAt: new Date().toISOString() };\r\n      return NextResponse.json(sample, { status: 200 });\r\n    }\r\n\r\n    // --- Handle real video upload ---\r\n    const formData = await req.formData().catch(() => null);\r\n    const file = formData?.get(\"video\") as File | null;\r\n\r\n    if (!file || typeof (file as any).arrayBuffer !== \"function\") {\r\n      return NextResponse.json(\r\n        { error: \"No video file received in 'video' field.\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Save uploaded video to a temp file\r\n    const arrayBuffer = await file.arrayBuffer();\r\n    const buffer = Buffer.from(arrayBuffer);\r\n\r\n    const tmpRoot = path.join(process.cwd(), \".tmp-swing\");\r\n    await fs.mkdir(tmpRoot, { recursive: true });\r\n\r\n    const inputPath = path.join(tmpRoot, `swing-${Date.now()}.mp4`);\r\n    await fs.writeFile(inputPath, buffer);\r\n\r\n    // Extract frames with ffmpeg\r\n    const framesBase64 = await extractFramesToBase64(inputPath);\r\n\r\n    if (framesBase64.length === 0) {\r\n      console.error(\"ffmpeg produced no frames\");\r\n      return NextResponse.json(\r\n        { error: \"Failed to extract frames from video.\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // Build vision messages\r\n    const systemPrompt = buildVisionPrompt();\r\n\r\n    const imageParts = framesBase64.map((b64) => ({\r\n      type: \"image_url\" as const,\r\n      image_url: {\r\n        url: `data:image/jpeg;base64,${b64}`,\r\n      },\r\n    }));\r\n\r\n    const openaiRes = await fetch(\"https://api.openai.com/v1/chat/completions\", {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        Authorization: `Bearer ${apiKey}`,\r\n      },\r\n      body: JSON.stringify({\r\n        model: \"gpt-4.1-mini\",\r\n        response_format: { type: \"json_object\" },\r\n        messages: [\r\n          {\r\n            role: \"system\",\r\n            content: systemPrompt,\r\n          },\r\n          {\r\n            role: \"user\",\r\n            content: [\r\n              {\r\n                type: \"text\",\r\n                text: \"Analyze this player's full swing from these frames and generate a SwingReport JSON object.\",\r\n              },\r\n              ...imageParts,\r\n            ],\r\n          },\r\n        ],\r\n      }),\r\n    });\r\n\r\n    if (!openaiRes.ok) {\r\n      const text = await openaiRes.text();\r\n      console.error(\"OpenAI API error:\", openaiRes.status, text);\r\n      return NextResponse.json(\r\n        { error: \"OpenAI API error.\", detail: text },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    const openaiJson = (await openaiRes.json()) as any;\r\n    const content: string | undefined =\r\n      openaiJson?.choices?.[0]?.message?.content;\r\n\r\n    if (!content) {\r\n      console.error(\"No content in OpenAI response:\", openaiJson);\r\n      return NextResponse.json(\r\n        { error: \"No content returned from AI.\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    let parsed: SwingReport;\r\n    try {\r\n      parsed = safeParseJSON(content) as SwingReport;\r\n    } catch (err) {\r\n      console.error(\"Failed to parse AI JSON:\", err, content);\r\n      return NextResponse.json(\r\n        { error: \"AI returned invalid JSON.\", raw: content },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // Normalize required fields\r\n    if (!parsed.createdAt) parsed.createdAt = new Date().toISOString();\r\n\r\n    return NextResponse.json(parsed, { status: 200 });\r\n  } catch (err: any) {\r\n    console.error(\"Error in /api/swing-report:\", err);\r\n    return NextResponse.json(\r\n      { error: \"Internal server error.\", detail: String(err?.message || err) },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}
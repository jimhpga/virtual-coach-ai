{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Sites/virtual-coach-ai/virtual-coach-ai/src/app/api/full-swing-report/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport OpenAI from \"openai\";\r\n\r\nconst client = new OpenAI({\r\n  apiKey: process.env.OPENAI_API_KEY,\r\n});\r\n\r\nexport const runtime = \"nodejs\";\r\n\r\ntype ReportCheckpoint = {\r\n  id: string;\r\n  label: string;\r\n  status: \"ON_TRACK\" | \"NEEDS_ATTENTION\" | \"PRIORITY\";\r\n  phase: string;\r\n  coachNotes: string;\r\n  commonMisses: string[];\r\n  keyDrills: string[];\r\n};\r\n\r\ntype FullSwingReport = {\r\n  playerOverview: string;\r\n  scores: {\r\n    overall: number;\r\n    power: number;\r\n    reliability: number;\r\n    consistency: number;\r\n  };\r\n  strengths: string[];\r\n  leaks: string[];\r\n  topFixes: string[];\r\n  checkpoints: ReportCheckpoint[];\r\n  practicePlan14Day: string[];\r\n};\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const body = await req.json().catch(() => ({}));\r\n    const {\r\n      playerName = \"Player\",\r\n      age = \"\",\r\n      handicap = \"\",\r\n      typicalBallFlight = \"\",\r\n      typicalMiss = \"\",\r\n      goals = \"\",\r\n      notes = \"\",\r\n    } = body || {};\r\n\r\n    const userSummary = `\r\nPlayer name: ${playerName}\r\nAge: ${age}\r\nHandicap / scoring: ${handicap}\r\nTypical ball flight: ${typicalBallFlight}\r\nTypical miss: ${typicalMiss}\r\nGoals: ${goals}\r\nExtra notes from player or coach: ${notes}\r\n`.trim();\r\n\r\n    const systemPrompt = `\r\nYou are an experienced golf coach creating a structured full-swing report for a serious amateur player.\r\n\r\n***VOICE & TONE***\r\n- Talk like a coach to one player.\r\n- Direct, positive, honest.\r\n- Short sentences, but real detail.\r\n- Talk to the player as \"you\".\r\n\r\n***P1–P9 CHECKPOINTS***\r\nYou MUST create EXACTLY 9 checkpoints mapped to:\r\n\r\nP1 – Setup / address  \r\nP2 – Takeaway  \r\nP3 – Lead arm parallel / early backswing  \r\nP4 – Top of backswing  \r\nP5 – Early downswing  \r\nP6 – Delivery position (shaft parallel on downswing)  \r\nP7 – Impact  \r\nP8 – Early follow-through  \r\nP9 – Finish / full follow-through  \r\n\r\nEach checkpoint's \"phase\" should read like \"P3 – Lead arm parallel / early backswing\".\r\n\r\n***JSON SHAPE (ONLY JSON, NO MARKDOWN)***\r\n\r\n{\r\n  \"playerOverview\": string,\r\n  \"scores\": {\r\n    \"overall\": number,\r\n    \"power\": number,\r\n    \"reliability\": number,\r\n    \"consistency\": number\r\n  },\r\n  \"strengths\": string[],\r\n  \"leaks\": string[],\r\n  \"topFixes\": string[],\r\n  \"checkpoints\": [\r\n    {\r\n      \"id\": string,\r\n      \"label\": string,\r\n      \"status\": \"ON_TRACK\" | \"NEEDS_ATTENTION\" | \"PRIORITY\",\r\n      \"phase\": string,\r\n      \"coachNotes\": string,\r\n      \"commonMisses\": string[],\r\n      \"keyDrills\": string[]\r\n    }\r\n  ],\r\n  \"practicePlan14Day\": string[]\r\n}\r\n\r\n***LENGTH & CONTENT RULES***\r\n\r\nPlayer overview:\r\n- 2 short paragraphs.\r\n- 8–12 sentences total.\r\n- Paragraph 1: clear picture of where their game is now (ball flight, miss, strengths, typical patterns).\r\n- Paragraph 2: HOW you will help them get better – the main priorities, what to focus on, and what it should do for their ball flight and scoring.\r\n\r\nCheckpoints (P1–P9):\r\n- \"coachNotes\": 3–5 sentences each.\r\n- Explain what you see now, what “good” looks like, and 1–2 feels to chase.\r\n- Tie to ball flight/contact whenever it makes sense.\r\n\r\nStrengths / leaks / top fixes:\r\n- \"strengths\": 3–5 specific bullets.\r\n- \"leaks\": 3–5 bullets showing where they lose strokes.\r\n- \"topFixes\": EXACTLY 3 items in priority order – these are the three biggest \"power moves\".\r\n\r\nPractice plan:\r\n- 12–14 one-line items, each a realistic 15–20 minute session.\r\n\r\nScores (VERY IMPORTANT):\r\n- Think of a typical serious amateur. Most scores should land between 45 and 85.\r\n- \"overall\" roughly reflects their mix of strengths and leaks.\r\n- \"power\" is about distance potential and quality of strike.\r\n- \"reliability\" is about how repeatable the motion is under pressure.\r\n- \"consistency\" is about controlling start line, curve, and contact.\r\n- DO NOT hand out 90+ unless you clearly describe an elite-level pattern.\r\n- Make sure the scores match the story you tell. If you say reliability is a weakness, keep that number lower (for example 45–65).\r\n`.trim();\r\n\r\n    const userPrompt = `\r\nUsing this player context, generate a full swing report in JSON only:\r\n\r\n${userSummary}\r\n`.trim();\r\n\r\n    const response = await client.responses.create({\r\n      model: \"gpt-4.1-mini\",\r\n      input: [\r\n        { role: \"system\", content: systemPrompt },\r\n        { role: \"user\", content: userPrompt },\r\n      ],\r\n    });\r\n\r\n    const first = response.output[0];\r\n    let rawText = \"\";\r\n\r\n    if (first.type === \"message\") {\r\n      const contentItem = (first as any).content.find(\r\n        (c: any) => c.type === \"output_text\"\r\n      );\r\n      if (contentItem?.text) {\r\n        rawText = contentItem.text;\r\n      }\r\n    }\r\n\r\n    if (!rawText) {\r\n      throw new Error(\"No text returned from model\");\r\n    }\r\n\r\n    rawText = rawText.trim();\r\n    if (rawText.startsWith(\"```\")) {\r\n      rawText = rawText.replace(/```json/i, \"\").replace(/```$/, \"\").trim();\r\n    }\r\n\r\n    let report: FullSwingReport;\r\n\r\n    try {\r\n      report = JSON.parse(rawText);\r\n    } catch (err) {\r\n      console.error(\"Failed to parse JSON from model:\", rawText);\r\n      throw new Error(\"Model did not return valid JSON\");\r\n    }\r\n\r\n    // Safety: enforce exactly 9 checkpoints (P1–P9)\r\n    if (report.checkpoints.length > 9) {\r\n      report.checkpoints = report.checkpoints.slice(0, 9);\r\n    } else if (report.checkpoints.length < 9) {\r\n      while (report.checkpoints.length < 9) {\r\n        const idx = report.checkpoints.length + 1;\r\n        report.checkpoints.push({\r\n          id: `p${idx}`,\r\n          label: `Checkpoint P${idx}`,\r\n          status: \"NEEDS_ATTENTION\",\r\n          phase: `P${idx}`,\r\n          coachNotes:\r\n            \"Placeholder checkpoint added to keep the report structure consistent.\",\r\n          commonMisses: [],\r\n          keyDrills: [],\r\n        });\r\n      }\r\n    }\r\n\r\n    return NextResponse.json({ ok: true, report });\r\n  } catch (err: any) {\r\n    console.error(\"full-swing-report error:\", err);\r\n    return NextResponse.json(\r\n      { ok: false, error: err?.message || \"Unknown error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AAAA;;;AAEA,MAAM,SAAS,IAAI,mLAAM,CAAC;IACxB,QAAQ,QAAQ,GAAG,CAAC,cAAc;AACpC;AAEO,MAAM,UAAU;AA2BhB,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;QAC7C,MAAM,EACJ,aAAa,QAAQ,EACrB,MAAM,EAAE,EACR,WAAW,EAAE,EACb,oBAAoB,EAAE,EACtB,cAAc,EAAE,EAChB,QAAQ,EAAE,EACV,QAAQ,EAAE,EACX,GAAG,QAAQ,CAAC;QAEb,MAAM,cAAc,CAAC;aACZ,EAAE,WAAW;KACrB,EAAE,IAAI;oBACS,EAAE,SAAS;qBACV,EAAE,kBAAkB;cAC3B,EAAE,YAAY;OACrB,EAAE,MAAM;kCACmB,EAAE,MAAM;AAC1C,CAAC,CAAC,IAAI;QAEF,MAAM,eAAe,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAgF1B,CAAC,CAAC,IAAI;QAEF,MAAM,aAAa,CAAC;;;AAGxB,EAAE,YAAY;AACd,CAAC,CAAC,IAAI;QAEF,MAAM,WAAW,MAAM,OAAO,SAAS,CAAC,MAAM,CAAC;YAC7C,OAAO;YACP,OAAO;gBACL;oBAAE,MAAM;oBAAU,SAAS;gBAAa;gBACxC;oBAAE,MAAM;oBAAQ,SAAS;gBAAW;aACrC;QACH;QAEA,MAAM,QAAQ,SAAS,MAAM,CAAC,EAAE;QAChC,IAAI,UAAU;QAEd,IAAI,MAAM,IAAI,KAAK,WAAW;YAC5B,MAAM,cAAc,AAAC,MAAc,OAAO,CAAC,IAAI,CAC7C,CAAC,IAAW,EAAE,IAAI,KAAK;YAEzB,IAAI,aAAa,MAAM;gBACrB,UAAU,YAAY,IAAI;YAC5B;QACF;QAEA,IAAI,CAAC,SAAS;YACZ,MAAM,IAAI,MAAM;QAClB;QAEA,UAAU,QAAQ,IAAI;QACtB,IAAI,QAAQ,UAAU,CAAC,QAAQ;YAC7B,UAAU,QAAQ,OAAO,CAAC,YAAY,IAAI,OAAO,CAAC,QAAQ,IAAI,IAAI;QACpE;QAEA,IAAI;QAEJ,IAAI;YACF,SAAS,KAAK,KAAK,CAAC;QACtB,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,oCAAoC;YAClD,MAAM,IAAI,MAAM;QAClB;QAEA,gDAAgD;QAChD,IAAI,OAAO,WAAW,CAAC,MAAM,GAAG,GAAG;YACjC,OAAO,WAAW,GAAG,OAAO,WAAW,CAAC,KAAK,CAAC,GAAG;QACnD,OAAO,IAAI,OAAO,WAAW,CAAC,MAAM,GAAG,GAAG;YACxC,MAAO,OAAO,WAAW,CAAC,MAAM,GAAG,EAAG;gBACpC,MAAM,MAAM,OAAO,WAAW,CAAC,MAAM,GAAG;gBACxC,OAAO,WAAW,CAAC,IAAI,CAAC;oBACtB,IAAI,CAAC,CAAC,EAAE,KAAK;oBACb,OAAO,CAAC,YAAY,EAAE,KAAK;oBAC3B,QAAQ;oBACR,OAAO,CAAC,CAAC,EAAE,KAAK;oBAChB,YACE;oBACF,cAAc,EAAE;oBAChB,WAAW,EAAE;gBACf;YACF;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAM;QAAO;IAC9C,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,IAAI;YAAO,OAAO,KAAK,WAAW;QAAgB,GACpD;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}
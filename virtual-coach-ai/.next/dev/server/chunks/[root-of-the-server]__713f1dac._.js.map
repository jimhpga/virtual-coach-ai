{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Sites/virtual-coach-ai/virtual-coach-ai/src/app/api/video-analysis/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport OpenAI from \"openai\";\r\n\r\nconst client = new OpenAI({\r\n  apiKey: process.env.OPENAI_API_KEY,\r\n});\r\n\r\nexport const runtime = \"nodejs\";\r\n\r\ntype VideoAnalysis = {\r\n  summary: string;\r\n  keyPositions: {\r\n    label: string; // e.g. \"Setup\", \"Top of swing\", \"Impact\"\r\n    focus: string; // what to look for\r\n    notes: string; // what this player is likely doing\r\n  }[];\r\n  matchesToCheckpoints: string[]; // how this ties into checkpoints\r\n  swingKeysOnCourse: string[]; // 3-5 things to focus on when playing\r\n};\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const body = await req.json().catch(() => ({}));\r\n    const {\r\n      playerName = \"Player\",\r\n      typicalBallFlight = \"\",\r\n      typicalMiss = \"\",\r\n      goals = \"\",\r\n      notes = \"\",\r\n      videoName = \"\",\r\n    } = body || {};\r\n\r\n    const context = `\r\nPlayer: ${playerName}\r\nTypical ball flight: ${typicalBallFlight}\r\nTypical miss: ${typicalMiss}\r\nGoals: ${goals}\r\nCoach / self notes about swing: ${notes}\r\nVideo file name (for reference only): ${videoName || \"not provided\"}\r\n`.trim();\r\n\r\n    const systemPrompt = `\r\nYou are a golf coach giving VIDEO-BASED feedback on a player's full swing.\r\n\r\nYou do NOT actually see the video, but you DO see detailed written notes about the player's swing, ball flight, and goals.\r\n\r\nYour job is to behave as if you just watched the swing on video and are summarizing what you saw.\r\n\r\nReturn ONLY valid JSON. No markdown, no commentary.\r\n\r\nJSON shape:\r\n\r\n{\r\n  \"summary\": string, // conversational summary of what you \"saw\" on video\r\n  \"keyPositions\": [\r\n    {\r\n      \"label\": string,  // \"Setup\", \"P2 takeaway\", \"Top\", \"Impact\", \"Finish\", etc.\r\n      \"focus\": string,  // what this player should look for in that position on video\r\n      \"notes\": string   // what they're likely doing now, based on the notes\r\n    }\r\n  ],\r\n  \"matchesToCheckpoints\": string[], // 4–6 bullets like \"Matches P3 checkpoint about lead arm depth\"\r\n  \"swingKeysOnCourse\": string[]     // 3–5 short, punchy keys for on-course swings\r\n}\r\n`.trim();\r\n\r\n    const userPrompt = `\r\nUsing this player context, pretend you just watched their full swing video and generate JSON feedback:\r\n\r\n${context}\r\n`.trim();\r\n\r\n    const response = await client.responses.create({\r\n      model: \"gpt-4.1-mini\",\r\n      input: [\r\n        { role: \"system\", content: systemPrompt },\r\n        { role: \"user\", content: userPrompt },\r\n      ],\r\n    });\r\n\r\n    const first = response.output[0];\r\n    let rawText = \"\";\r\n\r\n    if (first.type === \"message\") {\r\n      const contentItem = (first as any).content.find(\r\n        (c: any) => c.type === \"output_text\"\r\n      );\r\n      if (contentItem?.text) {\r\n        rawText = contentItem.text;\r\n      }\r\n    }\r\n\r\n    if (!rawText) {\r\n      throw new Error(\"No text returned from model\");\r\n    }\r\n\r\n    rawText = rawText.trim();\r\n    if (rawText.startsWith(\"```\")) {\r\n      rawText = rawText.replace(/```json/i, \"\").replace(/```$/, \"\").trim();\r\n    }\r\n\r\n    let analysis: VideoAnalysis;\r\n\r\n    try {\r\n      analysis = JSON.parse(rawText);\r\n    } catch (err) {\r\n      console.error(\"Failed to parse JSON from model:\", rawText);\r\n      throw new Error(\"Model did not return valid JSON for video analysis\");\r\n    }\r\n\r\n    return NextResponse.json({ ok: true, analysis });\r\n  } catch (err: any) {\r\n    console.error(\"video-analysis error:\", err);\r\n    return NextResponse.json(\r\n      { ok: false, error: err?.message || \"Unknown error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AAAA;;;AAEA,MAAM,SAAS,IAAI,mLAAM,CAAC;IACxB,QAAQ,QAAQ,GAAG,CAAC,cAAc;AACpC;AAEO,MAAM,UAAU;AAahB,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;QAC7C,MAAM,EACJ,aAAa,QAAQ,EACrB,oBAAoB,EAAE,EACtB,cAAc,EAAE,EAChB,QAAQ,EAAE,EACV,QAAQ,EAAE,EACV,YAAY,EAAE,EACf,GAAG,QAAQ,CAAC;QAEb,MAAM,UAAU,CAAC;QACb,EAAE,WAAW;qBACA,EAAE,kBAAkB;cAC3B,EAAE,YAAY;OACrB,EAAE,MAAM;gCACiB,EAAE,MAAM;sCACF,EAAE,aAAa,eAAe;AACpE,CAAC,CAAC,IAAI;QAEF,MAAM,eAAe,CAAC;;;;;;;;;;;;;;;;;;;;;;;AAuB1B,CAAC,CAAC,IAAI;QAEF,MAAM,aAAa,CAAC;;;AAGxB,EAAE,QAAQ;AACV,CAAC,CAAC,IAAI;QAEF,MAAM,WAAW,MAAM,OAAO,SAAS,CAAC,MAAM,CAAC;YAC7C,OAAO;YACP,OAAO;gBACL;oBAAE,MAAM;oBAAU,SAAS;gBAAa;gBACxC;oBAAE,MAAM;oBAAQ,SAAS;gBAAW;aACrC;QACH;QAEA,MAAM,QAAQ,SAAS,MAAM,CAAC,EAAE;QAChC,IAAI,UAAU;QAEd,IAAI,MAAM,IAAI,KAAK,WAAW;YAC5B,MAAM,cAAc,AAAC,MAAc,OAAO,CAAC,IAAI,CAC7C,CAAC,IAAW,EAAE,IAAI,KAAK;YAEzB,IAAI,aAAa,MAAM;gBACrB,UAAU,YAAY,IAAI;YAC5B;QACF;QAEA,IAAI,CAAC,SAAS;YACZ,MAAM,IAAI,MAAM;QAClB;QAEA,UAAU,QAAQ,IAAI;QACtB,IAAI,QAAQ,UAAU,CAAC,QAAQ;YAC7B,UAAU,QAAQ,OAAO,CAAC,YAAY,IAAI,OAAO,CAAC,QAAQ,IAAI,IAAI;QACpE;QAEA,IAAI;QAEJ,IAAI;YACF,WAAW,KAAK,KAAK,CAAC;QACxB,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,oCAAoC;YAClD,MAAM,IAAI,MAAM;QAClB;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAM;QAAS;IAChD,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,IAAI;YAAO,OAAO,KAAK,WAAW;QAAgB,GACpD;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}
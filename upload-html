<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Virtual Coach AI - Upload</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="coming-soon.html">Coming Soon</a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <h1>Upload Your Swing</h1>
    <input type="file" id="fileInput" accept="video/*" />
    <button onclick="uploadVideo()">Upload Video</button>
    <div id="status"></div>
    <video id="preview" controls style="display: none;"></video>
    <br /><br />
    <button onclick="runDiagnostics()">Run Diagnostics</button>
  </main>

  <script>
    async function uploadVideo() {
      const fileInput = document.getElementById('fileInput');
      const statusDiv = document.getElementById('status');
      const videoPreview = document.getElementById('preview');

      if (!fileInput.files.length) {
        statusDiv.textContent = 'Please select a video file.';
        return;
      }

      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append('video', file);

      try {
        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          statusDiv.textContent = 'Upload failed. Please try again.';
          return;
        }

        const result = await response.json();
        statusDiv.textContent = 'Upload successful!';
        videoPreview.src = result.videoUrl;
        videoPreview.style.display = 'block';
      } catch (error) {
        console.error('Upload error:', error);
        statusDiv.textContent = 'Upload failed. Please try again.';
      }
    }

    async function runDiagnostics() {
      const log = (msg) => console.log('%c[DIAG]', 'color: green', msg);
      const error = (msg) => console.error('%c[ERROR]', 'color: red', msg);
      try {
        log('Running Upload Diagnostics...');
        const fileInput = document.getElementById('fileInput');
        if (!fileInput) return error('Missing #fileInput element');
        log('âœ” File input exists.');
        const response = await fetch('/api/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ videoUrl: 'https://samplelib.com/lib/preview/mp4/sample-5s.mp4' })
        });
        if (!response.ok) return error(`/api/analyze failed. Status ${response.status}`);
        const json = await response.json();
        if (!json || !json.id || !json.totals) return error('Invalid response structure from /api/analyze');
        log('âœ” /api/analyze responded successfully.');
        if (json._saved) log('âœ” Data saved to Supabase successfully.');
        else error('âš  Supabase save failed or was not confirmed.');
        console.log('ðŸ“¦ Full API Response:', json);
        log('All systems GO. âœ… Upload pipeline seems functional.');
      } catch (err) {
        error(`Unexpected error: ${err.message}`);
      }
    }
  </script>
</body>

</html>

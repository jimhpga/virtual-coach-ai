<!doctype html>
<html lang="en">
<head>`n<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Upload ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Virtual Coach AI</title>
<link rel="preload" as="image" href="/homepage-background.png" />
<style>
  :root{
    --nav:#0b2b12; --scrim: rgba(0,0,0,.05);
    --panel: rgba(0,0,0,.30); --line: rgba(255,255,255,.12);
    --text:#f2f7f9; --muted:#cfe0e6; --maxw:980px; --radius:14px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;background:url('/homepage-background.png') center/cover fixed no-repeat;}
  .scrim{min-height:100vh;background:var(--scrim);}
  .wrap{width:min(var(--maxw),94%);margin:0 auto;padding:16px 0 40px}
  .card{padding:16px;border:1px solid var(--line);border-radius:var(--radius);background:var(--panel);backdrop-filter:blur(2px)}
  .row{display:grid;gap:12px}
  .hint{color:var(--muted)}
  .btn{border:1px solid var(--line);background:rgba(255,255,255,.12);color:#fff;padding:10px 14px;border-radius:12px;text-decoration:none;font-weight:600;cursor:pointer}
  .btn.primary{background:rgba(0,255,153,.16);border-color:#0a7}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  input[type=file]{display:block;width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.10);color:#fff}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:6px;color:#dfecef;font-size:.95rem;margin-top:8px}
  .note{color:#cfe0e6;font-size:.95rem;margin-top:10px}
  .status{margin-top:10px;color:#cfe0e6;font-size:.95rem;display:none}
  .spin{display:inline-block; width:1em; height:1em; border:.15em solid rgba(255,255,255,.35); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite; vertical-align:-.2em; margin-right:.5em}
  @keyframes spin{to{transform:rotate(360deg)}}
  footer{width:min(var(--maxw),94%);margin:10px auto 26px;text-align:center;color:#cbd9de;font-size:12px}
</style>
</head>
<body>
  <!-- NAV with fallback so it always shows -->
  <div id="navMount"></div>

  <div class="scrim">
    <main class="wrap">
      <h1 style="margin:6px 0 12px">Upload Your Swing</h1>
      <div class="card">
        <p class="hint">
          On iPhone, tap <strong>Choose File</strong> ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ pick <em>Take Video</em>, <em>Photo Library</em>, or <em>Browse</em>.
          Face-on & down-the-line both work.
        </p>

        <!-- IMPORTANT: no capture attribute, so iPhone shows all choices (camera, library, files) -->
        <input id="file" type="file" accept="video/*" />
        <div id="meta" style="display:none;margin-top:10px">
          <div class="kv"><div>Filename</div><div id="m_name"></div></div>
          <div class="kv"><div>Size</div><div id="m_size"></div></div>
          <div class="kv"><div>Duration</div><div id="m_dur"></div></div>
        </div>

        <!-- ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ~1 minuteÃƒÂ¢Ã¢â€šÂ¬Ã‚Â note -->
        <div class="note">After you submit, weÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ll analyze your swing. This usually takes about a minute. Please keep this tab open.</div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
          <button id="make" class="btn primary" disabled>Submit Video</button>
          <button id="reset" class="btn" disabled>Reset</button>
        </div>

        <!-- Live status line -->
        <p id="status" class="status" role="status" aria-live="polite"></p>

        <p id="err" style="color:#ffd1d1;margin-top:10px"></p>
      </div>
    </main>

    <footer>Ãƒâ€šÃ‚Â© <span id="y"></span> Virtual Coach AI</footer>
  </div>

<script>
  // Year
  document.getElementById('y').textContent = new Date().getFullYear();

  // --- REMOVE auth redirect for now to avoid blocking uploads ---
  // If you want it: if (localStorage.getItem('vc_auth')!=='ok') location.href='/login.html?next=upload';

  // --- Nav inline loader with fallback (guarantees nav appears) ---
  (function(){
    const mount = document.getElementById('navMount');
    if(!mount) return;
    function markCurrent(){
      const here = location.pathname.replace(/\/+$/,'');
      mount.querySelectorAll('a[data-nav]').forEach(a=>{
        const u = new URL(a.getAttribute('href'), location.origin);
        if(u.pathname.replace(/\/+$/,'') === here){ a.setAttribute('aria-current','page'); }
      });
    }
    function fallback(){
      mount.innerHTML = `
<nav class="topbar">
  <div class="brand"><a href="/index.html">Virtual Coach AI</a></div>
  <div class="nav">
    <a href="/index.html" data-nav>Home</a>
    <a href="/report.html?report=/report.json" data-nav>Reports</a>
    <a href="/coming-soon.html" data-nav>Coming Soon</a>
    <a href="/pricing.html" data-nav>Pricing</a>
    <a href="/faq.html" data-nav>FAQ</a>
    <a href="/contact.html" data-nav>Contact</a>
    <a href="/login.html" data-nav>Login</a>
  </div>
</nav>
<style>
  .topbar{position:sticky;top:0;z-index:1000;display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:#0b2b12;border-bottom:1px solid rgba(255,255,255,.08)}
  .topbar .brand a{color:#fff;text-decoration:none;font-weight:800;letter-spacing:.2px}
  .topbar .nav a{color:#fff;text-decoration:none;margin:0 8px;padding:8px 10px;border-radius:10px}
  .topbar .nav a:hover{background:rgba(255,255,255,.10)}
  .topbar .nav a[aria-current="page"]{text-decoration:underline;text-underline-offset:4px}
</style>`;
      markCurrent();
    }
    fetch('/nav.html?v='+Date.now(), {cache:'no-store'})
      .then(r=>r.ok?r.text():Promise.reject(r)).then(h=>{mount.innerHTML=h;markCurrent();}).catch(fallback);
  })();

  // --- iPhone/desktop upload ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ build report ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ force-redirect to report ---
  const fileEl = document.getElementById('file');
  const makeBtn = document.getElementById('make');
  const resetBtn = document.getElementById('reset');
  const errEl = document.getElementById('err');
  const metaBox = document.getElementById('meta');
  const mName = document.getElementById('m_name');
  const mSize = document.getElementById('m_size');
  const mDur  = document.getElementById('m_dur');
  const statusEl = document.getElementById('status');

  let chosenFile = null;
  let blobUrl = null;
  let duration = 0;

  function fmtBytes(b){
    if (b === 0) return '0 B';
    if (!b) return 'ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â';
    const u=['B','KB','MB','GB']; let i=0; let n=b;
    while(n>=1024 && i<u.length-1){ n/=1024; i++; }
    return n.toFixed(1)+' '+u[i];
  }
  function fmtSec(s){ if(!s) return 'ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â'; const m=Math.floor(s/60); const r=Math.round(s%60); return `${m}:${String(r).padStart(2,'0')}`; }

  function showStatus(msg){
    statusEl.innerHTML = `<span class="spin"></span>${msg}`;
    statusEl.style.display = '';
  }

  function safeGo(url){
    // multiple ways, just in case one is blocked
    try { window.location.assign(url); } catch(e) {}
    setTimeout(()=>{ try{ window.location.href = url; }catch(e){} }, 250);
    setTimeout(()=>{ try{ window.location.replace(url); }catch(e){} }, 500);
  }

  resetBtn.addEventListener('click', ()=>{
    errEl.textContent='';
    statusEl.style.display='none'; statusEl.textContent='';
    metaBox.style.display='none';
    mName.textContent=mSize.textContent=mDur.textContent='';
    fileEl.value='';
    makeBtn.disabled=true; resetBtn.disabled=true;
    if (blobUrl) { try{ URL.revokeObjectURL(blobUrl); }catch{} }
    chosenFile=null; blobUrl=null; duration=0;
  });

  fileEl.addEventListener('change', async (e)=>{
    resetBtn.disabled=false;
    errEl.textContent='';
    statusEl.style.display='none'; statusEl.textContent='';
    const f = e.target.files && e.target.files[0];
    if(!f){ makeBtn.disabled=true; return; }
    if(!f.type || !/^video\//i.test(f.type)){
      errEl.textContent='Please choose a video.'; makeBtn.disabled=true; return;
    }
    chosenFile=f;
    try{ blobUrl = URL.createObjectURL(f); }catch(e){ blobUrl = ''; }

    try{
      const v = document.createElement('video');
      v.preload='metadata'; v.src = blobUrl; v.muted = true; v.playsInline = true;
      await new Promise((res,rej)=>{
        const to = setTimeout(()=>rej(new Error('metadata timeout')), 10000);
        v.onloadedmetadata = ()=>{ clearTimeout(to); res(); };
        v.onerror = ()=>{ clearTimeout(to); rej(new Error('metadata error')); };
      });
      duration = isFinite(v.duration) ? v.duration : 0;
    }catch(e){ duration = 0; }

    metaBox.style.display='';
    mName.textContent = f.name || '(camera video)';
    mSize.textContent = fmtBytes(f.size);
    mDur.textContent  = fmtSec(duration);

    makeBtn.disabled=false;
  });

  makeBtn.addEventListener('click', ()=>{
    errEl.textContent='';
    if(!chosenFile || !blobUrl){
      errEl.textContent='Choose a video first.'; return;
    }

    showStatus('Analyzing your swingÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ ~1 minute');

    try{
      // Lightweight placeholder analysis; replace with backend results later
      const now = new Date();
      const durScore = Math.max(40, Math.min(95, Math.round((duration||3)*8)));
      const relScore = Math.max(35, Math.min(90, Math.round(60 + ((duration||0)-3)*5)));

      const phases = [
        ['P1','Setup'],['P2','Takeaway'],['P3','Lead Arm Parallel'],['P4','Top'],
        ['P5','Delivery'],['P6','Shaft Parallel'],['P7','Impact'],['P8','Post-Impact'],['P9','Finish']
      ].map(([id,name])=>({
        id, name, grade:'ok',
        short:'Review with coach',
        long:'Tap the Video button to view your swing for this checkpoint.',
        ref: blobUrl // opens your local phone video in a new tab
      }));

      const report = {
        discipline:'Full Swing',
        date: now.toISOString(),
        swings: 1,
        phases,
        coaching:{
          priority_fixes:[
            {title:'One Key Feel', short:'Pick one cue only', long:'Use one external cue for 15 balls (e.g., finish tall).'},
            {title:'Tempo Baseline', short:'3:1 feel', long:'Count ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œone-two-three-hitÃƒÂ¢Ã¢â€šÂ¬Ã‚Â to smooth transition.'},
            {title:'Impact Check', short:'Ball then turf', long:'Half swings with a mid-iron; brush after impact.'},
          ],
          power_fixes:[
            {title:'Finish Tall', short:'No stall', long:'Chest to target, push to full height after impact.'}
          ]
        },
        position_metrics:[
          {label:'Setup Match', value:72},
          {label:'Top Position', value:66},
          {label:'Impact Alignments', value:70}
        ],
        swing_metrics:[
          {label:'Tempo Repeatability', value:76},
          {label:'Face-to-Path Stability', value:64}
        ],
        power:{score:durScore, tempo:'~3:1', release_timing:relScore}
      };

      // Try to persist (ok if it failsÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Âredirect still happens)
      try{
        sessionStorage.setItem('vc_report', JSON.stringify(report));
        localStorage.setItem('vc_last_report', JSON.stringify(report));
      }catch(e){ /* ignore quota/private mode */ }

      // Force the redirect in multiple ways so it never sits stuck
      safeGo('/report.html?src=session');

      // Ultra-belt-and-suspenders: if somehow still here after 2s, try again
      setTimeout(()=>safeGo('/report.html?src=session'), 2000);

    }catch(e){
      console.error(e);
      errEl.textContent = 'Something went wrong preparing the report.';
      statusEl.style.display='none';
    }
  });
</script>
</body>
</html>





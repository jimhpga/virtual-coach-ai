import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";

// Public routes (no auth)
const PUBLIC_EXACT = new Set<string>([
  "/",              // landing
  "/upload",        // upload page
  "/login",         // login page
]);

const PUBLIC_PREFIXES: string[] = [
  "/_next/",
  "/favicon.ico",
  "/robots.txt",
  "/sitemap.xml",

  // public demo pages/assets
  "/pose-demo",
  "/report-beta",
  "/data/",
  "/frames/",
  "/impact/",
  "/uploads/",

  // common static images
  "/report-bg.png",
  "/golf-course-bg.jpg",
  "/golf_bg.jpg",
  "/homepage-background.png",
  "/virtualcoach-bg.png",
];

export function middleware(req: NextRequest) {
  // === VCA_PUBLIC_BYPASS_BLOCK ===
  // Allow landing + upload + report without auth (dev/demo)
  const __p = req.nextUrl.pathname;
  if (
    __p === "/" ||
    __p === "/upload" || __p.StartsWith("/upload/") ||
    __p === "/report" || __p.StartsWith("/report/") ||
    __p === "/investor-demo" || __p.StartsWith("/investor-demo/") ||
    __p === "/sequencing-truth" || __p.StartsWith("/sequencing-truth/") ||
    __p === "/login" || __p.StartsWith("/login/") ||
    __p.StartsWith("/_next/") ||
    __p.StartsWith("/frames/") ||
    __p.StartsWith("/data/") ||
    __p.StartsWith("/uploads/") ||
       __p === "/favicon.ico" ||    __p === "/robots.txt" ||    __p === "/sitemap.xml"
  ) {
    return NextResponse.next();
  }
  // === END VCA_PUBLIC_BYPASS_BLOCK ===

  const url = req.nextUrl;
  const path = url.pathname;

  // ✅ Never touch API routes (preserve Range/streaming headers)
  if (path.startsWith("/api/")) return NextResponse.next();

  // ✅ Allow public exact routes
  if (PUBLIC_EXACT.has(path)) return NextResponse.next();

  // ✅ Allow public prefixes
  if (PUBLIC_PREFIXES.some((p) => path.startsWith(p))) {
    // Keep golden demo special-case (still allowed anyway because /report-beta prefix is public)
    return NextResponse.next();
  }

  // ✅ Golden demo mode (extra-safe explicit allow)
  if (path === "/report-beta" && url.searchParams.get("golden") === "1") {
    return NextResponse.next();
  }

  // ---- AUTH GATE ----
  // Minimal default: require a cookie "vca_auth=1"
  const authed = req.cookies.get("vca_auth")?.value === "1";
  if (!authed) {
    const login = new URL("/login", req.url);
    login.searchParams.set("next", path + (url.search || ""));
    return NextResponse.redirect(login);
  }

  return NextResponse.next();
}

export const config = {
  // Only non-API routes (API is handled above too)
  matcher: ["/((?!api).*)"],
};



